<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 6, revision: 2, date: new Date("Jan 6, 2011"), extensions: {}};
//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2011

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<link rel="shortcut icon" href="localnotes-favicon.ico" type="image/x-icon">
<!--}}}-->
<!--PRE-HEAD-END-->
<title> localnotes -  </title>
<style id="styleArea" type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity=60)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0 0; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0;}
.wizardFooter .status {padding:0 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {margin:0 0 0 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding:0.1em 0.4em; margin:0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; width:90%; margin-left:3em; padding:1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none !important;}
#displayArea {margin: 1em 1em 0em;}
noscript {display:none;} /* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank [[TiddlyWiki]], you'll need to modify the following tiddlers:
* [[SiteTitle]] &amp; [[SiteSubtitle]]: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* [[MainMenu]]: The menu (usually on the left)
* [[DefaultTiddlers]]: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;</pre>
</div>
</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="2.2 installer" creator="colm" modifier="colm" created="201203051055" changecount="1">
<pre>{{{
java -cp  IS-&lt;version&gt;.jar run –V IS_CLEAN_TEMP=false
}}}</pre>
</div>
<div title="AEG" creator="colm" modifier="YourName" created="201210021418" modified="201309201300" changecount="6">
<pre>!!Tactical AEG approach at BT:
__AEG1__ - run weekend before ME, captures all product charge info based on future-dated accrualsDate
__AEG2__ – run at month end – collects usage accruals
__AEG3__ – run at month end based on accounts which have had product changes since AEG1 (captured by custom triggers)
Combined outputs of AEG 1,2 &amp;3 are sent downstream….

__ACPD-3692__ - Allow AEG accruals date in the future
Due to the length of time it takes to run AEG BT Retail want to be able to start the process earlier in the month and specify an accruals date on the last day of the month. For example starting AEG on 30 May 09 with an accruals date of 31 May 09.
See also CR#26021

__ACPD-3598__ - AEG - Splitting revenue streams and summarisation
BT Retail ( on IRB 2.2.40 ) is experiencing lengthy execution time for month-end AEG;  currently in the region of 14 hours.  All performance enhancements ( hardware, database and memory related ) have been implemented.
This suggestion aims to reduce the runtimes via software changes and streamlining database accesses by separating out the rental revenue extract, and the usage revenue extract, via switches to the AEG.

__ACPD-3691__ - Run AEG for a specified list of accounts - got a driver table for changed accounts
BT Retail (IRB 2.2.40) are experiencing lengthy execution time for month-end AEG.  Starting AEG earlier on the last day of the month to meet customer SLA will mean that account changes on that day impacting revenue may be missed from the extract.  To get round this BT can capture all changed accounts and populate a custom table with a list of accounts that have changed.  AEG can then be run again to recalculate accruals for this specified list of accounts.

!!!Details
* __AEG1__ - run weekend before ME, captures all product charge info based on future-dated accrualsDate
** single row written to ACCRUALSEXTRACT table to identify this run
** accruals info is written to ACCRUALS table (identifiable by above ACCRUALS_EXTRACT_ID)

//capture the change details using triggers into ~SI_AEGCHANGELOG - triggers on://
ACCOUNT
ACCOUNTSTATUS
CUSTPRODUCTDETAILS
CUSTPRODUCTSTATUS
CUSTPRODUCTCHARGE
CUSTPRODUCTDETAILS
CUSTPRODUCTTARIFFDETAILS
CUSTOVERRIDEPRICE
ADJUSTMENT
BILLSUMMARY

On ME night:
* disableAEGtriggers.sql
* Start AEG2 -  include additional parameter -accrueUsage 
* Run ~AEGgenerateArgumentFile.ksh &lt;argument file&gt; - generates a list of accounts from SI_AEGCHANGELOG
* Check argument file includes correct parameters and list of accounts to be processed.
* Start AEG3 with parameter –argFile &lt;argument file&gt; - regenerates all 
* Start AEGaccrualsDelete.ksh - deletes AEG1 rows identified by accounts in SI_AEGCHANGELOG

Combined outputs of AEG 1,2 &amp;3 is sent to IOTA.

!!! Description of accruals by Mervyn Wingfield
So they start off with the revenue that has been invoiced during the previous period X - let us call this £R

And they say to themselves, &quot;Is there revenue that we could have billed for at the end of the period?&quot; For example there may be unbilled usage records because accounts are not always billed at month end.

This revenue is calculated as accruals (as a snapshot at the end of the period) and is booked as 'accrued revenue' into period X - let us call this £A

Then they say to themselves, &quot;Is there revenue that we have billed for in the past but has not been earned because it is 'in advance'?&quot; For example there may be recurring charges that have been billed and cover time intervals beyond the end of the period (e.g. the following month).
This revenue is calculated as prepayments (as a snapshot at the end of the period) and is booked as  'negative revenue corrections' in  period X - let us call this £P
So Revenue for period X has now been 'corrected' and is calculated as £R plus £A minus £P.
Because this is an Accountant 'game' and not the real world, the 'corrections' applied at the end of the period X need to be removed in the following period X+1.
So in period X+1 there are 'reversing journals' which remove the effects of £A and £P, i.e. minus £A and plus £P are applied to the Revenue in period X+1.
At the end of period X+1 the whole process is repeated and £A and £P are recalculated from scratch (history is irrelevant).
</pre>
</div>
<div title="AEG rerun modes" creator="YourName" modifier="YourName" created="201401310956" modified="201401311008" changecount="7">
<pre>''-rerun'' - this restarts AEG attempting to continue the most recent run for the same date criteria (accruals date and revenue dates) 
* AEG –rerun if started from TM is just invoked as a normal run (starting each streams in turn in the usual manner). However each stream will check for previously completed accounts (from ACCRUALS) in its random hash range. See [[PR32139|http://intranet.emea.convergys.com/prd/cpt/pr.asp?prnumber=32139]]
* specifically each stream scans ACCRUALS for account_complete_boo = ‘T’ to indicate which accounts were processed, and builds an in memory list of accounts to skip, before then processing accounts in its hash range that aren’t in that list
* uses the same accrualsextract.ACCRUALS_EXTRACT_ID
* requires the previous run to have completed as it ignores in-progress runs.  It doesn’t need the previous run to have errored though.
*  updates the EXTRACTION_STATUS and EXTRACTION_DTM when complete mode is run with the JOB table pid:
{{{
AEG -m COMPLETE  -p &lt;process_instance_id&gt;
}}}

''-regenerate'' - starts a new run from scratch with a new ACCRUALS_EXTRACT_ID, disregarding prior work.</pre>
</div>
<div title="AWR - av buf wt" creator="colm" modifier="colm" created="201405151322" modified="201405151330" changecount="2">
<pre>Av Buf Wt (ms) in AWR

It's the average buffer busy wait time - except it includes the &quot;read by other session&quot; waits as &quot;buffer busy wait&quot;.

Detail from J Lewis:

&quot;As Franck has pointed out, the best we can do is look at statspack – where we have the pl/sql source – when we want to try and work backwards to the printed figures. Even then, as with your “Av Buf Wt(ms)” you also have to know that v$filestatxs is one of the view created by statspack and that the x$kcbfwait it references (which is not commonly documented) is the summary of buffer busy waits by file number – making the figures youthe fitur see the average buffer busy wait time by file.

Unfortunately, dependent on version of Oracle, you have to guess whether the buffer busy waits data (x$kcbwait and x$kcbfwait) includes or excludes the “read by other session” special case that was isolated in 10g; and then you have to cross check with the “Segments by Buffer Busy Waits” from v$segstat. Nobody does this type of analysis in a vacuum, so no-one has a list of the thousands of cross-referenced details that would be necessary to make it possible to automate the interpretation of the numbers.&quot;</pre>
</div>
<div title="Admin" modifier="YourName" created="200907160726" modified="201402051438" changecount="23">
<pre>4/5 Lochside View
Edinburgh Park
Edinburgh
~EH12 9DH
Scotland, UNITED KINGDOM

Telephone Number: +44 (0)131 200 5000
Fax Number: +44 (0)131 200 5001
Softphone: 	4728	SEP006FA494AD55	10.254.1.10

Peoplesoft ID: 100139211
NC: COMC0512

MeetMe (3151) - 675656

//The only two things that motivate me and that matter to me are revenge and guilt.// - Elvis Costello

//Plans are worthless. Planning is essential.// - Dwight D. Eisenhower

//My grandfather once told me that there were two kinds of people; those who do the work and those who take the credit. He told me to try to be in the first group; there was much less competition.// - Indira Gandhi
</pre>
</div>
<div title="App server connection count" creator="colm" modifier="colm" created="201209130858" changecount="1">
<pre>Classic Tom Kyte scenario where too large connection/process count allows too many connections... this hammers the machine.
//
From: Niki Weipers 
Sent: 06 September 2011 10:56
To: Scott Middlemiss; Fiona Jack; Colm McCartan; Stephen Billcliff
Subject: Sound familiar?

1.	At 11:54 AM PT, the number of sessions in instance 1 was 577. At 12:04 PM PT, the number of sessions went up to 2063. Almost 1500 sessions were created in 5.5 minutes. At 11:58:31, web logic did not get response from database for the already existing sessions, so kept on requesting more sessions (almost 1500). 
//</pre>
</div>
<div title="Availability" modifier="colm" created="201005170956" modified="201108121858" changecount="5">
<pre>|''Availability Percentage''|''Downtime per Year''|''Downtime per Month''|''Downtime per Week''|
|99%|3.65 days|7.2 hrs|1.68 hrs|
|99.99%|52.6 mins|4.32 mins|1.01 mins|
|99.999%|5.26 mins|25.9 secs|6.05 secs|</pre>
</div>
<div title="BDD process" creator="YourName" modifier="YourName" created="201309201025" modified="201309271334" changecount="2">
<pre>The System Processes docs explain best how BDD works (all holds for budget center report/summary statement or dunning notices as well as bills):
The Bill Data Deleter is driven by the BILLARCHIVELOG table. This table is populated by the Bill Data Writer every time a bill is produced. For each record that is sufficiently old, BDD selects all corresponding formatting requests (that is, those with an ARCHIVE_NAME matching that (BAL. ARCHIVE_INSTANCE_NAME) of the table's record) and, if the associated bill is ready for deletion, proceeds to delete it. The bill corresponding to a formatting request is ready for deletion if the formatting request has a request status of exported (written to file?) or processed and an archive status of written, not deleted,(and presumably not null)  and - in the case of bill data - if there are no outstanding reissue requests .. When the data has been processed, DELETED_DTM is updated to the current date and time and a commit is done before the next record is selected.

BDD works by looking in the BAL table, finding rows whose archive_bill_dat is sufficiently old (as governed by BDDdaysUntilDeleteAfterBilling), locating the associated formmattingrequests – by linking on the archive_instance_name. These FRs then tell BDD which account/bill_seq combinations are viable for deletion – they must also be marked as exported or processed and have an archive status of written. The BILLDATA rows are deleted while the FR and BAL records are only marked as deleted.

Note:
-	as its driven by BAL, BDD will fail if it sees 'valid' records there and then goes to BILLDATA only to find a large hole in the table.
-	Nothing housekeeps the FORMATTINGREQUEST and BILLARCHIVELOG tables - records are merely marked as deleted.

So:
BG -&gt; writes data to BILLDATA
BG -&gt; creates an FR record?
   - the fornatting request is based on the filetype
   - data i snow in BD waiting to be extracted and/or converted to an appropriate format for output...
BDW -&gt; creates a BAL record?
Once aged out, records in BDD are free to be deleted
</pre>
</div>
<div title="BG pseudocode" creator="colm" modifier="YourName" created="201205030920" modified="201401271045" changecount="5">
<pre>The Sequence for a straight forward period bill run is as below:

BG performs 2 commits per account billed.  This is not configurable. BG performs 2 transactions:
* period closure - this takes a few seconds at most since all it does is:
** update accountrating.next_bill_dtm to the next month
** update accountrating.rate_event_seq to the next value
** update account.billing_status to BB.
This will lock out rating for the time it takes to get all the accountrating rows for the account and then it commits allowing rating to continue again.  Realistically this should be no more than a few seconds (the updates take milliseconds, but they will have to wait for all the rows to be locked once rating has done its bit for the current batch).
* the main billing transaction - this will not lock out rating and can be done in parallel.

1) BILLPRODUCTCHARGE
...
2) UPDATE CUSTPRODUCTCHARGE
...
3) INSERT into CANCELBILLCUSTPC
....
4) BILLSUMMARY FOR UPDATE.

Sequence of BG after calculating product charges (select from BillproductCharge and update of CustProductCharge)
1) It should process the event for that account. (itemisation)
2) Calculate the discount.
3) Process payments,dispute, receivables
4) Calculate Tax.

BG can be run with the –test switch for testing billing only.
The speed of the billing engine when billing big customer hierarchies is not just influenced by the number of accounts in the hierarchy.  There are a large number of other factors which affect billing speed such as:

*  the number of events to be billed
* the complexity of the billing tariffs
* the number and complexity of any discounts
* whether override event or tariff pricing is in use
* the level of itemisation used
...etc etc</pre>
</div>
<div title="BPCD - Bill Product Charge Deleter" creator="colm" modifier="colm" created="201202011207" changecount="1">
<pre>Notes for 2.2:

BG generates the BPC records when it bills an account. BPCD inidexes for performance therefore impact BG insert performance.

* BPCD - does it take care of disputes?
- ignores themm but it does mean that bills can't be reissued once their BPCs are gone..?
- no product refunds after these are BPCD's
* what about product termination?
- product terms in the past try to automatically refund charges - this will be impossible if they have been BPCD'd.

BPCD deletes records that meet all of:
* The account associated with the BILLPRODUCTCHARGE record has been billed. 
* BILLPRODUCTCHARGE.CHARGE_END_DAT for all the customer product charge records associated with the account is earlier than ACCOUNT.EARLIEST_PROD_CHANGE_DAT. 
* BILLPRODUCTCHARGE.CHARGE_END_DAT is earlier than (ACCOUNT.LAST_BILL_DTM date portion - BPCDdaysToDelete). 

Each BPC in the table (per product seq) has a charge_start_dat and charge_end_dat showing thre time period the charge was valid for - BPCD remembers the *latest* of these for a given account and uses that +1 to set the ACCOUNT.ALLOW_PROD_CHANGES_FROM_DAT field.

BPC has a status:
1 	Active (the details contained in the charge record reflect the most up to date view of the charges applied in the period).
2 	Implied active (charge record to reflect the portion of an active record that remains after a refund has taken place; this charge never appears on a bill).
3 	Superseded active (charge record which was previously an active record but no longer reflects the most up to date view of the charges applied in the period).
4 	Refunded (charge record to provide details of a refunded charge).
5 	Cancelled (charge record to provide details of a cancelled charge).
6 	Superseded implied active (charge record which was previously an implied active record but no longer reflects the most up to date view of the charges applied in the period).

And a type:
1 	Initiation.
2 	Periodic.
3 	Termination.
4 	Usage.

!!!GPARAMS
~BPCDbulkSelectSize	INTEGER	01-Jan-91		5000 (default)
The maximum number of CUSTPRODUCTCHARGE records to be selected by bulk select. The value should not exceed 32767.

~BPCDdaysToDelete	INTEGER	01-Jan-91		90 (def)
Integer representing the number of days prior to the last bill date that should pass before an ended BILLPRODUCTCHARGE record should be deleted. Typically set to reflect the longest charging period in use in the system.

~BPCDmaxTransacSize	INTEGER	01-Jan-91		1 (def)
The maximum number of records to be processed by the Bill Product Charge Deleter per transaction.

!!!BPCD - schema
ACCOUNT.ALLOW_PROD_CHANGES_FROM_DAT
Indicates:
- The earliest date for which changes can be made to any product data for products that the account is being charged for, and,
- The latest date for which BillProductCharge records have been deleted by the BillProductCharge Deleter for all products to which the account is being charged.

ACCOUNT.EARLIEST_PROD_CHANGE_DAT
Indicates the earliest date for which changes have been made to any product data for products that the account is being charged for, that is, at any given point in time earliest_prod_change_dat = min (CustProductCharge.earliest_change_dat) where CustProductCharge.account_num is for this account. This value is stored so that the Bill Product Charge Deleter can assess which BillProductCharge records it may delete.

BILLPRODUCTCHARGE.CHARGE_START_DAT
First day which this product charge record covers.

BILLPRODUCTCHARGE.CHARGE_END_DAT
Last day which this product charge record covers.

CAM, BC &amp; TAD are down as deleting from DISPUTE

!!!BPCD - Hathorne
CR CB1#46809 - An additional index on BILLPRODUCTCHARGE would improve BPCD performance
CR CB1#38806 - BPCD batch size gparam no longer works - fxed at 2.2.52 - generated by:
CR CB1#31132 - BPCD does not respond correctly to a convenient stop command</pre>
</div>
<div title="Basic ksh profile" creator="colm" modifier="colm" created="201303051027" changecount="1">
<pre>{{{
export PATH=/usr/local/bin:/bin:~/bin

unalias ls
alias lt='ls -lart'
alias ll='ls -la'
alias cdir='cd $INFINYS_ROOT'
alias sd='sqlplus $DATABASE'
PS1='$LOGNAME@$ORACLE_SID:$PWD \$ '

#####################################################
# set up arrow keys
######################################################
set -o emacs
alias __A=$(print '\0020')    # ^P = up    = previous command
alias __B=$(print '\0016')    # ^N = down  = next command
alias __C=$(print '\0006')    # ^F = right = forward a character
alias __D=$(print '\0002')    # ^B = left  = back a character
alias __H=$(print '\0001')    # ^A = home  = beginning of line
}}}</pre>
</div>
<div title="Basic parfiles" modifier="colm" created="201008181357" modified="201108282119" changecount="9">
<pre>!!Export
userid=geneva_admin/geneva
file=mgate-17AUG.dmp
log=mgate-17AUG.log
FULL=N
GRANTS=Y
INDEXES=y
BUFFER=2097152
RECORDLENGTH=65535
FEEDBACK=1000000
CONSISTENT=Y
STATISTICS=NONE
COMPRESS=N
OWNER='~GENEVA_ADMIN'

!!Import
userid=geneva_admin/geneva_admin
file=mgate-17AUG.dmp
log=import-18AUG.log
ignore=y 
buffer=2097152 
RECORDLENGTH=65535
FEEDBACK=500000
STATISTICS=NONE
constraints=y 
grants=y 
indexes=y 
rows=y 
fromuser=geneva_admin 
touser=geneva_admin

!!!Import performance/monitoring:
{{{
select substr(sql_text,instr(sql_text,'INTO '),60) table_name,
         rows_processed,
         round((sysdate-to_date(first_load_time,'yyyy-mm-dd hh24:mi:ss'))*24*60,1) minutes,
         trunc(rows_processed/((sysdate-to_date(first_load_time,'yyyy-mm-dd hh24:mi:ss'))*24*60)) rows_per_min
  from   sys.v_$sqlarea
  where  sql_text like 'INSERT%INTO %'
    -- and  command_type = 2
    and  open_versions &gt; 0;
}}}

!!!Approach
!!!!TAP3:
Normal Customer / Account extract to extract the PLMN data.    – Not too big
One parfile for TAP3 Config                                                      - Not too big
One for the TAP3 PLMN data                                                   - This one can get large

The individual PLMN extract can get quite large as it has all the Roamer Costs and Data.

Not sure how we could limit the data, but think it would only be a few tables that would need restricted. Eg the two Roamer tables and maybe Export Status.
!!!!Hash range?
{{{
-- get required customers list
select customer_ref from customer where RANDOM_HASH&gt;=300001 and RANDOM_HASH&lt;=400000;

-- get related accounts list
select account_num 
from account a join customer c on a.customer_ref=c.customer_ref 
where c.RANDOM_HASH&gt;=300001 
and c.RANDOM_HASH&lt;=400000;
}}}

!!!Support parfiles
{{{
/emea/admin/tools/scripts
}}}</pre>
</div>
<div title="Billing Itemisation" creator="YourName" modifier="YourName" created="201402051641" modified="201402061158" changecount="4">
<pre>If itemisation is turned on then BG will load all events to memory. If itemisation is turned off then BG will only load in batches up to ~BGeventBatchSize - default is 5000.
!!!!To disable:
Customer Account Maintenance -&gt; product details -&gt; Rating view -&gt; Event Types tab -&gt; details dialog -&gt; check box to Itemise events which you should uncheck. 
Repeat for each event type.
</pre>
</div>
<div title="Bulk gparams" creator="colm" modifier="YourName" created="201103181405" modified="201307251234" changecount="16">
<pre>!!!! ~RATEbulkGuidingThresholdNum
From Sys Params: //If this system parameter is present and has a value that is less than or equal to the number of events in the rating envelope then a bulk guiding algorithm is used. If the value of the system parameter is greater than the number of events then the Active Rating Engine uses single event guiding.//

Developer’s view - from Anath Bandhu Mandal:
* In bulk guiding, all events in an envelope are guided at once. It is done in two steps: 
** All events in the envelope are written into a temporary table, ''~TMPeventGuiding''
** The guiding query (long JOIN with multiple tables) is executed for all events in bulk.
* If the bulk guiding is not configured, then each event in the envelope is guided separately. 
* For RTCC with single event envelope, one should not use bulk guiding. I did not find any mention for this in the documentation. 
!!!! ~BGeventBatchSize
The maximum number of event records to be processed at once. This limits the amount of memory required for event storage (only one batch plus one are held in memory at any one time).

The ideal setting - if the system configuration permits - is a little more than the maximum expected number of events per account. That achieves the highest efficiency with the least wasted memory. If it should happen to be too low for a few accounts the only effect should be a minor loss of efficiency. If this setting is impractical, the value should be limited to something that is sensible given the system configuration.
!!!! ~BGbulkProductLoadingBoo

Discussed in [[Hathorne PR34223|http://intranet.emea.convergys.com/prd/cpt/pr.asp?prnumber=34223]]
{{{
NAME                                     TYPE     DESCRIPTION                                   PARAM_SCOPE
---------------------------------------- -------- --------------------------------------------- -----------
BGbulkProductLoadingBoo                  STRING   Determines whether bulk product loading is en           3
                                                  abled.

BGbulkProductLoadingMinimum              INTEGER  Defines the minimum number of products to be            3
                                                  loaded for an account for which the Billing E
                                                  ngine will use bulk product loading.

BGbulkProductLoadingRatio                INTEGER  Bulk product loading will not be used for an            3
                                                  account if the ratio of the number of product
                                                  s that would be fetched by bulk product loadi
                                                  ng and the number of products, which need to
                                                  be loaded, is above this value.
}}}
!!!! ~BGimageBulkInsertSize
A tool for improving the billing performance for accounts which have large bills and for billing hierarchies with large numbers of accounts. It controls the number of BILLDATA, BCRDATA, and STATEMENTDATA records that are inserted in one go, via Oracle host arrays and bulk inserts.

The more records that are inserted in one go, the faster the Billing Engine runs. However, the memory requirements of the Billing Engine increase as it must cache more record data in memory to do this.

The maximum number of records that can be inserted in one go is the total number generated by the current billing hierarchy. Records are not cached across billing transactions.

This constraint imposes a practical upper limit on the size of BGimageBulkInsertSize beyond which no performance gains are achieved.</pre>
</div>
<div title="CDT" creator="colm" modifier="colm" created="201106090844" modified="201106091403" changecount="7">
<pre>Check gparams:

{{{
select * from gparams 
where name in ('SYSsiteID', 'SYStransConfigurationDataClientPath','SYStransConfigurationDataDirObjName');

update gparams set string_value='F:\customers\bt_wholesale_harlequin\open\TR7248339'
where name='SYStransConfigurationDataClientPath';
}}}
Make sure working dir is aligned:
{{{
col owner for a12
col DIRECTORY_PATH for a75
select * from dba_directories;

CREATE OR REPLACE DIRECTORY CDT_DIR AS 'F:\customers\bt_wholesale_harlequin\open\TR7248339';
}}}
Perms should be writable to CDT_DIR for oracle user - remember ancestor search bit. Then Ora privs need set...
{{{
cd $INFINYS_ROOT/RB/schema/roles/
sqlplus sys/sys as sysdba
SYS@CLIP1S50&gt; @cdtprivs.sql GENEVA_ADMIN CDT_DIR
}}}
Check site configuration..
{{{
select * from SITE;
select * from SITESEQUENCE;
}}}
Look out for:
* directory is viewable/mounted on the DB node, a la CVG_INFINYS_PF
* </pre>
</div>
<div title="CEA &amp; CED" modifier="YourName" created="201006030751" modified="201307251554" changecount="6">
<pre>All driven by ACCOUNT random hash

~CEDinit - does the logic to derive what acounts can't have their usage deleted and puts a row for these on LOCKEDACCOUNT. 
- COMPLETE - does the partition exchange -  and this drops the INDEX ptn and frees up space
CED - for stuff it can delete, updates billsummary EAS 1-&gt;2
- for stuff it can't, itself 'rescues' the usage from DELETEEVENT 
- COMPLETE phase - drops and swaps the partitions

It is sensible to seperate out CED and CED -deletediscountusage because the account is locked for less time if you do the CED-alone stuff first. You also don't want to have your basic CED functions interrupted by some trivial stuff with discount dropping.

From VDC Grant at 4.3:

//It appears the gparam config change from 1000 to 50 000 has worked.  Bringing the runtime of CED down from 30 hours to 5.5 hours.  All the other processes CEA, backuplog, CEDinit ran in the expected time and completed with no errors. //

See 6666917  - this is CEDrandomHashRangeIncrement 

!!!!Check progress
CEA:
{{{select /*+ PARALLEL(BILLSUMMARY,4) */ count(*) from BILLSUMMARY where
event_archive_status is null and archive_dat &lt;= trunc(sysdate)-90;}}}
The count will decrease as the process runs (to near zero).

CEDinit:
{{{select count(*) from BILLSUMMARY 
where event_archive_status = 1 and event_seq &lt; :highValue;}}}
This count will decrease as the process runs.  No parallel hint as this is on an index and so won’t parallelise (should still be a fairly fast query)

CED:
{{{select count(*) from lockedaccount 
where billed_boo != 'C';}}}
(though this should be quick)
 
Only other thing to watch is what happened in 3.0 Prod whilst I was out there – which was that the CED Complete phase will hang if there are long running open transactions in the DB as it is waiting to make the deleteevent tablespace read-only.  If this happens you need to query long running transactions (v$lock) and see what is going on and/or get Ian B to check it out.
</pre>
</div>
<div title="CEDrandomHashRangeIncrement" creator="YourName" modifier="YourName" created="201307251556" modified="201309030921" changecount="2">
<pre>In April, GParam CEDrandomHashRangeIncrement = 1000000 (which means no increments as random hash is only 1 to 1million). 

This meant that we did 1 execution of the update on Billsummary and 1 execution to delete from EventDeletionRequest for each copy (each one doing its own hash range of ¼ million).  We got 2 of the processes failing with ITL deadlocks on EDR because essentially all 4 processes needed to access almost all the blocks (as it is a narrow table and randomly populated).  After that we increased the ini_trans, so that the ITL deadlocks would go away, but, we also changed CEDrandomHashRangeIncrement = 1000. This random_hash range is the random number on account table - there are a million possible values so we would roughly expect there to be an even distribution and a couple of accounts per random_hash value (on average). 

This means that each copy will execute the update and delete statements 250 times, so e.g. copy_num 1 will run with random_hash 0 to 1000, then 1001 to 2000 etc.  Copy_num 2 would start at 250,000 etc. Now, according to the AWR/SQL files provided by Colm, we see quite different explain plans: 
- In April with lots of FTS and hash joins - but only done once 
- In May, the explain plan is more nested loops and index lookups - but this may be less efficient in the grander scheme of things. 

The same logic is used to do both statements (billsummary update and eventdeletionrequest delete) one after the other (for each hash range increment). 

We  would suggest that perhaps increasing CEDrandomHashRangeIncrement to e.g. 10,000 or maybe 50,000 would actually be beneficial?? Or whether, having fixed the ini_trans, it may be better to set it back to 1 million and take the hit of it being done in 1 transaction (per copy). 

</pre>
</div>
<div title="CEP partition logic" modifier="colm" created="201011110635" changecount="1">
<pre>At VDC, the SYSEventTidemark gparam is set to Nominal meaning that events are guided to bills on the basis of their account's nominal bill date. This means that events will be associated with the correct bill, even if billing is not up to date. For example, if billing for the 1st July still has not been carried out by the 10th, say, all the events from the 1st to the 10th will still have their event_seq set so that they will appear on the 1st August bill. BG picks up the event_seq form the ACCOUNTRATING table as usual but then performs a check to see if the event has occurred after the NEXT_BILL_DTM. If so, it will increment the event_seq accordingly. This behaviour still holds after implemementing CEP. With CEP, the event_seq is generated based on the bill_dtm (see []). As a consequence of this behaviour, it is not important when in the month BG lite has been run - events will still be guided to the appropriate partition.

(NOTE that SYSIndividualLateBillsBoo interacts with this behaviour...)

With CostedEvent partitioning (CEP), the partition selected to store an event is based upon the assigned event_seq. Instead of being a simple integer which is incremented at each bill run, the event_seq now represents the date of the bill. Partitions are created with a high_value which means all event_seqs strictly less than the high_value are stored there – here is a snapshot of the partitions in production during October 2008:

{{{
&quot;TABLE_NAME&quot;  &quot;PARTITION_NAME&quot;     &quot;HIGH_VALUE&quot;
&quot;COSTEDEVENT&quot; &quot;P1&quot;                 &quot;081001000&quot;   - the trailing partition
&quot;COSTEDEVENT&quot; &quot;P2&quot;                 &quot;081101000&quot;   - events rated during September after transition to CEP
&quot;COSTEDEVENT&quot; &quot;P3&quot;                 &quot;081201000&quot;   - events with bill date less than 01/12 i.e. the November partition. Current usage.
&quot;COSTEDEVENT&quot; &quot;P4&quot;                 &quot;090101000&quot;
&quot;COSTEDEVENT&quot; &quot;P5&quot;                 &quot;090201000&quot;
&quot;COSTEDEVENT&quot; &quot;P6&quot;                 &quot;090301000&quot;
&quot;COSTEDEVENT&quot; &quot;P7&quot;                 &quot;090401000&quot;
&quot;COSTEDEVENT&quot; &quot;P8&quot;                 &quot;090501000&quot;
&quot;COSTEDEVENT&quot; &quot;P9&quot;                 &quot;090601000&quot;
&quot;COSTEDEVENT&quot; &quot;P10&quot;                &quot;090701000&quot;
&quot;COSTEDEVENT&quot; &quot;P11&quot;                &quot;090801000&quot;
}}}

October usage currently coming into the system will be billed on Nov 1st. Therefore the next_bill_dtm is 081101 and event_seq 081101000 is assigned. However, because the partition key must be strictly less than the high_value, this usage is directed to P3 with high_value 081201000. A more intuitive way to view this would be to see the P3 partition as &quot;everything before 081201000&quot; i.e. the November partition.</pre>
</div>
<div title="CM Synergy" modifier="colm" created="200908131413" modified="200908140807" changecount="2">
<pre>Working on EMEA admin files:
cd /psg/cmccarta/UTIL-cmccarta3/UTIL/etc
In GUI:
- reconfigure - gets a refresh of my local propjcet files
- check out file to change
MAKE CHANGES
- check in changed file
- quit
su to pdgadmin/c!rcle15
ccm start
- Enter ~UTIL-3 as project at top left
- right click on file to show history
- check in 'current' file moving from SQA-&gt;released
- check in new one, going from integrate-&gt;SQA
- for top-level project (top line of list: UTIL), call reconfigure
changes should now be available</pre>
</div>
<div title="Catalogues" creator="colm" modifier="colm" created="201109051001" modified="201109051002" changecount="3">
<pre>BCM publishes/imports new billing catalogues:
cataloguechange.catalogue_change_id

RCM publishes/imports new Rating catalogues:
cataloguechange.rating_catalogue_id

These are linked via the TARIFFHASRATINGTARIFF table.</pre>
</div>
<div title="Check random hash distribution" creator="YourName" modifier="YourName" created="201309030922" changecount="1">
<pre>{{{
SELECT customer_ref, RANDOM_HASH, WIDTH_BUCKET(RANDOM_HASH, 0, 1000000, 100) bucket
FROM customer;
}}}
{{{
SELECT count(customer_ref), WIDTH_BUCKET(RANDOM_HASH, 0, 1000000, 100) bucket
FROM customer
group by WIDTH_BUCKET(RANDOM_HASH, 0, 1000000, 100)
order by WIDTH_BUCKET(RANDOM_HASH, 0, 1000000, 100);
}}}</pre>
</div>
<div title="Cluster Factor" creator="colm" modifier="colm" created="201108301037" modified="201108301041" changecount="4">
<pre>See: http://oracle-online-help.blogspot.com/2006/11/clustering-factor_28.html

Highlights:
* In simple terms it is the number of “block switches” while reading a table using an index.
* A good CF is equal (or near) to the values of number of blocks of table.
* A bad CF is equal (or near) to the number of rows of table.
* Rebuilding index to improve the CF is a myth - to improve the CF, it’s the table that must be rebuilt (and reordered) and if table has multiple indexes, careful consideration needs to be given by which index to order table.

Good CF:
[img[Good_CF.png]]

Bad CF: 
[img[Bad_CF.png]]</pre>
</div>
<div title="Collection queues" creator="colm" modifier="colm" created="201107210823" modified="201107210823" changecount="2">
<pre>There is a GPARAM “~SYScollectionsInUseBoo”, which if set to True means Collections is present. In this case, there is a script called fixcollectiontriggers.sql to enable or disable all collection triggers.

See http://intranet.emea.convergys.com/prd/cpt/pr.asp?db=CB1&amp;prnumber=53313</pre>
</div>
<div title="Core dumps" creator="colm" modifier="colm" created="201103081145" modified="201103081451" changecount="7">
<pre>On Solaris, ''pstack'' will print stack trace. Otherwise ''g|a|mdb'' should be called on the file. Look in /var/core for dump
files on ~HP-UX. Also ''coreadm'' will tell you about core dests etc on ~HP-UX 11.31 - here, try /opt/langtools/bin to find it...

Here is Julian's login stuff to setup core formats:
{{{
DIR=/tmp/cores
if [ ! -d $DIR ];
then
        mkdir /tmp/cores
fi
ulimit -c unlimited
coreadm -p $DIR/core.%f.%p.%t $$
}}}
With gdb, call
{{{
 gdb -c &lt;path/to/corefile&gt; &lt;full/path/to/app&gt; e.g.
 gdb -c core  /ibstst1/infinys/infroot/ibstst/stage/RB/RB/bin/TM
}}}
Then call bt to get a backtrace:
{{{
(gdb) bt
#0  0xc00000000029f090:0 in kill+0x30 () from /usr/lib/hpux64/libc.so.1
#1  0xc0000000001c32f0:0 in raise+0x30 () from /usr/lib/hpux64/libc.so.1
#2  0xc000000000260c70:0 in abort+0x190 () from /usr/lib/hpux64/libc.so.1
#3  0xc00000000d8a87d0:0 in GERfatalSignal () at GERinitialise.c:119
#4  &lt;signal handler called&gt;
#5  0xc00000000d8c7f30:1 in GERloadArgsToContext () at GERinterfaceToPF.cc:640
#6  0xc00000000d8c5350:0 in GERgetMessageDetails () at GERinterfaceToPF.cc:166
#7  0xc00000000d8a2ec0:0 in GERsendVA () at GER.c:219
#8  0xc00000000d8a2ba0:0 in GERsend () at GER.c:145
#9  0x40000000000dfcc0:0 in TMcreateStandardEntries () at TMplan.c:1067
#10 0x40000000000e2590:0 in TMcreatePlanFromConfig () at TMplan.c:1608
#11 0x40000000000f5880:0 in TMcreateTaskFromConfig () at TMtask.c:463
#12 0x40000000000cb120:0 in TMbuildJobFromSchedule () at TMjob.c:535
#13 0x40000000000cce40:0 in TMstartSchedule () at TMjob.c:777
#14 0x40000000000bfb30:0 in TMcheckSchedule () at TMschedule.c:347
#15 0x40000000000a92e0:0 in TMworkLoop () at TMmain.c:951
#16 0x40000000000aa8f0:0 in main () at TMmain.c:1154
(gdb)
}}}

You can also try ''what core'' to get its SCCS info and ''elfdump -o -S core''.

From Scott:

* Checking the Oracle alert log, plus any other files created in the Oracle dump directories.
* String the core file for ORA- errors.  Also check the head and tail of the core file for any recognisable error messages.
* Run the process with SQL trace on to try and identify the last transaction through before it core dumps.  You would have to set SQL trace at the database level so nothing else can be running on the base to get clean results.</pre>
</div>
<div title="Create DB checklist" creator="colm" modifier="colm" created="201205170821" changecount="1">
<pre>!!!Database Installation Checklist
*Verify system requirements
**Check memory, swap and temp space
**Verify OS version and patch levels
**Verify package requirements
**Verify kernel parameters
*Pre-installation Setup
**Verify/add Oracle and database mount points
**Create Oracle groups
**Create Oracle user account
**Set Oracle user environment
*Oracle user configuration
**Create OFA compliant ORACLE_BASE directory structure
**Configure ASM libraries if using ASM
**Create OFA compliant database file directories if using file systems
*Install Oracle server software
**If using CRS and/or ASM then create a separate CRS and/or ASM ORACLE_HOME first. Two ORACLE_HOME installations will be made with this configuration.
**Install any Oracle server patch sets.
**Install latest appropriate OPatch version.
**Install any Oracle server security patches.
**Install any Oracle server security patches (i.e. Critical Patch Updates).
**Install Daylight Savings Time patches if not incorporated in the patchset.
**Verify ORACLE_HOME/jdk Java DST and patch if necessary.
*Oracle Database Creation
**If using ASM then create ASM instance first.
**Create the target Oracle database.
**Apply any server security patches.
*Oracle Database Post-Creation Tasks
**Verify external password file
**Configure init.ora parameters
**Convert to spfile (optional)
**Move spfile to $ORACLE_BASE/admin/$ORACLE_SID/pfile (optional)
**Clean up the oratab file
**Grant SYSDBA to system
**Verify the database global name
**Verify database accounts for locked and expired status, verify passwords for unlocked accounts.
**Generate system statistics (minimally create &quot;NOWORKLOAD&quot; stats).
**Linux Specifics:
** 	For 32-bit installations add VLM changes if needed
** 	Modify memory to accommodate Huge Pages
** 	Relink Oracle and enable asynchronous I/O support (optional)
** 	Enable direct I/O support (optional)
**Optional tasks:
****Verify JVM Daylight Savings Time post-installation tasks.
****Change SYSTEM default tablespace to TOOLS or SYSAUX
****Verify the MAXSIZE setting for all tablespaces
****Verify that the SQL*Plus script pubbld.sql has been run and run the plustrce.sql script from the $ORACLE_HOME/sqlplus/admin directory
****Run $ORACLE_HOME/install/changePerm.sh to relax permissions on some files for client access
****Create a system plan_table by running the following as SYSTEM:
NOTE: In 10g catplan.sql will create a public global temporary plan table so these steps are unnecessary!
{{{
@?/rdbms/admin/utlxplan.sql
CREATE PUBLIC SYNONYM plan_table FOR system.plan_table;
GRANT SELECT, INSERT, DELETE ON plan_table TO public;
}}}
**Generate schema level statistics (optional)
**Create custom roles (i.e. data_owner)
*Network Configuration
**Verify sqlnet.ora, tnsnames.ora and listener.ora configuration files exist (or their links) in $ORACLE_HOME/network/admin
**Verify parameters and log file locations
**Configure each database explicitly in the listener.ora file (recommended)
**Password protect the listener (recommended)
**Configure IPC local database connections (optional)
**Move sqlnet.ora and tnsnames.ora files to $ORACLE_BASE/admin/snet/admin directory and create links in each $ORACLE_HOME/network/admin directory
*Utility Setup
**Create $ORACLE_BASE/local directory and create &quot;log&quot; and &quot;script&quot; subdirectories
**Set up dbcontrol and orasetup utilities
**Set up dbora utility and follow script directions to install in /etc/init.d
**Optionally add:
** 	Backup utility (e.g. bkctrl)
** 	logdelete utility
** 	chkdberr utility
** 	SYSMON utility
** 	SPACEMON utility
**Create crontab entries for any installed utilities
 </pre>
</div>
<div title="Custom short migration - 2.2" creator="colm" modifier="colm" created="201202211612" changecount="1">
<pre>From the 2.2.54 release notes on going to Oracle 10g. Mechanism should be good for other versions though.

* Create a text file called javaupgrade.txt in the schema/migration/scripts directory of the Infinys Rating and Billing 10g compatible release. This text file must contain the following line only:
{{{
Q2_java.sh
}}}
* Run the schema/migration/migration.sh file in the Infinys Rating and Billing 10g compatible release using the name of the text file as a parameter:
{{{
migration.sh javaupgrade.txt
}}}</pre>
</div>
<div title="DB Time" creator="colm" modifier="colm" created="201205090950" changecount="1">
<pre>&quot;For purposes of this thread it is sufficient to know that 'DB time' fully contains 'DB CPU' and that both are measured values (which means in particular that 'DB CPU' is not inflated by runq time)

'sql execute elapsed time' is fully contained in 'DB time' as well, but there is an unknown intersection between this and 'DB CPU'.&quot;

From: http://docs.oracle.com/cd/E11882_01/server.112/e25513/dynviews_3015.htm#REFRN30340
{{{
1) background elapsed time
    2) background cpu time
          3) RMAN cpu time (backup/restore)
1) DB time
    2) DB CPU
    2) connection management call elapsed time
    2) sequence load elapsed time
    2) sql execute elapsed time
    2) parse time elapsed
          3) hard parse elapsed time
                4) hard parse (sharing criteria) elapsed time
                    5) hard parse (bind mismatch) elapsed time
          3) failed parse elapsed time
                4) failed parse (out of shared memory) elapsed time
    2) PL/SQL execution elapsed time
    2) inbound PL/SQL rpc elapsed time
    2) PL/SQL compilation elapsed time
    2) Java execution elapsed time
    2) repeated bind elapsed time
}}}
The relationship between a parent and a child in the tree indicates containment only. Keep the following in mind with regard to the tree:
*    Children do not necessarily add up to the parent.
*   Children are not necessarily exclusive (that is, it is possible that they overlap).
*    The union of children does not necessarily cover the whole of the parent.</pre>
</div>
<div title="DBA and SYSDBA" modifier="colm" created="200911121058" modified="201011191151" changecount="5">
<pre>In short, SYSDBA is a system privilege whereas DBA is a role.

The DBA role does not include the SYSDBA or SYSOPER system privileges. SYSDBA and SYSOPER are special administrative privileges that allow an administrator to perform basic database administration tasks, such as creating the database, instance startup and shutdown, drop a database, open and mount a database, place database in archivelog mode or remove it from archivelog mode.

!!!SYSDBA system privilege

The SYSDBA and SYSOPER system privileges allow access to a database instance even when the database is not open. Control of these privileges is totally outside of the database itself. The SYSDBA and SYSOPER privileges can also be thought of as types of connections that enable you to perform certain database operations for which privileges cannot be granted in any other fashion. For example, if you have the SYSDBA privilege, you can connect to the database by specifying CONNECT AS SYSDBA.

!!!DBA Role

A predefined role, named &quot;DBA&quot;, is automatically created with every Oracle database. This role contains all database system privileges but SYSDBA and SYSOPER are excluded. Therefore, it is very powerful and should be granted only to fully functional database administrators.

Additionally, you may not grant SYSDBA privilege to a role. ORA-01931 error is raised when you try to grant it to a role.

A database user can be granted both DBA and SYSDBA privilege.

!!!SYS and SYSTEM From AskTom

SYS is like root for us. It holds the data dictionary, it is special (it physically works differently from other accounts - no flashback query for it, no read only transactions, no triggers, etc)

SYSTEM is our DBA account, it is just a normal user, subject to normal rules - but it is OUR account nonetheless. It holds non-mandatory things - extras if you will.</pre>
</div>
<div title="DBA_HIST_SQLSTAT" creator="colm" modifier="colm" created="201205101113" changecount="1">
<pre>from How To Interpret DBA_HIST_SQLSTAT [ID 471053.1]    
   
Q. When does ELAPSED_TIME_TOTAL and ELAPSED_TIME_DELTA or EXECUTIONS_TOTAL and EXECUTIONS_DELTA would be equal ?
A. ELAPSED_TIME_TOTAL &amp; ELAPSED_TIME_DELTA will be equal when the the instance restarts or cursor is flushed out of shared pool and reloaded back.

Q. When does EXECUTIONS_TOTAL and EXECUTIONS_DELTA would be zero and other fields are populated with non-zero values ?
A. This happens when AWR snapshot is taken during the execution of the query &amp; the snapshot ends before the query ends.

Q. BUFFER_GETS_TOTAL or DISK_READS_TOTAL would be increased during partial executions or when the query ends due to any error.
A. Yes these fields are incremented.

Q. How does END_OF_FETCH_COUNT_TOTAL or END_OF_FETCH_COUNT_DELTA changed when query throws any errors.
A. The value of this statistic is not incremented when the cursor is partially executed, either because it failed during the execution or because only the first few rows produced by this cursor are fetched before the cursor is closed or re-executed

Q. How does failed executions effects EXECUTIONS_TOTAL or BUFFER_GETS_TOTAL or any other columns.
A. These columns are incremented as usual. Even though the query fails with error EXECUTIONS_TOTAL is incremented to 1 and the BUFFER_GETS_TOTAL is incremented to a value of buffer gets the query has done before throwing any error. In this case END_OF_FETCH_COUNT_TOTAL is not incremented. </pre>
</div>
<div title="DBMS_METADATA" creator="colm" modifier="colm" created="201202071608" modified="201207231409" changecount="3">
<pre>!!! Table creation
{{{
SET LONG 9999
SELECT DBMS_METADATA.GET_DDL('TABLE','DUPLICATECHECK1') from dual;
SELECT DBMS_METADATA.GET_DEPENDENT_DDL('INDEX','DUPLICATECHECK1','GENEVA_ADMIN') FROM DUAL;
SELECT DBMS_METADATA.GET_DEPENDENT_DDL('OBJECT_GRANT','DUPLICATECHECK1','GENEVA_ADMIN') FROM DUAL;
SELECT DBMS_METADATA.GET_DEPENDENT_DDL('SYNONYM','DUPLICATECHECK1','GENEVA_ADMIN') FROM DUAL;
SELECT DBMS_METADATA.GET_DEPENDENT_DDL('PUBLIC_SYNONYM','DUPLICATECHECK1','GENEVA_ADMIN') FROM DUAL;
}}}

!!!Extract DDL to script
{{{
set newpage NONE space 0 lines 200 pages 0 echo off feed off verify off heading off trimspool on
SET LONG 9999
execute DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SQLTERMINATOR',true);
execute DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'CONSTRAINTS_AS_ALTER',true);
spool ddldump.sql
SELECT DBMS_METADATA.GET_DDL('PACKAGE','CVG_CAM_UTIL','GENEVA_ADMIN') FROM dual;
spool off
}}}

!!!Wrap SQL
{{{
wrap iname=cvg_cam_util.pkg
}}}</pre>
</div>
<div title="DCM" creator="colm" modifier="YourName" created="201109151309" modified="201110060932" changecount="2">
<pre>* DELETE_DAT is based upon //rating// date - DC table chosen to insert the event is based upon //EVENT_DTM// (necessarily)

Retention intervals - used to set DELETE_DAT:
{{{
select et.event_type_name, ft.file_type_name, fst.file_subtype_name, efe.keep_for_days_num, fst.file_subtype_desc
from eventfileevents efe
    join eventtype et on et.event_type_id = efe.event_type_id
    join filetype ft on ft.file_type_id = efe.file_type_id
    join filesubtype fst on fst.file_subtype = efe.file_subtype and fst.file_type_id=efe.file_type_id;
}}}

The Real-time Duplicate Check Maintainer uses the following information to determine which DUPLICATECHECK[N] table event information is deleted from:
•	Today's date. 
•	The RTDPmodificationDays system parameter. 
•	The RTDPnumberOfDupTables system parameter. 
•	The argument -eventAge. 
The calculation is as follows:
{{{
N = [(day_number(date) + modDays - eventAge) mod numTables] + 1 
}}}
where:
•	N is the table number (between 1 and 30). 
•	day_number(date) is the number of days between date and 1/1/1970. For example, day_number (1/1/2001) is 11323. 
•	modDays is the value of RTDPmodificationDays. 
The ~RTDPmodificationDays system parameter is used when the number of DUPLICATECHECK[N] tables is changed. This system parameter usually has a value of 0 (zero) and, as a result, has no effect on the calculation. For more information on the RTDPmodificationDays system parameter, refer to Infinys Rating and Billing Event and Rating Concepts. 
•	eventAge is the value of the argument -eventAge. 
•	numTables is the value of RTDPnumberOfDupTables. 
•	mod represents the mathematical function modulus. 
For example, if the system has a total of 5 tables, RTDPmodificationDays has the value 0, the date is 1/1/2001, and the command line argument -eventAge 2 is specified, the calculation is:
N = ((11323 + 0 - 2) mod 5) + 1 = 2 
Therefore entries are deleted from the DUPLICATECHECK2 table. 

!!!GPARAMS:
•	~RTDPmodificationDays 
Specifies the modification days to change which table an event with a specific event date is inserted.
Mandatory if using the real-time duplicate prevention functionality.
•	~RTDPnumberOfDupTables 
Specifies the number of tables that have been installed to hold the event data (maximum of 30).
Mandatory if using real-time duplicate prevention functionality
•	~DCMdeleteBatchSize 
Determines the commit size used by the Real-time Duplicate Check Maintainer, that is, how many records are deleted at once.
The minimum value is 1 and the maximum value is 32767.
The default value is 5000.

!!!Schema:
EVENTFILEEVENTS.keep_for_days_num
Specifies the number of days before an event may be deleted by the Real Time Duplicate Prevention Maintainer. Null implies that the events for this file_type_id, file_sub_type and event_type_id are not duplicate checked.

At RTDP Insertion time, date is calc'd:
{{{
N = [(day_number(event date) + modDays) mod numTables] + 1
}}}
where:
- N is the table number.
- day_number(event date) is the number of days between the event date and 1/1/1970.
For example, day_number (1/1/2001) is 11323.
- modDays is the value of RTDPmodificationDays.
- numTables is the value of RTDPnumberOfDupTables.
- mod represents the mathematical function modulus.

For example, if the system has a total of five tables and RTDPmodificationDays has the
value 1, an event with event date 1/1/2001 will be associated with the 
DUPLICATECHECK5 table, since ((11323 + 1) mod 5) + 1 = 5.


Epoch day 
{{{
echo $(($(date +%s)/$((60*60*24))))
}}}
e.g. 12 Sept 2011: 15229

Setup
-------------------------------------------------------------------------------
[x] Check gparam RATEfilterPlugInPath - RTDP.so
[x] Check gparam RTDPnumberOfDupTables - 30
[x] Check gparam RTDPmodificationDays - 0 
	Only needed for changing the number of Dup Tables
	
* LATE EVENTs  might have a DELETE_DAT that is later than that picked up by DCM when truncating

Worked Example - today 12th Spet - epoch day 15229.
With RTDP table sset to 30, RATE for events received today will insert to:
N=(15229 + 0) mod 30 +1 = DUPLICATECHECK20

Running DCM with eventAge 29 will truncate:
(15229 + 0 - 29) mod 30 + 1 = DUPLICATECHECK21

28: DUPLICATECHECK22
...
1: DUPLICATECHECK19</pre>
</div>
<div title="DConfigAgent notes" creator="colm" modifier="YourName" created="201103311050" modified="201402101554" changecount="3">
<pre>We had trouble using the IP address instead of hostname as well. I do see #51217 about this as well. Technically it must be nodename, which usually matches hostname. Ages ago had issue with nodename &gt; 8 characters on HP-UX.
You obviously can’t share ports on same box nor can you share memory (shmkey/semkey ?) values on a box across DCAs for different environments.
As Russell said, suggest you retry and make sure of the following:
-	kill pids
-	check memory to make sure free (use ipcrm to cleanup)
-	use settrace (100) to turn on trace
-	make sure your config is loaded via -d option
-	make sure DCA is running via -Q

</pre>
</div>
<div title="DMT/LMT versus ASSM/MSSM" modifier="YourName" created="201002251212" modified="201306181137" changecount="13">
<pre>!!!Tablespace Extent Management 
DMT using UET$ and FET$ versus LMT with ~BitMapped Extents - relates to ''EXTENTS IN THE TABLESPACE''. LMT allocates a chunk of 64KB in the header of each datafile to store the ~BitMaps.

* Set LMT with EXTENT MANAGEMENT LOCAL when creating a tablespace. 
* Shown as ~EXTENT_MANAGEMENT in ~DBA_TABLESPACES.

NB - ~ALLOCATION_TYPE shows whether size is fixed as uniform size at tbs-level or auto-allocate when Oracle assigns 64 Kb, 1 Mb, 8 Mb, and 64 Mb. ~NEXT_EXTENT will be NULL for AUTOALLOCATE and will show size for UNIFORM type. Type 'USER' normally implies a DMT converted to an LMT.

!!!Segment Space Management 
MSSM with FreeLists in the Segment Header versus ASSM with ~BitMapped Blocks - relates to ''FREE BLOCKS IN THE SEGMENT''.

* Set ASSM with SEGMENT SPACE MANAGEMENT AUTO for the tspace.
* Shown as ~SEGMENT_SPACE_MANAGEMENT in ~DBA_TABLESPACES.

Use of ASSM implies that PCTUSED, FREELISTS, and FREELISTS GROUPS storage parameters for schema objects are no longer needed.

!!!!The above are two different things. Although you cannot have ASSM in DMT. You can have either of ASSM or MSSM in LMT. </pre>
</div>
<div title="DUM Notes" modifier="colm" created="201004211422" modified="201109070905" changecount="11">
<pre>!!General notes
Discount processing split into:
''STANDARD EXTENSION'' phase : this is the creation of CPDU records into the future as dictated by DUMadvancedExtensionDays .
''ACTION'' phase: creates and modifies CUSTPRODRATINGDISCOUNT records, their corresponding buckets (~CPDUs), and the related CUSTPRODINVOICEDISCUSAGE records

In Daemon mode, DUM is driven by CPDUMRs and the scope is at the specific product instance level - only ACTION work is ever done by DDUM. Batch DUM does both phases and is driven by non-null DUADs and then lookups to CUSTPRODUCTDETAILS  - work is then doine at the nuch less efficient account level.

!!DUM post-3.0

Clients *must* run ~DUMcat after cat publish
- restart DUM
- resart/resignal RATE
- driven from CATDISCOUNTCHANGES

Dameon DUM *requires* ~CPDUMRs
- i.e. ~SYSuseCPDUManageRequestBoo must be set to true.
- check ~RATEprocessManageRequestScope?

DUADS
- still set at account creation?
- sometimes by ~DUMcat (it might also generate ~CPDUMRs)?
	
5.0 System Procs - DUM - 
&quot;DUM Catalog. This variant updates discount information associated with a new catalog. If you are not running in daemon mode it must be run whenever a new catalog is published&quot;

This is not really true - DUM cat is *mandatory*. Note also that all modes can be run in daemon mode e.g. the -mode parameter explicitly decides the DUM mode and the options are normal|product|catalog|extension. Earlier running DUM with -d option is used for processing ~CPDUMRs whereas now we need to specify -mode as 'product' to achieve the same i.e. 
{{{
DUM -d 1000 -a &quot;-mode product&quot;. 
}}}
Likewise now it is also possible to run Daemon DUM in catlog mode incase of RTCC solution i.e. DUM -d 1000 -a &quot;-mode catalog -driver product&quot;

!!Keep periods
Using keep periods not only reduces the amount of redo generated (since records are being zeroed and reused) but also total storage since it is no longer necessary to build records out into the future to meet the advanced action days requirement.

5.0 changes
The Process Plans for DUM in Daemon and Batch mode need updated to include the –mode parameter.
{{{
-- Add -mode flag for running DUM in mode other than catalogue change
/*SELECT pp.process_def_id, pp.plan_number, pp.start_dat, pp.process_plan_name, pp.process_plan_desc, pp.parameters, pp.daemon_boo, DECODE (pp.daemon_boo, 'T', '-mode product', 'F', '-mode extension')
FROM processplan pp*/

UPDATE processplan pp 
SET pp.parameters = DECODE (pp.daemon_boo, 
'T', '-mode product',
 		'F', '-mode extension')
WHERE pp.process_def_id = 36 -- normal DUM 
AND pp.parameters IS NULL;

UPDATE processplan pp SET pp.parameters = '-mode catalog'
 WHERE pp.process_def_id = 1520 -- catalog change mode DUM
   and pp.daemon_boo = 'F'
   AND pp.parameters IS NULL;   
}}}</pre>
</div>
<div title="Datapump" creator="colm" modifier="colm" created="201106290758" modified="201106290801" changecount="3">
<pre>Will default to using ~DATA_PUMP_DIR
{{{
CREATE DIRECTORY DATA_PUMP_DIR AS '/usr/app/RBM/share/harlsit3/dp';
GRANT READ, WRITE ON DIRECTORY DATA_PUMP_DIR TO GENEVA_ADMIN;
}}}
!!!Example parfiles for code export/import
Export:
{{{
FULL=N
SCHEMAS=GENEVA_ADMIN
CONTENT=METADATA_ONLY
DUMPFILE=HARL2-CODE.dmp
LOGFILE=HARL3-imp-CODE-28JUN11.log
EXCLUDE=VIEW,TABLE
STATUS=60
}}}
Import:
{{{
FULL=N
SCHEMAS=GENEVA_ADMIN
CONTENT=METADATA_ONLY
DUMPFILE=HARL2-CODE.dmp
LOGFILE=HARL3-imp-CODE-28JUN11.log
STATUS=60
}}}
!!!Export types
{{{
OBJECT_PATH                    COMMENTS
------------------------------ ------------------------------------------------------------------------------------------------------------------------
ALTER_FUNCTION                 Recompile functions
ALTER_PACKAGE_SPEC             Recompile package specifications
ALTER_PROCEDURE                Recompile procedures
ASSOCIATION                    Statistics type associations
AUDIT_OBJ                      Object audits on the selected tables
CLUSTER                        Clusters in the selected schemas and their indexes
COMMENT                        Table and column comments on the selected tables
CONSTRAINT                     Constraints (including referential constraints)
DB_LINK                        Private database links in the selected schemas
DEFAULT_ROLE                   Default roles granted to users associated with the selected schemas
DIMENSION                      Dimensions in the selected schemas
FGA_POLICY                     Fine-grained auditing policies
FGA_POLICY                     Fine-grained auditing policies
FUNCTION                       Functions and their dependent grants and audits
GRANT                          Object grants on the selected tables
INDEX                          Indexes
INDEXTYPE                      Indextypes and their dependent grants and audits
INSTANCE_CALLOUT               Instance callouts
JAVA_CLASS                     Java classes and their dependent grants and audits
JAVA_RESOURCE                  Java resources and their dependent grants and audits
JAVA_SOURCE                    Java sources and their dependent grants and audits
JOB                            Jobs in the selected schemas
LIBRARY                        External procedure libraries in the selected schemas and their dependent grants and audits
MATERIALIZED_VIEW              Materialized views
MATERIALIZED_VIEW_LOG          Materialized view logs
OBJECT_GRANT                   Object grants on the selected tables
OPERATOR                       Operators and their dependent grants and audits
PACKAGE                        Packages (both specification and body) and their dependent grants and audits
PACKAGE_BODY                   Package bodies
PACKAGE_SPEC                   Package specifications
PASSWORD_HISTORY               The password history for users associated with the selected schemas
POST_SCHEMA                    Post-schema procedural actions and objects and their dependent grants and audits
POST_TABLE_ACTION              Post-table actions
PRE_SCHEMA                     Pre-schema procedural actions and objects in the selected schemas and their dependent grants and audits
PRE_TABLE_ACTION               Pre-table actions
PROCACT_INSTANCE               Instance procedural actions
PROCACT_SCHEMA                 Schema procedural actions in the selected schemas
PROCDEPOBJ                     Instance procedural objects
PROCDEPOBJ_AUDIT               Audits on instance procedural objects
PROCDEPOBJ_GRANT               Grants on instance procedural objects
PROCEDURE                      Procedures and their dependent grants and audits
PROCOBJ                        Procedural objects in the selected schemas
PROCOBJ_AUDIT                  Schema procedural object audits in the selected schemas
PROCOBJ_GRANT                  Schema procedural object grants in the selected schemas
REFRESH_GROUP                  Refresh groups in the selected schemas
REF_CONSTRAINT                 Referential constraints
RLS_CONTEXT                    Fine-grained access control contexts
RLS_CONTEXT                    Fine-grained access control contexts
RLS_GROUP                      Fine-grained access control policy groups
RLS_GROUP                      Fine-grained access control policy groups
RLS_POLICY                     Fine-grained access control policies
RLS_POLICY                     Fine-grained access control policies
ROLE_GRANT                     Role grants to users associated with the selected schemas
SCHEMA_CALLOUT                 Schema callouts in the selected schemas
SEQUENCE                       Sequences in the selected schemas and their dependent grants and audits
STATISTICS                     Precomputed statistics
SYNONYM                        Private synonyms in the selected schemas
SYSTEM_GRANT                   System privileges granted to users associated with the selected schemas
TABLE                          Tables in the selected schemas and their dependent objects
TABLESPACE_QUOTA               Tablespace quotas granted to users associated with the selected schemas
TRIGGER                        Triggers
TYPE                           Types (both specification and body) and their dependent grants and audits
TYPE_BODY                      Type bodies
TYPE_SPEC                      Type specifications
USER                           User definitions for users associated with the selected schemas
VIEW                           Views and their dependent objects
XMLSCHEMA                      XMLSCHEMAS
}}}</pre>
</div>
<div title="Disable auto startup tasks" creator="colm" modifier="colm" created="201206200925" changecount="1">
<pre>{{{
update task t 
set t.task_desc='Was auto-run at TM startup - disabled CAM - 20JUN2012'
where t.run_at_startup_boo='T';

update task t 
set t.run_at_startup_boo='F'
where t.run_at_startup_boo='T';
}}}</pre>
</div>
<div title="Drop queues" creator="colm" modifier="colm" created="201108172125" modified="201207251404" changecount="2">
<pre>{{{
exec dbms_aqadm.unschedule_propagation('GENEVA_ADMIN.HYBRIDCUSTDATASYNCQUEUE', NULL);
exec dbms_aqadm.stop_queue(queue_name =&gt; 'GENEVA_ADMIN.HYBRIDCUSTDATASYNCQUEUE');
exec dbms_aqadm.drop_queue(queue_name =&gt; 'GENEVA_ADMIN.HYBRIDCUSTDATASYNCQUEUE');
exec dbms_aqadm.drop_queue_table(queue_table =&gt; 'GENEVA_ADMIN.HYBRIDCUSTDATASYNCQUEUE', force =&gt; TRUE);
}}}
Sometimes, the followin gcan help - followed by dropping the remaining tables:
{{{
alter session set events '10851 trace name context forever, level 2';
}}}</pre>
</div>
<div title="Duplicate Check Attributes" creator="YourName" modifier="colm" created="201110040842" modified="201206121303" changecount="5">
<pre>RATE/RTDP use eventfileeventattribute:
{{{
select efea.attr_name 
from eventfileeventattribute efea
where efea.attr_dup_check_boo='T';
}}}
BG/DEi/DER use eventtypeattribute on a input file/event type combination basis:
{{{
select eta.event_type_id, count(*)
from eventtypeattribute eta
where eta.attr_dup_check_boo='T'
group by eta.event_type_id;

select eta.event_type_id, et.event_type_name, eta.attr_name, eta.attr_dup_check_boo
from eventtypeattribute eta
    join eventtype et on et.event_type_id=eta.event_type_id
where eta.attr_dup_check_boo='T'
and eta.event_type_id=512;
}}}

Also note: DEI will assume events as duplicates when (from the 2.2 System Processes docs):
•	The account numbers are identical. 
•	The event sources are identical. 
•	The event type IDs are identical. 
•	The cost centre IDs are identical. 
•	The event dates and event times are identical. 
•	The tax override IDs are identical. 
•	All attributes configured for duplicate checking are identical

DER will do the following (from the 2.2 System Processes docs):
 
- Removes the duplicate events listed from the COSTEDEVENT table. 
- Removes the entries from the DUPLICATEEVENT table. 
- Updates the revenue assurance totals. 
- Updates the discount usage totals in the CUSTPRODUCTDISCOUNTUSAGE table (and any child entries in the CUSTPRODINVOICEDISCUSAGE table) where necessary.
- Updates the EVENTSOURCEUSAGE table, if SYScollectEventSourceUsageBoo is set to T (true). 
- Writes an audit record to DUPLICATEEVENTAUDIT. 
- Sets the billing status of the account to either OK (if the billing status was DM) or RR (if the billing status was RM).    
 
//Thresholds crossed as a result of using the Duplicate Event Remover trigger actions, if they are configured. Removing duplicate events using the Duplicate Event Remover may cause a threshold to be crossed in the opposite direction than originally specified. A threshold crossed in this way causes an action to be triggered. //</pre>
</div>
<div title="Duplicate Prevention" modifier="colm" created="200907160827" modified="201201301048" tags="Geneva RTDP" changecount="9">
<pre>!!!RTDP
*Typical impact ~5%
Enable with the ~RATEfilterPlugInPath GPARAMS entry. If this parameter is not present then RTDP wil not be used. In order to use RTFP.so plug-in the number of duplicate check tables required must be defined using the ~RTDPnumberOfDupTables GPARAMS entry. 

Note, running RATE with the REIP plugin does //not// do duplicate checking.

A good mail trail on this:
The duplicate check tables look like this...

EVENT_DTM		DATE not null,
HASHED_EVENT	RAW(10) not null,
DELETE_DAT		DATE not null

Assuming all events are rated on the day they were made (and I know this will never happen) you are correct in saying that on the 31st day it will cycle round and use the same table again.  The table is chosen on the event_dtm of the event so all events rated on day X will probably hit a number of tables - mostly X but sum in X-1, X-2 etc. depending on the &quot;age&quot; of the event when its presented to IRB.  The delete_dat however is set to the system date plus whatever is held on the event type as the number of duplicate check days.

I think the reason for having separate tables is to make the maintenance easy - there is a truncate option and therefore is you only duplicate check over 20 days all events from one table will be now old and therefore you can just truncate it (as opposed to deleting the records).

If you go more than 30 days then the truncate option is not usable (assume keep for 60 days)...

{{{
Day:	1 (X)                                                    30 (X+30)     31 (X+31)                                                       60 (X+60)     61 (X+61)                                                    90 (X+90)     91 (X+91)
	+---------------------------------------------+------------------+----------------------------------------------------+--------------+--------------------D--------------------------------+-------------------+
Table:	1                                                           30                        1                                                                    30                  1                                                                      30                       1
Delete:	X+60                                                   X+90                 X+91                                                               X+120       X+121                                                               X+150             X+151
}}}
So in table 1  at date D you get...

Event Dtm	Delete
X		X + 60
X + 30		X + 90
X + 60		X + 120

So you need to wait until after X+60 because you don't want RATE inserting and maintainer deleting from the same table.  When you run delete on day D (X + 65 ) for table 1 the only records that have a delete date before the system date are those with a delete date of X+60.  Therefore 1/3 of the table is going to be deleted.

From what you are saying they are not running the deleter as often as they should so we're probably in the same situation on 5.3 as we will be on 3.0.  They should really be running the deleter on a daily basis.  So on day X+66 they should be deleting records from table 2 etc.

If there were more tables then a similar thing would happen its just that the data in table 1 would only hold data from event date X and therefore the truncate option could be used.

George,  is this enough to document to Vodacom??

Julian


Julian Fontana
Solutions Implementation

Direct  : +44 (0) 131 200 5489
Mobile : +44 (0) 7930 605 215
mailto:julian.fontana@convergys.com
-------------------------------------------------------------------------
Convergys EMEA Ltd   http://www.convergys.com
4 Lochside View, Edinburgh Park,Edinburgh EH12 9DH, UK


Colm A McCartan/CIMG/CVG 
06/12/2007 18:35	
To
George Douglas/EMEA/CVG@CVG, Julian Fontana/EMEA/CVG@CVG
cc

Subject
Fw: PSG QandA Real-Time Duplicate Prevention process
(forwarded below is the mail I was talking to you about George). 

When you first mentioned the 60-day RTDP question, this reminded me of a question I have had at the back of my mind for a while - in the absence of housekeeping, RATE will presumably roll around to inserting data on the 31st day into the same table as data rated on the 1st. If you run DCM with a delete-older-than-60-days rule, won't this effectively use 30 tables to store 60 days' worth of RTDP data? Since, AFAIK, the insert-and-wait-for-PK-violation check doesn't give a monkeys what day the event originally came from. 

Questions:

- is there anything fundamentally faulty with this theory?
- how much does it slow RATE and DCM down to operate on a 'double-size' table? This is a pretty arbitrary question anyway, since some clients will RATE four times in one day what another will. So the question is really how much will it slow down VDC's ops?
- I have a feeling VDC neglected to run DCM for a while... they may have had a couple of months of stuff in their RTDP tables - does this ring a bell with either of you? I suppose details would be in a Site Visit Report somewhere...
- is this approach supported!?

Pursuing the logic of this approach, why bother having a table-per-day - this is entirely arbitrary also. Shouldn't it just be a big daily-partitioned table with num partitions=num of days I want to duplicate check?

	Mirijam Marx
	14/03/06 05:29 AM	
		 To: Gustavo Espoille/CIMG/CVG@CVG
		 cc: PSG QandA@CVG
		 Subject: Re: PSG QandA Real-Time Duplicate Prevention process

Hi Gustavo,

the number of days that events are kept in the DUPLICATECHECK tables for duplicate checking strongly depends on how much trust you put into your incoming data. For example, if you can be fairly sure that mediation won't be re-sending the files from today in 2 weeks, you should be safe enough to have a duplicate retention time of a few days. If you can't trust the incoming data accordingly, you should plan for more days (as far as I am aware the maximum that can be configured is 30 days). 

There is a difference between the days you can enter and the &quot;real&quot; time you retain the events. For example, if you configure for 30 days of duplicate checking:
 
 - your system will have 30 DUPLICATECHECK tables (DUPLICATECHECK_1, DUPLICATECHECK_2 etc.)
 - for each day, the events will be written in the according table (rated on day 1 = DUPLICATECHECK_1, rated on day 2 = DUPLICATECHECK_2 etc.), the &quot;circle&quot; will be re-started after &quot;reaching&quot; the last table
   -&gt; this means, if you have today day 31, you will be writing into the DUPLICATECHECK_1 table again and, if you haven't done housekeeping before (see below), you will have events from today and from 31 days ago in your DUPLICATECHECK_1 table. I am not sure if this actually enlongates the time period against which new incoming events are checked (because all entries in the DUPLICATECHECK tables are checked), or if the functionality acutally will ignore entries in the tables &gt; 30 days.

Two things to keep in mind when planning for the real-time duplicate checking :

 - you should plan for regular housekeeping for the duplicatecheck tables, otherwise you run into space problems on your database and also you may have performance impact. The more retention time you have, meaning the more DUPLICATECHECK tables you have, the longer this will take, because you have to do it table by table and, if I remember correctly, you have to consider exactly which entries to delete (Process is Duplicate Check Maintainer, DCM). Also it might be worth testing the performance of DCM on your system as part of the planning exercise.

 - if you decide to change your configuration in a running system, it is unfortunately a bit more complicated than you may think. At RTc, we started out with 30 days retention for duplicates (= 30 DUPLICATECHECK tables), and at some point considered going down to 5 tables. In theory, we knew how to do it, in practical life we never really got around realizing it. I attached below two possible approaches that I received at that point from Stuart Donald, both would still need to be tested and approved.

Extract from Stuart for reducing the number of days for duplicate checking in a running system:

&quot;
Using the DCM in truncate mode simply means that the whole of the table is truncated for the day x number of days in the past. There is no checking to see if the events have reached their delete by date. 

Whichever solution is used should be approved by another member of the team and tested. 

Solution A: 

The idea is to retain the tables used by duplicate check for the last 5 days of rated events -but move the data from the 30 day mode to fit the 5 day mode, without losing any checking for those last 5 days. 

1) Identify the tables for the last 5 days. The function can be calculated in Oracle like this (we do not have any modification days configured in gparams): 
&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; select mod(to_date('01-AUG-2005') - to_date('01-JAN-1970','DD-MON-YYYY'),30) + 1 from dual 
&amp;nbsp; &amp;nbsp; In this example the number of the table for events from the 1st August is returned. i.e. this returns number 7 for table duplicatecheck7. Repeat this to get the table numbers for the other 4 days required. 

2) Identify where the equivalent dates would be running under 5 day mode by changing the modulus to 5: 
&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; select mod(to_date('01-AUG-2005') - to_date('01-JAN-1970','DD-MON-YYYY'),5) + 1 from dual 
&amp;nbsp; Repeat for the other 4 days required 

3) Move the data from each of the tables identified for each date respectively from the one identified in 1) under 30 day mode to the one identified in 2) under 5 day mode. 

4) Swith the gparams from 30 day mode to 5 day mode 

Solution B: 

1) Wait until the tables fall into line naturally - the next occasion will be after the events have been rated for the 29th August 

2) &amp;nbsp;Swith the gparams from 30 day mode to 5 day mode before rating the events from the 30th. &quot;

!!! TAP and duplicate checking

The TAP3 duplicate data is stored in the TAP3IMPORTUNIQUEKEY and TAP3EXPORTUNIQUEKEY tables.  So the idea is the same as core but with different tables, so every time an event is imported or exported it is logged in these tables and a check is carried out on PK to see if the current event is a duplicate or not.  Fields stored in the tables are PLMN_CODE, EVENT_DAT and KEY_STRING (made up of a hash of unique elements from the event).  

You can turn duplicate checking on or off for all PLMNs for Import and/or Export via TAP3 Configuration UA (and also just turn it on and off for each individual PLMN), the details of this are stored on the TAP3PLMNINFORMATION table, along with the parameter for number of days of duplicate data to store.  I would say 30 should be plenty for this value (and the same as core RB which is based on the number of duplicatecheck tables configured).  Then you can use TDD in a specific mode to clear down the older duplicate data.</pre>
</div>
<div title="EVG" creator="colm" modifier="colm" created="201108031235" changecount="1">
<pre>The destination for output event files from EVG is controlled by the gparam EVGfileGroup.  If this gparam is not set which it is not in BTL31W22 then the default file group name of GENERATED_EVENTS will be used.  So for BTL31W22 EVG should write output files to /data/antillia/import (target directory of the GENERATED_EVENTS file group).  If this directory does not exist then the target directory file should be updated to provide a valid location.

{{{
EVG -a &quot;-allCustomers&quot;
}}}</pre>
</div>
<div title="Event Processing Groups" modifier="colm" created="200907161441" tags="geneva performance config" changecount="1">
<pre>See Events &amp; Rating Concepts. Check setup with:
{{{
select EVENTS_PER_DAY, count(*) from account group by EVENTS_PER_DAY;
select * from gparams where lower(name) like '%pergroup%';
}}}
Note if this is enabled that Account-level thresholds and actions will be disabled.</pre>
</div>
<div title="Expenses" creator="YourName" modifier="YourName" created="201308151424" modified="201401231454" changecount="6">
<pre>From guidelines docx:
* The total cost of food per day should not exceed £35.00 (EUR 40.00) per person.
* Preferred Edinburgh/Festival Cars Tel:  +44 131 552 1777
* Employees must submit receipts within 30 days. Any expenses submitted after 30 days will not be reimbursed.
* Detailed and original receipts for all expenditures are required and must be submitted to the designated Finance and Accounting department where the expense is reimbursed from. Employees should also keep a copy of their receipts and expense report submissions for their records. Photo copies and/or credit card statements are not an acceptable form of proof of expenditure. A written explanation must be provided if an original receipt cannot be obtained.

* Prep summary xls
* Scan all receipts - select Dn arrow to get folder destination, then hit 001 for share: {{{\\storage033ed\Scan\Users}}}
* Categorise each in Word doc
* Enter daily totals per category in TER
* send originals to Finance Cambourne - cover letter screenshot of TER claim 

</pre>
</div>
<div title="GENEVA_FIXEDDATE" creator="colm" modifier="colm" created="201106110020" modified="201107251803" changecount="2">
<pre>{{{
select * from gparams where name like '%SYSdate%';
update GPARAMS set name='SYSdateOverride' where name='##SYSdateOverride';
update GPARAMS set name='SYSdateValue' where name='##SYSdateValue';

update GPARAMS set name='##SYSdateOverride' where name='SYSdateOverride';
update GPARAMS set name='##SYSdateValue' where name='SYSdateValue';

UPDATE GPARAMS set string_value='20110303 120000'
where name='SYSdateValue';

export GENEVA_FIXEDDATE='20110303 12000000'
}}}</pre>
</div>
<div title="Generate a 10053 trace" creator="colm" modifier="colm" created="201301311217" modified="201301311218" changecount="2">
<pre>See - How to Obtain Tracing of Optimizer Computations (EVENT 10053) [ID 225598.1]
{{{
execute DBMS_SQLDIAG.DUMP_TRACE(p_sql_id=&gt;'5bh6wwp5b014b',  p_child_number=&gt;0, p_component=&gt;'Compiler', p_file_id=&gt;'ABCD');

select * from v$diag_info;

GENEVA_ADMIN@BTRETSI2&gt; select *  from v$diag_info;

   INST_ID NAME                                     VALUE
---------- ---------------------------------------- ----------------------------------------
         1 Diag Enabled                             TRUE
         1 ADR Base                                 /Disk0/app/oracle
         1 ADR Home                                 /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2

         1 Diag Trace                               /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/trace

         1 Diag Alert                               /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/alert

         1 Diag Incident                            /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/incident

         1 Diag Cdump                               /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/cdump

         1 Health Monitor                           /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/hm

         1 Default Trace File                       /Disk0/app/oracle/diag/rdbms/btretsi2/BT
                                                    RETSI2/trace/BTRETSI2_ora_7189_ABCD.trc

         1 Active Problem Count                     1
         1 Active Incident Count                    2

11 rows selected.

cdsora11 [BTRETSI2]/home/cdsora11&gt; ll /Disk0/app/oracle/diag/rdbms/btretsi2/BTRETSI2/trace/BTRETSI2_ora_7189_ABCD.trc
-rw-r----- 1 cdsora11 cdsdba 258940 Jan 31 12:05 /Disk0/app/oracle/diag/rdbms/btretsi2/BTRETSI2/trace/BTRETSI2_ora_7189_ABCD.trc
}}}</pre>
</div>
<div title="Geneva" modifier="colm" created="200907151521" changecount="1">
<pre>[[IRB3.0 Install checklist]]</pre>
</div>
<div title="HP-UX memory" modifier="YourName" created="201002111714" modified="201002251211" changecount="2">
<pre>A more severe indication of insufficient memory is swapping activity. To check swapping activity use the sar -w command. If bswot/s shows values that are consistently non-zero, this indicates that the system has a memory problem and is swapping. 

Similarly, if the swap queue shows activity, then there are processes being swapped out to make memory available. If the entries for swpq-sz and %swpocc when running sar -q remain blank then no processes are being swapped and memory is sufficient. If swpq-sz is greater than zero, then the system has experienced swapping, and there are runnable processes on swap. </pre>
</div>
<div title="Hard-coded sys user - Keith G's mail" creator="colm" modifier="colm" created="201204161536" modified="201204171447" changecount="2">
<pre>Fyi - the 5.1.? (and older) versions of RBIUH you can override the SYS password to be something other than SYS, but some of RBIUH has hardcoding for that value of the password. It didn’t stop my installs, so I’m assuming it didn’t hit that hardcoding. Also RBIUH has a lot more hardcoding of the id being “SYS” that password being “SYS”, which I thought RBIUH allows you to specify and DB id instead of SYS.

For example on 5.1.3 =
h/c password:
RB_IU_Common.ksh:            SessionCount=`($ORACLE_HOME/bin/sqlplus -s sys/sys@$cacheDB as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:                $ORACLE_HOME/bin/sqlplus -s sys/sys@$cacheDB as sysdba &lt;&lt;-EOF
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba 2&gt;&amp;1 &gt; /tmp/db_instance_${DB_TO_CLEAN}&lt;&lt;!!
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba 2&gt;&amp;1 &gt;&gt; $rbiuh_cleanup_log_name&lt;&lt;!!
rbiuh_cleanup.ksh:                sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba &lt;&lt;!!|tee -a $rbiuh_cleanup_log_name
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba &lt;&lt;!!|tee -a $rbiuh_cleanup_log_name
saverbdata:sqlplus -s &quot;sys/sys@${ORACLE_SID} as sysdba&quot; &lt;&lt;EOSQL &gt; workaround.log
saverbdata:    sqlplus -s &quot;sys/sys@${ORACLE_SID} as sysdba&quot; &lt; exu9tne.sql &gt; workaround.log

h/c id:
RB_IU_Cleanup.ksh:            if [[ &quot;`echo 'exit;' | ${Oracle_Home_Dir}/bin/sqlplus sys/${ORA_SYS_PWD}@${Two_Task} as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
RB_IU_Cleanup.ksh:        UNIF_USER_NUM=`(${Oracle_Home_Dir}/bin/sqlplus -s sys/${ORA_SYS_PWD}@${Two_Task} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:    if [[ &quot;`echo 'exit;' | ${ORACLE_HOME}/bin/sqlplus sys/${ORA_SYS_PWD}@$GLOBAL_NAME as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
RB_IU_Common.ksh:    if [[ &quot;`echo 'exit;' | ${ORACLE_HOME}/bin/sqlplus sys/${ORA_SYS_PWD}@$HOST_SID as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
RB_IU_Common.ksh:        if [[ &quot;`echo 'exit;' | ${ORACLE_HOME}/bin/sqlplus sys/${ORA_SYS_PWD}@$RAC_INSTANCE_NAME as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
RB_IU_Common.ksh:    $ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:    CF_DIR_TEMP=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:    $ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:    TS_USERS=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:        TS_USERS_STATUS=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:        TS_DATA=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:            TS_DATA_STATUS=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:            SessionCount=`($ORACLE_HOME/bin/sqlplus -s sys/sys@$cacheDB as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:                $ORACLE_HOME/bin/sqlplus -s sys/sys@$cacheDB as sysdba &lt;&lt;-EOF
RB_IU_Common.ksh:&quot; | ${ORACLE_HOME}/bin/sqlplus -s sys/${ORA_SYS_PWD}@$cacheDB as sysdba
RB_IU_Handler.ksh:            if [[ &quot;`echo 'exit;' | ${Oracle_Home_Dir}/bin/sqlplus sys/${ORA_SYS_PWD}@${Two_Task} as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
RB_IU_Handler.ksh:        UNIF_USER_NUM=`(${Oracle_Home_Dir}/bin/sqlplus -s sys/${ORA_SYS_PWD}@${Two_Task} as sysdba &lt;&lt;-EOF
RB_IU_Handler.ksh:    SessionCount=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD}@$TWO_TASK as sysdba &lt;&lt;-EOF
RB_IU_Handler.ksh:        $ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD}@$TWO_TASK as sysdba &lt;&lt;-EOF
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba 2&gt;&amp;1 &gt; /tmp/db_instance_${DB_TO_CLEAN}&lt;&lt;!!
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba 2&gt;&amp;1 &gt;&gt; $rbiuh_cleanup_log_name&lt;&lt;!!
rbiuh_cleanup.ksh:                sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba &lt;&lt;!!|tee -a $rbiuh_cleanup_log_name
rbiuh_cleanup.ksh:        sqlplus -s sys/sys@${DB_TO_CLEAN} as sysdba &lt;&lt;!!|tee -a $rbiuh_cleanup_log_name
RBSanityTest.ksh:    CUST_REF=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    ACCT_NUM=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    PROD_ID_CUST=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    PROD_ID_PROD=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    TARIFF_ID_CUST=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    TARIFF_ID_TARIFF=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    RATING_TARIFF_ID_CUST=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    RATING_TARIFF_ID_RATINGTARIFF=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    EVENT_SOURCE=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    EVENT_TYPE_ID_CUST=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
RBSanityTest.ksh:    EVENT_TYPE_ID_EVENTTYPE=`($ORACLE_HOME/bin/sqlplus -s sys/${ORA_SYS_PWD} as sysdba &lt;&lt;-EOF
saverbdata:sqlplus -s &quot;sys/sys@${ORACLE_SID} as sysdba&quot; &lt;&lt;EOSQL &gt; workaround.log
saverbdata:    sqlplus -s &quot;sys/sys@${ORACLE_SID} as sysdba&quot; &lt; exu9tne.sql &gt; workaround.log</pre>
</div>
<div title="ICOPARAMS" modifier="YourName" created="200911112102" changecount="1">
<pre>Invoicing Company Parameters rb_config_3_0
-----------------------------------------------------------------------
A system parameter applies its functionality to the entire Infinys Rating and Billing system.
An invoicing company parameter applies its functionality to an invoicing company only.
Invoicing company parameters are available only for a subset of the existing system
parameters. When an invoicing company parameter is specified, the equivalent system
parameter is overridden for that invoicing company. If no invoicing company parameter is
specified, then the equivalent system parameter is used.
Invoicing company parameters are configured in the ICOPARAMS table. This table must
be edited manually to enter the required invoicing company parameters and the invoicing
company associated with it.

You can view the system parameters that can have invoicing company
parameters by referring to the Infinys Rating and Billing System Parameters
interactive and listing all system parameters with a scope of “system and
invoicing company.”</pre>
</div>
<div title="IRB3.0 Install checklist" modifier="colm" created="200907151522" modified="200908110803" changecount="2">
<pre>{{{
mkdir tmp
mkdir stage
mkdir deploy
mkdir logs
mkdir dbascripts

[ ]  unzip UTILITIES, dbscripts, populate infinys.env
[ ]  make sure component zips correctly named

Prereqs:
[ ]  Oracle components?

select comp_id, version, status from dba_registry;

COMP_ID                        VERSION                        STATUS
------------------------------ ------------------------------ -----------
EXF                            10.2.0.3.0                     VALID
RUL                            10.2.0.3.0                     VALID
XDB                            10.2.0.3.0                     VALID
OWM                            10.2.0.1.0                     VALID
CATALOG                        10.2.0.3.0                     VALID
CATPROC                        10.2.0.3.0                     VALID
JAVAVM                         10.2.0.3.0                     VALID
XML                            10.2.0.3.0                     VALID
CATJAVA                        10.2.0.3.0                     VALID

9 rows selected.

[ ]  java 1.5.0?
[ ]  infadmin able to write all subdirs?
chmod -R  u+w $INFINYS_ROOT/*
[-]  Custom passwords to $INFINYS_ROOT/dbascripts/install/infinys_users.dat
[-] Changes to schema_params.sql, schema_default_tablespaces.sql? Repackage.

As DBA:
[ ]  USERS tablespace?
[ ]  Check for DBMSPOOL
    select * from all_objects where object_NAME='DBMS_SHARED_POOL';
    If not, @?/rdbms/admin/dbmspool.sql
[ ]  install.sh

As infadmin:
[ ]  ./verification_pre_install.sh -o VOD2201 -u INF_ADMIN -p INF_ADMIN
    NB, this doesn't check the infinys_users.dat for ipf_admin &amp; unif_admin
    needs edited. Also, DOESN'T USE $DATABASE! Manual check geneva_admin!
[ ]  xclock ?!?
[ ]  Run GUI for PF - s/w and schema INSTALL
[ ]  Run GUI for RB - s/w and schema INSTALL
{{{java -cp IS-3.0.14.jar –V IS_CLEAN_TEMP}}}
[-] desc sysreg as ipf_admin
[-] Run GUI for RB - software only
[-] Changes to schema_params.sql, schema_default_tablespaces.sql in $STAGE_ROOT/RB/RB/schema
[-] MM for schema

IMPORT VOD2204-GA.dmp

ORA-04020: deadlock detected while trying to lock object GENEVA_ADMIN.SYS_PLSQL_75248_25_1
Import terminated successfully with warnings.

As infadmin:
[ ] Copy infinys.properties:

# Run mode should be either retail or settlement
#
RUN_MODE=retail
# database login
PF_USER=ipf_admin
PF_USER_PASSWORD=ipf_admin
PF_ORA_HOSTNAME=hocpi03n
PF_ORA_PORT=1521
PF_ORA_SID=VOD2201

[ ] infinysctl -L -d deploy
[ ] update logging dirs

select * from ipf_admin.systemregistryentry t where name ='LogFileRootDir'
and parent_id in (select p.id from ipf_admin.systemregistryentry p where p.name='eventlog');

update ipf_admin.systemregistryentry set VALUE='/Disk1/home/vod2203/work/log' where ID=2395;

[ ] Set platform.cfg:

&lt;?xml version=&quot;1.0&quot; encoding=&quot;US-ASCII&quot; ?&gt;
&lt;config&gt;
  &lt;global&gt;
    &lt;configMgr masterHost=&quot;hocpi03n&quot; shmKey=&quot;20077010&quot; semKey=&quot;20077010&quot; slaveHost=&quot;&quot; port=&quot;3039&quot; maxDomains=&quot;10&quot; maxServices=&quot;100&quot;&gt;
    &lt;/configMgr&gt;
  &lt;/global&gt;

  &lt;host name=&quot;hocpi03n&quot;&gt;
    &lt;configMgr timeout=&quot;15&quot;/&gt;
  &lt;/host&gt;
&lt;/config&gt;

[ ] dconfigadmin -L platform.cfg
[ ] As working user DConfigAgent &amp;
[ ] GPARAMS:

update geneva_admin.gparams set string_value='en_US.iso88591'
where name in ('SYScurrencyLocale', 'SYSdateLocale', 'SYSnumericLocale');

update geneva_admin.gparams set string_value='hocpi03n'
where name in ('TMhostMachineName', 'TRDhostMachineName', 'REMhostMachineName');

update geneva_admin.gparams set integer_value=20 where name='TMnumStatusMessages';

update geneva_admin.gparams set integer_value=3030 where name='TMchildProcessPort';
update geneva_admin.gparams set integer_value=3031 where name='TMsystemMonitorPort';
update geneva_admin.gparams set integer_value=3032 where name='TRDclientPort';
update geneva_admin.gparams set integer_value=3033 where name='REMclientPort';

update gparams set string_value='/Disk1/home/vod2203/work/bin' where name ='TMimageDir';

TM -u geneva_admin -p geneva_admin -s db.world
}}}</pre>
</div>
<div title="IRB3.0 cleardown" modifier="colm" created="200907161054" modified="201206130810" tags="irb geneva install upgrade" changecount="6">
<pre>{{{
drop user GENEVABATCHUSER cascade;
drop user SECURITY cascade;
drop user IPFAPPUSER cascade;
drop user EVENT_ADMIN cascade;
drop user GENEVAADMINUSER cascade;
drop user UNIF_ADMIN cascade;
drop user IPF_ADMIN cascade;
drop user INF_ADMIN cascade;
drop user ENCRYPT_ADMIN cascade;
-- Run dropqs
drop user GENEVA_ADMIN cascade;

ALSO: ipf_sec_admin!!

drop role GENEVAVERSION;
drop role GENEVABATCH;
drop role GENEVAADMIN;
drop role GENEVAAPP;
drop role GENEVASECURITY;
drop role GENEVAPUBLIC;
drop role INFINYS_PUBLIC_INSTALL;
drop role CSM_ENCRYPT_ROLE;
drop role INFINYS_PF;
drop role INFINYS_RB;
drop role PF_READ_ONLY_ROLE_UNIF_ADMIN;
drop role PF_UPDATE_ROLE_UNIF_ADMIN;
drop role PF_READ_ONLY_ROLE_IPF_ADMIN;
drop role PF_UPDATE_ROLE_IPF_ADMIN;
drop type CUSTOMERSYNCOBJECT;
}}}
Filesystem:
{{{
# this always needs removed from homedir if retrying the GUI installer
rm ~/InstallShield

# list
find /tmp -user $(id -un) -exec ls -la {} \; 2&gt;/dev/null
find /var/tmp -user $(id -un) -exec ls -la {} \; 2&gt;/dev/null

# delete
find /tmp -user $(id -un) -exec rm -rf {} \; 2&gt;/dev/null
find /var/tmp -user $(id -un) -exec rm -rf {} \;2&gt;/dev/null

# clear out inf root tmp area if retrying
rm -rf $INFINYS_ROOT/tmp (or TMP_ROOT if different)
}}}</pre>
</div>
<div title="Iterate over args" creator="colm" modifier="colm" created="201108121357" tags="ksh" changecount="1">
<pre>{{{
until [[ $# -eq 0 ]];do
        print Got $1
        echo Got $1 &gt;&gt;$LOG
        shift
done
}}}</pre>
</div>
<div title="Keep cache" modifier="YourName" created="201003051003" changecount="1">
<pre>According to Sourav's mail:

Recycle:
Costedevent &amp; costedevent_uk1
Billdata (but not pk, as we have not seen much advantage by pushing that to recycle)
 
Keep:
ACCOUNT
ACCOUNTDETAILS
ACCOUNTRATING
ACCOUNTRATINGSUMMARY
ACCOUNTSTATUS
CUSTEVENTSOURCE
CUSTHASPRODUCT
CUSTPRODINVOICEDISCUSAGE
CUSTPRODRATINGDISCOUNT
CUSTPRODUCTDETAILS
CUSTPRODUCTDISCOUNTUSAGE
CUSTPRODUCTSTATUS
CUSTPRODUCTTARIFFDETAILS
 
and these indexes:
ACCOUNT_PK
ACCOUNTDETAILS_PK
ACCOUNTRATING_PK
ACCOUNTRATINGSUMMARY_PK
ACCOUNTSTATUS_PK
CUSTEVENTSOURCE_AK1
CUSTEVENTSOURCE_PK
CUSTHASPRODUCT_PK
CUSTHASPRODUCT_AK2
CUSTHASPRODUCT_AK5
CUSTPRODINVOICEDISCUSAGE_UKP
CUSTPRODRATINGDISCOUNT_AK2
CUSTPRODRATINGDISCOUNT_UK1
CUSTPRODRATINGDISCOUNT_UKP
CUSTPRODUCTDETAILS_AK1
CUSTPRODUCTDETAILS_PK
CUSTPRODUCTDISCOUNTUSAGE_UKP
CUSTPRODUCTSTATUS_PK
CUSTPRODUCTTARIFFDETAILS_PK</pre>
</div>
<div title="Korn Shell Path Stripping" modifier="colm" created="200908051212" tags="ksh regexp" changecount="1">
<pre>The Korn shell provides pattern-matching operators, shown in Table 16-3 , that you can use to strip off components of pathnames.

|Operator 	|Description |
|${variable#pattern} 	|Deletes the shortest part at the beginning of the variable that matches the pattern and returns the rest.|
|${variable##pattern} 	|Deletes the longest part at the beginning of the variable that matches the pattern and returns the rest.|
|${variable%pattern} 	|Deletes the shortest part at the end of the variable that matches the pattern and returns the rest.|
|${variable%%pattern} 	|Deletes the longest part at the end of the variable that matches the pattern and returns the rest.|

The following example shows how all of the operators work, using the pattern /*/ to match anything between two slashes, and .* to match a dot followed by anything:
{{{
$ pathname=/home/winsor/Design.book.new
$ echo ${pathname#/*/}
winsor/Design.book.new
$ echo ${pathname##/*/}
Design.book.new
$ echo ${pathname%.*}
/home/winsor/Design.book
$ echo ${pathname%%.*}
/home/winsor/Design
}}}</pre>
</div>
<div title="Late billing explanation" creator="YourName" modifier="YourName" created="201401271049" modified="201401271115" changecount="3">
<pre>The only normal scenario for rate_event_seq to be bill_event_seq + 1 is when an account is being billed, when the account billing_status would be 'B%' typically 'BB' as explained below. 

[For a non hierarchy account] 
At the start of billing [for bills that include events] the BG performs the period closure transaction - advancing the rate_event_seq to direct new events to be rated into the next bill period whilst the current one is billed. Billing_status is moved from OK to BB. 
At this point rate_event_seq = bill_event_seq + 1 

At the end of billing the BG performs the 'update account' transaction (inserting the bill, bill details, data etc) and then advances the bill_event_seq to now catch up with the rate_event_seq. The billing_status will be moved back to OK. 
At this point rate_event_seq = bill_event_seq [which are both the event seq of the last bill + 1] 
•	An explanation for this account (which has billing_status of OK) is that at some point it failed billing, and it manually had its bill status changed from BB to OK. This would leave rate_event_seq permanently one more than bill_event_seq (and during billing it would become bill_event_seq + 2 for the duration of the bill).
•	Given it is only one account, and we can see a period in which the account was not billed for 30 days longer than the usual 14 or so indicating possible billing errors this is plausible. 

Normally when an account is in a late billing scenario this discrepancy would not occur: when the next_bill_dtm is passed rating will start rating events using rate_event_seq + 1 as the event seq. However it will not actually change the rate_event_seq itself.
For example: 
•	if billing last ran for a monthly billed account on Jan 1 with that bill having event_seq 1 then the bill_event_seq and rate_event_seq would be 2 with next bill dtm of 1 Feb. Events rated in January will be assigned event seq 2 to tie them to the Feb bill.
•	Should 1st Feb comes and goes without billing running then rating will start using rate_event_seq + 1 i.e. 3 for events rated in February (putting them onto the March bill).
•	If ~SYSindividualLateBillsBoo is T then should the account not be billed for another month events rated in March will go onto rate_event_seq + 2 i.e. 4 for the April bill, and so on.
•	If ~SYSindividualLateBillsBoo is F then late events all get rate_event_seq + 1 i.e. 3 (March bill) no matter how late they are 

For the account in question we see last bill on 14 Dec had event_seq 97 (including events rated bet June and Sept 2013). Bill_event_seq is 98 but rate_event_seq is 99 so all events from 14 Dec to 14 March will get event_seq 99 and not be featured until the June bill. 
{{{
SELECT bb.*, c.CE_num_costedevents, c.CE_min_created_dtm, c.CE_max_created_dtm
FROM
    (
        SELECT b1.account_num, b1.bill_seq, b1.bill_dtm, b1.actual_bill_dtm,
            TRUNC ( b1.actual_bill_dtm - b1.bill_dtm) bill_delay_days,
            b1.event_seq, b2.num_events_on_bill, b1.event_billed_to_dtm
        FROM billsummary b1, (
                SELECT account_num, bill_seq, SUM(sum_attr_2_value)
                    num_events_on_bill
                FROM billdetails b
                WHERE account_num   = 'CL48183109'
                AND b.group_attr_1 IN
                    (
                        /* events */
                        SELECT revenue_code_id
                        FROM eventrevenuemap
                        WHERE event_type_id IN (512,513,519,514,515,516,517)
                    )
                GROUP BY account_num, bill_seq
            )
            b2
        WHERE b1.account_num = b2.account_num
        AND b1.bill_seq      = b2.bill_seq
        AND b1.bill_status  IN (1,2,4,7,8)
    )
    bb, (
        SELECT account_num, event_seq, MIN(created_dtm) CE_min_created_dtm, MAX
            ( created_dtm) CE_max_created_dtm, COUNT(1) CE_num_costedevents
        FROM costedevent
        WHERE account_num = 'CL48183109'
        GROUP BY event_seq
    )
    c
WHERE bb.account_num = c.account_num
AND bb.event_seq     = c.event_seq
ORDER BY bill_seq;
}}}</pre>
</div>
<div title="Linux" modifier="colm" created="201007281449" modified="201202091635" changecount="6">
<pre>!!!System
CPU
* cat /proc/cpuinfo
* mpstat -p ALL
* Use ''1'' in ''top'' to toggle between ssummary and individual CPUs

!!! Widescreen
To get around amazingly annoying truncated command line in linux do:
{{{
stty cols 180
export COLUMNS=180
}}}

To rewrap a file for viewing in vi which is too wide or wrapping badly:
{{{
adjust myfile.out &gt; boguscopy.out
vi boguscopy.out
}}}

Haven't tried this:while in vi.....
{{{
vi myfile.out
:.,.!adjust
:q!
}}} 
From the forums:
//wrapmargin=7 will wrap after the next white space that is less than 7 characters from the current right margin. With an 80 character line, typing text at column 73 will trigger a wrap. But only when inserting. It does not affect the appearance of existing lines. So :set wm=0 (vi and vim) is the same as :set nowrap (vim only).//</pre>
</div>
<div title="Linux I/O problems" creator="YourName" modifier="YourName" created="201305281336" modified="201305310850" changecount="7">
<pre>Use extended iostat to look at busy disks in isolation - ignore first report:
{{{
cdsora11 [EONS1C53]/home/cdsora11/cam&gt; iostat -x 5 5
Linux 2.6.18-274.7.1.el5 (camdl37)      05/28/2013

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.65    0.00    0.14    0.84    0.00   98.37

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           3.35    0.00    0.80   12.30    0.00   83.55

Device:         rrqm/s   wrqm/s   r/s   w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.00  4310.60  3.60 637.20    46.40 39584.00    61.85     4.82    6.97   1.56 100.02
sda1              0.00     0.00  0.00  0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00
sda2              0.00     0.20  0.00  0.20     0.00     3.20    16.00     0.00    3.00   3.00   0.06
sda3              0.00     2.80  0.00  1.20     0.00    32.00    26.67     0.04   31.00  31.00   3.72
sda4              0.00     0.00  0.00  0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00
sda5              0.00  4307.60  3.60 635.80    46.40 39548.80    61.93     4.79    6.93   1.56 100.02
}}}
Look for processes in STAT  D - this is uninterruptible sleep:
{{{
while true; do date; ps auxf | awk '{if($8==&quot;D&quot;) print $0;}'; sleep 1; done
OR 
while true; do date;ps -eo state,pid,cmd | grep &quot;^D&quot;; sleep 1; done
OR for HP-UX:
while true; do date; UNIX95=1 ps  -eo state,pid,comm | grep &quot;^W&quot;; sleep 1; done
}}}
Check pid's work load in /proc and with lsof - if allowed:
{{{
lsof -p pid
cat /proc/pid/io
}}}
Use pvdisplay or mount to associate /dev devices with mountpoints and directories.

On linux iostats -txm will give MB/sec and timestamps</pre>
</div>
<div title="Log Buffer Sizing" modifier="colm" created="201008212120" modified="201008212123" changecount="2">
<pre>J Lewis (http://kr.forums.oracle.com/forums/thread.jspa?threadID=841743)
Your statement is correct, but some of the details in that article have confused waits for space in the log buffer with waits for the log file. It's probably better to look to the wait events for clues, rather than the statistics, the crtiical events being &quot;log buffer space&quot;, and &quot;log file sync&quot;.

If sessions are spending excessive time waiting on &quot;log buffer space&quot;, then the log buffer needs to be increased - but you have to bear in mind that on a busy system you are likely to see a burst of &quot;log buffer space&quot; waits at each log file switch.

if sessions spending excessive time on &quot;log file sync&quot; then it is possible that the log buffer needs to be reduced in size - but you first need to check that this isn't a sign of slow I/O (check &quot;log file parallel write&quot; time if you're not suffering from the 9.2 bug), or a sign of excessive CPU usage (time lost on messaging between sessions and lgwr). Then you might suspect that some sessions are suffering from the size of the bfufer because other sessions are generating a lot of redo between commits, resulting in large writes being triggered by a session that has only generated a small amount of redo.

Of course, there's no point in putting lots of memory into the log buffer when it could be more useful elsewhere, and I've only seen a few systems that needed a log buffer in the region of 32MB - and they were OLTP systems with a very large number of concurrent sessions.

//PeterW2 wrote:

And do you think that the floor threshold of 1/3 log buffer or 1MB determines only that the buffer will be written not the size of the write? I think this is the case.//

Correct - the 1MB is simply a trigger to make sure that the log writer doesn't stay idle when it could be doing something.

Once the write starts, of course, it's possible (a) that the volume to be written is larger than 1MB - but it's also possibly that in the time that LGWR writes 1MB, other processes have dumped another 5MB into the log buffer; then, as LWGR writes that 5MB, another 35MB gets dumped, and so on.

I assume your log buffer has to be larger than 35MB for you to get that message in the alert log. If it isn't, then the code that generates that message has gone wrong.</pre>
</div>
<div title="Log file waits" creator="colm" modifier="colm" created="201204041117" modified="201204051153" changecount="5">
<pre>Changes go to the buffer cache blocks and redo info gets written into the log_buffer. LGWR writes these blocks from log_buffer to online redo logs. If in archivelog mode, ARCH then copies these off before they are overwritten as the FIFO loops around.
* ''log buffer space'' - This is when a session is waiting to write to the log_buffer - LGWR writes from this buffer to redo logs so implication is app is generating redo faster than LGWR can write it which in turnn suggests either:
** slow disk or contention on redo log disks
** log buffer is too small (sho parameter log_buffer)
* ''log file parallel write'' - LGWR posts this when writing from log_buffer to all members of redo group - will be done in parallel if async_io enabled, otherwise will be serial.
** slow disk or contention on redo log disks
* ''log file sequential read'' - Process is waiting for blocks to be read from the online redo logs - ARCH enounters this.
* ''log file switch (archiving needed)'' - ARCH is not keeping up with LGWR and the online redo logs have not yet been archived off
* ''log file switch (checkpoint incomplete)'' - Waiting session is waitoing for the log file to switch but it cannot because the checkpoint process for that logfile has not finished
** redo logs may be too small
* ''log file switch completion'' - Process is waiting for log file switch to complete - not specified why...
* ''log file sync'' - At transaction completion (commit or rollback) the session redo must go from log_buffer to redo logfile on disk before the session can continue - this wait is posted while LGWR does that work.
** too frequent commits?
** bad I/O time to redo log disks?</pre>
</div>
<div title="Long running SQL" creator="colm" modifier="colm" created="201303081101" changecount="1">
<pre>This will run for a good while:
{{{
SELECT COUNT(*)
FROM customer c, account a,
	(SELECT 1 FROM dual CONNECT BY LEVEL &lt;= 10000) x,
	(SELECT 1 FROM dual CONNECT BY LEVEL &lt;= 10000) y
WHERE c.customer_ref = a.customer_ref;
}}}</pre>
</div>
<div title="MainMenu" modifier="colm" created="200907151151" modified="200907160724" changecount="4">
<pre>[[Geneva]]
[[Oracle]]
[[Unix]]
[[Admin]]</pre>
</div>
<div title="MarkupPreHead" creator="colm" modifier="colm" created="201108111500" changecount="1">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;link rel=&quot;shortcut icon&quot; href=&quot;localnotes-favicon.ico&quot; type=&quot;image/x-icon&quot;&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="MonoPageTemplate" modifier="colm" created="200701130013" modified="201108101219" tags="MonochromeTheme" server.type="file" server.host="tiddlythemes.com/empties/Monochrome.html" server.page.revision="200708091512" changecount="1">
<pre>&lt;div id='header' class='header' macro='gradient vert   #555555       #3b3b3b '&gt;
        &lt;div class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/div&gt;
        &lt;span id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="MonoStyleSheet" modifier="colm" created="200701130013" modified="201108101219" tags="MonochromeTheme" server.type="file" server.host="tiddlythemes.com/empties/Monochrome.html" server.page.revision="200708091512" changecount="1">
<pre>/*{{{*/
/*Monochrome Theme for TiddlyWiki*/
/*Design and CSS by Saq Imtiaz*/
/*Version 1.0*/
/*}}}*/
/*{{{*/

body {background:#3B3B3B; color:#C3C3C3; font:12px Verdana, Helvetica, sans-serif;
	}

#header {padding: 0em 0em 0em 0em; background:transparent;	font-family: arial,helvetica; font-size:12px;
 }

.siteTitle {
padding-top:5px;
float:left;
font-family: 'Trebuchet MS' sans-serif;
font-weight: bold;
font-size: 32px;
color: #ccc; margin-right:2em;margin-left:0.5em;
}

#topMenu br {display:none;}
#topMenu a, #topMenu .tiddlyLink, #topMenu .button {margin:0em; color:#666; padding:15px 15px 10px 15px;padding-top:1.6em;border:none; border-right: 1px solid #666;float:left;}
#topMenu {border-left: 1px solid #666;  float:left;margin:0;}
#topMenu a:hover {color:#ccc; background:#3b3b3b;}

#displayArea {margin-left:1.35em; margin-right:17.65em; margin-top:0.5em; padding-top:1em; padding-bottom:10px;}

.tiddler {background:#454545; margin-bottom:20px; padding:1em 2em 1em 2em;}

a, a:hover{
color:#fff;
text-decoration: none; background:transparent;
}

.viewer a, .viewer a:hover{border-bottom:1px dotted #fff; font-weight:normal;}

.viewer .button, .editorFooter .button{
color: #fff;
border: 1px solid #fff;
}

.viewer .button:hover,
.editorFooter .button:hover, .viewer .button:active, .viewer .highlight,.editorFooter .button:active, .editorFooter .highlight{
color: #fff;
background: #3B3B3B;
border-color: #3B3B3B;
}

.title {color:#ccc; font-family:'Lucida Grande', Verdana, Sans-Serif; font-size:1.5em;
}

.subtitle, .subtitle a { color: #777; font-size: 0.95em;margin:0.2em;}
.shadow .title{color:#777;}

.toolbar {font-size:90%;}
.selected .toolbar a {color:#666;border:0;}
.selected .toolbar a:hover {color:#999; background:transparent;border:0;}

.toolbar .button:hover, .toolbar .highlight, .toolbar .marked, .toolbar a.button:active{color:#666;border:0; background:transparent;border:0;}

.tagging, .tagged {
border: 1px solid #555;
background-color: 	#444;
}

.selected .tagging, .selected .tagged {
background-color: 	#3B3B3B;
border: 1px solid #666;
}

.tagging .listTitle, .tagged .listTitle {
color: #666;
}

.selected .tagging .listTitle, .selected .tagged .listTitle {
color: #aaa;
}

.tagging .button, .tagged .button {
color:		#838383;
}
.selected .tagging .button, .selected .tagged .button {
color:#c3c3c3;
}

.highlight, .marked {background:transparent; color:#111; border:none; text-decoration:underline;}

.tagging .button:hover, .tagged .button:hover, .tagging .button:active, .tagged .button:active {
border: none; background:transparent; text-decoration:underline; color:#333;
}

#sidebarOptions {margin-top:1em;}
#sidebar {margin-right:1.35em;}

#sidebarTabs .tabContents {	
	font-family: arial,helvetica;}

#sidebarOptions a, #sidebarOptions a:hover{border:none;color:#666;}
#sidebarOptions a:hover, #sidebarOptions a:active {background:#454545; color:#ccc;}
#sidebarTabs .tabContents {background:#454545;border:0px solid #666; border-right:1px solid #454545;}
#sidebarOptions input {background:#ccc; border:1px solid #666;}

#sidebarTabs .tabContents .tiddlyLink, #sidebarTabs .tabContents .button{color:#666;font-weight:normal;}
#sidebarTabs .tabContents .tiddlyLink:hover, #sidebarTabs .tabContents .button:hover {color:#ccc; background:transparent;}
.listTitle {color:#777;}

#sidebarTabs .tabSelected,#sidebarTabs .tabSelected:hover{background:#454545;border:none;color:#ccc; border:1px solid #454545;}
#sidebarTabs .tabUnselected{background:#3B3B3B; border:1px solid #454545; color:#666;}

   #sidebarTabs .txtMoreTab .tabSelected,
   #sidebarTabs .txtMoreTab .tab:hover,
   #sidebarTabs .txtMoreTab .tabContents{
color: #ccc;
background: #3B3B3B; border:1px solid #3B3B3B;
}

   #sidebarTabs .txtMoreTab .tabUnselected {

color: #777; border:1px solid #3B3B3B;
background: #454545;
}


#sidebarTabs .tabContents .button:hover, #sidebarTabs .tabContents .highlight, #sidebarTabs .tabContents .marked, #sidebarTabs .tabContents a.button:active{color:#ccc; background:transparent;}

   #sidebarOptions .sliderPanel {
background: #454545; font-size: .9em;
}

#sidebarOptions .sliderPanel input {border:1px solid #666; background:#ccc;}
#sidebarOptions .sliderPanel .txtOptionInput {border:1px solid #666;width:9em;}

#sidebarOptions .sliderPanel a {font-weight:normal; color:#666;background-color: #454545; border-bottom:1px dotted #333;}

#sidebarOptions .sliderPanel a:hover {
color:#ccc;
background-color: #454545;
border:none;
border-bottom:1px dotted #111;
}

.popup {
background: #3B3B3B;
border: 1px solid #454545;
}

.popup li.disabled {
color: #000;
}

.popup li a, .popup li a:visited {
color: #777;
border: none;
}

.popup li a:hover {
background: #3b3b3b;
color: #c3c3c3;
border: none;
}
.popup hr {
	color: #777;
	background: #777;
	border-bottom: 1px;
}

.listBreak div{
	border-bottom: 1px solid #777;
}

#messageArea {
border: 4px dotted #ccc;
background: #454545;
color: #777;
font-size:90%;
}

#messageArea .button{

color: #3B3B3B;
background:#ccc;
border: 1px solid #ccc;
}

#messageArea .button:hover {

color: #ccc;
background: #3B3B3B;
border-color: #3B3B3B;
}

.viewer blockquote {
border-left: 5px solid 		#3B3B3B; background:#3B3B3B
}

.viewer table, .viewer td {
border: 1px solid 	#2E2E2E;
}

.viewer th, thead td {
background: #3B3B3B;
border: 1px solid #3B3B3B;
color: #ccc;
}
.viewer pre {
border: 1px solid #3b3b3b;
background: #5F5F5F;
}

.viewer code {
color: #c3c3c3; background:#5f5f5f;
}

.viewer hr {
border-top: dashed 1px #222; margin:0 1em;
}

.editor input {
border: 1px solid #ccc; margin-top:5px;
}

.editor textarea {
border: 1px solid #ccc;
}

h1,h2,h3,h4,h5 { color: 		#9c9c9c; background: transparent; padding-bottom:2px; font-family: Arial, Helvetica, sans-serif; }
h1 {font-size:18px;}
h2 {font-size:16px;}
h3 {font-size: 14px;}</pre>
</div>
<div title="NC confcalls" creator="colm" modifier="colm" created="201209041358" modified="201210021550" changecount="3">
<pre>{{{
Dial in numbers from most common countries (see full list below):
                Freephone       Paid
UNITED KINGDOM: 08082349387 London 02031070277

Helpful Keypad Commands:
*0      Operator assistance - conference
00      Operator assistance-individual
*1      Dial-out to a participant - leader only
*2      Begin/end conference record (leader only)
*3      Change entry/exit method (recorded names, tones, silence) - leader only
*4      Private roll call
*5/#5   Mute/unmute all participant lines - leader only
*6/#6   Mute/unmute your own line
*7/#7   Lock/unlock conference (including operator) - leader only
*8      Allow/disallow conference continuation - leader only
*9      Start/join sub-conferencing
11      Third-party conference start - bypass hold music to start call as leader
*51/#51 Lecture mode on/off – leader only
#99     Disconnect all lines except leader’s – leader only
*#      Participant count
**      List available keypad commands
}}}</pre>
</div>
<div title="NetCracker Access" creator="colm" modifier="colm" created="201208201059" modified="201208231126" changecount="2">
<pre>https://ras02.netcracker.com/im

Login: cmccarta
Password: Tihd27#
Domain: NETCRACKER

https://erp.netcracker.com </pre>
</div>
<div title="New instance" modifier="colm" created="200907301141" tags="oracle instance create" changecount="1">
<pre>!!! Copy admin area

Various $OH/admin dirs: create, pfile, bdump etc.

 mkdir adump bdump cdump create pfile udump 

!!! Edit creation scripts

Globally replace SID. *Check locations of oradata files exist.* In vi:

 :%s/OLD/NEW/g

!!! Edit initSID.ora

DBname, pool size etc. *Make sure ctlfile locations exist.* Globally replace SID. (Consider disabling remote password for duration of install).

*NB* Set sga_target for 200M at install time to allow headroom for initjava, XML etc.

!!! Symlinks

Set up links under &lt;code&gt;$ORACLE_HOME/dbs&lt;/code&gt; (and/or &lt;code&gt;$ORACLE_BASE/admin&lt;/code&gt;) to actual init files

 ln -s REAL_THING LINKNAME

!!! Start NOMOUNT instance

Needs SID in environment (unless you specify it explicitly at STARTUP time). Put new entry in /etc/oratab and use setoraenv or else export important vars - see &quot;Oracle Sysadmin guide&quot;:http://download-west.oracle.com/docs/cd/B10501_01/server.920/a96521/create.htm#1000691

 [TSGTEST] /Disk1/app/oracle/admin&gt; sqlplus /nolog 
 SQL*Plus: Release 9.2.0.6.0 - Production on Wed Oct 26 14:19:33 2005
 Copyright (c) 1982, 2002, Oracle Corporation.  All rights reserved.
 &gt;  connect / as sysdba
 Connected to an idle instance.
 &gt;
 &gt; startup nomount
 ORACLE instance started.
 Total System Global Area  456102960 bytes
 Fixed Size                   734256 bytes
 Variable Size             301989888 bytes
 Database Buffers          150994944 bytes
 Redo Buffers                2383872 bytes
 &gt;

!!! Run create scripts

Best to go from create dir and connect to idle instance before calling @create1. Catalog, JVM, XML script can take some time:

 nohup sqlplus 'sys/change_on_install as sysdba' @create3 &amp;

!!! Remote admin passwd file 

Set with:

 orapwd file=$ORACLE_HOME/dbs/orapw$ORACLE_SID password=secret

!!! Edit listener scripts on host

Appropriate entries into &lt;CODE&gt;$ORACLE_HOME/network/admin/tnsnames.ora&lt;/CODE&gt; and &lt;code&gt;listener.ora&lt;/code&gt;. (Remember to check under @/var/opt@ on solaris).

!!! CHECK REGISTRY!

Make sure components are installed:

 set lines 200
 col COMP_ID for a24
 col VERSION for a12
 SELECT comp_id, version, status FROM dba_registry;

!!! Imports etc.

You will probably want to run a cr_geneva_user script or equivalent to create a genevauser so that the dataset can be imported into their schema. 

Note there may be some DefaultSchemas already in place.

&lt;hr size=&quot;1&quot;&gt;

!!! Provided scripts

@?/rdbms/admin/UTLXPLAN.SQL sets up default table for explain plan

&lt;hr size=&quot;1&quot;&gt;

!!! (Re)installing XMLDB

Check installed versions with:

 SELECT comp_id, version, status FROM dba_registry;

If necessary, drop the created XDB instance:

{{{
drop user xdb cascade;
alter tablespace &lt;XDB_TS_NAME&gt; offline;
drop tablespace &lt;XDB_TS_NAME&gt; including contents;
}}}

And reinstall:

{{{
@$ORACLE_HOME/rdbms/admin/catqm xdb_pass xdb_ts_name xdb_tmp_name;
catxdbj.sql
}}}</pre>
</div>
<div title="ORA-28002: the password will expire" creator="colm" modifier="colm" created="201305100948" changecount="1">
<pre>REst password and lifetime on profile:
{{{
SYS@BTRETSI1&gt; SELECT PROFILE FROM dba_users WHERE username = 'GENEVA_ADMIN';

PROFILE
------------------------------
DEFAULT

SYS@BTRETSI1&gt; SELECT  LIMIT FROM DBA_PROFILES WHERE PROFILE='DEFAULT'
  AND RESOURCE_NAME='PASSWORD_LIFE_TIME';  2

LIMIT
----------------------------------------
180

SYS@BTRETSI1&gt; ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED;

Profile altered.

SYS@BTRETSI1&gt; alter user GENEVA_ADMIN identified by GENEVA_ADMIN;

User altered.

SYS@BTRETSI1&gt;
}}}</pre>
</div>
<div title="Online Sizing Model" modifier="colm" created="200908111518" modified="200908111522" tags="sizings" changecount="3">
<pre>The RB sizing model now supports RTCC. Below is some guidance.

RTCC can be selected via the Global Architecture page. Take care to select from the sub-list the relevant apps for RTCC operation (e.g. real-time IAM, RTED, real-time rating, OELC FF/non-FF, and optionally file-based IAM, EFD, file-based rating). We plan to make this easier in future. Note that under RTCC, even file-based rating will need to use the Caches. Hence, if using RTCC, if you require file-based Rating as well, choose that option under RTCC and choose no options under the Rating section.
 
You will see several new server types in the sizing report’s server table. Also required but listed separately are the SAFfire and Domain Lookup Cache servers. These are sized simply in terms of the number of servers of the same CPU type as Cache Servers. However it should be noted that for SAFfire, the servers can be single-chip. 
 
As you know, hardware sizings and deployment architectures are dependent on each other in an iterative process. For RTCC the deployment architecture is a much more complex issue. Depending on the sizings, it may be possible to combine smaller tiers, and then servers for various tiers can gain availability with N+M, N+N or by using a no-redundancy model. Tiers for which only N+N is recommended are listed in the report and to aid deployment design, the number of servers is given. Servers of each of these types will require an equivalent standby so the Number of Servers figure must be doubled when considering HA. 
 
In order to size for overheads per cache server, the Number of Cache Servers is an input as well as an output. Use any number to begin with (remember this has to be 60 or less). When the rest of the sizing is otherwise ready, update the Number of Cache Servers to match the output figure and run the calculations again. This will ensure the report shows the correct figure, and overheads per cache DB are correctly calculated. 
 
A few updates to the notes below. As before, these are for previously trained spreadsheet model users so are not thorough but they may be helpful until the updated training is delivered.
 
Note RTCC sizings are currently missing mass provisioning, mass update, LCAM, Billing lite.
 
!!!Notes on use of new technology sizing model, for previously trained sizing spreadsheet users
 
URL for the test system is http://sizingmodel/. You can create yourself a user (if you haven't already). This will let you enter inputs. Let me/Simon know your user id and we will increase privileges to allow sizings reports to be created. 
 
General definitions
A &quot;Function Subtype&quot; is an RB architectural feature
A &quot;Resource Type&quot; is CPU, I/O or Redo
A &quot;Server Type&quot; is DB, VPA, NFS, ESM, APP, Cache, IAM, Real-time Rating, RTED etc
 
!!!!Notes on Inputs
* Sizing Home is your base. Complete every section of inputs from there, generally in numbered order. Ignore section labelled &quot;Set overrides&quot; as these are for technical sizings. 
* Errors appear in red text at the top of the screen.
* Every page will require a button to be clicked to save data. E.g on Workload Distribution, this means scrolling all the way down to the bottom of the screen.
* Most inputs reflect the old spreadsheet inputs.
* When creating a new sizing, or Cloning, it is recommended that the version of the sizing for an operator, an other key parameters, be included in the Sizing Name field. This will make it easier to find the correct version when searching eg &quot;DoTel 2010 3-cycles v0.1 &quot;.
* Then creating a new sizing, set the Sizing Status to Working. When complete, and ready for review, set to Draft. You will not be able to edit the sizing once in Draft status as this is a baseline for review and hence change control. To apply review comments, find your sizing on the Search page, and Clone it. Or Clone it from the New Sizing page. (I think only the latter works at the time of writing). After as many rounds of Working -&gt; Draft -&gt; Clone-&gt;Working-&gt;Draft-&gt;Clone-&gt;Woking-&gt;Draft as required, and the sizing is ready for delivery, set the Status to Approved.
* Any sizing can be cloned. Cloning creates the sizing in the 'New' status, and forces you to change to Sizing Name to allow differentiation in search results.
* On the Architecture page, select all architectural features (known as function subtypes) the operator is expecting to use. These will appear when you click on the larger groupings, e.g. &quot;Using billing?&quot;. Choose valid mixes of architectural options; invalid combinations will give an error in red text at the top when clicking on Save Selection. Error will flag just one pair at a time. Examples:
** Cannot size for ECA and PL/SQL API in the same sizing. 
** FF stands for Costed Event Flat-File. If any option with Flat-file events is chosen, no non-FF can be chosen. Vice versa.
** If any DRP Billing option  is chosen, cannot choose any non-DRP for Billing. Vice versa.
** If any DRP Rating option is chosen, cannot choose any non-DRP for Rating. Vice versa.
** Can have Rating non-DRP and Billing DRP and vice versa.
** If you choose to use FF, then must also enabled Daily ESM and MiniESM
** If using RTCC then choose all the relevant options for such an environment. You will need to be familiar with this.
** If file-based rating is required then choose this under RTCC and not under the Rating section. In an RTCC system even file-based rating uses the caches.
* Global and Customer input pages refresh with new questions when choosing some options - E.g &quot;Do you use domaining?&quot;, saying Yes opens up the question &quot;Number of domains&quot;
* On 'Enter Global Params': ESM SCHEDULE section has no entries below it if  'Costed Event File Store' was disabled.
* On the 'Enter Global Params' page. Only say Yes to 'Costed Event File Store' if previously chosen an Architecture with FF and enabled Daily and Mini ESM. Only say Yes to &quot;VPAs run on DB server?&quot; if previously selected only non-DRP options.
* On 'Enter Global Params', the Corrective Rating inputs are not used. Input here will be ignored. To work around this, add the rejected event re-processing load to the normal Usage Transaction inputs on Customer Type Params. 
* On the Customer Type Architecture page, currently the only options are Billing-lite non-DRP or Billing-lite DRP. Leave blank if not using either. These will also be validated against the Global Architecture inputs as described above e.g. will only allow Billing-lite DRP if chose a Billing DRP option at the Global Architecture level.  
* A Workload Distribution will have to be entered for every Function Subtype selected in Architecture inputs and Customer Type pair . Unfortunately this is the case even if a Customer Type is not using a particular Function Subtype. We're looking to make is easier but for now enter 100% in an hour outside of the peak period. This will not impact the sizing since volumetric inputs will have been set to zero. E.g. If message-based and file-based rating are enabled but a customer type only uses the former, they will have zero events arriving in files. The MS Word report takes this into account an suppresses the unnecessary Workload distribution if number of events in files/message is zero.
* Use the 'Check Configuration Status' button on Sizing Home to check if any major sections have not been completed. 
* If not using FF, the report will still label File Disk Storage against 'NFS'. This is for Managed Files and Payments etc. Not actually required to be NFS.
* For RTCC (OLC), the model sizes separate servers for each of the main applications/tiers: IAM, RTED/EFD, Rate, Cache, DL, VPA (for OELC and file-based Rating), and DB. These can be combined for smaller environments with due consideration of response-time and availability requirements. 
 
What areas of sizings might differ from the spreadsheet model
* Sizings will be for 4.0 or 3.0, whereas you may only have a 2.2 spreadsheet model
* PL/SQL CPU and I/O
* Only RB is supported currently.
* DRP/VPA server memory -improved calculations
* RAC sizing is not yet supported.
 
Not adequately tested yet
* Combinations of non-DRP Rating and DRP Billing, and vice versa.
* Hierarchies
* Billing lite
* Msg-based rating
* Impact of itemisation and large BGs on memory requirements

 </pre>
</div>
<div title="Optimised Upgrade Steps" creator="colm" modifier="colm" created="201202230904" modified="201202230905" changecount="3">
<pre>Techniques for speeding up migration steps
!!! Mass deletion from a table
* Consider doing a CTAS with the subset that will remain - very often faster.
!!! Dropping a column
* Mark column as unused and drop in a separate outage window - see:
http://asktom.oracle.com/pls/asktom/f?p=100:11:0::::P11_QUESTION_ID:623063677753</pre>
</div>
<div title="Oracle Enterprise Linux" creator="colm" modifier="colm" created="201108101426" modified="201108101826" tags="BT" changecount="2">
<pre>2 kernels: Unbreakable Enterprise Kernel and standard RHEL kernel.

Unbreakable Enterprise Kernel is based on a stable 2.6.32 kernel and includes optimizations
developed in collaboration with Oracle’s Database, Middleware and Hardware engineering
teams to ensure stability and optimal performance for the most demanding enterprise
workloads.

Oracle Linux also includes a Red Hat compatible kernel, compiled directly from Red Hat
Enterprise Linux source. Under the Unbreakable Linux Support program, Oracle will continue
to support the Red Hat Compatible kernel. This means you have a choice at boot time: strict
RHEL compatibility with the Red Hat Compatible Kernel or a system optimized for running
enterprise software with the Unbreakable Enterprise Kernel.</pre>
</div>
<div title="Oracle I/O" modifier="colm" created="200912091550" modified="201203290919" changecount="3">
<pre></pre>
</div>
<div title="Oracle I/O Latencies" creator="colm" modifier="colm" created="201203290917" modified="201405161012" changecount="17">
<pre>* General
Provided timed_statistics is set to TRUE v$filestat has the info, but take into consideration that Write I/O performance is a tricky matter in the sense that:
* Writes to datafiles are done by DBWR in the background so as long as DBWR can keep up with the load you really don't care about I/O performance;; DBWR will get it done and user community will never notice performance fluctuations.
* Writes to logs and temporary segments on the other hand are done in the foreground therefore poor performance in such segments will immediately have a negative impact on overall performance.

Bottom line, don't waste your time analyzing Write I/O on standard &quot;data and indexes&quot; data files; focus your attention on Logs or Temporary segment data files.

2003 era - from //Useful Constants for the Oracle Performance Analyst// - Millsap &amp; Holt
|''Event'' |''Max. tolerated latency per event'' | ''Sec'' |''per second rate'' |
|Single-block disk read (PIO) | 10 ms | 0.010 000 s | 100 |
|Single-block access from Oracle buffer cache (LIO), 500 ~MHz CPU | 20 µs | 0.000 020 s | 50,000 |
|Single-block access from Oracle buffer cache (LIO), 1 ~GHz CPU | 10 µs | 0.000 010 s | 102,400 |
|Single-block access from Oracle buffer cache (LIO), 2 ~GHz CPU | 5 µs | 0.000 005 s | 204,800 |
|SQL*Net transmission via WAN | 200 ms | 0.200 000 s | 5 |
|SQL*Net transmission via LAN | 15 ms | 0.015 000 s | 67 |
|SQL*Net transmission via IPC | 1 ms | 0.001 000 s | 1,000 |

* &quot;Administrator's Reference for ~UNIX-Based Operating Systems&quot; is the one with all the obscure I/O config details.

* V$~SYSTEM_EVENT.AVERAGE_WAIT is in centiseconds 

|''Interval size'' |''Unit of measure'' |''Light'' |
|1.0 s |second (s) |186,000 miles 300,000 km |
|0.01 s |centisecond (cs) |1,860 miles 3,000 km |
|0.001 s |millisecond (ms) |186 miles 300 km |
|0.000 001 s |microsecond (µs) |327 yards 300 m |
|0.000 000 001 s |nanosecond (ns) |11.8 inches  30 cm |</pre>
</div>
<div title="Oracle bundled perl and DBI/DBD" creator="colm" modifier="YourName" created="201202201617" modified="201309131401" changecount="7">
<pre>Use the full path to Oracle perl as your shebang line:
{{{
#!/Disk0/app/oracle/product/11.1.0.7/perl/bin/perl
}}}
And export the associated lib paths as ''~PERL5LIB'':
{{{
export PERL5LIB=/Disk0/app/oracle/product/11.1.0.7/perl/lib/5.8.3: \
/Disk0/app/oracle/product/11.1.0.7/perl/lib/site_perl/5.8.3
}}}
!!!! Check perl &amp; DBD versions
{{{
perl -v
perl -V

#  check the modules
perl -MDBI -e 'print &quot;$DBI::VERSION\n&quot;;'
perl -MDBD::Oracle -e 'print &quot;$DBD::Oracle::VERSION\n&quot;;'
}}}
Or dump INC:
{{{
perl -e 'print join &quot;\n&quot;, @INC;'
}}}</pre>
</div>
<div title="Oracle startup stages" creator="colm" modifier="colm" created="201202221003" modified="201202221003" changecount="2">
<pre>''1. startup nomount''
1.1. Reads the initialization file
1.2. Allocates the shared memory (SGA)
1.3. Starts the background processes
1.4. Opens the alert and trace files

''2. alter database mount''
2.1. Opens and reads the control files
2.2. Mounts the database and associates the started instance with the database

''3. alter database open''
3.1. Opens data files and redo logs
3.2. Performs database consistency and auto recovery</pre>
</div>
<div title="Orwell's 5 rules" modifier="colm" created="201101061255" changecount="1">
<pre>1. Never use a metaphor, simile, or other figure of speech which you are used to seeing in print.
2. Never use a long word where a short one will do.
3. If it is possible to cut a word out, always cut it out.
4. Never use the passive where you can use the active.
5. Never use a foreign phrase, a scientific word, or a jargon word if you can think of an everyday English equivalent.
6. Break any of these rules sooner than say anything outright barbarous.</pre>
</div>
<div title="Outlook safe mode" modifier="colm" created="200909160913" changecount="1">
<pre>Windows-R:
{{{outlook /safe}}}</pre>
</div>
<div title="PATH order in infinys.env" modifier="colm" created="200908051512" modified="201202071121" changecount="14">
<pre>!!!Environment setup
{{{
######################################################################
# Set up RB paths
# HP - SHLIB_PATH, AIX - LIBPATH, Other - LD_LIBRARY_PATH
######################################################################
# Installed binaries path
export IRB_INSTALLED_PATH=$INFINYS_ROOT/RB/bin:$INFINYS_ROOT/PF/bin:$INFINYS_ROOT/IS/bin
# Staged binaries path
export IRB_STAGED_PATH=$STAGE_ROOT/RB/RB/bin:$STAGE_ROOT/PF/platform/bin
# Temp binaries path
export IRB_TMP_PATH=$TMP_ROOT/PF/platform/bin

# Installed libpaths
export IRB_INSTALLED_LIBS=$INFINYS_ROOT/RB/lib:$INFINYS_ROOT/PF/lib:$INFINYS_ROOT/IS/lib
# Staged libpaths
export IRB_STAGED_LIBS=$STAGE_ROOT/RB/RB/lib:$STAGE_ROOT/PF/platform/lib:$STAGE_ROOT/IS/IS/lib
# Temp libpaths
export IRB_TEMP_LIBS=$TMP_ROOT/PF/platform/lib

# Base path
export PATH=/sbin:/usr/sbin:/usr/bin:/usr/ccs/bin:/sbin:/bin:/usr/local/bin:.:$ORACLE_HOME/bin:$JAVA_HOME/bin:$PATH
# Base libpath
export SHLIB_PATH=$ORACLE_HOME/obackup/lib:$ORACLE_HOME/lib:$SHLIB_PATH

######################################################################
# Export paths in RUNTIME mode i.e. installed/tmp/staged
######################################################################
export PATH=$PATH:$IRB_INSTALLED_PATH:$IRB_TMP_PATH:$IRB_STAGED_PATH
export SHLIB_PATH=$SHLIB_PATH:$IRB_INSTALLED_LIBS:$IRB_TEMP_LIBS:$IRB_STAGED_LIBS

######################################################################
# Export paths in UPGRADE mode i.e. tmp/staged/installed
######################################################################
# export PATH=$PATH:$IRB_TMP_PATH:$IRB_STAGED_PATH:$IRB_INSTALLED_PATH
# export SHLIB_PATH=$SHLIB_PATH:$IRB_TEMP_LIBS:$IRB_STAGED_LIBS:$IRB_INSTALLED_LIBS
}}}
From 4.0 Upgrade PDF:
!!!Pre upgrade
The path ($PATH) environment variable must be re-organized to ensure the correct
order of executed during upgrade. The paths must be configured in the following
order:
{{{
A $TMP_ROOT/&lt;component&gt;/&lt;installable&gt;/bin
B $STAGE_ROOT/&lt;component&gt;/&lt;installable&gt;/bin
C $INFINYS_ROOT/&lt;component&gt;/bin
}}}
The library path ($~LD_LIBRARY_PATH or $LIBPATH) environment variable must be
re-organized to ensure the correct order of executed during upgrade. The library paths
must be configured in the following order:
{{{
A $TMP_ROOT/&lt;component&gt;/&lt;installable&gt;/lib
B $STAGE_ROOT/&lt;component&gt;/&lt;installable&gt;/lib
C $INFINYS_ROOT/&lt;component&gt;/lib
}}}

!!!Post upgrade
After an upgrade, the infinys.env file must be modified to re-organize the path ($PATH)
and library path ($~LD_LIBRARY_PATH or $LIBPATH) environment variables to ensure
the correct order of executed whilst Infinys is running:
* For the path environment variable, the paths must be configured in the following order:
{{{
A $INFINYS_ROOT/&lt;component&gt;/bin
B $TMP_ROOT/&lt;component&gt;/&lt;installable&gt;/bin
C $STAGE_ROOT/&lt;component&gt;/&lt;installable&gt;/bin
}}}
*For the relevant library path environment variable, the paths must be configured in the following order:
{{{
A $INFINYS_ROOT/&lt;component&gt;/lib
B $TMP_ROOT/&lt;component&gt;/&lt;installable&gt;/lib
C $STAGE_ROOT/&lt;component&gt;/&lt;installable&gt;/lib
}}}</pre>
</div>
<div title="PCI Encryption" modifier="colm" created="201005190824" modified="201005190937" changecount="3">
<pre>!!How to disable

1) using the attached scripts (check out the readme file included in the zip) – safest way, or for clean installs you can

2) editing the RB/RB/schema/install/build.xml file directly to switch off encryption. Note you would do this before the install, not after!

e.g, set the encryptionEnabled=&quot;true&quot; to encryptionEnabled=&quot;false&quot;
{{{
    &lt;echo message=&quot;Register RB with Platform Data Security&quot; /&gt;

    &lt;cvgRegisterWithDataSecurity id=&quot;000110&quot; component=&quot;RB&quot;/&gt;

    &lt;echo message=&quot;Register NPCI fields with Platform&quot; /&gt;

    &lt;cvgAddMaskedField id=&quot;000091&quot; fieldName=&quot;RB_HOLDINGACCOUNT_BANK_ACCOUNT_NUMBER&quot;
                 encryptionEnabled=&quot;true&quot; dataDisplayDirection=&quot;FROM_RIGHT&quot;
                 numCharsToShow=&quot;4&quot; maskCharacter=&quot;*&quot; infinysUser=&quot;Installer&quot;&gt;
    &lt;/cvgAddMaskedField&gt;

    &lt;cvgAddMaskedField id=&quot;000092&quot; fieldName=&quot;RB_PRMANDATE_BANK_ACCOUNT_NUMBER&quot;
                 encryptionEnabled=&quot;true&quot; dataDisplayDirection=&quot;FROM_RIGHT&quot;
                 numCharsToShow=&quot;4&quot; maskCharacter=&quot;*&quot; infinysUser=&quot;Installer&quot;&gt;
    &lt;/cvgAddMaskedField&gt;

    &lt;cvgAddMaskedField id=&quot;000093&quot; fieldName=&quot;RB_PRMANDATE_CARD_NUMBER&quot;
                 encryptionEnabled=&quot;true&quot; dataDisplayDirection=&quot;FROM_RIGHT&quot;
                 numCharsToShow=&quot;4&quot; maskCharacter=&quot;*&quot; infinysUser=&quot;Installer&quot;&gt;
    &lt;/cvgAddMaskedField&gt;
}}}

NB - Incanto is just an OSS agile framework for Oracle sqlplus and login tasks. It calls some ipf_admin packages:

{{{
SQL&gt; desc ipf_admin.data_security_mask.DELETEMASKEDFIELD_1
Parameter     Type     Mode Default? 
------------- -------- ---- -------- 
P_FIELDNAME   VARCHAR2 IN            
P_INFINYSUSER VARCHAR2 IN   
}}}

Find encrypted fields with:
{{{
select *
from ipf_admin.pvsysregcontextvalue sr
where context like '%EncryptionEnabled%'

CONTEXT                                                                                              VALUE
---------------------------------------------------------------------------------------------------- ----------------------------------------
/Infinys/Security/Masking/RB_HOLDINGACCOUNT_BANK_ACCOUNT_NUMBER/EncryptionEnabled                    true
/Infinys/Security/Masking/RB_PRMANDATE_BANK_ACCOUNT_NUMBER/EncryptionEnabled                         true
/Infinys/Security/Masking/RB_PRMANDATE_CARD_NUMBER/EncryptionEnabled                                 true
}}}</pre>
</div>
<div title="PDC business goals notes" modifier="colm" created="201005191016" modified="201005191016" changecount="3">
<pre>!!!Q2 2010
* pre-identify cloning as a problem for EON
* work to get encryption stuff sorted for O2 - CVG networking
* lessons learned for VDC</pre>
</div>
<div title="PGA and hash joins" creator="colm" modifier="colm" created="201204051329" modified="201204052024" changecount="6">
<pre>Sorting has ONLY 3 modes
- ''optimal'' or cache (all in memory)
- ''1 pass'' (the entire result set is written once to disk)
- ''multi-pass'' (the entire result set is written multiple times to disk)

* optimal is by far the best
* avoid select * and adding literal strings to selects
* The maximum PGA workarea is hard limited to 5% of pga_aggregate_target or a max of 100Mb
** Can be controlled with _smm_max_size -  Value is in KB !
* One process can have many workareas 
** Max total size can be controlled with _pga_max_size
** Value is in bytes, default 200Mb

From ixora: ''Hash join performance''
//Which type of join is faster - hash join, or nested loops - and why?//
* Hash join uses the smaller input to build a hash table and the larger to probe it. Its performance is highly sensitive to the hash_area_size and the hash_multiblock_io_count parameters. The number of partitions into which the hash table is divided is inversely proportional to the I/O size. If any of the partitions do not fit into the hash_area_size the performance will degrade badly. If memory is scarce you must use a small I/O count, despite that that makes the I/O less efficient. But assuming you don't make these mistakes, hash join will outperform nested loops every time in both the number of I/Os required and the number of join key comparisons. Nested loops will however win in terms of the FIRST_ROWS response time.
 
//When you say partitions, what exactly are you referring to. Also, is there a recommended size for the hash_area_size and hash_multiblock_io_count?//
*The partitions in this case are just parts of the dynamically constructed hash table for the hash join. If Oracle cannot keep the whole hash table in memory, then it will write all the partitions that do not fit to a temp segment, and similarly the probe input data that needs to be joined thereto. Where it really goes badly is when a single partition will not fit, because then it needs to be repartitioning and recursively joined. However, there is lots of hidden intelligence working for you here. For example, probe inputs are checked against a bitmap of hash values and only retained if they will be able to be joined. Also, when revisiting a hash table partition and the corresponding dynamic partition of the probe input, Oracle will dynamically reverse the role of the build and probe inputs if better performance can be obtained that way. There is a really helpful trace to show you exactly what is going on with a hash join so you can see all this happening. You can enable it with:

{{{alter session set events '10104 trace name context forever';}}}

Your hash area size must take lots of factors into account: how much memory you have, how much data you are joining, how critical the query response time is relative to other work on the server, and so on. But, if you want a hash join to fly, make your hash area size slightly larger than the size of the smaller input and use a multiblock I/O count equivalent to 64K. </pre>
</div>
<div title="PL/SQL compile" creator="colm" modifier="colm" created="201106301213" modified="201108221533" changecount="2">
<pre>Visibility of errors often seems to be in scope of owner - re-log on iof nothing is appearing...
{{{
alter package IPGCUSTOMERACTIVITYREPORTS compile;
alter package IPGCUSTOMERACTIVITYREPORTS compile body;
sho errors

ALTER SESSION SET PLSQL_WARNINGS='DISABLE:ALL';
}}}</pre>
</div>
<div title="PageTemplate" modifier="TiddlyThemes" created="200701130013" modified="200708091512" tags="BlackicityTheme" server.type="file" server.host="http://tiddlythemes.com/empties/Blackicity.html" server.page.revision="200708091512">
<pre>&lt;!--{{{--&gt;

&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Parallel SQL" creator="colm" modifier="colm" created="201201121159" modified="201201121619" changecount="2">
<pre>Some required reading for this:

[[Randolf Geists Parallel Execution|http://oracle-randolf.blogspot.com/2011/02/things-worth-to-mention-and-remember-i.html]]
[[Doug Burns Stats on PX objects|http://oracledoug.com/serendipity/index.php?/archives/1562-Statistics-on-Partitioned-Tables-Part-1.html]]</pre>
</div>
<div title="Pasword check SQL" creator="colm" modifier="colm" created="201202280947" modified="201202280951" changecount="2">
<pre>From RBIUH:
{{{
stty -echo
echo
echo &quot;Enter the Oracle system password&quot;
read answer
export ORA_SYS_PWD=$answer
stty echo
#Check whether the password entered is valid or not.
if [[ &quot;`echo 'exit;' | ${ORAHOME}/bin/sqlplus sys/${ORA_SYS_PWD}@${Two_Task} as sysdba | fgrep Connected`&quot; = &quot;&quot; ]]; then
	echo &quot;[WARN]   sys password entered is not valid.&quot;
	exit
fi
}}}</pre>
</div>
<div title="Permissions on performance views" modifier="colm" created="200907201117" modified="201108121857" tags="PL/SQL permissions perms session view" changecount="8">
<pre>Remember that permission on an object must be explicitly granted to the user - they cannot be acquired via a role. Also note, the v$ views are dynamic synonyms - to grant perms use their underscore form - the following should allow GA useful admin views.
{{{
grant select on v_$session to geneva_admin;
grant select on v_$process to geneva_admin;
grant select on v_$session_wait to geneva_admin;
grant select on v_$sql to geneva_admin;
grant select on v_$sqlarea to geneva_admin;
grant select on v_$sql_plan to geneva_admin;

grant select on gv_$session to geneva_admin;
grant select on gv_$process to geneva_admin;
grant select on gv_$session_wait to geneva_admin;
grant select on gv_$sql to geneva_admin;
grant select on gv_$sqlarea to geneva_admin;
grant select on gv_$sql_plan to geneva_admin;

-- to allow @free diskspace query
grant select on sys.dba_objects to geneva_admin;
grant select on sys.dba_segments to geneva_admin;
grant select on sys.dba_data_files to geneva_admin;
grant select on sys.dba_temp_files to geneva_admin;
grant select on sys.dba_free_space to geneva_admin;

-- for some ICE installs
grant create public synonym to geneva_admin;
}}}</pre>
</div>
<div title="Phone numbers" creator="colm" modifier="colm" created="201201111409" modified="201206141339" changecount="9">
<pre>''UK Free:	0808 234 8430''
''London 	0203 107 0290 ''

|Alex|75245|
|David W|75022|</pre>
</div>
<div title="Physical pagesize in HP-UX" creator="colm" modifier="colm" created="201202061110" changecount="1">
<pre>From man page:
{{{
sz             The size in physical pages of the core image of
               the process, including text, data, and stack
               space.  Physical page size is defined by
               _SC_PAGE_SIZE in the header file &lt;unistd.h&gt; (see
               sysconf(2) and unistd(5)).

time           The cumulative execution time for the process.

vsz            The size of the process in (virtual) memory in
               kilobytes (1024 byte units).
}}}
{{{
PGSIZE=$(kctune base_pagesize | tail -1 | tr -s &quot; &quot; | cut -d' ' -f2)
print Got pagesize ${PGSIZE}K
}}}</pre>
</div>
<div title="Port Numbers" modifier="colm" created="201009011001" changecount="1">
<pre>Ports		Service Name	
-------------------------------------------------------------------------------
20,21		FTP 
22		SSH
23		telnet
137-9		Samba
1521-5	Oracle listener
6000-6010	X (Infinys GUI installer)
8030-8060	Geneva System Monitor</pre>
</div>
<div title="Process status" modifier="colm" created="201102041631" modified="201102041631" changecount="2">
<pre>Value  	Value Description

1 	Running. The process is running normally. 

2 	Paused. The process is in the paused state. 

3 	Stopped - Requested by user. The process stopped beforce completing its work, at the request of a user. 

4 	Stopped - Timed out. The process stopped before completing its work because the maximum running time allotted to it was exceeded. 

5 	Hard Stopped - Requested by user. Either the user requested an immediate stop, or the user requested a convenient stop, but the process did not do so within the allowable grace period defined in the GParam SYSconvenientGracePeriod, and was therefore terminated abruptly. 

6 	Hard Stopped - Timed out. The process exceeded its maximum running time and the allowable grace period, and was therefore terminated abruptly. 

7 	Success. Process was completely successful. No runtime errors occurred. 

8 	Finished. Process completed normally in a controlled manner, attempted all its work but some errors occurred. An example use of this would be a Billing Engine run that encountered some errors resulting in the failure to produce bills for particular accounts. This status requires investigation. 

9 	Failed. Process completed prematurely due to some error without being able to attempt all its work, but exited in a controlled manner. This is some fundamental problem that affects the processing as a whole. Examples could be missing or inconsistent configuration data, disk full, or serious integrity failures. This status requires investigation. The process will also indicate the final error that caused it to exit, and whether it should be retried or not. 

10 	Unfinished. Written by the Task Master when it recieved notification of a Volume Processing Application which terminated but did not update the database to indicate its final status. This implies that the Volume Processing Application has crashed. 

11 	Did not start. Written by the Task Master when it receives notification of a Volume Processing Application which terminated but never connected to the database. This could arise by some failure within the Volume Processing Application before connecting to the database. However, it is more likely to arise because the process could not be executed, for example it was missing, or it existed but the Task Master did not have execute permission for it. 

NULL 	Initial value. </pre>
</div>
<div title="RATE deadlocks &amp; RTDP" modifier="YourName" created="201001110916" modified="201001110919" changecount="3">
<pre>From Michael Evans:

//Yes duplicate checking is in a separate transaction to the rating of an event - and it is a known issue that if rating aborts completely during the latter the former is not undone: if the envelope simply fails or rating is asked to terminate it attempts to remove the duplicate entries for the envelope (which it keeps in a list in memory). But once it has stopped processing it currently has no way to identify and remove duplicatecheck entries for events it didn't rate.//

And Chris Dale:

//Stop Convenient tells Rate to commit the current envelope and then exit – as such, this is not a problem.

For a Stop Immediate, RATE is supposed to rollback the current transaction – but the insert to duplicatecheck is already committed. This has been solved by RATE keeping a list of the last batch to be inserted and rolling that back – this was done under PR26514.

This still leaves the case where a core dump occurs, or someone does a kill -9 (never recommended) or kills the oracle session.  In all 3 cases, the process doesn’t get a chance to backout the work it has done. This is the topic of CR29718 – but this has never been sponsored by a client to be implemented and so has never been done//</pre>
</div>
<div title="RB - Advanced Queues" creator="YourName" modifier="YourName" created="201401271000" changecount="1">
<pre>Extract from Support item 5968459 - http://intranet.emea.convergys.com/prd/ice/iain/show_comments.php?item=5968459

best to answer the questions in order:
1) number of events in a message. The number of events will be controlled by the commitSize to a degree - but can be higher if:
a) event fragmenting is in use (eventtype.output_fragments_boo = T)
b) multiparty events are in use.
In such cases, the number of events will increase based upon the amount of extra events that will be generated by this.
There is no configurable way to prevent this - we always commit 1 envelope to 1 message.

2) I don't believe we have any other software that would write a message and say that it was the RATE application - so it is safe to assume that the only case where you would have a message of type Insert with Application Rate is when rating has just rated some events.

3) Best you actually look at the contents of the subscriber view on any queue. You always get at least 2 since you have to have an exception queue (and a default one is always created). We don't do anything explicit in this manner (but you can do to specify something other than the default).

4) There is no right answer - as you say, the CEW sets the no_wait flag and traps the resultant error and then sleeps in its own application logic - I prefer this as you have more control over behaviour - but it is up to BT as to what they want the application to actually do.

5) No other applications will be delayed in the way that BG is - but if CEW is not up-to-date you will have some oddities - e.g. if you move events due to changing next_bill_dtm, the system will be in an unsynchronised state until CEW has completed (events in CE will be on the wrong event_seq) - essentially, when queues are enabled, the movement of events is asynchronous as the API does not do the work (unlike when queues are not in use).

Note - the only viable technology that can be used to dequeue messages is OCI - this is because all other interfaces have an Oracle induced limit of 32K on the message size and this is very quickly exceeded if your commitSize is &gt; 1.
</pre>
</div>
<div title="RB Trace" modifier="YourName" created="201011221059" modified="201402041014" changecount="7">
<pre>{{{
export TRACE_ALL=true
export TRACE_LEVEL = FULL
}}}

For discount errors:
{{{
TRACE_RATE ON
TRACE_DUL ON
TRACE_RDISC ON
}}}

!!Enabling options
The only ways to enable tracing on an RB application are:
1)       set TRACE_&lt;DOMAIN&gt; ON and TRACE_LEVEL FULL and restart TM - but this will cause all processes (including TM) to utilise these values
2)       set TRACE_LEVEL FULL and restart TM - since no domains are specified, no additional tracing will occur.  Then, insert rows into GERCONFIGURATION for individual domains you are interested in (ALL does not work as env variable TRACE_ALL would) and start the application you are interested in.
3)       Run the application that is problematic from the command line


{{{
insert into GERCONFIGURATION values ('ORACLE','ON',1,null);

insert into gerconfiguration (message_domain, trace_status, message_domain_type, message_domain_desc)
values ('DUL', 'ON', 1, 'Performance testing - inserted by CAM - 21APR2011');


 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------------
 MESSAGE_DOMAIN                            NOT NULL VARCHAR2(16)
 TRACE_STATUS                              NOT NULL VARCHAR2(3)
 MESSAGE_DOMAIN_TYPE                       NOT NULL NUMBER(2)
 MESSAGE_DOMAIN_DESC                                VARCHAR2(255)
}}}</pre>
</div>
<div title="Realtime" modifier="colm" created="200908111511" modified="200908111511" changecount="2">
<pre>Essentially, RTRI is the mechanism used - it is also part of the OLC solution, but OLC is more of an architecture.

Latencies:

* OLC - documented at 40ms but this is probably round trip from RATE via RTRI to Oracle and back - ignores the RTED and mediation layers which are significant. Joel S. is happier talking about numbers like 90% of events in 60-65ms.
* RTRI - around 300ms.

In general for 99.999% availability, OLC is our offering. Note this is only for the rating part of the solution. RTRI is suitable for 99.99% assuming adequate work has gone into failover support e.g. ServiceGuard, passive RAC etc.</pre>
</div>
<div title="Recompile Oracle objects" creator="colm" modifier="colm" created="201201181414" changecount="1">
<pre>Alternative for non-sys:
{{{
GENEVA_ADMIN@BTL31W22&gt; exec dbms_utility.compile_schema('GENEVA_ADMIN');
}}}</pre>
</div>
<div title="Remote Desktop" creator="colm" modifier="colm" created="201105051403" modified="201106281203" changecount="4">
<pre>{{{
%SystemRoot%\System32\mstsc.exe
}}}
!!!Shortcuts
~ALT-PgUp/Dn - ALT-tab
~Ctrl-Alt-Brk - toggle full screen</pre>
</div>
<div title="Repackage component zip" modifier="colm" created="200907161112" modified="201208301228" tags="irb install upgrade" changecount="7">
<pre>{{{
cd tmp
unzip ../stage/RB-3.0.27hI10g.zip
}}}
Carry out edits
{{{
zip -rv test.zip RB
}}}
Latter arg is the directory to zip up... if you need stuff in the current directory (a la PF), just do it at top level e.g:
{{{
&gt; ll
total 96
drwxrwxr-x   3 cdsinf50   infinys       1024 Apr  4 10:22 ./
drwxrwxrwx   9 cdsinf50   infinys       1024 Apr  4 10:08 ../
drwxr-xr-x   4 cdsinf50   infinys       1024 Apr 28  2011 PF/
-rw-r--r--   1 cdsinf50   infinys       9625 Apr 28  2011 build.xml
-rw-r--r--   1 cdsinf50   infinys       6219 Apr 28  2011 ut.properties
...
&lt;make changes&gt;
...
&gt;zip -rv new-PF.zip *
...
&gt; ll
total 213984
drwxrwxr-x   3 cdsinf50   infinys       1024 Apr  4 10:23 ./
drwxrwxrwx   9 cdsinf50   infinys       1024 Apr  4 10:08 ../
drwxr-xr-x   4 cdsinf50   infinys       1024 Apr 28  2011 PF/
-rw-r--r--   1 cdsinf50   infinys       9625 Apr 28  2011 build.xml
-rw-rw-r--   1 cdsinf50   infinys    109443134 Apr  4 10:23 new-PF.zip
-rw-r--r--   1 cdsinf50   infinys       6219 Apr 28  2011 ut.properties
}}}
Just extract the scripts area:
{{{
unzip -l new-pkgs/RB-5.3.3hI11g.zip RB/RB/schema/migration/scripts/*
}}}</pre>
</div>
<div title="Rerating events" modifier="colm" created="201101281411" modified="201101281438" changecount="6">
<pre>Events can need rerated for lots of reasons - see below. In general, this means running CEU (to remove events) and RATE (to reprice). BILLED events are handled by generating ANTI-EVENTS. Deleted events CANNOT be rerated...

Rows are written to RERATEREQUEST - status can be:
{{{
select count(*),
decode(nvl(rerate_request_status, 0),
0, 'NULL - initial value',
1, '1-In pending',
2, '2-In progress (ready for unloading)',
3, '3-Unloading failed',
4, '4-In progress (ready for rerating)',
5, '5-Rerating failed',
6, '6-Completed',
7, '7-Canceled') rrstatus
from reraterequest group by rerate_request_status;
}}}

Triggers:
- The start date or end date of a customer event source is changed.
- The rate plan or competitor rate plan associated with a customer event source is changed.
- The label of a customer event source is changed and the associated product's on-net match type is an event source label or both an event source label and an event source.
- A customer event source is changed or deleted.
- The event type of a customer event source is changed.
- An event guiding rule is created, modified, or deleted.
- An account is terminated.
- A customer product is moved to another account.
- An override rate is added to or removed from a customer product.
- An override rate for a customer product is modified.
- A customer subscription is moved to another account.
- A product event type is modified and the SYSuseDefaultRatingTariffBoo system parameter is set to T (true).
- A customer product or package is moved to a subscription.
- The price plan associated with a customer product is changed.
- Backdated changes are made to a customer event filter.
- Backdated changes are made to add-on rate plans.</pre>
</div>
<div title="Rerun Y9" creator="colm" modifier="colm" created="201106070934" modified="201202071428" changecount="6">
<pre>{{{
. $STAGE_ROOT/RB/RB/schema/migration/scripts/compareSchemaWithDump.sh 5_0E &quot;Rerun schema diff report&quot;
}}}
''NOTES''
* The letters here should refer to a schema dump that is in place under: {{{$STAGE_ROOT/RB/RB/schema/migration/scripts/schemadumps/combined}}}. Note the ''underscore'' between the version numbers.
* Has to be run from the scripts directory! Either install or migration..
* remember to add the required double quotes to line 101 of the script!
!!! Schema diffs
- An invalid PROCEDURE will not show up in dba_procedures - but will still show in dba_objects. So, use the latter to do comparisons.</pre>
</div>
<div title="Restart IRB" modifier="colm" created="200908030835" modified="201102080939" tags="irb recovery" changecount="8">
<pre>From RBM4.0 Admin &amp; Maint:

The script may need to perform the following actions:
* Remove the TASKMASTERACTIVE table entry, if present, to enable the Task Master to start.
* Cancel any BACKUPLOG table entry that does not have dates in the BACKUP_CONFIRMED_DTM or BACKUP_CANCELLED_DTM columns. This enables the Task Master to run tasks. The following circumstances might cause a backup to be incomplete:
** The backup was in progress when the system failed.
** The backup was created to ensure that the Task Master does not start any further task on shut-down. See &quot;Shut-Down Actions&quot; for further details.
* Change any rows in the JOB table that have a JOB_STATUS of 3 (being processed) to a JOB_STATUS of 6 (ready to be run again, after partial completion). 
* Change any rows in the JOBHASFILE table that have a JOB_FILE_STATUS of 2 (being processed) to a JOB_FILE_STATUS of 1 (awaiting processing).
* For all rows of the SCHEDULELOG, TASKLOG, PROCESSLOG, and PROCESSINSTANCELOG tables that do not have an END_DTM set, the END_DTM must be set. This ensures that System Monitor shows the process as being finished.
* If the Billing Engine is shut down unexpectedly, it can leave accounts with a billing status of BB (currently being billed). If the logs have an appropriate status value, when the Task Master starts the Billing Engine, those accounts have the status changed from BB (currently being billed) to OK (billable). However, if the Task Master is not being used or you want to recover the data before starting the Task Master, the script must run the Billing Engine in recovery mode, using the -m RECOVER command line parameter.

The preceding list is not exhaustive but is a good starting point for writing a data cleaning script.

~GPARAMs for auto-tidy:
* ~TMcleanupAbandonedProcessesBoo
* ~TMrecoverAbandonedProcessesBoo</pre>
</div>
<div title="Restarting a failed MigMgr session" modifier="colm" created="200908071026" modified="201303181122" changecount="12">
<pre> The buildFile/emea/ipg/working/~VDSI4101/infroot/stage/RB/RB/schema/migration/build_4_0.xml is already executing. Please check the status
{{{
GENEVA_ADMIN@VDSI4101&gt; select * from ipf_admin.systemregistryentry
where name like 'build_4_0%';
  2
        ID  PARENT_ID    VERSION NAME                                                              VALUE
---------- ---------- ---------- -------------------------------------------------------------------------- 
      3120       3100       6001 build_4_0_3_keymgmt_install_ingrian.xml                           completed
      3201       3100       6005 build_4_0_3_pci_km_create_tables.xml                              completed
      3202       3100       6009 build_4_0_3_pci_km_create_roles.xml                               completed
      3203       3100       6013 build_4_0_3_pci_km_synonyms.xml                                   completed
      3204       3100       6017 build_4_0_3_convert_encryption_key_map.xml                        completed
      5525       5524      15369 build_4_0_7_extensible_attr.xml                                   completed
      5526       5524      15373 build_4_0_7_audit_log_stored_proc.xml                             completed
      5532       5531      15401 build_4_0_9_3_caaf_install_java.xml                               completed
      5701       3070      15869 build_4_0.xml                                                     started
      5702       3070      15821 build_4_0_preMigrate.xml                                          completed
      5703       3070      15871 build_4_0_migrate.xml                                             started

select * from ipf_admin.systemregistryentry where ID in (5701, 5703);
update ipf_admin.systemregistryentry set value='failed' where ID in (5701, 5703);
commit;
}}}
or 
{{{
select * from ipf_admin.systemregistryentry where value like '%started%';
update ipf_admin.systemregistryentry set value='failed' where ID in (&lt;id&gt;, &lt;id&gt;);
}}}
!!!GNVSCHEMA
At Y9 failure, use: 
{{{
exec gnvschema.skipfailedscript; 
}}}
!!!Steve's note
If db_migrate_menu quits unexpectedly and the next time you run things you get the following:  
infroot/stage/RB/RB/schema/migration/build_4_2.xmlis already executing. Please check the status  
{{{
update PF_TASK_STATE set  TASK_STATE_IND=1 where TASK_STATE_IND=3;
update systemregistryentry set  name='build_4_2.xml1'  where name like 'build_4_2.xml';
}}}
Instead of 2 above – remove all systemregistryentries that point to Build_4_2.xml%
Or build_4_2_migrate.xml as indicated in original error message.

Actually don’t have to remove it just follow original instruction and add “1” to the xml to make it an invalid name.
</pre>
</div>
<div title="SQL profile" creator="colm" modifier="colm" created="201303141043" modified="201303141044" changecount="3">
<pre>See - http://kerryosborne.oracle-guy.com/2010/02/gather_plan_statistics/
And: http://intermediatesql.com/oracle/how-to-add-a-hint-to-oracle-query-without-touching-its-text/

slow SQL
{{{
SELECT COUNT(*)
FROM customer c, account a,
	(SELECT 1 FROM dual CONNECT BY LEVEL &lt;= 10000) x,
	(SELECT 1 FROM dual CONNECT BY LEVEL &lt;= 10000) y
WHERE c.customer_ref = a.customer_ref;
}}}
show components of plan
{{{
colu operation format A20
colu options format A25
colu object_name format A20
colu object_alias format A20
SELECT operation,options,object_name,object_alias
FROM v$sql_plan
WHERE sql_id='&amp;SQL_ID'
AND child_number=&amp;CHILD_NO;
}}}
dump extended hints: shows full format of e.g. index hint
{{{
select extractvalue(value(d), '/hint') as outline_hints
from xmltable('/*/outline_data/hint'
  passing (
    select xmltype(other_xml) as xmlval
    from v$sql_plan
    where sql_id='&amp;SQL_ID'
      and child_number = &amp;CHILD_NO
      and other_xml IS NOT NULL
  )
) d;
}}}
undocumented interface allows you to attach a new hint:
{{{
DECLARE
clsql_text CLOB;
BEGIN
SELECT sql_fulltext INTO clsql_text FROM v$sqlarea WHERE sql_id = '&amp;SQL_ID';

DBMS_SQLTUNE.IMPORT_SQL_PROFILE(
  sql_text =&gt; clsql_text,
  profile =&gt; sqlprof_attr('INDEX(@&quot;SEL$1&quot; T@&quot;SEL$1&quot; &quot;T_D_IDX&quot;)'),
  name =&gt; 'PROFILE_&amp;SQL_ID',
  force_match =&gt; TRUE
);
END;
/
}}}
check for extended stats:
{{{
set lines 180
select * from table(dbms_xplan.display_cursor('&amp;sql_id','&amp;child_no','allstats  +peeked_binds'))
/
}}}
drop a profile
{{{
EXEC dbms_sqltune.drop_sql_profile('PROFILE_&amp;SQL_ID');
}}}</pre>
</div>
<div title="SQL strip control characters" creator="colm" modifier="colm" created="201303151357" modified="201303181114" changecount="2">
<pre>Just CR/LFs:
{{{
select replace(replace(m.long_notes,chr(10),' '),chr(13),' ') from mytable m;
}}}
from http://andrewfraserdba.com/2010/06/08/chr13-chr10-carriage-return-line-feed-cr-lf/


{{{
select '|' || trim( val ) || '|' &quot;Trim&quot;,
       '|' || trim( regexp_replace( val, '[[:cntrl:]]+' ) ) || '|' &quot;Regexp&quot;
  from ( select '   abc   '|| chr(13) || chr(10) || chr(8) val 
           from dual
        );
}}}</pre>
</div>
<div title="SYSindividualLateBills" creator="YourName" modifier="YourName" created="201401301505" modified="201402061536" changecount="5">
<pre>RATE generates the event sequence of an event to classify that event for the appropriate bill. The event sequence is generated based on the event date and bill date of the account. BG picks up the events and assigns them to the appropriate bill.
RATE uses the account.rate_event_seq to generate the event sequence for rated events. It assigns the account.rate_event_seq to an event if the event date is before the bill date of account. If an event date falls after the bill date of account and SYSindividualLateBillsBoo is off, then RATE assigns account.rate_event_seq + 1 to to all the events irrespective of the bills. If SYSindividualLateBills is on, RATE will us an event sequence that is incremented based on the number of bill cycles that fall between the nominal bill date and the event date.

As we know if the NBD is passed without the bill being generated, RATE will start to assign ~RATE_EVENT_SEQ+1 etc ot make sure events go to the correct bill event_seq.

If SYSindividualLateBills is false, all will get just +1 - otherwise RATE will calculate out the actual ~EVENT_SEQ required.

Remember: EventTidemark is used to determine if 
* the bill period to use is the latest bill period [~EventTidemark == ACTUAL]
* the first bill period that ends after the event date time [~EventTidemark == NOMINAL].)

Also, tidemark is set by account -&gt; ico -&gt; system, whichever is lowest... Check ~AccountDetails.event_tidemark:
1              Use nominal billing date.
2              Use actual billing date.
</pre>
</div>
<div title="Script via System Monitor" creator="colm" modifier="colm" created="201108121401" modified="201108121411" changecount="5">
<pre>Pass args either from command line or SM - if passed from SM they will arrive in arg #14 - otherwise arg #1 as usual.
{{{
if [ $# -eq 1 ]
then
    # called from command line
    doWork $1
else
    if [ $# -eq 14 ]
    then
        #called from TM
        doWork ${14}
    else
        echo &quot;ERROR: Expecting arguments: Parallelism, Commit Size, Days Until Delete, Ico&quot;        
        exit 1
    fi
fi
}}}

If you set some args in the parameters field of processplan these are passed first, followed by those typed in at the Task prompt - avoid the latter by toggling prompt_for_params_boo in ~processdefinition... Stdout will go to the &lt;PID&gt;.log file under the usual logging place...
{{{
insert into processdefinition (	PROCESS_DEF_ID, IMAGE_NAME, INITIALISE_PHASE_BOO, COMPLETION_PHASE_BOO, 
					RECOVER_PHASE_BOO, PARALLEL_BOO, DETERMINE_COUNT_BOO, PARAMETER_MASK, 
					WORK_UNIT, RETRY_LIMIT, EXIT_STATUS_ONLY_BOO, PARAMS_REQUIRED_BOO, 
					PROMPT_FOR_PARAMS_BOO, PARAMS_DESC, LOG_ATTR_1_NAME, LOG_ATTR_2_NAME, 
					LOG_ATTR_3_NAME, LOG_ATTR_4_NAME, LOG_ATTR_5_NAME, LOG_ATTR_6_NAME, 
					LOG_ATTR_7_NAME, LOG_ATTR_8_NAME, LOG_ATTR_9_NAME, LOG_ATTR_10_NAME, 
					LOG_ATTR_11_NAME, LOG_ATTR_12_NAME, LOG_ATTR_1_UNITS, LOG_ATTR_2_UNITS, 
					LOG_ATTR_3_UNITS, LOG_ATTR_4_UNITS, LOG_ATTR_5_UNITS, LOG_ATTR_6_UNITS, 
					LOG_ATTR_7_UNITS, LOG_ATTR_8_UNITS, LOG_ATTR_9_UNITS, LOG_ATTR_10_UNITS, 
					LOG_ATTR_11_UNITS, LOG_ATTR_12_UNITS, GENEVA_DATABASE, PAUSE_BOO, CONVENIENT_STOP_BOO)
values (510, 'GCEdeleteBillData.sh', 'F', 'F',
			'F', 'F', 'F', '&lt;1&gt; &lt;2&gt; &lt;3&gt; &lt;4&gt;',
			'Bills', 1, 'T', 'T',
			'T', 'Please enter the parallelism, commit size, days until delete and invoicing company id', '', '',
			'', '', '', '',
			'', '', '', '',
			'', '', '', '',
			'', '', '', '',
			'', '', '', '',
			'', '', 'GENEVA', 'F', 'F');

insert into task (TASK_ID, TASK_NAME, REQUESTABLE_BOO, TASK_DESC, RUN_AT_STARTUP_BOO, MAX_RUN_TIME)
values (51, 'GCEdeleteBillData', 'T', '', 'F', null);

insert into processplan (PROCESS_DEF_ID, PLAN_NUMBER, START_DAT, PROCESS_PLAN_NAME, 
				PROCESS_PLAN_DESC, PARALLELISM, PARAMETERS, PROCESS_COUNT, 
				USED_COUNT, LAST_WORK_DONE, JOB_PRIORITY, DAEMON_BOO, 
				POLLING_DELAY, MAX_RUN_TIME, REMOTE_HOST, CACHE_STATS_UPDATE_DELAY)
values (510, 1, to_date('01-08-2010', 'dd-mm-yyyy'), 'GCEdeleteBillData', 
				'', 1, '', 1,
				13, 0, null, 'F',
				null, null, '', null);

insert into taskhasprocessplan (TASK_ID, EXECUTION_ORDER, PROCESS_DEF_ID, PLAN_NUMBER)
values (51, 0, 510, 1);
}}}</pre>
</div>
<div title="Show explain plan" creator="colm" modifier="YourName" created="201203201335" modified="201309091047" changecount="3">
<pre>{{{
select * from table(dbms_xplan.display_cursor('33wqw5qvawa92', null)); -- null the child num else assumes 0

-- after explain plan for...
select * from table(dbms_xplan.display)

select * from table (dbms_xplan.display(null, null, 'advanced'))
-- table_name, stmt_id, format, filter_preds

-- from script
alter session force parallel DDL;
alter session force parallel DML;
alter session force parallel query;

explain plan for
INSERT /*+ append parallel(thrf) */ INTO tariffhasratingtariff thrf
   (SELECT /*+ parallel (bck,8) */ tariff_id, rating_tariff_id, catalogue_change_id
      FROM tariffhasratingtariff_bck bck
     WHERE bck.catalogue_change_id = gnvgen.liveBillingCatalogueID ('ZAR'));

select * from table(dbms_xplan.display);

}}}</pre>
</div>
<div title="Signalling VPAS" modifier="colm" created="200908051321" modified="200908171036" changecount="4">
<pre>Sending SIGINT to TM to close it down:
{{{
cdsinf40[VDSI4101]/emea/ipg/working/VDSI4101/infroot&gt; ps -ef | grep TM
cdsinf40 27538     1  0 14:02:11 pts/0     0:00 TM -u geneva_admin -s vdsi4101
cdsinf40 27925 24667  0 14:17:51 pts/0     0:00 grep TM
cdsinf40[VDSI4101]/emea/ipg/working/VDSI4101/infroot&gt; kill -INT 27538
cdsinf40[VDSI4101]/emea/ipg/working/VDSI4101/infroot&gt; Signal 2 received - Task Master is exiting
}}}
According to 4.0 docs (4.0.8 Release Notes - docs errata - PR 45004), signals are:
|Stop convenient|SIGINT||
|Stop immediate|SIGTERM||
|Pause|SIGTSTP||
|Resume|SIGCONT||
|Recache|SIGUSR1|Only for RATE to reload caches|
|Timeout|SIGALRM|Used by TM - like conv stop but recorded as timeout|
From HP-UX man pages:
| signum|signame   |Name            |Description|
|      0|    SIGNULL |  Null            |Check access to pid|
|     1|   SIGHUP   | Hangup          |Terminate; can be tapped|
|      2|    SIGINT   | Interrupt      |Terminate; can be trapped|
|      3|    SIGQUIT |  Quit          |Terminate with core dump; can be trapped|
|      9|    SIGKILL  | Kill            |Forced termination; cannot be trapped|
|     15|     SIGTERM |  Terminate      |Terminate; can be trapped|
|     24|     SIGSTOP  | Stop            |Pause the process; cannot be trapped|
|     25|     SIGTSTP   | Terminal stop   |Pause the process; can be trapped|
|     26|     SIGCONT   | Continue        |Run a stopped process|</pre>
</div>
<div title="SiteSubtitle" modifier="colm" created="200907151150" changecount="1">
<pre></pre>
</div>
<div title="SiteTitle" modifier="colm" created="200907151150" changecount="1">
<pre>localnotes</pre>
</div>
<div title="Sizing - minimum inputs" creator="colm" modifier="colm" created="201204191406" changecount="1">
<pre>An indicative sizing using the standard inputs questionnaire is always recommended. However the following metrics are the absolute minimum that can be used to produce a very high level indicative sizing, such as those required for RFI responses. 
!!!RBM Database Metrics
Total number of customers	
Average number of accounts per customer	
Average number of events per account per month (events = entity to be rated)	
Size of the input event file (in bytes)?	
% of events that are messaged based (real-time)?	
% of events that are file based (batch)?	
Number of days events are to be held online in the solution?	
Rating operations workload i.e. one a day for 12 hours	
% of accounts billed in the largest bill run	
Longest allowable bill run elapsed time (in hours)	
Account billing frequency e.g. weekly, monthly, quarterly	
Concurrency: Rating and billing run at same time or kept separate?	
Integrating using ECA or PL/SQL?	
Number of CSR contact minutes per account per month	
!!!Hardware Requirements
High availability required?	
Hardware platform &amp; operating system e.g. SUN/Solaris, HP/HP-UX, Intel/Linux etc.	
Traditional deployment or distributed (more, smaller, servers)	

Any additional information that can be provided should be included.</pre>
</div>
<div title="Sizing notes" modifier="colm" created="200909211425" changecount="1">
<pre>Mostly from Simon/Saylesh.

* No VPAs other than RATE and BG are taken into account
* RATE was heavily optimised for DRP but not so BG - it is more hurt by network roundtrips.</pre>
</div>
<div title="StyleSheet" modifier="YourName" created="200701130013" modified="201402101554" tags="BlackicityTheme" server.type="file" server.host="http://tiddlythemes.com/empties/Blackicity.html" server.page.revision="200708091512" changecount="9">
<pre>/*{{{*/
/*Blackicity Theme for TiddlyWiki*/
/*Design and CSS by Saq Imtiaz*/
/*Version 1.0*/
/*}}}*/
/*{{{*/
body{	font-family: &quot;Neue Helvetica&quot;, Helvetica, &quot;Lucida Grande&quot;, Verdana, sans-serif;
	background-color: #fff;
	color: #333;}

#topMenu {position:relative; background:#282826; padding:10px; color:#fff;font-family:'Lucida Grande', Verdana, Sans-Serif;}
#topMenu br {display:none;}

#topMenu a{			color: #999;
			padding: 0px 8px 0px 8px;
			border-right: 1px solid #444;}
#topMenu a:hover {color:#fff; background:transparent;}

#displayArea {margin-left:1em; margin-bottom:2em; margin-top:0.5em;}


a, a:hover{
color:#333;
text-decoration: none;   background:transparent; 
}

.viewer a, .viewer a:hover {border-bottom:1px dotted #333; font-weight:bold;}


.viewer .button, .editorFooter .button{
color: #333;
border: 1px solid #333;
}

.viewer .button:hover,
.editorFooter .button:hover, .viewer .button:active, .viewer .highlight,.editorFooter .button:active, .editorFooter .highlight{
color: #fff;
background: #333;
border-color: #333;
}

.tiddler .viewer {line-height:1.45em;}
.title {color:#222; border-bottom:1px solid#222; font-family:'Lucida Grande', Verdana, Sans-Serif; font-size:1.5em;}
.subtitle, .subtitle a { color: #999999; font-size: 0.95em;margin:0.2em;}
.shadow .title{color:#999;}

.toolbar {font-size:90%;}
.selected .toolbar a {color:#999999;}
.selected .toolbar a:hover {color:#333; background:transparent;border:1px solid #fff;}

.toolbar .button:hover, .toolbar .highlight, .toolbar .marked, .toolbar a.button:active{color:#333; background:transparent;border:1px solid #fff;}

/***
!Sidebar
***/
#sidebar { margin-bottom:2em !important; margin-bottom:1em; right:0;
}

/***
!SidebarOptions
***/
#sidebarOptions { padding-top:2em;background:#f3f3f3;padding-left:0.5em;}

#sidebarOptions a {
			color:#333;
                        background:#f3f3f3;
                        border:1px solid #f3f3f3;
			text-decoration: none;
}

#sidebarOptions	a:hover, #sidebarOptions a:active {
			color:#222;
			background-color:#fff;border:1px solid #fff;
		}

#sidebarOptions input {border:1px solid #ccc; }

#sidebarOptions .sliderPanel {
	background: #f3f3f3; 	font-size: .9em;
}

#sidebarOptions .sliderPanel input {border:1px solid #999;}
#sidebarOptions .sliderPanel .txtOptionInput {border:1px solid #999;width:9em;}

#sidebarOptions .sliderPanel a {font-weight:normal; color:#555;background-color: #f3f3f3; border-bottom:1px dotted #333;}


#sidebarOptions .sliderPanel a:hover {
color:#111;
background-color: #f3f3f3;
border:none;
border-bottom:1px dotted #111;
}
/***
!SidebarTabs
***/
 .listTitle {color:#222;}
#sidebarTabs {background:#f3f3f3;}

#sidebarTabs .tabContents {background:#cfcfcf;}

#sidebarTabs .tabUnselected:hover {color:#999;}

#sidebarTabs .tabSelected{background:#cfcfcf;}

#sidebarTabs .tabContents .tiddlyLink, #sidebarTabs .tabContents .button{color:#666;}
#sidebarTabs .tabContents .tiddlyLink:hover,#sidebarTabs .tabContents .button:hover{color:#222;background:transparent; text-decoration:none;border:none;}

#sidebarTabs .tabContents .button:hover, #sidebarTabs .tabContents .highlight, #sidebarTabs .tabContents .marked, #sidebarTabs .tabContents a.button:active{color:#222;background:transparent;}

#sidebarTabs .txtMoreTab .tabSelected,
#sidebarTabs .txtMoreTab .tab:hover,
#sidebarTabs .txtMoreTab .tabContents{
 color: #111;
 background: #f3f3f3; border:1px solid #f3f3f3;
}

#sidebarTabs .txtMoreTab .tabUnselected {
 color: #555;
 background: #AFAFAF;
}



/***
!Tabs
***/
.tabSelected{color:#fefefe; background:#999; padding-bottom:1px;}
 .tabSelected, .tabSelected:hover {
 color: #111;
 background: #fefefe;
 border: solid 1px #cfcfcf;
}

 .tabUnselected {
 color: #999;
 background: #eee;
 border: solid 1px #cfcfcf;
 padding-bottom:1px;
}
.tabUnselected:hover {text-decoration:none; border:1px solid #cfcfcf;}
.tabContents {background:#fefefe;}





.tagging, .tagged {
border: 1px solid #eee;
background-color: #F7F7F7;
}

.selected .tagging, .selected .tagged {
background-color: #f3f3f3;
border: 1px solid #ccc;
}

.tagging .listTitle, .tagged .listTitle {
color: #bbb;
}

.selected .tagging .listTitle, .selected .tagged .listTitle {
color: #333;
}

.tagging .button, .tagged .button {
color:#ccc;
}
.selected .tagging .button, .selected .tagged .button {
color:#aaa;
}

.highlight, .marked {background:transparent; color:#111; border:none; text-decoration:underline;}

.tagging .button:hover, .tagged .button:hover, .tagging .button:active, .tagged .button:active {
border: none; background:transparent; text-decoration:underline; color:#333;
}



.popup {
background: #cfcfcf;
border: 1px solid #333;
}

.popup li.disabled {
color: #000;
}

.popup li a, .popup li a:visited {
color: #555;
border: none;
}

.popup li a:hover {
background: #f3f3f3;
color: #555;
border: none;
}



#messageArea {

border: 4px dotted #282826;
background: #F3F3F3;
color: #333;
font-size:90%;
}

#messageArea a:hover { background:#f5f5f5; border:none;}


#messageArea .button{
color: #333;
border: 1px solid #282826;
}

#messageArea .button:hover {
color: #fff;
background: #282826;
border-color: #282826;
}






.tiddler {padding-bottom:10px;}

.viewer blockquote {
border-left: 5px solid #282826;
}

.viewer table, .viewer td {
border: 1px solid #282826;
}

.viewer th, thead td {
background: #282826;
border: 1px solid #282826;
color: #fff;
}
.viewer pre {
border: 1px solid #ccc;
background: #f5f5f5;
font-size:1.1em;
}

.viewer code {
color: #111; background:#f5f5f5;
font-size:1.0em;
}

.viewer hr {
border-top: dashed 1px #222; margin:0 1em;
}

.editor input {
border: 1px solid #ccc; margin-top:5px;
}

.editor textarea {
border: 1px solid #ccc;
}

h1,h2,h3,h4,h5 { color: #282826; background: transparent; padding-bottom:2px; font-family: &quot;Lucida Grande&quot;, Verdana, sans-serif; }
h1 {font-size:18px;}
h2 {font-size:16px;}
h3 {font-size: 14px;}
/*}}}*/</pre>
</div>
<div title="Subversion" creator="colm" modifier="colm" created="201210151258" changecount="1">
<pre>SVN ID :: cmccarta
Passwd :: cmccarta

change your default password: http://craze:3343/csvn 

svn co http://svnserver:8080/svn/bt_custom
svn list http://10.12.11.10:8080/svn/bt_custom

{{{
svn --version
svn list &lt;URL&gt;
svn checkout &lt;URL&gt;
svn status &lt;Directory_Path&gt;
svn copy &lt;URL&gt; &lt;URL&gt; -m &quot;Message&quot;
svn commit -m &quot;Message&quot;
svn add &lt;Filename&gt;
svn delete &lt;Filename&gt;
svn info &lt;Directory_Path&gt;
}}}</pre>
</div>
<div title="Supplemental Logging" creator="colm" modifier="colm" created="201302221608" changecount="1">
<pre>Caused: //ORA-31172: cannot load XMLType column using direct path// during PF install

To check if supplemental logging is enabled.
{{{
SELECT
    supplemental_log_data_min,
    supplemental_log_data_pk,
    supplemental_log_data_ui,
    supplemental_log_data_fk,
    supplemental_log_data_all
FROM v$database;
}}}
Fix: Disable supplemental logging.
{{{
ALTER DATABASE DROP SUPPLEMENTAL LOG DATA;
ALTER DATABASE DROP SUPPLEMENTAL LOG DATA (PRIMARY KEY) COLUMNS;
ALTER DATABASE DROP SUPPLEMENTAL LOG DATA (UNIQUE) COLUMNS;
ALTER DATABASE DROP SUPPLEMENTAL LOG DATA (FOREIGN KEY) COLUMNS;
ALTER DATABASE DROP SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
}}}
Supplemental logging is the process of adding additional column data to the redo log whenever an operation is performed (such as a row update). A capture process captures this additional information and places it in logical change records (LCRs). Apply processes that apply these LCRs might need this additional information to apply database changes properly.

Further information on supplemental logging can be found in Oracle Streams Replication Administrator's Guide 11g Release 2.</pre>
</div>
<div title="Support acronyms" modifier="YourName" created="200912031418" changecount="1">
<pre>PR = Problem Report (defect) raised in ChangeSynergy – i.e. a defect in RB/ECA or a few other related subsystems (TAP3)
CR = Change Request in ChangeSynergy – i.e. a requested change in RB/ECA or a few other related subsystems (TAP3)
IR = Information Request in WMS – we use it for support tickets that are not obvious or suspected defects
TR = Trouble Report in WMS – used for defect or suspected defect related issues

IR/TR are often interchangeable I don’t really care what a support incident is – since it will be investigated based on the info in it.

CBn vs ORn
Cambridge copy of CM/Synergy vs Orlando copy of CM/Synergy – mostly used for tasks (change control) – don’t really use it for PRs/CRs.</pre>
</div>
<div title="Symmetrix SNAPs" creator="colm" modifier="colm" created="201106280907" changecount="1">
<pre>Snap LUNs are virtual devices, which live in memory on the Symmetrix.  At the time of activation, the virtual device (snap LUN) is updated with a set of pointers which point to the content of the source (physical) LUN to which it was paired.  

If host A which has access to the source LUN, writes to the source LUN, the content of the block to be updated will first be copied away to a save pool which also lives on physical devices, and then only will the host be allowed to update the source LUN.  At this time the pointer in the snap device will also be updated to point to the new location of the copied block, now on the save pool devices.  This ensures that the snap device still has access to the original content as before host A updated the source LUN.

Similar, if the snap devices are mounted to a host B, where they will appear as normal disks, and host B issues a write to one of the devices, the TimeFidner software in the Symmetrix will copy the content of the block to which the pointer in the virtual snap device points to the save pool, update the pointer, and update the block in its new location.

Once a block has been copied to the save pool, further updates to the source and/or snap devices continue without this copy-on-first-write penalty.

Content that has not been updated on source or snap instances remain physically on the source LUNs, and host B which accesses them via the snap devices will in fact compete with host A’s IOs to that same physical LUN (source device).</pre>
</div>
<div title="Synonyms" creator="colm" modifier="colm" created="201103031059" modified="201103031412" changecount="2">
<pre>Use the CREATE SYNONYM statement to create a synonym, which is an alternative name for a table, view, sequence, operator, procedure, stored function, package, materialized view, Java class schema object, user-defined object type, or another synonym. 

___A synonym places a dependency on its target object and becomes invalid if the target object is changed or dropped.___

Specify PUBLIC to create a public synonym. Public synonyms are accessible to all users. However each user must have appropriate privileges on the underlying object in order to use the synonym.

When resolving references to an object, Oracle Database uses a public synonym only if the object is not prefaced by a schema and is not followed by a database link.

If you omit this clause, then the synonym is private. A private synonym name must be unique in its schema. A private synonym is accessible to users other than the owner only if those users have appropriate privileges on the underlying database object and specify the schema along with the synonym name.

A public synonym will have PUBLIC as owner. a local synonym in system would have SYSTEM as the user. A local synonym will always override a public synonym. A local table will always override a synonym.</pre>
</div>
<div title="TAD" creator="colm" modifier="colm" created="201202011541" modified="201209131417" changecount="5">
<pre>For the Terminated Account Deleter to delete data about a particular account, the following criteria must be true:
* The account must have been terminated (have status TX). 
* The account must have a balance of zero. 
* The invoicing company associated with the account must specify that terminated account data should be deleted. 
* The collections process must have finished running for the account (that is, the account columns DEBT_ANALYSIS_REQUIRED_DTM, NEXT_DEBT_ACTION_DAT, and NEXT_BAND_SUMMARY_DAT must be null). 
* The account must have no unbilled event associated with it (ACCOUNTRATINGSUMMARY.RATED_EVENT_MNY and ACCOUNTRATINGSUMMARY.RATED_EVENT_COUNT must both be zero). 
* The current date must be greater than the account termination date plus the termination delete delay. 
!!!NOTES
* No scheduled future reinstatements. From what I can see from the docs, this would be a future-dated status change in the ACCOUNTSTATUS table. 
* New form of DEBTAGE (2.2.40.?) can be used to correctly NULL the next_debt_action_dat for an account - this was run at BT Avalon.
* The following API can be used to set the account balance to zero: GNVPAY.WRITEOFFBALANCE1NC
* TeleFonica have an ACPD request (two actually) out for TAD.
**ACPD #4769 – Provision of an argfile (back ported from RBM 5.1), and
**ACPD #4773 – New TAD Requirements (Run TAD in –TEST mode)
* The new TAD feature of using an argfile is version RBM3.0, however this doesn’t include the –test option that has been requested by CUK.
!!!TAD - Hathorne
CR CB1#31185 - Parallel instances of TAD divide random hash range unevenly and with overlap - fixed 2.2.26
CR CB1#36873 - TAD design is not suitable for Tier1 clients - this was the issue whereby parent custs were put on a 'bad list' and deleted at end - troublesome if TAD is interrupted. Fixed at 2.2.26.
!!!TAD - Schema
ACCOUNT.next_debt_action_dat
The next date that a collections action is scheduled to take place.
The collections action subprocess of collections will only act on the account if the system date &gt;= next_debt_action_dat. Null if there is no scheduled collections action.

ACCOUNT.debt_analysis_required_dtm
The date/time that a receivables recalculation is deemed to be required for an account.
The collections action subprocess of collections will only act on the account is the system date/time &gt;= debt_analysis_required_dtm. Null if no receivables analysis has been requested.

ACCOUNT.last_debt_action_dtm
The last date/time that the collections action subprocess of collections was run against the account. Null if the collections action subprocess has never been run.

INVOICINGCOMPANY.term_acc_del_boo  varchar2(1) not null BOO   
Whether data pertaining to terminated accounts should be deleted from the database.

INVOICINGCOMPANY.term_cust_del_boo  varchar2(1) null BOO   
Whether data pertaining to terminated customers should be deleted from the database.
 
INVOICINGCOMPANY.term_acc_del_delay_days  number(4) null     
The number of days for which an account should have been terminated before data pertaining to that account can be deleted. Null if term_acc_del_boo is F, indicating that the field is irrelevant in this case.

INVOICINGCOMPANY.debt_managed_boo
Defines whether the Infinys operator manages collections on behalf of this invoicing company.

!!!Investigation SQL
{{{
-- Total accounts:
select count(*) from accounts;

-- Total TX accounts:
select count(*)
from accountstatus a
where (account_num,effective_dtm) in (select s.account_num,max(s.effective_dtm) from accountstatus s group by s.account_num)
and a.account_status='TX';

-- State of ICO params:
select invoicing_co_id, invoicing_co_name,ico.term_acc_del_boo, ico.term_cust_del_boo, ico.term_acc_del_delay_days,  debt_managed_boo 
from invoicingcompany ico;

-- Problem combinations

-- zero balance: PVACCOUNTBALANCE –  total_billed_tot – total_paid_tot 
select * from pvaccountbalance2 pva
where pva.ACCOUNT_BALANCE!=0
and pva.account_num in (
    select at.account_num
    from accountstatus at
    where (account_num,effective_dtm) in 
        (select s.account_num, max(s.effective_dtm) from accountstatus s group by s.account_num)
    and at.account_status='TX')
;

-- disputes &amp; adjustments
select a.account_num, a.active_disputes_tot, a.unbilled_adjustment_mny
from account a 
where (a.unbilled_adjustment_mny !=0 or a.active_disputes_tot !=0)
and a.account_num in (
    select at.account_num
    from accountstatus at
    where (account_num,effective_dtm) in 
        (select s.account_num,max(s.effective_dtm) from accountstatus s group by s.account_num)
    and at.account_status='TX')
;

-- outstanding collections activity
select count(*)
from account a
where (a.next_debt_action_dat is not null 
    or a.debt_analysis_required_dtm is not null 
    or a.next_band_summary_dat is not null)
and a.account_num in (
    select at.account_num
    from accountstatus at
    where (account_num,effective_dtm) in 
        (select s.account_num,max(s.effective_dtm) from accountstatus s group by s.account_num)
    and at.account_status='TX')
;

-- unbilled events
select a.account_num, sum(ars.rated_event_count) 
    from accountratingsummary ars
        join account a on a.account_num = ars.account_num
where ars.event_seq &gt;= a.bill_event_seq
and a.account_num in (
    select at.account_num
    from accountstatus at
    where (account_num,effective_dtm) in 
        (select s.account_num,max(s.effective_dtm) from accountstatus s group by s.account_num)
    and at.account_status='TX')
group by a.account_num
having sum(rated_event_count) &gt;0;

-- termination date
select count(*) from account a
where a.termination_dat is null
and a.account_num in (
    select at.account_num
    from accountstatus at
    where (account_num,effective_dtm) in 
        (select s.account_num,max(s.effective_dtm) from accountstatus s group by s.account_num)
    and at.account_status='TX')
;
}}}</pre>
</div>
<div title="TAP customer/account exports" modifier="colm" created="201010081237" modified="201102081402" changecount="5">
<pre>tap3plmninformation.roamer_account_num is the join back to account_num... From here, customer and therefore all accounts should be derived - there will always be 3 for each TAP cust... 

ROAMER_ACCOUNT_NUM, IMP_SUMM_ACCOUNT_NUM &amp; EXP_SUMM_ACCOUNT_NUM are all joins back to ACCOUNT.

Andy's steps from mail:

Create temporary tables to hold the relevent customer_refs and account_nums:

{{{SELECT COUNT(*) FROM tap3plmninformation;  --566 plmns 20100628}}}

-- Only need to select from one account reference as all accounts share single customer

{{{
create table temp_tap3extract_cust as 
       select distinct customer_ref 
       from account
      where account_num in (select roamer_account_num 
                                      from tap3plmninformation);

SELECT COUNT(*) 
FROM temp_tap3extract_cust; --566 custs 20100628
}}}

All the core CUST records for PLMNs. Now get all related accounts...

{{{
create table temp_tap3extract_acc as 
select distinct account_num 
from account
where customer_ref in (select customer_ref from temp_tap3extract_cust);

SELECT COUNT(*) FROM temp_tap3extract_acc; --1698 accs (566 * 3) 20100628
}}}

3 for each TAP PLMN customer...</pre>
</div>
<div title="TAP process" modifier="colm" created="201101281059" changecount="1">
<pre>TAP usage comes in via RUI because normally mediation is set to produce seperate files for this sort of usage. A bunch of usage will be associated with, say, Orange Uk and added up to a 'bill' for them. TFE is used to export the details of this usage. At PMCL end, they will use TFI to bring this usage into the system and here it will use the T3eventkey table to associate certain usage types with certain mappings - once the mapping has been defined, it will then use the TAP3FIELDMAPPING table to find out how to map inbound TAP values in the event files to RB-type event attributes.</pre>
</div>
<div title="Table rename" creator="colm" modifier="colm" created="201206261016" modified="201206261047" changecount="3">
<pre>From docs:
* Oracle Database automatically transfers integrity constraints, indexes, and grants on the old object to the new object.
* Oracle Database invalidates all objects that depend on the renamed object, such as views, synonyms, and stored procedures and functions that refer to a renamed table.

After a move:
- synonym is invalid
- constraints have moved to new table
- index has not been renamed but is VALID and the PK constraint is VALID and referring to old index name

At creation time, the index is by default named after the constraint if you didn't name it yourself. </pre>
</div>
<div title="Test Billing" modifier="YourName" created="201001271149" changecount="1">
<pre>Hi Guy,

As discussed, the documentation is not so very clear until the RB 4.3 Billing Concept Guide – which states:
 In test mode, you can specify a future billing date, which the Billing Engine takes as the
current date while producing test bills.
To do this, you must specify an extra parameter in the process plan that runs the Billing
Engine:
-test -testDateTime YYYYMMDD HHMMSSTT
You should note that:
�� For test billing on a future date, the -test and -testDateTime parameters must
both be present. The Billing Engine stops with an error if the -test parameter is
missing.
�� YYYYMMDD HHMMSSTT indicates the future date and time that the test bill run is to take
place. The Billing Engine stops with an error if a date in the past is specified

This feature is available in all versions since Geneva 5.3 (it was implemented under CR31643).

An example command line would be (to test bill an account with a next_bill_dtm on 1st Feb 2010):
BG –a “-test –testDateTime ‘20100201 12000000’ –a ACC000000001”

Thanks

Chris

Solutions Consultant, Infinys Centre of Expertise
Core Product Development, Convergys 
Building 2010, Cambourne Business Park
Cambourne, Cambridge CB23 6DW
Tel: +44 (0)1223 705828 Fax: +44 (0)1223 705001
e-mail: chris.dale@convergys.com 
www.convergys.com
________________________________________
From: Guy Nudel 
Sent: 26 January 2010 16:39
To: Chris Dale
Subject: RE: Test bill in production environment

Chris,

This is exactly what I need.
Can you confirm this is valid for RBM 4.08 as well?
If this is confirmed, I suggest that reply will include the Q&amp;A forum.
 
Best regards,
Guy Nudel
 
Tel:      +972 (0)9 9716593
Mobile: +972 (0)52 8359917
________________________________________
From: Chris Dale 
Sent: Tuesday, January 26, 2010 6:35 PM
To: Guy Nudel
Subject: RE: Test bill in production environment

The 4.3 Billing Concepts Guide is better than the 4.2.4 Release notes for describing it:
In test mode, you can specify a future billing date, which the Billing Engine takes as the
current date while producing test bills.
To do this, you must specify an extra parameter in the process plan that runs the Billing
Engine:
-test -testDateTime YYYYMMDD HHMMSSTT
You should note that:
�� For test billing on a future date, the -test and -testDateTime parameters must
both be present. The Billing Engine stops with an error if the -test parameter is
missing.
�� YYYYMMDD HHMMSSTT indicates the future date and time that the test bill run is to take
place. The Billing Engine stops with an error if a date in the past is specified

Thanks

Chris


Solutions Consultant, Infinys Centre of Expertise
Core Product Development, Convergys 
Building 2010, Cambourne Business Park
Cambourne, Cambridge CB23 6DW
Tel: +44 (0)1223 705828 Fax: +44 (0)1223 705001
e-mail: chris.dale@convergys.com 
www.convergys.com
________________________________________
From: Guy Nudel 
Sent: 26 January 2010 16:29
To: Chris Dale
Subject: RE: Test bill in production environment

Chris,
 
I thought that the –testDateTime includes input like &lt;date to use&gt; as part of the BG parameters, but I can't see that this is input to the process.
If the date is taken from the SYSdateOverride it will not allow me to use it in production.
 
Am I missing something regarding the override date?
 
Best regards,
Guy Nudel
 
Tel:      +972(0)9 9716593
Mobile: +972(0)52 8359917
________________________________________
From: Chris Dale
Sent: Tuesday, January 26, 2010 6:26 PM
To: Guy Nudel; PSG QandA
Subject: RE: Test bill in production environment
Hi Guy,
 
The requirement you have is specifically what this command line argument is for.  Essentially, in Production, where SYSdateOverride is not set, you can run BG to produce a test bill using both the –test and –testDateTime to bill an account with a future (or past) next_bill_dtm.
 
Thanks
 
Chris
 
Solutions Consultant, Infinys Centre of Expertise
Core Product Development, Convergys 
Building 2010, Cambourne Business Park
Cambourne, Cambridge CB23 6DW
Tel: +44 (0)1223 705828 Fax: +44 (0)1223 705001
e-mail: chris.dale@convergys.com 
www.convergys.com
________________________________________
From: Guy Nudel 
Sent: 26 January 2010 16:19
To: PSG QandA
Subject: Test bill in production environment
 
Hi,
 
The BG documentation includes the following:
“-testDateTime        Test mode with the date/time override. The database is not changed.”
 
My understanding is that if date is overridden, and -testDateTime parameter is used in run of the BG, the results of the BG would be as if the process runs at the overridden date.
If the date is overridden and the BG runs with parameter -test, will the BG ignore the overridden date?
 
While –test parameter can be used in production, -testDateTime seems like a flag which should not be used in production but only in test environments where date can be overridden, is that confirmed?
Is there a way in production (without change next bill date or override date) to run the BG before next bill date is crossed for simulate the expected results of the bill at the end of the bill period? (e.g. Next bill date is 1/Feb/2010 and on 26/Jan/2010 BG run in test mode to check the expected results of the bill). 
 
Best regards,
Guy Nudel
 
Tel:      +972 (0)9 9716593
Mobile: +972 (0)52 8359917
 </pre>
</div>
<div title="Trace domains" creator="colm" modifier="colm" created="201108240833" changecount="1">
<pre>At 2.2

|AEG |(Accruals Extract Generator)|
|BC |(Bill Canceller)|
|BDC |(Bill Data Checker)|
|BDD |(Bill Data Deleter)|
|BDW |(Bill Data Writer)|
|BG |(Billing Engine)|
|BID |(Bill Image Data Library)|
|BMG |(Bill Formatting Engine)|
|BPCD |(Bill Product Charge Deleter)|
|BR |(Bill Reissuer)|
|CAL |(Cache Abstraction Layer)|
|CDG |(Customer Data Generator)|
|CEA |(Event Archiver)|
|CED |(Event Deleter)|
|CEL |(Costed Event Library)|
|CEM |(Event Migrator)|
|CEU |(Event Unloader)|
|CEW |(Costed Event Writer)|
|CIL |(Cache Implementation Library)|
|CL |(Cache Loader)|
|CM |(Cache Manager)|
|CND |(Customer Notes Deleter)|
|DCM |(Real-Time Duplicate Check Maintainer)|
|DCU |(Denormalized Count Updater)|
|DEBT |(Debt Escalation Engine)|
|DEI |(Duplicate Event Identifier)|
|DER |(Duplicate Event Remover)|
|DLG |(Dunning Letter Generator)|
|DREP |(Data Repository Library)|
|DUL |(Discount Usage Library)|
|DUM |(Discount Usage Manager)|
|EFD |(Event File Distributor)|
|EVG |(Event Generator)|
|EXP |(Managed File Exporter)|
|FDU |(File-based Database Updater)|
|FDUABI|
|FDUACC|
|FDUADJ|
|FDUAHP|
|FDUCOSTBAND|
|FDUCOSTCODE|
|FDUCOSTGROUP|
|FDUCOSTGROUPXREF|
|FDUCOSTX|
|FDUCOUN|
|FDUDET|
|FDUDIS|
|FDUFPR|
|FDUFRQ|
|FDULBX|
|FDUMAN|
|FDUPAY|
|FDUSUM|
|FDUVHBANDMAP|
|FEL |(File Library)|
|FID |(Managed File Importer [File Import Daemon])|
|FMT |(Formatting Library)|
|GBRT |(Brazilian Taxation Library)|
|GCA |(Customer Address Library)|
|GCAT |(Catalog Library)|
|GCL |(Cache Library)|
|GDB |(Database Access Layer)|
|GDISC |(Discount Library)|
|GER |(Error Handling)|
|GEVA |(Event Handling Library)|
|GFH |(File Handling)|
|GFLT |(Event Filter Library)|
|GHOL |(Holiday Library)|
|GIM |(In-memory Tables)|
|GLIST |(Link List Library)|
|GMEM |(Memory Manager Library)|
|GMNY |(Currency Conversion Library)|
|GOV |(Override Event Tax Information Library)|
|GP |(System Parameter Library)|
|GPROD |(product Charging Library)|
|GREV |(Revenue Library)|
|GROT |(Shared Read-Only Table Access Library)|
|GSTR |(String Handling Library)|
|GSUM |(Event Summary Library)|
|GTAR |(Tariff Library)|
|GTF |(Text File Input/Output)|
|GTI |(Translation Library)|
|GTOFT |(Tree of Trees Library)|
|GTR |(Tax Library)|
|GTREE |(Blanaced Binary Tree Library)|
|GU |(Utilities)|
|GUST |(U.S. Taxation Library)|
|GVAT |(European Tax Library)|
|ING |(Invoice Number Generator)|
|JM |(Job Management Library)|
|MFD |(Managed File Deleter)|
|MFL |(Managed File Library)|
|MFM |(Managed File Modifier)|
|MIC |(MI Complete)|
|MIW |(MI Write)|
|MOD |(modifyAccount/modifyCustomer)|
|OCR |(Bank Giro Checksum Library)|
|ODD |(Outbound Message Dispatcher)|
|OFD |(Orphan Managed File Deleter)|
|PLFD |(Process Log Deleter)|
|PRC |(PR Complete)|
|PRW |(PR Write)|
|RATE |(Active Rating Engine)|
|READ |(Rejected Event Archiver and Deleter)|
|RTF |(Rich Text Format Library)|
|RU |(Rating Utility Library)|
|SEC |(Security Library)|
|SRD |(Service Request Deleter)|
|SPM |(Settlement Period Manager)|
|SPPA |(Settlement Period Payment Allocator)|
|TAD |(Terminated Account Deleter)|
|TMPI |(Task Master Process Interface)|
|TRD |(Test Rating Daemon)|
|ALL |(All Domains)|</pre>
</div>
<div title="Travel process" creator="YourName" modifier="YourName" created="201307251052" modified="201307260913" changecount="2">
<pre>When submitting a travel request, take the following into account:

1.	Obtain an email confirmation for a business trip from one of the authorized Business Travel Approvers listed below.
2.	To create a New Travel Request in NC TMS (please find the guidelines attached), attach the email approval. If an employee needs to rent a car, note this in the Comments field.  For the interim period please also put your Proactis code in the Comments field.
3.	TMS will generate an email notification that will be distributed to the Europe Travel Support Group, the business traveler, the employee’s line manager, and the business trip initiator.
4.	A Travel Support specialist will respond to the travel request by email within 3 hours providing the traveler with ticket and accommodation options.
5.	The business traveler must confirm the ticket and accommodation option by email.
6.	The Travel Support specialist will send the purchased airline/railway tickets and hotel/car reservations (if any) by email. Airline tickets and car hires will be billed back to the company directly; hotels will be booked with the employee’s credit card, and the respective payment transactions will be made upon hotel check-in/check-out.
7.	If changes are required to the original travel itinerary, the employee must open his Travel Request page in TMS and click the Update button. The reason for the change must be specified (e.g. business trip extension till 04/30/2013). No additional approvals are required.
8.	The Travel Support specialist will communicate the itinerary changes to the traveler. The employee must confirm the changes by email.
9.	Taxis must be requested in the Comments field of the travel request.

Please note that the costs of tickets and hotel/car bookings do not require additional management approval because FCm is well versed in our travel policy and procedure and will assist NetCracker by offering reasonable cost options. However, employees should be cost conscious when choosing itinerary options and must not take personal advantage of work-related business travel according to the terms of the Travel and Expense Policy.
</pre>
</div>
<div title="UTF-8" modifier="colm" created="201005311113" modified="201108300820" changecount="7">
<pre>From Oracle docs:

* The NLS_CHARACTERSET is used for CHAR, VARCHAR2, CLOB columns;
* The NLS_NCHAR_CHARACTERSET is used for NCHAR, NVARCHAR2, NCLOB columns. defined when the database is created, defaults to AL16UTF16 if nothing is specified.&quot;

{{{
export NLS_LANG='ENGLISH_UNITED KINGDOM.WE8ISO8859P1'
export NLS_LANG='AMERICAN_AMERICA.WE8ISO8859P1'
}}}

From Chris Dale - April 2009:

//When running BG, you must set NLS_LANG to .UTF8, however you must also set LC_CTYPE to a UTF8 value - e.g. en_GB.UTF-8

This is important or the billdata can get corrupted when the billdata is more than 1 segment in size - if a multibyte char is part-way through at the 32K limit for billdata, the multibyte code is not called correctly unless you have LC_CTYPE explicitly set (implicitly from LANG variable is not sufficient).
There are some details on this in PR33838.

Further, you may need to run BDW for each language separately - with appropriate NLS_LANG values for that language - this is dependant on the charset of the formatter - for example, if you were to forgat the data using Bill Formatter to view the bill in windows, you would need to set the NLS_LANG to the appropriate Windows value when running BDW - or some chars may not be correctly rendered when opening the Word Doc in windows (it is BDW not BF that this is important for as BDW is the process that takes the data out of the DB and puts it into the file).//

And more:
&lt;&lt;&lt;
You are right to be concerned.  We only support NLS_LENGTH_SEMANTICS = BYTE not CHAR.  This means that the fields in the DB are all n bytes long and so you may get fewer characters in there if a given character is more than 1 byte in length.
Generally, the restriction is not too bad, most characters are still going to be ASCII which are only 1 byte long in UTF8 – however, if you use special values (e.g. Euro symbol), then you may hit cases where you could blow the field if the client application passes in a string that, in the DB is more than the field length in bytes.

Other major issues are related to ensuring your client settings and VPA values are correct so that you accurately enter data into the DB.
e.g. you cannot run Windows in UTF8 – so you should not attempt to set the Windows NLS_LANG to UTF8 – instead, you need to set the NLS_LANG to match the code page of the PC (e.g. “.WE8MSWIN1252”) – and this will allow some values to be entered and seen.  Other values may not be viewable (e.g. Arabic) on this PC.

If you use a Java/HTML based application to view the DB data (and enter it), then, with the right settings, you can view all the UTF8 chars (assuming the glyphs are installed on the PC).

BG needs to run with an NLS_LANG of .UTF8.
BDW needs to be run with an NLS_LANG that matches the expected output format for the formatter – which, with e.g. DOC1 may be UTF8.  If not, then you may need to run a different BDW for each language set you have to output – e.g. 1 for Western European, 1 for Eastern European (and Cyrillic) and one for Arabic.

Finally, there are some gotchas around setting your UNIX locale and LC_CTYPE correctly to ensure that you invoke the RB accurately.  See PR33838 for some details on that.
&lt;&lt;&lt;

This PR also notes:
//Geneva does explicitly set some related locale variables and we have GParams ~SYSdateLocale, ~SYSnumericLocale and ~SYScurrencyLocale, which set LC_TIME, LC_NUMERIC and LC_MONETARY variables but there is no such setting for LC_CTYPE.//
...
//When the BG connects to the database, the GDB library fetches the gparams
SYSdateLocale, SYScurrencyLocale and SYSnumericLocale and calls the FMT
library to set the locale categories LC_TIME, LC_MONETARY and LC_NUMERIC
accordingly (see GDBconnect.pc-20 lines 407-447). However, there is no
equivalent gparam for the LC_CTYPE locale category, and so this locale
category remains set to the default &quot;C&quot; locale.//
But later:
//This functionality was found to exist in TMPI.c:TMPIsetCtypeLocale.  If set, the environment variable LC_CTYPE, is set as the CTYPE locale for all Geneva batch applications.//</pre>
</div>
<div title="Unix" modifier="colm" created="200907151156" modified="201404072351" tags="unix commands shell" changecount="27">
<pre>!!!!Compressed tar:
{{{
tar -cvf - &lt;files&gt; | gzip -c &gt; backup.tar.gz
gunzip -c backup.tar.gz | tar -xvf -

move to different dir - GNU tar
tar -xvzf filename.tar.gz -C /desired/path
}}}
!!!!Archive contents
{{{
gunzip -l --verbose &lt;archive&gt;
unzip -v &lt;archive&gt;
}}}
Repack 
{{{
zip -rv &lt;file&gt; &lt;pattern&gt; (solaris - don't add a .zip at the end!)
unzip -j RB-3.0.8hI10g.zip *.pdf (only PDFs and junk prefixed dir)
}}}
Extract single file
{{{
unzip -j pkg/RB-5.0.3hI11g.zip  RB/RB/RBIUH/RB_IU_Handler.ksh -d $INFINYS_ROOT
unzip -j RB-5.0.3hI11g.zip  RB/RB/doc/release_notes* -d ~/cam/tmp
}}}
!!!!Links
{{{
ln -s(f) &lt;realthing&gt; linkname
}}}
!!!!Recursive grep for braindead OS's:
{{{
find . -type f | xargs grep -il &lt;search&gt; OR
find . -type f -exec grep -il &lt;search&gt; {} \;
}}}
''NB'' grep will return 0 if any matches were found, and 1 if no matches were found. If you check the $? variable after running grep -q. If it is 0, you found a match.
!!!!GID problems
Look in /etc/nsswitch.conf - set nis first, followed by files..
!!!!Avoid NFS mounts in a find:
{{{
find / -fstype nfs -prune -name java -type d 2&gt;/dev/null
}}}
*NB* redirecting stderr gets rid of all 'can't open this file' stuff
!!!!Limited-depth find
Unless using GNU find, you're unlikely to have maxdepth available.. below limits the PF/bin matching to one dir in depth
{{{
cd lib
find $RELEASE/PF/lib -type f -exec ln -s {} . \;
find $RELEASE/RB/lib -type f -exec ln -s {} . \;
cd bin
find $RELEASE/PF/bin ! -path &quot;$RELEASE/PF/bin/*/*&quot; -type f -exec ln -s {} . \;
find $RELEASE/RB/bin -type f -exec ln -s {} . \;
}}}
!!!!find by size - smaller than 600B:
{{{
find . ! -name &quot;*control*&quot; -size -600c
}}}
!!!!find by date - mtime (modify-=creation) time more than 20 days ago:
{{{
find . -mtime +20 -exec ls -la {} \;
}}}
!!!!Printable man
{{{
man sar | col -bx &gt; sarman.txt
}}}
!!!! cut
To get around single-space delimiter, use tr to compress e.g. pull out PIDs:
{{{
ps -ef | grep &lt;search&gt; |  grep -v grep | tr -s &quot; &quot; | cut -d' '  -f2
}}}
Pipe into tr to remove chars we don't want:
{{{
grep &quot;execute migrationRename&quot; *.sql | cut -d'(' -f2 | tr -d &quot;',;)&quot; 
}}}
Strip out spaces (use :space: to include newlines)
{{{
 cat post-segment-size.log | tr -d [:blank:] &gt; sfix.log
}}}
!!!! comm
Find common lines between files - default does three columns: file1, file2 and common - what we want is:
{{{
comm -1 -2 config-import-tablist statics-tablist
}}}
!!!! Generic remarks on vmstat output
Paging is an aspect of virtual memory addressing whereby relatively inactive pages can be temporarily removed from physical memory if necessary. If these pages have been modified, they must be saved to a temporary storage area on disk, called a paging file or *swap space*. The operation of writing one inactive page, or a cluster of inactive memory pages to disk is called a page out, and the corresponding operation of reading them in again later when one of the pages is referenced is called a page in. Paging is effective because programs typically only use a small proportion of their virtual memory pages actively at any one a time. The set of pages in active use by a process is called its *working set*.

Some physical memory is reserved for the operating system itself, and for its data structures. This is called *wired me
ory*, because it is not subject to paging. The rest of physical memory is managed via the paging mechanism, and is call
d the page pool. Whenever a virtual memory page that is not in physical memory is referenced, a page is allocated from
he page poolÔÇÖs free list and mapped to the required virtual memory address. Pages are returned to the free list when
he memory has been unmapped or freed. Pages can be *reclaimed* from the free list if they are referenced again before t
e physical memory page has been reused.

If the number of pages on the free list falls below a certain threshold, then the operating system begins to scan for i
active pages to page out. Pages are regarded as inactive if they have not been referenced for a certain amount of time.
Inactive pages are moved to the end of the free list, but if they have been modified then their contents must first be
aged out to disk. Paging stops as soon as the number of free pages rises back above the threshold. If the number of pag
s on the free list continues to fall, then the operating system begins to scan increasingly rapidly and thus regards pa
es as inactive more quickly. The *scan rate* is a measure of the number of pages scanned per second. It is a good indic
tor of memory pressure.

!!! Shells
*csh* looks for its startup stuff in @.cshrc@ or @.login@. Uses @source@. It uses @setenv@ (with no equals sign!) for s
ell and env variables, apart from those inherited which are accessed with @set@. Syntax for aliases and @PATH@ are as f
llows:
{{{
set PATH = (. ~/bin /opt/bin)
setenv PATH ~/bin:$ORACLE_HOME/bin
alias lt    'ls -lart'
setenv TRACE_BG ON
setenv TRACE_LEVEL FULL
}}}

*ksh* uses the @.profile@ (and will execute any script exported as @ENV@), it uses bash-style @export@ to propagate env
vars and bash-style alias syntax:
{{{
export PATH=/usr/local/bin:/bin:~/bin

unalias ls
alias lt='ls -lart'
alias cdir='cd $INFINYS_ROOT'
alias sd='sqlplus $DATABASE'
PS1='$LOGNAME@$ORACLE_SID:$PWD \$ '
HOSTLABEL=`hostname`
export PS1='$LOGNAME@${HOSTLABEL} ${PWD##*/}&gt; '

#####################################################
# set up arrow keys
######################################################
set -o emacs
alias __A=$(print '\0020')    # ^P = up    = previous command
alias __B=$(print '\0016')    # ^N = down  = next command
alias __C=$(print '\0006')    # ^F = right = forward a character
alias __D=$(print '\0002')    # ^B = left  = back a character
alias __H=$(print '\0001')    # ^A = home  = beginning of line
}}}

Also, to set X-Windows titlebars (putty also):
{{{
echo &quot;^[]2;`whoami`@`hostname`^G&quot;
}}}

or

{{{
echo &quot;ESC]2;TEXT^G&quot;
}}}

with:
echo &quot;
Ctrl-V ESC key
]2;
TEXT
Ctrl-G-close quotes

ESC is the escape key, TEXT is the string you wish to have displayed, and ^G is a Control-G (the BEL character). Note that the semi-colon is demanded by more recent versions of xterm. (Some shells and editors need an escape character typically ^V, before accepting control characters literally.) If you're in vi, this amounts to: CtrlV-ESC-literal ]2;`whoami`@`hostname` - Ctrl G

Use the dot operator (or source) to execute scripts - instead of forking to a subshell this will affect vars in _curren
 environment_.

_watch_ on ksh is a good example of interactive shell scripting:

 user@host&gt; while [ 1 ];do
 &gt; las -lart
 &gt; done

How to &quot;change the root passwd on RHAL&quot;:http://forums1.itrc.hp.com/service/forums/questionanswer.do?threadId=1013650&amp;ad</pre>
</div>
<div title="Unix filesystem permissions" modifier="YourName" created="200911121136" modified="201001102312" changecount="3">
<pre>Very good coverage at: http://content.hccfl.edu/pollock/AUnix1/FilePermissions.htm

Factoids:
* At least on ~HP-UX, a user needs execute on all ancestor directories to write to a directory, even if it has 777 perms.
* Group perms override Other/World perms</pre>
</div>
<div title="Unknown Instance" creator="YourName" modifier="YourName" created="201111021345" modified="201111021347" changecount="3">
<pre>{{{
select * from v$instance;
SELECT * FROM V$DBFILE;

col FILE_NAME for a60
col mb for 999,999.99
col max for 999,999.99
break on TABLESPACE_NAME 
select TABLESPACE_NAME, FILE_NAME, status, AUTOEXTENSIBLE, 
BYTES/(1024*1024) as mb, MAXBYTES/(1024*1024) as max  
from DBA_DATA_FILES 
union
select TABLESPACE_NAME, FILE_NAME, status, AUTOEXTENSIBLE, 
BYTES/(1024*1024) as mb, MAXBYTES/(1024*1024) as max  
from DBA_temp_FILES 
order by TABLESPACE_NAME, FILE_NAME;

select table_name from dba_tables where table_name like 'VERSION%';
select * from version_geneva_5_4;

select count(*) from account;
select count(*) from costedevent;
}}}</pre>
</div>
<div title="Upgrade Acceptance Criteria" creator="YourName" modifier="YourName" created="201201041411" changecount="1">
<pre>!!Acceptance Criteria

•	WebLogic Domains for ECA &amp; PCM component are up and running
•	Task Master is up and running
•	DConfigAgent is up and running
•	The rating and billing applications can be successfully executed to return their version information i.e. RATE –v and BG -v 
•	PCMI notification Perl script started
•	Test RBM  &amp; PCM client GUIs can be started and can connect

•	Logical have two working days after such completions to raise any environment issues deemed to be issues resulting from the cloning/creation activities.

Dependencies
As the new environments will be clones of an existing source environment, then it will be Logica responsibility to ensure the source environment is working properly before cloning operations commence. Should the newly created environments display any issues that are also found in the source environment, then Convergys will be under no obligation to resolve such issues under this work agreement and instead they would be handled normally as change requests as and if required. </pre>
</div>
<div title="Upgrade questions" modifier="colm" created="200912081203" modified="201301101113" changecount="16">
<pre>Typical issues that should be addressed in an Upgrade Strategy or at least raised with the project team:

* the big stuff: start and end versions of OS, Oracle and RB - confirmed path with Support
* rtdProcessor!!
* has there been a clear discussion of the size of the upgrade window and expectations set accordingly?
* set a clear expectation of several full volume test upgrades - for any relatively large client we normally recommend 3:
** first to shake out all the migration script errors and data issues in the process and get rough timings and a documented process (Upgrade Guide)
** second to rerun the documented steps from the first and catch all the things that were inevitably missed - some patches will likely have been supplied for the upgrade scripts also
** third to be as close as possible to production with the stopwatch running to get a realistic time estimate
* the mechanism (e.g. Oracle datapump) and timelines for providing this full volume test environment should be understood/discussed
* who is responsible for custom/3rd party work?
* are there any character set/locale-related conversions?
* what is happening to Rejected/rerate events at upgrade time?
* how will managed files be treated? All copied? Just unbilled?
* how will logs be treated? All copied? 
*are there any changes to high-volume tables esp. CE?
* How low-level is Impact Analysis? e.g how will DUM behaviour change? ~GPARAMs? This level of detail is required at some point
* are there TAP version issues to consider?
* any non-standard apps e.g. TariffLoader in use?
* have any plugins been tested early?
* interface versions (e.g. RTRI) tested and understood?
* has cloning been discussed?
* has working directory layout been discussed?
* who will manage environments: release management and timelines for versions etc.
* are any tables/tspaces in unusual arrangemtns: freelists, pctfree etc - these will be lost  on rebuild unless populated in schema_params
top concerns:
* the upgrade will take much longer than the client expects
* there will need to be more full-volume rehearsals than the client expects
* performance testing is done too late - in my experience, it invariably throws up functional problems as well as any performance issues
* the impact analysis does not go into sufficient detail and days/weeks of UAT are spent sorting out new DUM modes, changes to RATE arguments, new TAP file formats etc etc.
!!! Big tables
Key tablesize to get an idea,
CUSTOMER: 502,755
ACCOUNT: 1,495,659
BILLSUMMARY: 44,129,497
CPDU: 2,783,441
CPRD: 1,555,226
BILLDETAILS: 171,967,775
BPC: 187,428,806
CPC: 36,368,794
CPD: 9,808,472
CPIDU: 1,791,256
!!!Optimisation
* Disable archivelog mode?
* Larger REDO logfiles to reduce checkpoints and bigger logbuffer (100MB)?
* Make sure mount options are for direct, async I/O
* Unix bufcache about 1-3% of memory+
!!!Gotchas
* Remember for overnight upgrades to disable stats vcollection
* Look out for silent failures of A2 mig tablespaces
* Check Y9 for failed implementations of step-restarts a la K9_notnulls - remember this is related to DDL - PR
*  check for weird storage setups beforehand
* start rebuilding and testing plugins early!
* stratet rebuilding and testing perl scripts early - very often complex perl environment rebuild requirements e.g. 32/64-bit issues</pre>
</div>
<div title="VPA concurrency" modifier="YourName" created="201001211130" changecount="1">
<pre>//&quot;Does anyone know If there is any limitation between running RATE parallel to changing the Next_bill_date to an account?..
I'm changing the next bill dates to the future, if I may add-so my guess is there is no problem...&quot;//

- You can do this – though the API will temporarily lock out RATE whilst it updates accountrating.next_bill_dtm – obviously unless you are using big wholesale accounts, the chances are small and the time window is also small
- Chris Dale - 21 Jan 2010</pre>
</div>
<div title="Veritas cheatsheet" creator="colm" modifier="colm" created="201103301346" modified="201103301402" changecount="3">
<pre>Get disk groups:
{{{vxprint | grep &quot;Disk group&quot;}}}

Get disk details (sorted by wio's):
{{{vxstat -g snp1oradg -d|sort -nk4}}}

[[VxVM System Administrator's Guide - VxVM Performance Monitoring|http://uw714doc.sco.com/en/ODM_VMadmin/sag-5.html]]</pre>
</div>
<div title="Weblogic port" creator="colm" modifier="colm" created="201108081351" modified="201108081351" changecount="2">
<pre>{{{
&gt; grep -i listen $INFINYS_ROOT/Infinys/config/config.xml
    &lt;listen-port&gt;9711&lt;/listen-port&gt;
    &lt;listen-address&gt;&lt;/listen-address&gt;
}}}</pre>
</div>
<div title="Wide ps on unix" modifier="colm" created="200907162240" modified="201201181544" changecount="4">
<pre>Wide format is not much use.. but shows how to use UNIX95/XPG4:
{{{UNIX95=1 ps -eo args}}}

More recently, -x does the trick..
{{{ps -efx}}}

Also, may find (Solaris?) that the commands are under
 {{{/usr/xpg4/bin}}}

Also on solaris:
{{{
/usr/ucb/ps -auxwwweg | grep RATE
}}}</pre>
</div>
<div title="Windows" modifier="colm" created="200908131111" modified="201106281204" changecount="3">
<pre>!!!!Keyboard shortcuts
|~Ctrl-Shift-Esc| TaskManager |

!!!!Outlook
|ctrl-k| check names|
|ctrl-q|mark as read|

!!!! Disable zip in browser
Windows-R:
{{{regsvr32 /u zipfldr.dll}}}</pre>
</div>
<div title="Work Division AEG" creator="YourName" modifier="YourName" created="201310221432" modified="201402031259" changecount="6">
<pre>New Modes:
1)      -untaxUsage
2)      -productCharging
3)      -catalogueChange
4)      -consolidation

New tables:
AEGSUMMARIZEDDUS            
AEGPRODUCTCHARGE            
AEGPRODUCTCHANGE            
AEGDAILYUSAGESUMMARY        
AEGCATALOGUECHANGE          
AEGACCOUNT    

It is mandatory that either &quot;-ccid&quot; or &quot;-ico&quot; are passed with this option. For a catalogue change &quot;-ccid&quot; with latest catalogue change id must be passed. i.e

{{{AEG -catalogueChange -ccid &lt;ID NUM&gt;}}}

or in the case where a catalogue is created for an ICO, AEG should be executed as follows.

{{{AEG -catalogueChange  -ico&lt;ICO ID&gt;}}}

The different modes might be scheduled as follows:
-          Daily RATE is populating AEGDAILYUSAGESUMMARY.
-          During whole month, API/GUI driven changes will add entries to AEGPRODUCTCHANGE.
-          Weekly or twice-weekly or even daily runs of AEG ?untaxUsage will untax usage and summarise rows to AEGSUMMARIZEDDUS.
-          Perhaps one week before month end - as when current AEG 1 is run - AEG ?productCharges should be run to precalulate product charges. (This mode can also be used multiple times to pick up changes in AEGPRODUCTCHANGE.)
-          After any catalogue publications, AEG ?catalogueChange should be run to detect relevant changes. This mode will generate rows to AEGPRODUCTCHANGE and clears down AEGCATALOGUECHANGE.
-          At accruals date, AEG ?consolidation should be run to combine usage summaries and  product charges ? any missed AEGPRODUCTCHANGE rows will also be processed.

!!!Queue check GPARAM
~AEGbypassQueueCheckBoo was introduced by CR 50464 at 3.0.27.61 and rolled up at RB5.2.1

</pre>
</div>
<div title="YourName" creator="YourName" modifier="YourName" created="201401231454" modified="201401231455" changecount="3">
<pre>colm</pre>
</div>
<div title="YourSearchPlugin" modifier="YourName" created="200601161427" modified="201002161623" tags="Plugin UdoBorkowski YourSearchProject systemConfig" server.type="file" server.host="http://tiddlywiki.abego-software.de" server.page.revision="201002161623">
<pre>/***
|''Name:''|YourSearchPlugin|
|''Version:''|2.1.5 (2010-02-16)|
|''Source:''|http://tiddlywiki.abego-software.de/#YourSearchPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2010 [[abego Software|http://www.abego-software.de]]|
|''~CoreVersion:''|2.1.0|
|''Community:''|[[del.icio.us|http://del.icio.us/post?url=http://tiddlywiki.abego-software.de/index.html%23YourSearchPlugin]]|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; ~InternetExplorer 6.0|
!About YourSearch
YourSearch gives you a bunch of new features to simplify and speed up your daily searches in TiddlyWiki. It seamlessly integrates into the standard TiddlyWiki search: just start typing into the 'search' field and explore!

For more information see [[Help|YourSearch Help]].
!Compatibility
This plugin requires TiddlyWiki 2.1. 
Check the [[archive|http://tiddlywiki.abego-software.de/archive]] for ~YourSearchPlugins supporting older versions of TiddlyWiki.
!Source Code
***/
/***
This plugin's source code is compressed (and hidden). Use this [[link|http://tiddlywiki.abego-software.de/archive/YourSearchPlugin/Plugin-YourSearch-src.2.1.5.js]] to get the readable source code.
***/
///%
if(!version.extensions.YourSearchPlugin){version.extensions.YourSearchPlugin={major:2,minor:1,revision:5,source:&quot;http://tiddlywiki.abego-software.de/#YourSearchPlugin&quot;,licence:&quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,copyright:&quot;Copyright (c) abego Software GmbH, 2005-2010 (www.abego-software.de)&quot;};if(!window.abego){window.abego={};}if(!Array.forEach){Array.forEach=function(_1,_2,_3){for(var i=0,_4=_1.length;i&lt;_4;i++){_2.call(_3,_1[i],i,_1);}};Array.prototype.forEach=function(_5,_6){for(var i=0,_7=this.length;i&lt;_7;i++){_5.call(_6,this[i],i,this);}};}abego.toInt=function(s,_8){if(!s){return _8;}var n=parseInt(s);return (n==NaN)?_8:n;};abego.createEllipsis=function(_9){var e=createTiddlyElement(_9,&quot;span&quot;);e.innerHTML=&quot;&amp;hellip;&quot;;};abego.shallowCopy=function(_a){if(!_a){return _a;}var _b={};for(var n in _a){_b[n]=_a[n];}return _b;};abego.copyOptions=function(_c){return !_c?{}:abego.shallowCopy(_c);};abego.countStrings=function(_d,s){if(!s){return 0;}var _e=s.length;var n=0;var _f=0;while(1){var i=_d.indexOf(s,_f);if(i&lt;0){return n;}n++;_f=i+_e;}return n;};abego.getBracedText=function(_10,_11,_12){if(!_11){_11=0;}var re=/\{([^\}]*)\}/gm;re.lastIndex=_11;var m=re.exec(_10);if(m){var s=m[1];var _13=abego.countStrings(s,&quot;{&quot;);if(!_13){if(_12){_12.lastIndex=re.lastIndex;}return s;}var len=_10.length;for(var i=re.lastIndex;i&lt;len&amp;&amp;_13;i++){var c=_10.charAt(i);if(c==&quot;{&quot;){_13++;}else{if(c==&quot;}&quot;){_13--;}}}if(!_13){if(_12){_12.lastIndex=i-1;}return _10.substring(m.index+1,i-1);}}};abego.select=function(_14,_15,_16,_17){if(!_17){_17=[];}_14.forEach(function(t){if(_15.call(_16,t)){_17.push(t);}});return _17;};abego.consumeEvent=function(e){if(e.stopPropagation){e.stopPropagation();}if(e.preventDefault){e.preventDefault();}e.cancelBubble=true;e.returnValue=true;};abego.TiddlerFilterTerm=function(_18,_19){if(!_19){_19={};}var _1a=_18;if(!_19.textIsRegExp){_1a=_18.escapeRegExp();if(_19.fullWordMatch){_1a=&quot;\\b&quot;+_1a+&quot;\\b&quot;;}}var _1b=new RegExp(_1a,&quot;m&quot;+(_19.caseSensitive?&quot;&quot;:&quot;i&quot;));this.tester=new abego.MultiFieldRegExpTester(_1b,_19.fields,_19.withExtendedFields);};abego.TiddlerFilterTerm.prototype.test=function(_1c){return this.tester.test(_1c);};abego.parseNewTiddlerCommandLine=function(s){var m=/(.*?)\.(?:\s+|$)([^#]*)(#.*)?/.exec(s);if(!m){m=/([^#]*)()(#.*)?/.exec(s);}if(m){var r;if(m[3]){var s2=m[3].replace(/#/g,&quot;&quot;);r=s2.parseParams(&quot;tag&quot;);}else{r=[[]];}var _1d=m[2]?m[2].trim():&quot;&quot;;r.push({name:&quot;text&quot;,value:_1d});r[0].text=[_1d];return {title:m[1].trim(),params:r};}else{return {title:s.trim(),params:[[]]};}};abego.parseTiddlerFilterTerm=function(_1e,_1f,_20){var re=/\s*(?:(?:\{([^\}]*)\})|(?:(=)|([#%!])|(?:(\w+)\s*\:(?!\/\/))|(?:(?:(&quot;(?:(?:\\&quot;)|[^&quot;])+&quot;)|(?:\/((?:(?:\\\/)|[^\/])+)\/)|(\w+\:\/\/[^\s]+)|([^\s\)\-\&quot;]+)))))/mg;var _21={&quot;!&quot;:&quot;title&quot;,&quot;%&quot;:&quot;text&quot;,&quot;#&quot;:&quot;tags&quot;};var _22={};var _23;re.lastIndex=_1f;while(1){var i=re.lastIndex;var m=re.exec(_1e);if(!m||m.index!=i){throw &quot;Word or String literal expected&quot;;}if(m[1]){var _24={};var _25=abego.getBracedText(_1e,0,_24);if(!_25){throw &quot;Invalid {...} syntax&quot;;}var f=Function(&quot;tiddler&quot;,&quot;return (&quot;+_25+&quot;);&quot;);return {func:f,lastIndex:_24.lastIndex,markRE:null};}if(m[2]){_23=true;}else{if(m[3]){_22[_21[m[3]]]=1;}else{if(m[4]){_22[m[4]]=1;}else{var _26=m[6];var _27=m[5]?window.eval(m[5]):m[6]?m[6]:m[7]?m[7]:m[8];var _20=abego.copyOptions(_20);_20.fullWordMatch=_23;_20.textIsRegExp=_26;var _28=[];for(var n in _22){_28.push(n);}if(_28.length==0){_20.fields=_20.defaultFields;}else{_20.fields=_28;_20.withExtendedFields=false;}var _29=new abego.TiddlerFilterTerm(_27,_20);var _2a=_26?_27:_27.escapeRegExp();if(_2a&amp;&amp;_23){_2a=&quot;\\b&quot;+_2a+&quot;\\b&quot;;}return {func:function(_2b){return _29.test(_2b);},lastIndex:re.lastIndex,markRE:_2a?&quot;(?:&quot;+_2a+&quot;)&quot;:null};}}}}};abego.BoolExp=function(s,_2c,_2d){this.s=s;var _2e=_2d&amp;&amp;_2d.defaultOperationIs_OR;var _2f=/\s*(?:(\-|not)|(\())/gi;var _30=/\s*\)/g;var _31=/\s*(?:(and|\&amp;\&amp;)|(or|\|\|))/gi;var _32=/\s*[^\)\s]/g;var _33=/\s*(\-|not)?(\s*\()?/gi;var _34;var _35=function(_36){_33.lastIndex=_36;var m=_33.exec(s);var _37;var _38;if(m&amp;&amp;m.index==_36){_36+=m[0].length;_37=m[1];if(m[2]){var e=_34(_36);_30.lastIndex=e.lastIndex;if(!_30.exec(s)){throw &quot;Missing ')'&quot;;}_38={func:e.func,lastIndex:_30.lastIndex,markRE:e.markRE};}}if(!_38){_38=_2c(s,_36,_2d);}if(_37){_38.func=(function(f){return function(_39){return !f(_39);};})(_38.func);_38.markRE=null;}return _38;};_34=function(_3a){var _3b=_35(_3a);while(1){var l=_3b.lastIndex;_31.lastIndex=l;var m=_31.exec(s);var _3c;var _3d;if(m&amp;&amp;m.index==l){_3c=!m[1];_3d=_35(_31.lastIndex);}else{try{_3d=_35(l);}catch(e){return _3b;}_3c=_2e;}_3b.func=(function(_3e,_3f,_40){return _40?function(_41){return _3e(_41)||_3f(_41);}:function(_42){return _3e(_42)&amp;&amp;_3f(_42);};})(_3b.func,_3d.func,_3c);_3b.lastIndex=_3d.lastIndex;if(!_3b.markRE){_3b.markRE=_3d.markRE;}else{if(_3d.markRE){_3b.markRE=_3b.markRE+&quot;|&quot;+_3d.markRE;}}}};var _43=_34(0);this.evalFunc=_43.func;if(_43.markRE){this.markRegExp=new RegExp(_43.markRE,_2d.caseSensitive?&quot;mg&quot;:&quot;img&quot;);}};abego.BoolExp.prototype.exec=function(){return this.evalFunc.apply(this,arguments);};abego.BoolExp.prototype.getMarkRegExp=function(){return this.markRegExp;};abego.BoolExp.prototype.toString=function(){return this.s;};abego.MultiFieldRegExpTester=function(re,_44,_45){this.re=re;this.fields=_44?_44:[&quot;title&quot;,&quot;text&quot;,&quot;tags&quot;];this.withExtendedFields=_45;};abego.MultiFieldRegExpTester.prototype.test=function(_46){var re=this.re;for(var i=0;i&lt;this.fields.length;i++){var s=store.getValue(_46,this.fields[i]);if(typeof s==&quot;string&quot;&amp;&amp;re.test(s)){return this.fields[i];}}if(this.withExtendedFields){return store.forEachField(_46,function(_47,_48,_49){return typeof _49==&quot;string&quot;&amp;&amp;re.test(_49)?_48:null;},true);}return null;};abego.TiddlerQuery=function(_4a,_4b,_4c,_4d,_4e){if(_4c){this.regExp=new RegExp(_4a,_4b?&quot;mg&quot;:&quot;img&quot;);this.tester=new abego.MultiFieldRegExpTester(this.regExp,_4d,_4e);}else{this.expr=new abego.BoolExp(_4a,abego.parseTiddlerFilterTerm,{defaultFields:_4d,caseSensitive:_4b,withExtendedFields:_4e});}this.getQueryText=function(){return _4a;};this.getUseRegExp=function(){return _4c;};this.getCaseSensitive=function(){return _4b;};this.getDefaultFields=function(){return _4d;};this.getWithExtendedFields=function(){return _4e;};};abego.TiddlerQuery.prototype.test=function(_4f){if(!_4f){return false;}if(this.regExp){return this.tester.test(_4f);}return this.expr.exec(_4f);};abego.TiddlerQuery.prototype.filter=function(_50){return abego.select(_50,this.test,this);};abego.TiddlerQuery.prototype.getMarkRegExp=function(){if(this.regExp){return &quot;&quot;.search(this.regExp)&gt;=0?null:this.regExp;}return this.expr.getMarkRegExp();};abego.TiddlerQuery.prototype.toString=function(){return (this.regExp?this.regExp:this.expr).toString();};abego.PageWiseRenderer=function(){this.firstIndexOnPage=0;};merge(abego.PageWiseRenderer.prototype,{setItems:function(_51){this.items=_51;this.setFirstIndexOnPage(0);},getMaxPagesInNavigation:function(){return 10;},getItemsCount:function(_52){return this.items?this.items.length:0;},getCurrentPageIndex:function(){return Math.floor(this.firstIndexOnPage/this.getItemsPerPage());},getLastPageIndex:function(){return Math.floor((this.getItemsCount()-1)/this.getItemsPerPage());},setFirstIndexOnPage:function(_53){this.firstIndexOnPage=Math.min(Math.max(0,_53),this.getItemsCount()-1);},getFirstIndexOnPage:function(){this.firstIndexOnPage=Math.floor(this.firstIndexOnPage/this.getItemsPerPage())*this.getItemsPerPage();return this.firstIndexOnPage;},getLastIndexOnPage:function(){return Math.min(this.getFirstIndexOnPage()+this.getItemsPerPage()-1,this.getItemsCount()-1);},onPageChanged:function(_54,_55){},renderPage:function(_56){if(_56.beginRendering){_56.beginRendering(this);}try{if(this.getItemsCount()){var _57=this.getLastIndexOnPage();var _58=-1;for(var i=this.getFirstIndexOnPage();i&lt;=_57;i++){_58++;_56.render(this,this.items[i],i,_58);}}}finally{if(_56.endRendering){_56.endRendering(this);}}},addPageNavigation:function(_59){if(!this.getItemsCount()){return;}var _5a=this;var _5b=function(e){if(!e){var e=window.event;}abego.consumeEvent(e);var _5c=abego.toInt(this.getAttribute(&quot;page&quot;),0);var _5d=_5a.getCurrentPageIndex();if(_5c==_5d){return;}var _5e=_5c*_5a.getItemsPerPage();_5a.setFirstIndexOnPage(_5e);_5a.onPageChanged(_5c,_5d);};var _5f;var _60=this.getCurrentPageIndex();var _61=this.getLastPageIndex();if(_60&gt;0){_5f=createTiddlyButton(_59,&quot;Previous&quot;,&quot;Go to previous page (Shortcut: Alt-'&lt;')&quot;,_5b,&quot;prev&quot;);_5f.setAttribute(&quot;page&quot;,(_60-1).toString());_5f.setAttribute(&quot;accessKey&quot;,&quot;&lt;&quot;);}for(var i=-this.getMaxPagesInNavigation();i&lt;this.getMaxPagesInNavigation();i++){var _62=_60+i;if(_62&lt;0){continue;}if(_62&gt;_61){break;}var _63=(i+_60+1).toString();var _64=_62==_60?&quot;currentPage&quot;:&quot;otherPage&quot;;_5f=createTiddlyButton(_59,_63,&quot;Go to page %0&quot;.format([_63]),_5b,_64);_5f.setAttribute(&quot;page&quot;,(_62).toString());}if(_60&lt;_61){_5f=createTiddlyButton(_59,&quot;Next&quot;,&quot;Go to next page (Shortcut: Alt-'&gt;')&quot;,_5b,&quot;next&quot;);_5f.setAttribute(&quot;page&quot;,(_60+1).toString());_5f.setAttribute(&quot;accessKey&quot;,&quot;&gt;&quot;);}}});abego.LimitedTextRenderer=function(){var _65=40;var _66=4;var _67=function(_68,_69,_6a){var n=_68.length;if(n==0){_68.push({start:_69,end:_6a});return;}var i=0;for(;i&lt;n;i++){var _6b=_68[i];if(_6b.start&lt;=_6a&amp;&amp;_69&lt;=_6b.end){var r;var _6c=i+1;for(;_6c&lt;n;_6c++){r=_68[_6c];if(r.start&gt;_6a||_69&gt;_6b.end){break;}}var _6d=_69;var _6e=_6a;for(var j=i;j&lt;_6c;j++){r=_68[j];_6d=Math.min(_6d,r.start);_6e=Math.max(_6e,r.end);}_68.splice(i,_6c-i,{start:_6d,end:_6e});return;}if(_6b.start&gt;_6a){break;}}_68.splice(i,0,{start:_69,end:_6a});};var _6f=function(_70){var _71=0;for(var i=0;i&lt;_70.length;i++){var _72=_70[i];_71+=_72.end-_72.start;}return _71;};var _73=function(c){return (c&gt;=&quot;a&quot;&amp;&amp;c&lt;=&quot;z&quot;)||(c&gt;=&quot;A&quot;&amp;&amp;c&lt;=&quot;Z&quot;)||c==&quot;_&quot;;};var _74=function(s,_75){if(!_73(s[_75])){return null;}for(var i=_75-1;i&gt;=0&amp;&amp;_73(s[i]);i--){}var _76=i+1;var n=s.length;for(i=_75+1;i&lt;n&amp;&amp;_73(s[i]);i++){}return {start:_76,end:i};};var _77=function(s,_78,_79){var _7a;if(_79){_7a=_74(s,_78);}else{if(_78&lt;=0){return _78;}_7a=_74(s,_78-1);}if(!_7a){return _78;}if(_79){if(_7a.start&gt;=_78-_66){return _7a.start;}if(_7a.end&lt;=_78+_66){return _7a.end;}}else{if(_7a.end&lt;=_78+_66){return _7a.end;}if(_7a.start&gt;=_78-_66){return _7a.start;}}return _78;};var _7b=function(s,_7c){var _7d=[];if(_7c){var _7e=0;var n=s.length;var _7f=0;do{_7c.lastIndex=_7e;var _80=_7c.exec(s);if(_80){if(_7e&lt;_80.index){var t=s.substring(_7e,_80.index);_7d.push({text:t});}_7d.push({text:_80[0],isMatch:true});_7e=_80.index+_80[0].length;}else{_7d.push({text:s.substr(_7e)});break;}}while(true);}else{_7d.push({text:s});}return _7d;};var _81=function(_82){var _83=0;for(var i=0;i&lt;_82.length;i++){if(_82[i].isMatch){_83++;}}return _83;};var _84=function(s,_85,_86,_87,_88){var _89=Math.max(Math.floor(_88/(_87+1)),_65);var _8a=Math.max(_89-(_86-_85),0);var _8b=Math.min(Math.floor(_86+_8a/3),s.length);var _8c=Math.max(_8b-_89,0);_8c=_77(s,_8c,true);_8b=_77(s,_8b,false);return {start:_8c,end:_8b};};var _8d=function(_8e,s,_8f){var _90=[];var _91=_81(_8e);var pos=0;for(var i=0;i&lt;_8e.length;i++){var t=_8e[i];var _92=t.text;if(t.isMatch){var _93=_84(s,pos,pos+_92.length,_91,_8f);_67(_90,_93.start,_93.end);}pos+=_92.length;}return _90;};var _94=function(s,_95,_96){var _97=_96-_6f(_95);while(_97&gt;0){if(_95.length==0){_67(_95,0,_77(s,_96,false));return;}else{var _98=_95[0];var _99;var _9a;if(_98.start==0){_99=_98.end;if(_95.length&gt;1){_9a=_95[1].start;}else{_67(_95,_99,_77(s,_99+_97,false));return;}}else{_99=0;_9a=_98.start;}var _9b=Math.min(_9a,_99+_97);_67(_95,_99,_9b);_97-=(_9b-_99);}}};var _9c=function(_9d,s,_9e,_9f,_a0){if(_9f.length==0){return;}var _a1=function(_a2,s,_a3,_a4,_a5){var t;var _a6;var pos=0;var i=0;var _a7=0;for(;i&lt;_a3.length;i++){t=_a3[i];_a6=t.text;if(_a4&lt;pos+_a6.length){_a7=_a4-pos;break;}pos+=_a6.length;}var _a8=_a5-_a4;for(;i&lt;_a3.length&amp;&amp;_a8&gt;0;i++){t=_a3[i];_a6=t.text.substr(_a7);_a7=0;if(_a6.length&gt;_a8){_a6=_a6.substr(0,_a8);}if(t.isMatch){createTiddlyElement(_a2,&quot;span&quot;,null,&quot;marked&quot;,_a6);}else{createTiddlyText(_a2,_a6);}_a8-=_a6.length;}if(_a5&lt;s.length){abego.createEllipsis(_a2);}};if(_9f[0].start&gt;0){abego.createEllipsis(_9d);}var _a9=_a0;for(var i=0;i&lt;_9f.length&amp;&amp;_a9&gt;0;i++){var _aa=_9f[i];var len=Math.min(_aa.end-_aa.start,_a9);_a1(_9d,s,_9e,_aa.start,_aa.start+len);_a9-=len;}};this.render=function(_ab,s,_ac,_ad){if(s.length&lt;_ac){_ac=s.length;}var _ae=_7b(s,_ad);var _af=_8d(_ae,s,_ac);_94(s,_af,_ac);_9c(_ab,s,_ae,_af,_ac);};};(function(){function _b0(msg){alert(msg);throw msg;};if(version.major&lt;2||(version.major==2&amp;&amp;version.minor&lt;1)){_b0(&quot;YourSearchPlugin requires TiddlyWiki 2.1 or newer.\n\nCheck the archive for YourSearch plugins\nsupporting older versions of TiddlyWiki.\n\nArchive: http://tiddlywiki.abego-software.de/archive&quot;);}abego.YourSearch={};var _b1;var _b2;var _b3=function(_b4){_b1=_b4;};var _b5=function(){return _b1?_b1:[];};var _b6=function(){return _b1?_b1.length:0;};var _b7=4;var _b8=10;var _b9=2;var _ba=function(s,re){var m=s.match(re);return m?m.length:0;};var _bb=function(_bc,_bd){var _be=_bd.getMarkRegExp();if(!_be){return 1;}var _bf=_bc.title.match(_be);var _c0=_bf?_bf.length:0;var _c1=_ba(_bc.getTags(),_be);var _c2=_bf?_bf.join(&quot;&quot;).length:0;var _c3=_bc.title.length&gt;0?_c2/_bc.title.length:0;var _c4=_c0*_b7+_c1*_b9+_c3*_b8+1;return _c4;};var _c5=function(_c6,_c7,_c8,_c9,_ca,_cb){_b2=null;var _cc=_c6.reverseLookup(&quot;tags&quot;,_cb,false);try{var _cd=[];if(config.options.chkSearchInTitle){_cd.push(&quot;title&quot;);}if(config.options.chkSearchInText){_cd.push(&quot;text&quot;);}if(config.options.chkSearchInTags){_cd.push(&quot;tags&quot;);}_b2=new abego.TiddlerQuery(_c7,_c8,_c9,_cd,config.options.chkSearchExtendedFields);}catch(e){return [];}var _ce=_b2.filter(_cc);var _cf=abego.YourSearch.getRankFunction();for(var i=0;i&lt;_ce.length;i++){var _d0=_ce[i];var _d1=_cf(_d0,_b2);_d0.searchRank=_d1;}if(!_ca){_ca=&quot;title&quot;;}var _d2=function(a,b){var _d3=a.searchRank-b.searchRank;if(_d3==0){if(a[_ca]==b[_ca]){return (0);}else{return (a[_ca]&lt;b[_ca])?-1:+1;}}else{return (_d3&gt;0)?-1:+1;}};_ce.sort(_d2);return _ce;};var _d4=80;var _d5=50;var _d6=250;var _d7=50;var _d8=25;var _d9=10;var _da=&quot;yourSearchResult&quot;;var _db=&quot;yourSearchResultItems&quot;;var _dc;var _dd;var _de;var _df;var _e0;var _e1=function(){if(version.extensions.YourSearchPlugin.styleSheetInited){return;}version.extensions.YourSearchPlugin.styleSheetInited=true;setStylesheet(store.getTiddlerText(&quot;YourSearchStyleSheet&quot;),&quot;yourSearch&quot;);};var _e2=function(){return _dd!=null&amp;&amp;_dd.parentNode==document.body;};var _e3=function(){if(_e2()){document.body.removeChild(_dd);}};var _e4=function(e){_e3();var _e5=this.getAttribute(&quot;tiddlyLink&quot;);if(_e5){var _e6=this.getAttribute(&quot;withHilite&quot;);var _e7=highlightHack;if(_e6&amp;&amp;_e6==&quot;true&quot;&amp;&amp;_b2){highlightHack=_b2.getMarkRegExp();}story.displayTiddler(this,_e5);highlightHack=_e7;}return (false);};var _e8=function(){if(!_de){return;}var _e9=_de;var _ea=findPosX(_e9);var _eb=findPosY(_e9);var _ec=_e9.offsetHeight;var _ed=_ea;var _ee=_eb+_ec;var _ef=findWindowWidth();if(_ef&lt;_dd.offsetWidth){_dd.style.width=(_ef-100)+&quot;px&quot;;_ef=findWindowWidth();}var _f0=_dd.offsetWidth;if(_ed+_f0&gt;_ef){_ed=_ef-_f0-30;}if(_ed&lt;0){_ed=0;}_dd.style.left=_ed+&quot;px&quot;;_dd.style.top=_ee+&quot;px&quot;;_dd.style.display=&quot;block&quot;;};var _f1=function(){if(_dd){window.scrollTo(0,ensureVisible(_dd));}if(_de){window.scrollTo(0,ensureVisible(_de));}};var _f2=function(){_e8();_f1();};var _f3;var _f4;var _f5=new abego.PageWiseRenderer();var _f6=function(_f7){this.itemHtml=store.getTiddlerText(&quot;YourSearchItemTemplate&quot;);if(!this.itemHtml){_b0(&quot;YourSearchItemTemplate not found&quot;);}this.place=document.getElementById(_db);if(!this.place){this.place=createTiddlyElement(_f7,&quot;div&quot;,_db);}};merge(_f6.prototype,{render:function(_f8,_f9,_fa,_fb){_f3=_fb;_f4=_f9;var _fc=createTiddlyElement(this.place,&quot;div&quot;,null,&quot;yourSearchItem&quot;);_fc.innerHTML=this.itemHtml;applyHtmlMacros(_fc,null);refreshElements(_fc,null);},endRendering:function(_fd){_f4=null;}});var _fe=function(){if(!_dd||!_de){return;}var _ff=store.getTiddlerText(&quot;YourSearchResultTemplate&quot;);if(!_ff){_ff=&quot;&lt;b&gt;Tiddler YourSearchResultTemplate not found&lt;/b&gt;&quot;;}_dd.innerHTML=_ff;applyHtmlMacros(_dd,null);refreshElements(_dd,null);var _100=new _f6(_dd);_f5.renderPage(_100);_f2();};_f5.getItemsPerPage=function(){var n=(config.options.chkPreviewText)?abego.toInt(config.options.txtItemsPerPageWithPreview,_d9):abego.toInt(config.options.txtItemsPerPage,_d8);return (n&gt;0)?n:1;};_f5.onPageChanged=function(){_fe();};var _101=function(){if(_de==null||!config.options.chkUseYourSearch){return;}if((_de.value==_dc)&amp;&amp;_dc&amp;&amp;!_e2()){if(_dd&amp;&amp;(_dd.parentNode!=document.body)){document.body.appendChild(_dd);_f2();}else{abego.YourSearch.onShowResult(true);}}};var _102=function(){_e3();_dd=null;_dc=null;};var _103=function(self,e){while(e!=null){if(self==e){return true;}e=e.parentNode;}return false;};var _104=function(e){if(e.target==_de){return;}if(e.target==_df){return;}if(_dd&amp;&amp;_103(_dd,e.target)){return;}_e3();};var _105=function(e){if(e.keyCode==27){_e3();}};addEvent(document,&quot;click&quot;,_104);addEvent(document,&quot;keyup&quot;,_105);var _106=function(text,_107,_108){_dc=text;_b3(_c5(store,text,_107,_108,&quot;title&quot;,&quot;excludeSearch&quot;));abego.YourSearch.onShowResult();};var _109=function(_10a,_10b,_10c,_10d,_10e,_10f){_e1();_dc=&quot;&quot;;var _110=null;var _111=function(txt){if(config.options.chkUseYourSearch){_106(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}else{story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}_dc=txt.value;};var _112=function(e){_111(_de);return false;};var _113=function(e){if(!e){var e=window.event;}_de=this;switch(e.keyCode){case 13:if(e.ctrlKey&amp;&amp;_e0&amp;&amp;_e2()){_e0.onclick.apply(_e0,[e]);}else{_111(this);}break;case 27:if(_e2()){_e3();}else{this.value=&quot;&quot;;clearMessage();}break;}if(String.fromCharCode(e.keyCode)==this.accessKey||e.altKey){_101();}if(this.value.length&lt;3&amp;&amp;_110){clearTimeout(_110);}if(this.value.length&gt;2){if(this.value!=_dc){if(!config.options.chkUseYourSearch||config.options.chkSearchAsYouType){if(_110){clearTimeout(_110);}var txt=this;_110=setTimeout(function(){_111(txt);},500);}}else{if(_110){clearTimeout(_110);}}}if(this.value.length==0){_e3();}};var _114=function(e){this.select();clearMessage();_101();};var args=_10e.parseParams(&quot;list&quot;,null,true);var _115=getFlag(args,&quot;buttonAtRight&quot;);var _116=getParam(args,&quot;sizeTextbox&quot;,this.sizeTextbox);var btn;if(!_115){btn=createTiddlyButton(_10a,this.label,this.prompt,_112);}var txt=createTiddlyElement(null,&quot;input&quot;,null,&quot;txtOptionInput searchField&quot;,null);if(_10c[0]){txt.value=_10c[0];}txt.onkeyup=_113;txt.onfocus=_114;txt.setAttribute(&quot;size&quot;,_116);txt.setAttribute(&quot;accessKey&quot;,this.accessKey);txt.setAttribute(&quot;autocomplete&quot;,&quot;off&quot;);if(config.browser.isSafari){txt.setAttribute(&quot;type&quot;,&quot;search&quot;);txt.setAttribute(&quot;results&quot;,&quot;5&quot;);}else{txt.setAttribute(&quot;type&quot;,&quot;text&quot;);}if(_10a){_10a.appendChild(txt);}if(_115){btn=createTiddlyButton(_10a,this.label,this.prompt,_112);}_de=txt;_df=btn;};var _117=function(){_e3();var _118=_b5();var n=_118.length;if(n){var _119=[];for(var i=0;i&lt;n;i++){_119.push(_118[i].title);}story.displayTiddlers(null,_119);}};var _11a=function(_11b,_11c,_11d,_11e){invokeMacro(_11b,&quot;option&quot;,_11c,_11d,_11e);var elem=_11b.lastChild;var _11f=elem.onclick;elem.onclick=function(e){var _120=_11f.apply(this,arguments);_fe();return _120;};return elem;};var _121=function(s){var _122=[&quot;''&quot;,&quot;{{{&quot;,&quot;}}}&quot;,&quot;//&quot;,&quot;&lt;&lt;&lt;&quot;,&quot;/***&quot;,&quot;***/&quot;];var _123=&quot;&quot;;for(var i=0;i&lt;_122.length;i++){if(i!=0){_123+=&quot;|&quot;;}_123+=&quot;(&quot;+_122[i].escapeRegExp()+&quot;)&quot;;}return s.replace(new RegExp(_123,&quot;mg&quot;),&quot;&quot;).trim();};var _124=function(){var i=_f3;return (i&gt;=0&amp;&amp;i&lt;=9)?(i&lt;9?(i+1):0):-1;};var _125=new abego.LimitedTextRenderer();var _126=function(_127,s,_128){_125.render(_127,s,_128,_b2.getMarkRegExp());};var _129=TiddlyWiki.prototype.saveTiddler;TiddlyWiki.prototype.saveTiddler=function(_12a,_12b,_12c,_12d,_12e,tags,_12f){_129.apply(this,arguments);_102();};var _130=TiddlyWiki.prototype.removeTiddler;TiddlyWiki.prototype.removeTiddler=function(_131){_130.apply(this,arguments);_102();};config.macros.yourSearch={label:&quot;yourSearch&quot;,prompt:&quot;Gives access to the current/last YourSearch result&quot;,handler:function(_132,_133,_134,_135,_136,_137){if(_134.length==0){return;}var name=_134[0];var func=config.macros.yourSearch.funcs[name];if(func){func(_132,_133,_134,_135,_136,_137);}},tests:{&quot;true&quot;:function(){return true;},&quot;false&quot;:function(){return false;},&quot;found&quot;:function(){return _b6()&gt;0;},&quot;previewText&quot;:function(){return config.options.chkPreviewText;}},funcs:{itemRange:function(_138){if(_b6()){var _139=_f5.getLastIndexOnPage();var s=&quot;%0 - %1&quot;.format([_f5.getFirstIndexOnPage()+1,_139+1]);createTiddlyText(_138,s);}},count:function(_13a){createTiddlyText(_13a,_b6().toString());},query:function(_13b){if(_b2){createTiddlyText(_13b,_b2.toString());}},version:function(_13c){var t=&quot;YourSearch %0.%1.%2&quot;.format([version.extensions.YourSearchPlugin.major,version.extensions.YourSearchPlugin.minor,version.extensions.YourSearchPlugin.revision]);var e=createTiddlyElement(_13c,&quot;a&quot;);e.setAttribute(&quot;href&quot;,&quot;http://tiddlywiki.abego-software.de/#YourSearchPlugin&quot;);e.innerHTML=&quot;&lt;font color=\&quot;black\&quot; face=\&quot;Arial, Helvetica, sans-serif\&quot;&gt;&quot;+t+&quot;&lt;font&gt;&quot;;},copyright:function(_13d){var e=createTiddlyElement(_13d,&quot;a&quot;);e.setAttribute(&quot;href&quot;,&quot;http://www.abego-software.de&quot;);e.innerHTML=&quot;&lt;font color=\&quot;black\&quot; face=\&quot;Arial, Helvetica, sans-serif\&quot;&gt;&amp;copy; 2005-2008 &lt;b&gt;&lt;font color=\&quot;red\&quot;&gt;abego&lt;/font&gt;&lt;/b&gt; Software&lt;font&gt;&quot;;},newTiddlerButton:function(_13e){if(_b2){var r=abego.parseNewTiddlerCommandLine(_b2.getQueryText());var btn=config.macros.newTiddler.createNewTiddlerButton(_13e,r.title,r.params,&quot;new tiddler&quot;,&quot;Create a new tiddler based on search text. (Shortcut: Ctrl-Enter; Separators: '.', '#')&quot;,null,&quot;text&quot;);var _13f=btn.onclick;btn.onclick=function(){_e3();_13f.apply(this,arguments);};_e0=btn;}},linkButton:function(_140,_141,_142,_143,_144,_145){if(_142&lt;2){return;}var _146=_142[1];var text=_142&lt;3?_146:_142[2];var _147=_142&lt;4?text:_142[3];var _148=_142&lt;5?null:_142[4];var btn=createTiddlyButton(_140,text,_147,_e4,null,null,_148);btn.setAttribute(&quot;tiddlyLink&quot;,_146);},closeButton:function(_149,_14a,_14b,_14c,_14d,_14e){var _14f=createTiddlyButton(_149,&quot;close&quot;,&quot;Close the Search Results (Shortcut: ESC)&quot;,_e3);},openAllButton:function(_150,_151,_152,_153,_154,_155){var n=_b6();if(n==0){return;}var _156=n==1?&quot;open tiddler&quot;:&quot;open all %0 tiddlers&quot;.format([n]);var _157=createTiddlyButton(_150,_156,&quot;Open all found tiddlers (Shortcut: Alt-O)&quot;,_117);_157.setAttribute(&quot;accessKey&quot;,&quot;O&quot;);},naviBar:function(_158,_159,_15a,_15b,_15c,_15d){_f5.addPageNavigation(_158);},&quot;if&quot;:function(_15e,_15f,_160,_161,_162,_163){if(_160.length&lt;2){return;}var _164=_160[1];var _165=(_164==&quot;not&quot;);if(_165){if(_160.length&lt;3){return;}_164=_160[2];}var test=config.macros.yourSearch.tests[_164];var _166=false;try{if(test){_166=test(_15e,_15f,_160,_161,_162,_163)!=_165;}else{_166=(!eval(_164))==_165;}}catch(ex){}if(!_166){_15e.style.display=&quot;none&quot;;}},chkPreviewText:function(_167,_168,_169,_16a,_16b,_16c){var _16d=_169.slice(1).join(&quot; &quot;);var elem=_11a(_167,&quot;chkPreviewText&quot;,_16a,_16c);elem.setAttribute(&quot;accessKey&quot;,&quot;P&quot;);elem.title=&quot;Show text preview of found tiddlers (Shortcut: Alt-P)&quot;;return elem;}}};config.macros.foundTiddler={label:&quot;foundTiddler&quot;,prompt:&quot;Provides information on the tiddler currently processed on the YourSearch result page&quot;,handler:function(_16e,_16f,_170,_171,_172,_173){var name=_170[0];var func=config.macros.foundTiddler.funcs[name];if(func){func(_16e,_16f,_170,_171,_172,_173);}},funcs:{title:function(_174,_175,_176,_177,_178,_179){if(!_f4){return;}var _17a=_124();var _17b=_17a&gt;=0?&quot;Open tiddler (Shortcut: Alt-%0)&quot;.format([_17a.toString()]):&quot;Open tiddler&quot;;var btn=createTiddlyButton(_174,null,_17b,_e4,null);btn.setAttribute(&quot;tiddlyLink&quot;,_f4.title);btn.setAttribute(&quot;withHilite&quot;,&quot;true&quot;);_126(btn,_f4.title,_d4);if(_17a&gt;=0){btn.setAttribute(&quot;accessKey&quot;,_17a.toString());}},tags:function(_17c,_17d,_17e,_17f,_180,_181){if(!_f4){return;}_126(_17c,_f4.getTags(),_d5);},text:function(_182,_183,_184,_185,_186,_187){if(!_f4){return;}_126(_182,_121(_f4.text),_d6);},field:function(_188,_189,_18a,_18b,_18c,_18d){if(!_f4){return;}var name=_18a[1];var len=_18a.length&gt;2?abego.toInt(_18a[2],_d7):_d7;var v=store.getValue(_f4,name);if(v){_126(_188,_121(v),len);}},number:function(_18e,_18f,_190,_191,_192,_193){var _194=_124();if(_194&gt;=0){var text=&quot;%0)&quot;.format([_194.toString()]);createTiddlyElement(_18e,&quot;span&quot;,null,&quot;shortcutNumber&quot;,text);}}}};var opts={chkUseYourSearch:true,chkPreviewText:true,chkSearchAsYouType:true,chkSearchInTitle:true,chkSearchInText:true,chkSearchInTags:true,chkSearchExtendedFields:true,txtItemsPerPage:_d8,txtItemsPerPageWithPreview:_d9};for(var n in opts){if(config.options[n]==undefined){config.options[n]=opts[n];}}config.shadowTiddlers.AdvancedOptions+=&quot;\n&lt;&lt;option chkUseYourSearch&gt;&gt; Use 'Your Search' //([[more options|YourSearch Options]]) ([[help|YourSearch Help]])// &quot;;config.shadowTiddlers[&quot;YourSearch Help&quot;]=&quot;!Field Search\nWith the Field Search you can restrict your search to certain fields of a tiddler, e.g&quot;+&quot; only search the tags or only the titles. The general form is //fieldname//'':''//textToSearch// (e.&quot;+&quot;g. {{{title:intro}}}). In addition one-character shortcuts are also supported for the standard field&quot;+&quot;s {{{title}}}, {{{text}}} and {{{tags}}}:\n|!What you want|!What you type|!Example|\n|Search ''titles &quot;+&quot;only''|start word with ''!''|{{{!jonny}}} (shortcut for {{{title:jonny}}})|\n|Search ''contents/text &quot;+&quot;only''|start word with ''%''|{{{%football}}} (shortcut for {{{text:football}}})|\n|Search ''tags only&quot;+&quot;''|start word with ''#''|{{{#Plugin}}} (shortcut for {{{tags:Plugin}}})|\n\nUsing this feature you may&quot;+&quot; also search the extended fields (\&quot;Metadata\&quot;) introduced with TiddlyWiki 2.1, e.g. use {{{priority:1&quot;+&quot;}}} to find all tiddlers with the priority field set to \&quot;1\&quot;.\n\nYou may search a word in more than one&quot;+&quot; field. E.g. {{{!#Plugin}}} (or {{{title:tags:Plugin}}} in the \&quot;long form\&quot;) finds tiddlers containin&quot;+&quot;g \&quot;Plugin\&quot; either in the title or in the tags (but does not look for \&quot;Plugin\&quot; in the text). \n\n!Boole&quot;+&quot;an Search\nThe Boolean Search is useful when searching for multiple words.\n|!What you want|!What you &quot;+&quot;type|!Example|\n|''All words'' must exist|List of words|{{{jonny jeremy}}} (or {{{jonny and jeremy}}}&quot;+&quot;)|\n|''At least one word'' must exist|Separate words by ''or''|{{{jonny or jeremy}}}|\n|A word ''must &quot;+&quot;not exist''|Start word with ''-''|{{{-jonny}}} (or {{{not jonny}}})|\n\n''Note:'' When you specify two&quot;+&quot; words, separated with a space, YourSearch finds all tiddlers that contain both words, but not neces&quot;+&quot;sarily next to each other. If you want to find a sequence of word, e.g. '{{{John Brown}}}', you need&quot;+&quot; to put the words into quotes. I.e. you type: {{{\&quot;john brown\&quot;}}}.\n\nUsing parenthesis you may change &quot;+&quot;the default \&quot;left to right\&quot; evaluation of the boolean search. E.g. {{{not (jonny or jeremy)}}} finds&quot;+&quot; all tiddlers that contain neither \&quot;jonny\&quot; nor \&quot;jeremy. In contrast to this {{{not jonny or jeremy}}&quot;+&quot;} (i.e. without parenthesis) finds all tiddlers that either don't contain \&quot;jonny\&quot; or that contain \&quot;j&quot;+&quot;eremy\&quot;.\n\n!'Exact Word' Search\nBy default a search result all matches that 'contain' the searched tex&quot;+&quot;t. E.g. if you search for {{{Task}}} you will get all tiddlers containing 'Task', but also '~Complet&quot;+&quot;edTask', '~TaskForce' etc.\n\nIf you only want to get the tiddlers that contain 'exactly the word' you&quot;+&quot; need to prefix it with a '='. E.g. typing '=Task' will find the tiddlers that contain the word 'Tas&quot;+&quot;k', ignoring words that just contain 'Task' as a substring.\n\n!~CaseSensitiveSearch and ~RegExpSearch&quot;+&quot;\nThe standard search options ~CaseSensitiveSearch and ~RegExpSearch are fully supported by YourSearc&quot;+&quot;h. However when ''~RegExpSearch'' is on Filtered and Boolean Search are disabled.\n\nIn addition you m&quot;+&quot;ay do a \&quot;regular expression\&quot; search even with the ''~RegExpSearch'' set to false by directly enterin&quot;+&quot;g the regular expression into the search field, framed with {{{/.../}}}. \n\nExample: {{{/m[ae][iy]er/&quot;+&quot;}}} will find all tiddlers that contain either \&quot;maier\&quot;, \&quot;mayer\&quot;, \&quot;meier\&quot; or \&quot;meyer\&quot;.\n\n!~JavaScript E&quot;+&quot;xpression Filtering\nIf you are familiar with JavaScript programming and know some TiddlyWiki interna&quot;+&quot;ls you may also use JavaScript expression for the search. Just enter a JavaScript boolean expression&quot;+&quot; into the search field, framed with {{{ { ... } }}}. In the code refer to the variable tiddler and e&quot;+&quot;valuate to {{{true}}} when the given tiddler should be included in the result. \n\nExample: {{{ { tidd&quot;+&quot;ler.modified &gt; new Date(\&quot;Jul 4, 2005\&quot;)} }}} returns all tiddler modified after July 4th, 2005.\n\n!Com&quot;+&quot;bined Search\nYou are free to combine the various search options. \n\n''Examples''\n|!What you type|!Res&quot;+&quot;ult|\n|{{{!jonny !jeremy -%football}}}|all tiddlers with both {{{jonny}}} and {{{jeremy}}} in its tit&quot;+&quot;les, but no {{{football}}} in content.|\n|{{{#=Task}}}|All tiddlers tagged with 'Task' (the exact wor&quot;+&quot;d). Tags named '~CompletedTask', '~TaskForce' etc. are not considered.|\n\n!Access Keys\nYou are encour&quot;+&quot;aged to use the access keys (also called \&quot;shortcut\&quot; keys) for the most frequently used operations. F&quot;+&quot;or quick reference these shortcuts are also mentioned in the tooltip for the various buttons etc.\n\n|&quot;+&quot;!Key|!Operation|\n|{{{Alt-F}}}|''The most important keystroke'': It moves the cursor to the search in&quot;+&quot;put field so you can directly start typing your query. Pressing {{{Alt-F}}} will also display the pr&quot;+&quot;evious search result. This way you can quickly display multiple tiddlers using \&quot;Press {{{Alt-F}}}. S&quot;+&quot;elect tiddler.\&quot; sequences.|\n|{{{ESC}}}|Closes the [[YourSearch Result]]. When the [[YourSearch Resul&quot;+&quot;t]] is already closed and the cursor is in the search input field the field's content is cleared so &quot;+&quot;you start a new query.|\n|{{{Alt-1}}}, {{{Alt-2}}},... |Pressing these keys opens the first, second e&quot;+&quot;tc. tiddler from the result list.|\n|{{{Alt-O}}}|Opens all found tiddlers.|\n|{{{Alt-P}}}|Toggles the &quot;+&quot;'Preview Text' mode.|\n|{{{Alt-'&lt;'}}}, {{{Alt-'&gt;'}}}|Displays the previous or next page in the [[Your&quot;+&quot;Search Result]].|\n|{{{Return}}}|When you have turned off the 'as you type' search mode pressing the &quot;+&quot;{{{Return}}} key actually starts the search (as does pressing the 'search' button).|\n\n//If some of t&quot;+&quot;hese shortcuts don't work for you check your browser if you have other extensions installed that alr&quot;+&quot;eady \&quot;use\&quot; these shortcuts.//&quot;;config.shadowTiddlers[&quot;YourSearch Options&quot;]=&quot;|&gt;|!YourSearch Options|\n|&gt;|&lt;&lt;option chkUseYourSearch&gt;&gt; Use 'Your Search'|\n|!|&lt;&lt;option chkPreviewText&quot;+&quot;&gt;&gt; Show Text Preview|\n|!|&lt;&lt;option chkSearchAsYouType&gt;&gt; 'Search As You Type' Mode (No RETURN required&quot;+&quot; to start search)|\n|!|Default Search Filter:&lt;&lt;option chkSearchInTitle&gt;&gt;Title ('!')     &lt;&lt;option chk&quot;+&quot;SearchInText&gt;&gt;Text ('%')     &lt;&lt;option chkSearchInTags&gt;&gt;Tags ('#')    &lt;&lt;option chkSearchExtendedFiel&quot;+&quot;ds&gt;&gt;Extended Fields&lt;html&gt;&lt;br&gt;&lt;font size=\&quot;-2\&quot;&gt;The fields of a tiddlers that are searched when you don&quot;+&quot;'t explicitly specify a filter in the search text &lt;br&gt;(Explictly specify fields using one or more '!&quot;+&quot;', '%', '#' or 'fieldname:' prefix before the word/text to find).&lt;/font&gt;&lt;/html&gt;|\n|!|Number of items &quot;+&quot;on search result page: &lt;&lt;option txtItemsPerPage&gt;&gt;|\n|!|Number of items on search result page with pre&quot;+&quot;view text: &lt;&lt;option txtItemsPerPageWithPreview&gt;&gt;|\n&quot;;config.shadowTiddlers[&quot;YourSearchStyleSheet&quot;]=&quot;/***\n!~YourSearchResult Stylesheet\n***/\n/*{{{*/\n.yourSearchResult {\n\tposition: absolute;\n\twidth: 800&quot;+&quot;px;\n\n\tpadding: 0.2em;\n\tlist-style: none;\n\tmargin: 0;\n\n\tbackground: #ffd;\n\tborder: 1px solid DarkGra&quot;+&quot;y;\n}\n\n/*}}}*/\n/***\n!!Summary Section\n***/\n/*{{{*/\n.yourSearchResult .summary {\n\tborder-bottom-width:&quot;+&quot; thin;\n\tborder-bottom-style: solid;\n\tborder-bottom-color: #999999;\n\tpadding-bottom: 4px;\n}\n\n.yourSea&quot;+&quot;rchRange, .yourSearchCount, .yourSearchQuery   {\n\tfont-weight: bold;\n}\n\n.yourSearchResult .summary .&quot;+&quot;button {\n\tfont-size: 10px;\n\n\tpadding-left: 0.3em;\n\tpadding-right: 0.3em;\n}\n\n.yourSearchResult .summa&quot;+&quot;ry .chkBoxLabel {\n\tfont-size: 10px;\n\n\tpadding-right: 0.3em;\n}\n\n/*}}}*/\n/***\n!!Items Area\n***/\n/*{{{*&quot;+&quot;/\n.yourSearchResult .marked {\n\tbackground: none;\n\tfont-weight: bold;\n}\n\n.yourSearchItem {\n\tmargin-to&quot;+&quot;p: 2px;\n}\n\n.yourSearchNumber {\n\tcolor: #808080;\n}\n\n\n.yourSearchTags {\n\tcolor: #008000;\n}\n\n.yourSearc&quot;+&quot;hText {\n\tcolor: #808080;\n\tmargin-bottom: 6px;\n}\n\n/*}}}*/\n/***\n!!Footer\n***/\n/*{{{*/\n.yourSearchFoote&quot;+&quot;r {\n\tmargin-top: 8px;\n\tborder-top-width: thin;\n\tborder-top-style: solid;\n\tborder-top-color: #999999;&quot;+&quot;\n}\n\n.yourSearchFooter a:hover{\n\tbackground: none;\n\tcolor: none;\n}\n/*}}}*/\n/***\n!!Navigation Bar\n***/&quot;+&quot;\n/*{{{*/\n.yourSearchNaviBar a {\n\tfont-size: 16px;\n\tmargin-left: 4px;\n\tmargin-right: 4px;\n\tcolor: bla&quot;+&quot;ck;\n\ttext-decoration: underline;\n}\n\n.yourSearchNaviBar a:hover {\n\tbackground-color: none;\n}\n\n.yourSe&quot;+&quot;archNaviBar .prev {\n\tfont-weight: bold;\n\tcolor: blue;\n}\n\n.yourSearchNaviBar .currentPage {\n\tcolor: #&quot;+&quot;FF0000;\n\tfont-weight: bold;\n\ttext-decoration: none;\n}\n\n.yourSearchNaviBar .next {\n\tfont-weight: bold&quot;+&quot;;\n\tcolor: blue;\n}\n/*}}}*/\n&quot;;config.shadowTiddlers[&quot;YourSearchResultTemplate&quot;]=&quot;&lt;!--\n{{{\n--&gt;\n&lt;span macro=\&quot;yourSearch if found\&quot;&gt;\n&lt;!-- The Summary Header ============================&quot;+&quot;================ --&gt;\n&lt;table class=\&quot;summary\&quot; border=\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;+&quot;&lt;tbody&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tYourSearch Result &lt;span class=\&quot;yourSearchRange\&quot; macro=\&quot;yourSearc&quot;+&quot;h itemRange\&quot;&gt;&lt;/span&gt;\n\t\t&amp;nbsp;of&amp;nbsp;&lt;span class=\&quot;yourSearchCount\&quot; macro=\&quot;yourSearch count\&quot;&gt;&lt;/span&gt;\n&quot;+&quot;\t\tfor&amp;nbsp;&lt;span class=\&quot;yourSearchQuery\&quot; macro=\&quot;yourSearch query\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n\t&lt;td class=\&quot;yourSea&quot;+&quot;rchButtons\&quot; align=\&quot;right\&quot;&gt;\n\t\t&lt;span macro=\&quot;yourSearch chkPreviewText\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;chkBoxLabel&quot;+&quot;\&quot;&gt;preview text&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch newTiddlerButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch openAllButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch lin&quot;+&quot;kButton 'YourSearch Options' options 'Configure YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkB&quot;+&quot;utton 'YourSearch Help' help 'Get help how to use YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch clo&quot;+&quot;seButton\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n\n&lt;!-- The List of Found Tiddlers =================&quot;+&quot;=========================== --&gt;\n&lt;div id=\&quot;yourSearchResultItems\&quot; itemsPerPage=\&quot;25\&quot; itemsPerPageWithPr&quot;+&quot;eview=\&quot;10\&quot;&gt;&lt;/div&gt;\n\n&lt;!-- The Footer (with the Navigation) ===========================================&quot;+&quot;= --&gt;\n&lt;table class=\&quot;yourSearchFooter\&quot; border=\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tbody&quot;+&quot;&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tResult page: &lt;span class=\&quot;yourSearchNaviBar\&quot; macro=\&quot;yourSearch naviBar&quot;+&quot;\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n\t&lt;td align=\&quot;right\&quot;&gt;&lt;span macro=\&quot;yourSearch version\&quot;&gt;&lt;/span&gt;, &lt;span macro=\&quot;yourSearc&quot;+&quot;h copyright\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n&lt;!-- end of the 'tiddlers found' case =========&quot;+&quot;================================== --&gt;\n&lt;/span&gt;\n\n\n&lt;!-- The \&quot;No tiddlers found\&quot; case =================&quot;+&quot;========================== --&gt;\n&lt;span macro=\&quot;yourSearch if not found\&quot;&gt;\n&lt;table class=\&quot;summary\&quot; border=&quot;+&quot;\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tbody&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tYourSearch Resu&quot;+&quot;lt: No tiddlers found for &lt;span class=\&quot;yourSearchQuery\&quot; macro=\&quot;yourSearch query\&quot;&gt;&lt;/span&gt;.\n\t&lt;/td&gt;\n\t&lt;t&quot;+&quot;d class=\&quot;yourSearchButtons\&quot; align=\&quot;right\&quot;&gt;\n\t\t&lt;span macro=\&quot;yourSearch newTiddlerButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkButton 'YourSearch Options'&quot;+&quot; options 'Configure YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkButton 'YourSearch Help' help&quot;+&quot; 'Get help how to use YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch closeButton\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;&quot;+&quot;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n&lt;/span&gt;\n\n\n&lt;!--\n}}}\n--&gt;\n&quot;;config.shadowTiddlers[&quot;YourSearchItemTemplate&quot;]=&quot;&lt;!--\n{{{\n--&gt;\n&lt;span class='yourSearchNumber' macro='foundTiddler number'&gt;&lt;/span&gt;\n&lt;span class='yourSea&quot;+&quot;rchTitle' macro='foundTiddler title'/&gt;&lt;/span&gt;&amp;nbsp;-&amp;nbsp;\n&lt;span class='yourSearchTags' macro='found&quot;+&quot;Tiddler field tags 50'/&gt;&lt;/span&gt;\n&lt;span macro=\&quot;yourSearch if previewText\&quot;&gt;&lt;div class='yourSearchText' macro='fo&quot;+&quot;undTiddler field text 250'/&gt;&lt;/div&gt;&lt;/span&gt;\n&lt;!--\n}}}\n--&gt;&quot;;config.shadowTiddlers[&quot;YourSearch&quot;]=&quot;&lt;&lt;tiddler [[YourSearch Help]]&gt;&gt;&quot;;config.shadowTiddlers[&quot;YourSearch Result&quot;]=&quot;The popup-like window displaying the result of a YourSearch query.&quot;;config.macros.search.handler=_109;var _195=function(){if(config.macros.search.handler!=_109){alert(&quot;Message from YourSearchPlugin:\n\n\nAnother plugin has disabled the 'Your Search' features.\n\n\nYou may &quot;+&quot;disable the other plugin or change the load order of \nthe plugins (by changing the names of the tidd&quot;+&quot;lers)\nto enable the 'Your Search' features.&quot;);}};setTimeout(_195,5000);abego.YourSearch.getStandardRankFunction=function(){return _bb;};abego.YourSearch.getRankFunction=function(){return abego.YourSearch.getStandardRankFunction();};abego.YourSearch.getCurrentTiddler=function(){return _f4;};abego.YourSearch.closeResult=function(){_e3();};abego.YourSearch.getFoundTiddlers=function(){return _b1;};abego.YourSearch.getQuery=function(){return _b2;};abego.YourSearch.onShowResult=function(_196){highlightHack=_b2?_b2.getMarkRegExp():null;if(!_196){_f5.setItems(_b5());}if(!_dd){_dd=createTiddlyElement(document.body,&quot;div&quot;,_da,&quot;yourSearchResult&quot;);}else{if(_dd.parentNode!=document.body){document.body.appendChild(_dd);}}_fe();highlightHack=null;};})();}
//%/</pre>
</div>
<div title="cheat sheet" creator="colm" modifier="colm" created="201103031538" changecount="1">
<pre>[[Cheat Sheet - Also]]

!Inline Formatting
|!Option|!Syntax|!Output|
|bold font|{{{''bold''}}}|''bold''|
|italic type|{{{//italic//}}}|//italic//|
|underlined text|{{{__underlined__}}}|__underlined__|
|strikethrough text|{{{--strikethrough--}}}|--strikethrough--|
|superscript text|{{{^^super^^script}}}|^^super^^script|
|subscript text|{{{~~sub~~script}}}|~~sub~~script|
|highlighted text|{{{@@highlighted@@}}}|@@highlighted@@|
|preformatted text|&lt;html&gt;&lt;code&gt;{{{preformatted}}}&lt;/code&gt;&lt;/html&gt;|{{{preformatted}}}|
!Block Elements
!!Headings
{{{
!Heading 1
!!Heading 2
!!!Heading 3
!!!!Heading 4
!!!!!Heading 5
}}}
!Heading 1
!!Heading 2
!!!Heading 3
!!!!Heading 4
!!!!!Heading 5
!!Lists
{{{
* unordered list, level 1
** unordered list, level 2
*** unordered list, level 3

# ordered list, level 1
## ordered list, level 2
### ordered list, level 3

; definition list, term
: definition list, description
}}}

* unordered list, level 1
** unordered list, level 2
*** unordered list, level 3
# ordered list, level 1
## ordered list, level 2
### ordered list, level 3
; definition list, term
: definition list, description
!!Blockquotes
{{{
&gt; blockquote, level 1
&gt;&gt; blockquote, level 2
&gt;&gt;&gt; blockquote, level 3
&gt;&gt; blockquote, level 2
&gt; blockquote, level 1

&lt;&lt;&lt;
blockquote
blockquote
&lt;&lt;&lt;
}}}
&gt; blockquote, level 1
&gt;&gt; blockquote, level 2
&gt;&gt;&gt; blockquote, level 3
&gt;&gt; blockquote, level 2
&gt; blockquote, level 1

&lt;&lt;&lt;
blockquote
blockquote
&lt;&lt;&lt;
!!Preformatted Text
&lt;html&gt;&lt;pre&gt;
{{{
preformatted (e.g. code)
}}}
&lt;/pre&gt;&lt;/html&gt;

{{{
preformatted (e.g. code)
}}}

!!Tables
{{{
|~CssClass|k
|!heading column 1|!heading column 2|
|row 1, column 1|row 1, column 2|
|row 2, column 1|row 2, column 2|
|&gt;|COLSPAN|
|ROWSPAN| … |
|~| … |
|…| … |
|caption|c
}}}
''Annotation:''
* The {{{&gt;}}} marker creates a &quot;colspan&quot;, causing the current cell to merge with the one to the right.
* The {{{~}}} marker creates a &quot;rowspan&quot;, causing the current cell to merge with the one above.
&lt;&lt;&lt;
|~CssClass|k
|!heading column 1|!heading column 2|
|row 1, column 1|row 1, column 2|
|row 2, column 1|row 2, column 2|
|&gt;|COLSPAN|
|ROWSPAN| … |
|~| … |
|…| … |
|caption|c
&lt;&lt;&lt;
!!Images /% TODO %/
cf. [[TiddlyWiki.com|http://www.tiddlywiki.com/#EmbeddedImages]]
!Hyperlinks
* ~WikiWords (mixed case) are automatically transformed to hyperlinks to the respective tiddler
** the automatic transformation can be suppressed by preceding the respective ~WikiWord with a tilde ({{{~}}}): {{{~WikiWord}}}
* ~PrettyLinks are enclosed in double square brackets and contain the desired tiddler name: {{{[[tiddler name]]}}}
** optionally, a custom title or description can be added, separated by a pipe character ({{{|}}}): {{{[[title|target]]}}}&lt;br&gt;''N.B.:'' In this case, the target can also be any website (i.e. URL).
!Special Markers
* {{{&lt;br&gt;}}} forces a manual line break
* {{{----}}} creates a horizontal ruler
* [[HTML entities|http://www.tiddlywiki.com/#HtmlEntities]]
* {{{&lt;&lt;macroName&gt;&gt;}}} calls the respective &quot;&quot;&quot;[[macro|Macros]]&quot;&quot;&quot;
* To hide text within a tiddler so that it is not displayed, it can be wrapped in {{{/%}}} and {{{%/}}}.&lt;br/&gt;This can be a useful trick for hiding drafts or annotating complex markup.
* To prevent wiki markup from taking effect for a particular section, that section can be enclosed in three double quotes: e.g. {{{&quot;&quot;&quot;WikiWord&quot;&quot;&quot;}}}.</pre>
</div>
<div title="cpio" creator="colm" modifier="colm" created="201104281155" changecount="1">
<pre>Let the source directory be /source, and let the destination directory be /destination.
{{{
# cd  /source
# cd ..
# find  ./source  -depth -print | cpio -cvo&gt; /destination/source_data.cpio
# cd /destination
# cpio -icvmdI ./source_data.cpio
# rm -rf ./source_data.cpio
}}}</pre>
</div>
<div title="deadlock" creator="colm" modifier="colm" created="201109060859" modified="201109061108" changecount="3">
<pre>See Metalink 62365 - What to do with &quot;ORA-60 Deadlock Detected&quot; Errors

This is an ITL-type deadlock graph:
{{{
                       ---------Blocker(s)--------  ---------Waiter(s)---------
Resource Name          process session holds waits  process session holds waits
TX-01680010-000000d6       162     106     X            127     249           S
TX-0132001f-00000131       127     249     X            162     106           S

session 106: DID 0001-00A2-00000001     session 249: DID 0001-007F-00000001
session 249: DID 0001-007F-00000001     session 106: DID 0001-00A2-00000001

Rows waited on:
  Session 106: obj - rowid = 0001133F - AAARM/AAyAAG33kAAA
  (dictionary objn - 70463, file - 50, block - 1801700, slot - 0)
  Session 249: obj - rowid = 0001133F - AAARM/AAyAAG3snAAA
  (dictionary objn - 70463, file - 50, block - 1800999, slot - 0)
}}}

The X implies a row level lock, the S implies that the 'other' session has a lock on another record in the same block.

For a row level deadlock, they would all be X. Implies modify the initrans on CPRD and rebuild the table...

To decode objects, check the row IDs given later (also often missing on an ~ITL-type deadlock):
{{{
SELECT owner, object_name, object_type
FROM dba_objects
WHERE object_id = 70463; -- dec for hex 0001133F

select * 
from &lt;above object?&gt;
where rowid='AAARM/AAyAAG33kAAA';
}}}</pre>
</div>
<div title="default role" creator="colm" modifier="colm" created="201302181020" modified="201302181022" changecount="4">
<pre>This will not always be ALL... check DEFROLE

0 – None (So when a role is assigned to a user the role is not a default) and none of the current roles are default. The value is set to 0 by “ALTER USER test DEFAULT ROLE NONE”.
1 – Roles assigned to users and the ones that will be assigned will be default roles. The value is set to 1 by “ALTER USER test DEFAULT ROLE ALL”.
2 – Specific roles are default roles, the list of roles that are default to a user is stored in the table “DEFROLE$” and also can be seen when querying “DBA_ROLE_PRIVS” column “DEFAULT_ROLE”. The value is set to 2 by “ALTER USER test DEFAULT ROLE &lt;role name&gt;” only if the value was 0, if the value is 1 it can't be changed to 2 unless to 0 (NONE) first.

(this last rule does not appear to be true..)

{{{
select NAME, DEFROLE, decode (DEFROLE, 
						0,'NONE',
						1,'ALL',
						2,'LIST - see DBA_ROLE_PRIVS.DEFAULT_ROLE') defrole_decode
from sys.user$
where name='GENEVA_ADMIN';

ALTER USER GENEVA_ADMIN DEFAULT ROLE DBA; -- sets to list (2)
ALTER USER GENEVA_ADMIN DEFAULT ROLE CONNECT; -- sets to list (2)
ALTER USER GENEVA_ADMIN DEFAULT ROLE ALL; - resets to ALL (1) 
}}}</pre>
</div>
<div title="e6400" creator="colm" modifier="colm" created="201107081251" changecount="1">
<pre>1440x900 res</pre>
</div>
<div title="edit mode sharepoint link" creator="colm" modifier="colm" created="201208281105" modified="201208281235" changecount="2">
<pre>If you simply enter the URL of the document into the Shortcut Wizard, it will create an Internet Explorer shortcut. You do not want this. Instead, go to your document library and open it in Windows Explorer. Right click the document you want to create a shortcut for and select Send To -&gt; Desktop. This should create a shortcut that will open in edit mode.</pre>
</div>
<div title="erlang" creator="colm" modifier="colm" created="201204171447" modified="201204171447" changecount="2">
<pre>from wikipedia:

When used to represent carried traffic, a value (which can be a non-integer such as 43.5) followed by “erlangs” represents the average number of concurrent calls carried by the circuits (or other service-providing elements), where that average is calculated over some reasonable period of time. The period over which the average is calculated is often one hour, but shorter periods (e.g., 15 minutes) may be used where it is known that there are short spurts of demand and a traffic measurement is desired that does not mask these spurts. One erlang of carried traffic refers to a single resource being in continuous use, or two channels being in use fifty percent of the time, and so on. For example, if an office has two telephone operators who are both busy all the time, that would represent two erlangs (2 E) of traffic; or a radio channel that is occupied for one hour continuously is said to have a load of 1 Erlang.

When used to describe offered traffic, a value followed by “erlangs” represents the average number of concurrent calls that would have been carried if there were an unlimited number of circuits (that is, if the call-attempts that were made when all circuits were in use had not been rejected). The relationship between offered traffic and carried traffic depends on the design of the system and user behavior. Three common models are (a) callers whose call-attempts are rejected go away and never come back, (b) callers whose call-attempts are rejected try again within a fairly short space of time, and (c) the system allows users to wait in queue until a circuit becomes available.

A third measurement of traffic is instantaneous traffic, expressed as a certain number of erlangs, meaning the exact number of calls taking place at a point in time. In this case the number is an integer. Traffic-level-recording devices, such as moving-pen recorders, plot instantaneous traffic.</pre>
</div>
<div title="excel tips" creator="YourName" modifier="YourName" created="201306041052" modified="201309021016" changecount="12">
<pre>* Dbl-click fill drag button to fill data range - at least up to blank lines
* Scroll-lock to change arrow key behaviour
* Ctrl Dn Arrow - last used cell in current column
!!!Text import wizard
invoke this by doing a normal paste and then using the pate options dropdown to select wizard
!!!Paste values
Customize the ribbon to have a Paste Values command to get an Alt-NUM keyboard shortcut
!!!Date times
For elapsed times, use the [hh] format which will not rollover at 24 hours.
For negative times: The solution is to use the optional 1904 date system. Select Tools, Options, click the Calculation tab, and check the 1904 date system box to change the starting date to January 2, 1904. 
!!!Substrings
E.g.: run001_B1_C1_dropsyn_3_0_05.log -&gt; STEP-010 DROP of SYNONYM IVRTARIFFn

- Locate script and step number:
{{{=Mid(c2,Find(&quot;run&quot;,C2)+7,8) &amp; MID(C2,FIND(&quot;STEP&quot;,C2),8)}}}

- handle #VALUE error for script titles with no STEP number
{{{=(MID(C2,FIND(&quot;run&quot;,C2)+7,8)) &amp; &quot;-&quot; &amp; if(iserror(FIND(&quot;STEP&quot;,C2))=true,&quot;SCRIPT&quot;,MID(C2,FIND(&quot;STEP&quot;,C2),8))}}}
!!!Moving formulas
Inserting/deleting rows will move formula contents - there are a couple of approaches:

- use indirect to make cell references unchanging so rows can be inserted - works but will not increment across cells at paste time
{{{=(MID(indirect(&quot;A113&quot;),FIND(&quot;run&quot;,indirect(&quot;A113&quot;))+7,8)) &amp; &quot;-&quot; &amp; IF(ISERROR(FIND(&quot;STEP&quot;,indirect(&quot;A113&quot;)))=TRUE,&quot;SCRIPT&quot;,MID(indirect(&quot;A113&quot;),FIND(&quot;STEP&quot;,indirect(&quot;A113&quot;)),8))}}}

- use offset to refer to the same relative cell - this does it:
{{{=MID(offset(c113,0,-2),FIND(&quot;run&quot;,offset(c113,0,-2))+7,8)  &amp; &quot;-&quot; &amp; if(iserror(FIND(&quot;STEP&quot;,offset(c113,0,-2)))=true,&quot;SCRIPT&quot;,MID(offset(c113,0,-2),FIND(&quot;STEP&quot;,offset(c113,0,-2)),8))}}}

!!!vlookup 
fetches a value from a table:
{{{=vlookup(known value (cell), table where values reside (known values on lefmost colt), column # where RETURN value is located, false)}}}
the trailing false has to do with exact matches and a 'true' implies a sorted table - see docs.

!!! Dropdown
* create a named range by selecting data and entering  a name at top left of datsheet
* in dest cells, select Data Validation -&gt; List -&gt; Source - in here enter '= range-name&quot;
</pre>
</div>
<div title="force_logging" creator="colm" modifier="colm" created="201301221616" modified="201301241423" changecount="5">
<pre>NOLOGGING can be used to minimize the amount of redo generated by Oracle.  Only the following operations can make use of nologging:
* SQL*Loader in direct mode
* INSERT /*+APPEND*/ ...
* CTAS
* ALTER TABLE statements (move/add/split/merge partitions)
* CREATE INDEX
* ALTER INDEX statements (move/add/split/merge partitions) 

Independent of specifying FORCE LOGGING for the database, you can selectively specify FORCE LOGGING or NO FORCE LOGGING at the tablespace level. However, if FORCE LOGGING mode is in effect for the database, it takes precedence over the tablespace setting. If it is not in effect for the database, then the individual tablespace settings are enforced. Oracle recommends that either the entire database is placed into FORCE LOGGING mode, or individual tablespaces be placed into FORCE LOGGING mode, but not both.

http://docs.oracle.com/cd/E11882_01/server.112/e25494/create004.htm#ADMIN11097

Also:
At the tablespace level, the logging clause specifies the default logging attribute for all tables, indexes, and partitions created in the tablespace. When an existing tablespace logging attribute is changed by the ALTER TABLESPACE statement, then all tables, indexes, and partitions created after the ALTER statement have the new logging attribute; existing ones do not change their logging attributes. The tablespace-level logging attribute can be overridden by the specifications at the table, index, or partition level.</pre>
</div>
<div title="get homedir sql" creator="colm" modifier="colm" created="201206121558" changecount="1">
<pre>{{{
#!/usr/bin/ksh

print FTPing
ftp -n ftp.emea.convergys.com &lt;&lt;EOT
user btraurora cN0lJz
cd cam
bin
get homedirsql.tgz
quit
EOT
}}}</pre>
</div>
<div title="gparams" creator="colm" modifier="colm" created="201107152146" modified="201107162135" changecount="2">
<pre>{{{
update geneva_admin.gparams set string_value='hocpi03n'
where name in ('TMhostMachineName', 'TRDhostMachineName', 'REMhostMachineName');

update geneva_admin.gparams set integer_value=20 where name='TMnumStatusMessages';

update geneva_admin.gparams set integer_value=3060 where name='TMchildProcessPort';
update geneva_admin.gparams set integer_value=3061 where name='TMsystemMonitorPort';
update geneva_admin.gparams set integer_value=3062 where name='TRDclientPort';
update geneva_admin.gparams set integer_value=3063 where name='REMclientPort';

update gparams set string_value='/Disk1/home/vod2201/work/bin' where name ='TMimageDir';

update GPARAMS set STRING_VALUE=replace(STRING_VALUE,'/Disk1/home/vod2207','//Disk1/home/vod2201');
update filegroup set TARGET_DIRECTORY=replace(TARGET_DIRECTORY,'/Disk1/home/vod2207','//Disk1/home/vod2201');
update processplan set parameters=replace(parameters,'/Disk1/home/vod2207','//Disk1/home/vod2201');

insert into gparams (name, type, start_dtm, string_value,integer_value) 
values ('PCMIdatFileDirObjName', 'STRING',  TO_Date( '01/01/2000 12:00:00 AM', 'MM/DD/YYYY HH:MI:SS AM'), 'PCMLOGDIR', NULL); 

insert into gparams (name, type, start_dtm, string_value,integer_value) 
values ('PCMIJMmessageServerURL', 'STRING',  TO_Date( '01/01/2000 12:00:00 AM', 'MM/DD/YYYY HH:MI:SS AM'), 't3://163.164.47.179:9700', NULL); 
}}}</pre>
</div>
<div title="ksh Scripts" modifier="colm" created="200907151210" modified="201102091456" changecount="5">
<pre>*Consider using wait instead of sleep
!!!Datestamp
{{{
date +&quot;%Y%m%d-%H%M%S&quot;
}}}
!!! Perl CPAN shell
{{{
 perl -MCPAN -e shell
 i /&lt;search&gt;/ e.g. i /oracle/
 install &lt;module name&gt;
}}}
!!! Ksh Scripting
Contents
Principle of Script
Variables
Branching
Looping
Commandline Arguments
Comparisons
Variable Manipulations
Ksh Regular Expressions
Functions
Data Redirection
Pipes
Coprocesses
Read Input from User and from Files
Special Variables
Action on Success or Failure of a Command
Trivial Calculations
Numerical Calculations using &quot;bc&quot;
&quot;grep&quot;
&quot;sed&quot;
&quot;awk&quot;
&quot;perl&quot;

Principle of Script

Defining the Shell Type

To make a ksh script (which is a ksh program) crate a new file with a starting line like:

 #!/usr/bin/ksh

It is important that the path to the ksh is propper and that the line doesn not have more than 32 characters. The shell from which you are starting the script will find this line and and hand the whole script over to to ksh. Without this line the script would be interpreted by the same typ of shell as the one, from which it was started. But since the syntax is different for all shells, it is necessary to define the shell with that line.
Four Types of Lines

A script has four types of lines: The shell defining line at the top, empty lines, commentary lines starting with a # and command lines. See the following top of a script as an example for these types of lines:

{{{
#!/usr/bin/ksh

# Commentary......

file=/path/file
if [[ $file = $1 ]];then
   command
fi
}}}

Start and End of Script

The script starts at the first line and ends either when it encounters an &quot;exit&quot; or the last line. All &quot;#&quot; lines are ignored.
Start and End of Command

A command starts with the first word on a line or if it's the second command on a line with the first word after a&quot;;'.
A command ends either at the end of the line or whith a &quot;;&quot;. So one can put several commands onto one line:

 print -n &quot;Name: &quot;; read name; print &quot;&quot;


One can continue commands over more than one line with a &quot;\&quot; immediately followed by a newline sign which is made be the return key:

 grep filename | sort -u | awk '{print $4}' | \
 uniq -c &gt;&gt; /longpath/file

Name and Permissions of Script File

The script mus not have a name which is identical to a unix command: So the script must NOT be called &quot;test&quot;!
After saveing the file give it the execute permissions with: chmod 700 filename.

Variables
Filling in

When filling into a variable then one uses just it's name: state=&quot;US&quot; and no blanks. There is no difference between strings and numbers: price=50.
Using

When using a variable one needs to put a $ sign in front of it: print $state $price.
Arrays

Set and use an array like:
{{{
arrname[1]=4	To fill in
print ${arraname[1]}	To print out
${arrname[*]}	Get all elements
${#arrname[*]}	Get the number of elements
}}}

Declaration

There are happily no declarations of variables needed in ksh. One cannot have decimals only integers.

Branching
if then fi

{{{
if [[ $value -eq 7 ]];then
   print &quot;$value is 7&quot;
fi
}}}

or:

{{{
if [[ $value -eq 7 ]]
then
   print &quot;$value is 7&quot;
fi
}}}

or:
{{{
if [[ $value -eq 7 ]];then print &quot;$value is 7&quot;;fi

if then else fi

if [[ $name = &quot;John&quot; ]];then
   print &quot;Your welcome, ${name}.&quot;
else
   print &quot;Good bye, ${name}!&quot;
fi
}}}

if then elif then else fi

{{{
if [[ $name = &quot;John&quot; ]];then
   print &quot;Your welcome, ${name}.&quot;
elif [[ $name = &quot;Hanna&quot; ]];then
   print &quot;Hello, ${name}, who are you?&quot;
else
   print &quot;Good bye, ${name}!&quot;
fi
}}}

case esac

{{{
case $var in
   john|fred) print $invitation;;
   martin)    print $declination;;
   *)         print &quot;Wrong name...&quot;;;
esac
}}}

Looping
while do done

{{{
while [[ $count -gt 0 ]];do
   print &quot;\$count is $count&quot;
   (( count -= 1 ))
done
}}}

until do done

{{{
until [[ $answer = &quot;yes&quot; ]];do
   print -n &quot;Please enter \&quot;yes\&quot;: &quot;
   read answer
   print &quot;&quot;
done
}}}

for var in list do done

{{{
for foo in $(ls);do
   if [[ -d $foo ]];then
      print &quot;$foo is a directory&quot;
   else
      print &quot;$foo is not a directory&quot;
   fi
done
}}}

continue...break

One can skip the rest of a loop and directly go to the next iteration with: &quot;continue&quot;.

{{{
while read line
do
   if [[ $line = *.gz ]];then
      continue
   else
      print $line
   fi
done
}}}

One can also prematurely leave a loop with: &quot;break&quot;.

{{{
while read line;do
   if [[ $line = *!(.c) ]];then
      break
   else
      print $line
   fi
done
}}}

Command Line Arguments

(Officially they are called &quot;positional parameters&quot;)

The number of command line arguments is stored in $# so one can check
for arguments with:

{{{
if [[ $# -eq 0 ]];then
   print &quot;No Arguments&quot;
   exit
fi
}}}

The single Arguments are stored in $1, ....$n and all are in $* as one string. The arguments cannot directly be modified but one can reset the hole commandline for another part of the program. If we need a first argument $first for the rest of the program we do:

{{{
if [[ $1 != $first ]];then
   set $first $*
fi
}}}

One can iterate over the command line arguments with the help of the shift command. Shift indirectly removes the first argument.

{{{
until [[ $# -qe 0 ]];do
   # commands ....
   shift
done
}}}

One can also iterate with the for loop, the default with for is $*:

{{{
for arg;do
   print $arg
done
}}}

The program name is stored in $0 but it contains the path also!

!!!! Comparisons

To compare strings one uses &quot;=&quot; for equal and &quot;!=&quot; for not equal.
To compare numbers one uses &quot;-eq&quot; for equal &quot;-ne&quot; for not equal as well as &quot;-gt&quot; for greater than
and &quot;-lt&quot; for less than.

{{{
if [[ $name = &quot;John&quot; ]];then
   # commands....
fi
if [[ $size -eq 1000 ]];then
   # commands....
fi
}}}

With &quot;&amp;&amp;&quot; for &quot;AND&quot; and &quot;||&quot; for &quot;OR&quot; one can combine statements:

{{{
if [[ $price -lt 1000 || $name = &quot;Hanna&quot; ]];then
   # commands....
fi
if [[ $name = &quot;Fred&quot; &amp;&amp; $city = &quot;Denver&quot; ]];then
   # commands....
fi
}}}

!!! Variable Manipulations

!!!! Removing something from a variable

Variables that contain a path can very easily be stripped of it: ${name##*/} gives you just the filename. Or if one wants the path: ${name%/*}. % takes it away from the left and # from the right.
%% and ## take the longest possibility while % and # just take the shortest one.

!!!! Replacing a variable if it does not yet exist

If we wanted $foo or if not set 4 then: ${foo:-4} but it still remains unset. To change that we use:
${foo:=4}

!!!! Exiting and stating something if variable is not set

This is very important if our program relys on a certain variable: ${foo:?&quot;foo not set!&quot;}
Just check for the variable

${foo:+1} gives one if $foo is set, otherwise nothing.

!!! Ksh Regular Expressions

Ksh has it's own regular expressions. Use an * for any string. So to get all the files ending it .c use *.c. A single character is represented with a ?. So all the files starting with any sign followed bye 44.f can be fetched by: ?44.f.

Especially in ksh there are quantifiers for whole patterns:
{{{
?(pattern) matches zero or one times the pattern.
*(pattern) matches any time the pattern.
+(pattern) matches one or more time the pattern.
(pattern) matches one time the pattern.
!(pattern) matches string without the pattern.
}}}
So one can question a string in a variable like:

{{{
 if [[ $var = fo(?4*67).c ]];then ...
}}}

!!! Functions

!!!! Description

A function (= procedure) must be defined before it is called, because ksh is interpreted at run time.
It knows all the variables from the calling shell except the commandline arguments. But has it's
own command line arguments so that one can call it with different values from different places in
the script. It has an exit status but cannot return a value like a c funcition can.
Making a Function

One can make one in either of the following two ways:

{{{
function foo {
   # commands...
}

foo(){
   # commands...
}
}}}

*Calling the Function*

To call it just put it's name in the script: foo. To give it arguments do: foo arg1 arg2 ...
The arguments are there in the form of
{{{
$1...$n   and
$*        as a sngle string like in the main loop
}}}

And the main $1 is not influenced bye the $1 of a particular function.

The return statement exits the function imediately with the specified return value as an exit status.

!!! Data Redirection

!!!! General

Data redirection is done with the follwoing signs: &quot;&gt; &gt;&gt; &lt; &lt;&lt;&quot;. Every program has at least a
standardinput, standardoutput and standarderroroutput. All of these can be redirected.

*Command Output to File*

For writing into a new file or for overwriting a file do: command &gt; file

For appending to a file do: command &gt;&gt; file

!!!! Standard Error Redirection

To redirect the error output of a command do: command 2&gt; file

To discard the error alltogether do: command 2&gt;/dev/null

To put the error to the same location as the normal output do: command 2&gt;&amp;1

*File into Command*

If a program needs a file for input over standard input do: command &lt; file

*Combine Input and Output Redirection*

{{{
command &lt; infile &gt; outfile
command &lt; infile &gt; outfile 2&gt;/dev/null
Commands into Program ( Here Document )
}}}

Every unix command can take it's commands from a text like listing with:

{{{
command &lt;&lt;EOF
input1
input2
input3
EOF
}}}

From eof to eof all is feeded into the above mentioned command.

*Pipes*

For a serial processing of data from one command to the next do:

{{{
command1 | command2 | command3 ...
e.g. last | awk '{print $1}' | sort -u.
}}}

*Coprocesses*

One can have one background process with which one can comunicate with read -p and print -p. It is started with command |&amp;. If one uses: ksh |&amp; then this shell in the background will do everything for us even telnet and so on: print -p &quot;telnet hostname&quot;.

!!! Read Input from User and from Files

*Read in a Variable*

From a user we read with: read var. Then the users can type something in. One should first print something like: print -n &quot;Enter your favorite haircolor: &quot;;read var; print &quot;&quot;. The -n suppresses the newline sign.

*Read into a File Line for Line*

To get each line of a file into a variable iteratively do:

{{{
{ while read myline;do
   # process $myline
done } &lt; filename
}}}

To catch the output of a pipeline each line at a time in a variable use:

{{{
last | sort | {
while read myline;do
   # commands
done }
}}}

*Special Variables*

{{{
$# Number of arguments on commandline.
$? Exit status of last command.
$$ Process id of current program.
$! Process id of last backgroundjob or background function.
$0 Program name including the path if started from another directory.
$1..n Commandline arguments, each at a time.
$* All commandline arguments in one string.
}}}

*Action on Success or on Failure of a Command*

If one wants to do a thing only if a command succeded then: command1 &amp;&amp; command2. If the second command has to be performed only if the first one failed, then: command1 || command2.

*Trivial Calculations*

Simple calculations are done with either a &quot;let&quot; in front of it or within (( ... )). One can increment a variable within the (( )) without a &quot;$&quot;: (( a+=1 )) or let a+=1. e.g. Calculate HP-UX free memory in human-readable form:
{{{
ora10g@hocpi03n:[TSGTEST] ora10gXX&gt; echo $(( 4*88629/1024 ))
346
}}}

*Numerical Calculations using &quot;bc&quot;*

For bigger caluculations one uses &quot;bc&quot; like:

{{{
$result=$(print &quot;n=1;for(i=1;i&lt;8;i++)n=i*n;n&quot;|bc)
}}}

!!!! &quot;grep&quot;

Search for the occurence of a pattern in a file: grep 'pattern' file. If one just wants to know how often soemthing occurs in a file, then: grep -c 'pattern' file. This can be used in a script like:

{{{
if [[ $(grep -c 'pattern' file) != 0 ]];then ......;fi
}}}

The condition is fullfilled if the pattern was found.

!!!! &quot;sed&quot;

Sed means stream line editor. It searches like grep, but is then able to replace the found pattern. If you want to change all occurences of &quot;poor&quot; with &quot;rich&quot;, do:

{{{
sed -e 's/poor/rich/g' filename
}}}

Or what is often seen in software packages, that have to be compiled after getting a propper configuration, is a whole file stuffed with replacements patterns like:

{{{
/foo/s;;king;g
}}}

This file with inumerable lines like that has to be given to sed with: sed -f sedscript filename

It then processes each line from file with all the sed commands in the sedscript.

&quot;awk&quot;

Awk can find and process a found line with several tools: It can branch, loop, read from files and also print out to files or to the screen, and it can do arithmetic. For example: We have a file with lines like: Fred 300 45 70 but hundreds of them. But some lines have a &quot;#&quot; as the first sign of them and we have to omit these ones for both, processing and output. And we want to have lines as output like: 415 Fred where 415 is the sum of 300, 45 and 70. Then we call on awk:

{{{
awk '$1 !~ /^#/ &amp;&amp; $0 ~ /[^ ]/ {print $2+$3+$4,&quot;\t&quot;,$1}' filename.
}}}

This ignores lines with a &quot;#&quot; at the beginning of the first field and also blank lines. It then prints the desired sum and the $1 ist only printed after a tab. This is the most trivial use of awk only.

&quot;perl&quot;

Perl is a much richer programming language then ksh, but still one can do perl commands from within a ksh script. This might touch Randal, but it's true. Let's say you want to remove all ^M from a file, then take perl for one line in your ksh script:

perl -i -ep 's/\015//g' filename.

Perl can do an infinite amount of things in many different ways. For anything bigger use perl instead of a shell script.</pre>
</div>
<div title="ksh tests" creator="YourName" modifier="YourName" created="201309231036" modified="201309231522" changecount="8">
<pre>Tests can be either the test command, or its alias, [, or the ksh/bash built-in {{{[[ ... ]]}}} command, which has slightly different options, or it can be any command which returns a suitable exit status. Zero is taken to be &quot;True&quot;, while any non-zero value is &quot;False&quot;. Note that this is backwards from the C language convention.
!!!File tests
{{{-e file}}}
    True if file exists (can be of any type - but not a directory!). 
{{{-f file}}}
    True if file exists and is an ordinary file. 
{{{-d file}}}
    True if file exists and is a directory. 
{{{-r file}}}
    True if file exists and is readable - can be a directory
    Similarly, -w = writable, -x = executable, -L = is a symlink. 
{{{-s file}}}
    True if file exists and has size greater than zero 
{{{-t filedescriptor}}}
    True if the open filedescriptor is associated with a terminal device. E.g. this is used to determine if standard output has been redirected to a file. 
!!!Character string tests
{{{-n &quot;string&quot;}}}
    true if string has non-zero length 
{{{-z &quot;string&quot;}}}
    true if string has zero length... see below
{{{$variable = text}}}
    True if $variable matches text. 
{{{$variable &lt; text}}}
    True if $variable comes before (lexically) text
    Similarly, &gt; = comes after 
!!! Zero length strings
With [, the argument must be quoted, because if it is a variable that has a null value, the resulting expansion ( {{{[ -z ]}}} ) is a syntax error. An expansion resulting in &quot;&quot; counts as a null string. For [ only, a quoted string alone is equivalent to the -n test, e.g. {{{[ &quot;$var&quot; ]}}}. In older shells for which [ is an external program, the only way to test for a null string is:
{{{if [ &quot;X$var&quot; = &quot;X&quot; ]}}}
This is rarely needed now, but is still often found. 
!!!From StackOverflow:
- Just to add that when using double brackets the expanded variables are not subject to shell word/field. That, of course, is not the case when using the [ ... ] construct. 
- For bash (and ksh and others), you want [[ &quot;$x&quot; == &quot;$y&quot; ]] with double brackets. That uses the built-in expression handling. A single bracket calls out to the test executable which is probably barfing on the ==.</pre>
</div>
<div title="logging" creator="colm" modifier="colm" created="201107162132" changecount="1">
<pre>{{{
update ipf_admin.systemregistryentry set VALUE='/Disk1/home/vod2207/work/log' where ID=3536;
update ipf_admin.systemregistryentry set VALUE='/Disk1/home/vod2207/work/log/perflog' where ID=3532;
update ipf_admin.systemregistryentry set VALUE='/Disk1/home/vod2207/work/log/perflog' where ID=3539;
update ipf_admin.systemregistryentry set VALUE='/Disk1/home/vod2207/work/log/tracelog' where ID=3529;
update geneva_admin.gparams set string_VALUE='/Disk1/home/vod2207/work/log' where name='SYSlogFileRootDir';
}}}</pre>
</div>
<div title="opatch" modifier="colm" created="201010111407" modified="201010201521" changecount="2">
<pre>{{{opatch lsinventory -detail}}}

as long as it is installed... post -10.2 see:

{{{select * from sys.registry$history;}}}</pre>
</div>
<div title="outlook - remove sig hyperlinks" modifier="colm" created="200908121049" changecount="1">
<pre>Tools-Options-Mail Format-Sigs-Advanced Edit-RClick -Remove hyperlink</pre>
</div>
<div title="parallel ddl" creator="colm" modifier="colm" created="201204091102" changecount="1">
<pre>Enabling and validating constraints is can take a huge amount of time in big oracle databases.
To speed the validaten up, it can be done in parallel.
This can save you valuable time in release windows.
* Enable Constraint with novalidate option
* Set parallel degree on the table or on session with force ddl parallel
* Enable the constraints with validation

Example:
{{{
ALTER TABLE T_1 ADD CONSTRAINT NC_1 not null (colname) disabled;
ALTER TABLE T_1 ENABLE NOVALIDATE CONSTRAINT NC_1;
ALTER SESSION FORCE PARALLEL DDL PARALLEL 8;
ALTER TABLE T_1 PARALLEL 8;
ALTER TABLE T_1 ENABLE VALIDATE CONSTRAINT NC_1;
ALTER SESSION DISABLE PARALLEL DDL;
}}}</pre>
</div>
<div title="pctfree" creator="colm" modifier="colm" created="201202011229" modified="201207232106" changecount="3">
<pre>!!!!PCTFREE is the minimum percentage of space in the data block reserved for updates to the existing rows.
By default, Oracle uses a value of 10 for PCTFREE. This means that it will add data to a block until it is 90% full; after this it will create a new block to hold information. If you set PCTFREE to 1, then Oracle will fill up blocks to 99% full, before using another block; This allows you to store more data in fewer blocks. If you set PCTFREE to 99, then Oracle will fill up blocks to 1% full before using another block. Usually this has the general effect of causing each row to go into a single block.

!!!Using a low PCTFREE
!!!!Low PCTFREE effects for reads
For reads, especially scans (including full table scans), it almost always will reduce the amount of physical reads required to satisfy a read-only query (ie a select SQL statement).
!!!!Low PCTFREE for data changes
However, for row updates, this can really hurt performance, because if a field is changed in a row (via an update statement), and this requires a larger row size than is free in an existing block, then the database needs to ’split’ the row among 2 or more blocks. This is called ‘row chaining’, and can definitely affect performance adversely when those rows are read, as &gt;1 block will need to be retrieved.

For inserts, having a low PCTFREE will cause them to go faster, as more rows will be inserted for each block written.

Note that if an index is built with a low pctfree, it may take longer for the index to be updated when corresponding rows are updated.
!!!Low PCTFREE applications

The ideal place to use a very low value for PCTFREE include:
* Log tables that are never updated (only inserts, and deletes in rough order of inserts)
* auditing tables which should never be updated,
* Tables used to support Data warehouses, esp if rows are not updated,

Table examples where you probably should not use a very low value for PCTFREE include:

    Tables where the rowsize expands over the life of a row via many updates,
    Tables that have a lot of active transactions going against them,
    Tables where inserts and deletes happen that are not in the order of inserts
    Tables which have lots of updates in general.

!!!Using a high PCTFREE

Above the discussion has been about having a particularly low value for PCTFREE. There are cases where a higher than default value for PCTFREE is recommended. If it is known that a rowsize will be very small upon the 1st insert, and then updated a lot (say to swell from 20 bytes to 16k bytes), and especially if the table had a high transaction rate, then forcing Oracle to store fewer rows (upon insert) will really minimize row chaining. If a table will be updating an in-row (B/C)LOB (again increasing row-length) having a low value for PCTFREE again would increase performance.
Conclusion

If you’re interested in changing your PCTFREE, try to of course test it first in a development or QA environment. The default value (10) is for many cases quite satisfactory. Using the wrong one can really hurt performance, and sometimes this happens a long time after rows are inserted.</pre>
</div>
<div title="pctused" creator="colm" modifier="colm" created="201207232009" modified="201207232200" changecount="7">
<pre>!!!!PCTUSED determines minimum %age used before the block comes back in the Freelist.
Oracle's measure of  the minimum percentage of the space used by the existing rows plus overhead before new rows can be added to the block. For indexes, pctused is not allowed - it must always be 0% which means that the block is not on the freelist until it is completely empty. This is because indexes have ordered entries in them - summary of:

//It has to be 0% PCTUSED, in other words, because entries in an index have to be organized according to some order. Allowing you to reuse space ‘out of order’ would destroy the point of an index. And you can only say, “Order is irrelevant at this point” when no entries exist at all… which equates to PCTUSED of 0.//

Full explanation at: http://aprakash.wordpress.com/2009/10/31/indexes-pctused-0-why/</pre>
</div>
<div title="perl" creator="colm" modifier="colm" created="201104042249" changecount="1">
<pre>Perl Notes

Files

Strings

Scalers

System Variables

Arrays

Associative Arrays (Hashes)

If Statement

Formatted Reports

Subroutines

Network

Misc Stuff

Files

Open/Close Commands

open(OUT_FILE,&quot;&gt;output.txt&quot;);     # Open for output (create)
open(OUT_FILE,&quot;&gt;&gt;output.txt&quot;); # Open for output (append, or create)
open(OUT_FILE,&quot;input-command |&quot;);    # Input filter/redirect
open(OUT_FILE,&quot;| output-command&quot;);   # Output filter/redirect
close(OUT_FILE);

Simple Read Loop

open(MY_FILE,&quot;some.dat&quot;) or die (&quot;Can't open file.&quot;);
while( &lt;MY_FILE&gt; ) {
print if 1 .. 5; #print the first 5 lines of the file
}
close(MY_FILE);

Printing to a file

open(OUT_FILE,&quot;&gt;output.txt&quot;);  # Open for output
print OUT_FILE &quot;Yo!\n&quot;;
close(OUT_FILE);

Specifying File to open for input on the command line

open(MY_FILE,$ARGV[0]) or die (&quot;Can't open $ARGV[0]: $!\n&quot;);

Reading filenames into and array.

@logfilenames = &lt;/var/log/*&gt;;

Strings

String Concatenation

$string1 = &quot;Hi &quot; . &quot;There!&quot;;

Testing if a string contains a sub string

if ($a_string =~ m/Elephant/)

if ($a_string =~ m/Elephant/i) # case insensitive search

Search, and Replace on a String

$a_string =~ s/Peking/Bejing/g;

Change String to all upper, or lower case

  $string =~ tr/a-z/A-Z/;  # convert to upper case
  $string =~ tr/A-Z/a-z/;  # convert to lower case

Finding First occurence of sub string in string

  $tmp_ptr = index($current_line,&quot;something&quot;);

Grabbing a sub-string from a string

    $a_bit_of_string = substr($some_string,$start_pos,$length);


Splitting Strings by a character

$a_string= &quot;name=john&quot;;
($tmp1, $tmp2) = split(/=/,$a_string);
#$tmp1 now has &quot;name&quot; in it, $tmp2 has &quot;john&quot;

Scalers

Assignments and Operations

$a = 3 - 4;     # Subtracts 4 from 3. Stores in $a
$a = 3 + 4;	# Adds 3 and 4. Stores in $a
$a = 3 * 4;	# Multiply 3 and 4
$a = 3 / 4;	# Divide 3 by 4
$a = 3 ** 4;	# three to the power of four
$a = 3 % 4;	# Remainder of 3 divided by 4
++$x;		# Increment $x. Then return its value
$x++;		# Return $x. Then increment its value
--$x;		# Decrement $x. Then return its value
$x--;		# Return $x. Then decrement its value
$x = $y . $z;	# Concatenate $y and $z
$x = $y x $z;	# $y repeated $z times

Assigning values

$x = $y;	# Assign $y to $x
$x += $y;	# Add $y to $x
$x -= $y;	# Subtract $y from $x
$x .= $y;	# Append $y onto $x

Whan a value is assigned with $x = $y it makes a copy of $y and then assigns it to $x. The next time you change $y it will not 
change $x.

$a = 'rock';
$b = 'paper';
print $a . $b; #prints: rockpaper
print $a. '123' .$b; #prints: rock123paper
print &quot;$a 123 $b&quot;; #prints: rock 123 paper

System Variables

Global Scalar Variables

The $_ variable

Lots of Perl functions and operators will modify the contents of $_ if you
do not explicitly specify a scalar variable on which they are to operate.

These functions and operators work with the $_ variable by default:

    * The pattern-matching operator
    * The substitution operator
    * The translation operator
    * The &lt;&gt; operator, if it appears in a while or for conditional expression
    * The chop function
    * The print function
    * The study function 

print (&quot;found&quot;) if ($_ =~ /xyz/);
print (&quot;found&quot;) if (/xyz/); #You can leave off =~ if using $_ to match

s/abc/xyz/; #Substitution operator uses the $_ variable if you do not specify a variable using =~
$substitcount = s/abc/xyz/g #Substituting inside $_, returns the number of substitutions performed

tr/a-z/A-Z/; #Translates all lowercase letters in the value stored in $_ to their uppercase
$transcount = tr/z/z/; #Counts the number of z's in $_. Then hash %transcount keeps track of
#the number of occurrences of each of the characters being counted. 

while (&lt;&gt;) {
 #Resulting input line is assigned to the scalar variable $_
}

while (&lt;&gt;) {
  chop; #Uses $_ to get rid of the newline character 
  print; #Prints whats in $_ 
}

print; #Just prints whats in $_ by default



The $0 variable

The $0 variable contains the name of the Perl script you are running.

print (&quot;Name of current script printing this is: $0\n&quot;);


The $&lt; and $&gt; variables

The $&lt; variable contains the real user ID and $&gt; contains the effective user ID for user of the program.
If they have more than one id $&lt; and $&gt; will contain a list of user IDs, with each pair of user IDs being
separated by spaces. Use the split function to retrieve them.

print (&quot;UserID(s) running this script are: $&lt;\n&quot;);



The $( and $) variables

The $( variable contains the real group ID and $) contains the effective group ID for user of the program.
If they are in more than one group $( and $) contain a list of group IDs, with each pair of group IDs being
separated by spaces. Use the split function to retrieve them.

print (&quot;GroupID(s) running this script are: $(\n&quot;);


The $] variable

The $] contains the the current version of Perl running.  And other info.

print (&quot;Info about the Perl installed on this system: $]\n&quot;);


The $/ variable

The $/ contains the current input line separator. Newline character is the default. 

$/ = &quot;-&gt;&quot;; #Set the input line separator to -&gt;. It will keep reading a line until it hits -&gt;

The $\ variable

The $\ contains the current output line separator. It is set to a null character by default.
Which means no output. This is automatically printed after every call to print.

$\ = &quot;-&gt;&quot;;
print (&quot;Current output line separator is: $\&quot;); #you be shown -&gt; after every print statement


The $, variable

The $, contains the character or sequence of characters that are printed between elements when print is called.
Defaults to a null character.

$, = &quot;-&gt;&quot;;
$x = &quot;foo&quot;;
$y = &quot;bar&quot;;
print ($x, $y); #prints: foo-&gt;bar

The $&quot; variable

The $&quot; contains the array element separator. Defaults to a single blank space.

@array = (&quot;x&quot;, &quot;y&quot;, &quot;z&quot;);
print (&quot;@array\n&quot;); # Prints: x y z
$&quot; = &quot;,&quot;;
@array = (&quot;x&quot;, &quot;y&quot;, &quot;z&quot;);
print (&quot;@array\n&quot;); # Prints: x,y,z


The $# variable

The $# variable holds the number output format. Defaults to 20-digit floating point number in compact format.

$x = 21.9876543219876543219876;
$# = &quot;%.5g&quot;;
print &quot;$x\n&quot;; # Prints: 21.988

The $? variable

The $? variable checks return value from last last pipe close, backtick command or system operator.
Exit value of 0 means everything looks like it went ok. To retrieve the actual exit value, use the &gt;&gt; operator
to shift the eight bits to the right: $returncode = $? &gt;&gt; 8;.

$command = `hostname`;
if ($? != 0) {
  die (&quot;\nProgram did not exit correctly. Try a test manualy.\n&quot;);
}

The $! variable

The $! system error messge variable. When the system library function generates an error, the error code
it generates (by the function) gets assigned to this variable.

open (FILE1, &quot;nonexistantfile&quot;) or die (&quot;\nProgram died trying to open file with error: $!\n&quot;);

The $. variable

The $. variable contains the line number of the last line read from an input file.

open (FILE1, &quot;filename&quot;) || die (&quot;Can't open file1\n&quot;);
$input = &lt;FILE1&gt;;
print (&quot;line number is $.\n&quot;);
close(FILE1);

The $$ variable

The $$ variable contains the process id of your script your running.

print (&quot;The process id of this script is: $$\n&quot;);

The $ARVG variable

When the &lt;&gt; operator reads from a file for the first time, it assigns the name of the file to the $ARGV system variable.
The Perl interpreter reads input from each file named on the command line. Code below needs to be executed from the
command line like: ./program file1 . So the name of the filename you list is read into the $ARGV var. 

while (&lt;&gt;) {
  print (&quot;Filename being read currently is: $ARGV \n&quot;);
  exit();
}
close(FILE1);

The $^T variable

The $^T variable contains the time at which your program began running.
This time is in the same format as is returned by the time function.
The number of seconds since January 1, 1970.

($Second, $Minute, $Hour, $Day, $Month, $Year, $WeekDay, $DayOfYear, $IsDaylightSavings) = localtime($^T);
$Month += 1;
$Year += 1900;
if ($Month &lt; 10) { $Month = &quot;0&quot; . $Month; }
if ($Hour &lt; 10) { $Hour = &quot;0&quot; . $Hour; }
if ($Minute &lt; 10) { $Minute = &quot;0&quot; . $Minute; }
if ($Second &lt; 10) { $Second = &quot;0&quot; . $Second; }
if ($Day &lt; 10) { $Day = &quot;0&quot; . $Day; }

print &quot;Program started at Time: $Hour:$Minute:$Second Date: $Month-$Day-$Year\n&quot;;


Pattern System Variables

The $1 $2 $3 and so on variables

In a pattern match you can enclose a sub-pattern in parentheses. Like: /(\W+)/.
After there is a pattern match, the system variables $1, $2, and so on get set
to the subpatterns enclosed in parentheses.

$test = &quot;123ABC&quot;;
if ($test =~ /(\d+)([A-Z])/) { #Match one or more digits and an uppercase letter after digits
  print &quot;Found $1 $2\n&quot;; #Prints: Found 123 A
}

The $&amp; variable

In a pattern match you can use $&amp; to retrieve the entire pattern.

$test = &quot;123ABC&quot;;
if ($test =~ /(\d+)([A-Z])/) { #Match one or more digits and an uppercase letter after the digits
  print &quot;Found $&amp;\n&quot;; #Prints: Found 123A
}


The $` and $' variables

In a pattern match you can use $&amp; to retrieve the entire pattern. The rest of the string is
stored in two other system variables.The unmatched text preceding the match is stored in
the $` variable. The unmatched text following the match is stored in the $' variable. 

$test = &quot;123ABC&quot;;
if ($test =~ /(\d)([A-Z])/) { #Match a digit and a uppercase letter
  print &quot;Found $` before $&amp; and $' after it\n&quot;; #Prints: Found 12 before 3A and BC after it
}

The $+ variable

In a pattern match the $+ variable matches the last subpattern enclosed in parentheses.

$test = &quot;123ABC&quot;;
if ($test =~ /(\d+)([A-Z])/) { #Match one or more digits and an uppercase letter after the digits
  print &quot;Last matched subpattern was  $+\n&quot;; #Prints: Last matched subpattern was A
}

Array System Variables

The @_ variable

The @_ variable is defined inside each subroutine. It is a list (array) of all the arguments passed to the subroutine.

yellowsub (&quot;1starg&quot;,&quot;2ndarg&quot;); # run subroutine with 2 arguments. Prints: Argument1 1starg Argument2: 2ndarg
sub yellowsub { print &quot;Argument1: $_[0] Argument2: $_[1]&quot;\n; } # create subroutine

The @ARGV variable

The @ARGV variables get set when running a Perl program from the command line. You can specify the values that are
to be passed to the program by including them on the command line.

#execute program from command line: ./test.pl foo bar
print (&quot;@ARGV\n&quot;); #prints: foo bar

The @F variable

If you specify the -n or -p option, you can also supply the -a option. This option tells the Perl interpreter to break
each input line into individual words. It will throw away all tabs and spaces. These words are stored in the built-in
array variable @F.

The @INC variable

The @INC array variable contains a list of directories that are searched for files requested by the function require.
The directories specified by the -I option are searched first. Then the Perl library directory (which is normally
/usr/local/bin/perl). Last the current working directory. 

The %INC variable

The associative array %INC will list files requested by the require function that it has already found.
When require function finds a file, the hash element $INC{file} is defined. This element is the name of the file.
The value of this hash element is the location of the actual file. 

The %ENV variable

The %ENV hash lists the environment variables defined for the program and their values. The environment variables are
the array subscripts, and the values of the variables are the values of the array elements.

print $ENV{PATH}; #Prints the user executing the scripts path

The %SIG variable

This array contains one element for each available signal. The signal name serves as the subscript for the element.
For example, the INT (interrupt) signal is represented by the $SIG{&quot;INT&quot;} element.

Arrays

Looping thru an Array, and examining each value

foreach (@some_array){
   print $_; # the value is in $_ by default
}

Associative Arrays (Hashes)

Adding a key/value pair to an hash

$hashname{key}{value} = &quot;newvalue&quot;;

Keeping a running count of the times a string is equal to a certain value

$different_strings{$a_string} = $different_strings{$a_string}++;

Looping thru an Associative Array, and examining each value

foreach (@some_assoc_array){
   print $_; # the value is in $_ by default
} 

Looping thru an Associative Array, and printing each key and value

foreach $key keys(%hash_1) {
   print &quot;$key =&gt; $hash_1{$key}\n&quot;;
}

Print the keys of a Associative Array in sorted order (alphabetical/ascending)

foreach $key (sort (keys(%hash_1))) {
   print &quot;$key =&gt; $hash_1{$key}\n&quot;;
}

Testing if a Associative Array has a key/value

if ($some_assoc_arry{$the_key} eq &quot;&quot; ) {
   print &quot;key not in array&quot;; 
}

Testing if a Associative Array has any key/value. Is it empty?

if (%some_assoc_array) {
print &quot;Hash is not empty. It has data!&quot;;
}


Hashes of Arrays

%families = (
    smith =&gt; [ &quot;jim&quot;, &quot;bob&quot; ],
    jones =&gt; [ &quot;roger&quot;, &quot;jan&quot;, &quot;roy&quot; ],
    kent  =&gt; [ &quot;mark&quot;, &quot;mag&quot;, &quot;bert&quot; ],
);

Add another Array to the hash of arrays

$families{bluejean} = [ &quot;norma jean&quot;, &quot;jack&quot;, &quot;pam&quot;, &quot;port&quot; ];

Append new members to an existing existing array in the hash

push @{ $families{smith} }, &quot;jen&quot;, &quot;jack&quot;;

Accessing (changing) the first element of an array in the hash

# Change &quot;jim&quot; to &quot;Jimmy&quot;
$families{smith}[0] = &quot;Jimmy&quot;;

You can print all of the families in the arrays by looping through the keys of the hash

for $family ( keys %families ) {
    print &quot;$family =&gt;  @{ $families{$family} }\n&quot;;
}

Sort the arrays in the hash by how many elements they have

for $family ( sort { @{$families{$b}} &lt;=&gt; @{$families{$a}} } keys %families ) {
    print &quot;$family =&gt; @{ $families{$family} }\n&quot;
}

Loop thru the hash of arrays. Sort on the second value (name) in the arrays. Print the key and only values 0 and 1.

for $family ( sort {  $families {$b}[1] cmp $families{$a}[1] }  keys %families ) {
  print &quot;Key =&gt; $family\n
  Value0 =&gt; $families{$family}[0]\n
  Value1 =&gt; $families{$family}[1]\n&quot;;
}

IF Statement

IF statement

if ( $string eq &quot;Hi There&quot; )
if ( &quot;A&quot; gr &quot;B&quot; )
if ( $num == 10)
if ( $num != 10)
if ( $num &gt; 10)
if ($x &gt; 208 &amp;&amp; $x &lt; 275 &amp;&amp; $y &gt; 64 &amp;&amp; $y &lt; 78 )   # &amp;&amp; is AND, || is OR

Subroutines

Subroutine example

# create subroutine
sub write_current_date 
{
}

# Run subroutine
write_current_date ();

Reports

Print a formatted print line-

#Define the Header Line
format STDOUT_TOP=
Name               Address                Num
-----------     ----------------------   -----
.   #Dot marks end of format

#Define the detail Line
format STDOUT =
@&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;@&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;@######


Network

Network example

use Socket;

# use port 9999 as default
$port = shift || 9999;

# create a socket, make it reusable
socket(SERVER, PF_INET, SOCK_STREAM, getprotobyname('tcp')) or die &quot;socket: $!&quot;;
setsockopt(SERVER, SOL_SOCKET, SO_REUSEADDR, 1) or die &quot;setsock: $!&quot;;

# grab a port on this machine
$paddr = sockaddr_in($port, inet_aton(&quot;127.0.0.1&quot;));

# bind to a port, then listen
bind(SERVER, $paddr) or die &quot;bind: $!&quot;;
listen(SERVER, SOMAXCONN) or die &quot;listen: $!&quot;;
accept(CLIENT, SERVER);

select CLIENT; #select filehandle
$| = 1; #make filehandle hot so data shows up unbuffered

print CLIENT &quot;\ntest\n&quot;;

# telnet to port 9999 on localhost to see your printed word above.


Misc

Checking if system call failed or not.

@args = (&quot;wget&quot;,&quot;-qN&quot;,&quot;-T15&quot;);
$rc = 0xffff &amp; system @args;
if ($rc != 0) {
  printf &quot;system(%s) returned %#04x: &quot;, &quot;@args&quot;, $rc;
  die (&quot;\nProgram did not exit correctly. Try a test manualy.\n&quot;);
}</pre>
</div>
<div title="screen" modifier="colm" created="201101051147" modified="201102222316" changecount="10">
<pre>!!Connections
{{{screen -r}}} will reattach see below  if you need to manually detach a screen session (e.g. putty failure)

{{{screen -wipe}}} will clean up old screen records, sockets etc...

{{{
$ screen -ls
There is a screen on:
        24865.pts-4.ge  (Attached)
1 Socket in /tmp/screens/S-infinys.
}}}

To detach it: 
{{{screen -D 24865.pts-4.ge}}}

!!Scrollback
To enter scrollback hit C-a [. A status line will indicate that you've entered copy mode. To exit scrollback mode, hit the escape button. Use vi commands to move in the scrollback buffer. vi search also works - / and ?. This copy mode allows you toggle a selection with space bar - C-G ] will paste.

C-G i will give window info - scrollback is the number after the plus sign.

C-G : will give command mode - enter {{{scrollback num}}} to set it to num.</pre>
</div>
<div title="sed" creator="colm" modifier="colm" created="201207301118" changecount="1">
<pre>In place edit:
{{{
sed -i '.bak' -re 's|GEN_INDS|USERS|g' -e 's|GEN_TABS|USERS|g' schema_params*
}}}</pre>
</div>
<div title="settrace" modifier="YourName" created="201008142304" modified="201402101555" changecount="2">
<pre>If there is still a problem after that, we will need to enable the trace for platform by using the settrace command. This can be done without having to bounce RATE and it can be done for a single instance if the PID is provided:

Usage: settrace [-h|-H](help) [-C ConfigFile] [-N DomainName] [ProgramName] [Level] [Pid]
Examples:
settrace - lists trace levels for all programs.
settrace programName - lists trace level for programName.
settrace programName 10 - sets programName's level to 10
settrace programName 10 20560 - sets programName's level to 10 for only pid 20506.

The trace message that are produced by the extension libraries are at level 10, so any number greater or equal to 10 should work.

settrace RATE 10 [pid]

Using:

settrace RATE 0 

will turn trace off.

!!!!Settings in shared env
May need to set up location in config for shared environments.
{{{
cdsinf50 [BTRETSI2]/psg/working/BTRETSI2/INF_ROOT&gt; dconfigadmin -d
&lt;?xml version=&quot;1.0&quot; encoding=&quot;US-ASCII&quot; ?&gt;
&lt;config&gt;
  &lt;global&gt;
    &lt;configMgr masterHost=&quot;hocpi03n&quot; slaveHost=&quot;&quot; port=&quot;5569&quot; maxDomains=&quot;10&quot; maxServices=&quot;100&quot;&gt;
      &lt;downCmd cmd=&quot;DConfigFailoverDomain&quot;/&gt;
    &lt;/configMgr&gt;
  &lt;/global&gt;

  &lt;host name=&quot;hocpi03n&quot;&gt;
        &lt;trace traceDir=&quot;/psg/working/BTRETSI2/INF_ROOT/logs&quot; cfgDir=&quot;/psg/working/BTRETSI2/INF_ROOT&quot;/&gt;
        &lt;configMgr shmKey=&quot;20130530&quot; semKey=&quot;20130530&quot; port=&quot;5569&quot; timeout=&quot;10&quot;/&gt;
  &lt;/host&gt;
&lt;/config&gt;
}}}</pre>
</div>
<div title="showVersionInfo" creator="YourName" modifier="YourName" created="201110311044" changecount="1">
<pre>This utility can handle a whole ldd output dump:
{{{
[SBTR22L]&gt; whence showVersionInfo
/emea/csg/working/SBTR22L/RB/bin/showVersionInfo
[SBTR22L]&gt; showVersionInfo `/usr/ccs/bin/ldd /emea/csg/working/SBTR22L/RB/bin/BG`
showVersionInfo: cannot open file 'libnsl.so.1'.
showVersionInfo: cannot open file '=&gt;'.
/usr/lib/hpux64/libnsl.so.1:
    [no information available]

showVersionInfo: cannot open file 'libGnvTMPI.sl'.
showVersionInfo: cannot open file '=&gt;'.
/emea/csg/working/SBTR22L/RB/lib/libGnvTMPI.sl:
    Task Master Process Interface Library sqa5.4.38.itanium.oracle10g 35.5 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
    TMPI version 1.0 (source version 21)

showVersionInfo: cannot open file 'libGnvGSTR.sl'.
showVersionInfo: cannot open file '=&gt;'.
/emea/csg/working/SBTR22L/RB/lib/libGnvGSTR.sl:
    String Buffer Library sqa5.4.38.itanium.oracle10g 35.5 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
    GSTR version 2.0 (source version 6)
....
}}}</pre>
</div>
<div title="singlepagemode" modifier="colm" created="200907152106" modified="201106020927" tags="systemConfig" changecount="3">
<pre>version.extensions.SinglePageMode= {major: 2, minor: 2, revision: 0, date: new Date(2006,6,1)};

if (config.options.chkSinglePageMode==undefined) config.options.chkSinglePageMode=false;
config.shadowTiddlers.AdvancedOptions += &quot;\n&lt;&lt;option chkSinglePageMode&gt;&gt; Display one tiddler at a time&quot;;

if (config.options.chkTopOfPageMode==undefined) config.options.chkTopOfPageMode=false;
config.shadowTiddlers.AdvancedOptions += &quot;\n&lt;&lt;option chkTopOfPageMode&gt;&gt; Always open tiddlers at the top of the page&quot;;

config.SPMTimer = 0;
config.lastURL = window.location.hash;
function checkLastURL()
{
 if (!config.options.chkSinglePageMode)
 { window.clearInterval(config.SPMTimer); config.SPMTimer=0; return; }
 if (config.lastURL == window.location.hash)
 return;
 var tiddlerName = convertUTF8ToUnicode(decodeURI(window.location.hash.substr(1)));
 tiddlerName=tiddlerName.replace(/\[\[/,&quot;&quot;).replace(/\]\]/,&quot;&quot;); // strip any [[ ]] bracketing
 if (tiddlerName.length) story.displayTiddler(null,tiddlerName,1,null,null);
}

if (Story.prototype.SPM_coreDisplayTiddler==undefined) Story.prototype.SPM_coreDisplayTiddler=Story.prototype.displayTiddler;
Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly)
{
 if (config.options.chkSinglePageMode) {
 window.location.hash = encodeURIComponent(String.encodeTiddlyLink(title));
 config.lastURL = window.location.hash;
 document.title = wikifyPlain(&quot;SiteTitle&quot;) + &quot; - &quot; + title;
 story.closeAllTiddlers();
 if (!config.SPMTimer) config.SPMTimer=window.setInterval(function() {checkLastURL();},1000);
 }
 if (config.options.chkTopOfPageMode) { story.closeTiddler(title); window.scrollTo(0,0); srcElement=null; }
 this.SPM_coreDisplayTiddler(srcElement,title,template,animate,slowly)
}

if (Story.prototype.SPM_coreDisplayTiddlers==undefined) Story.prototype.SPM_coreDisplayTiddlers=Story.prototype.displayTiddlers;
Story.prototype.displayTiddlers = function(srcElement,titles,template,unused1,unused2,animate,slowly)
{
 // suspend single-page mode when displaying multiple tiddlers
 var save=config.options.chkSinglePageMode;
 config.options.chkSinglePageMode=false;
 this.SPM_coreDisplayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly);
 config.options.chkSinglePageMode=save;
}</pre>
</div>
<div title="softphone" creator="colm" modifier="colm" created="201305091511" changecount="1">
<pre>Name 		ext	SEP	TFTP Server
Niki Weipers	Office	4717	SEP00AE70AAC93B	10.254.1.10
Stuart Menzies	Office	4718	SEP006D386C9C72	10.254.1.10
David Mathieson	Office	4719	SEP004FF73849BE	10.254.1.10
George Douglas	Office	4722	SEP002A1D6A2A1E	10.254.1.10
Luke Reay	Office	4723	SEP000D50219E1E	10.254.1.10
David Strang	Office	4725	SEP006C390313BC	10.254.1.10
Colm McCartan	Office	4728	SEP006FA494AD55	10.254.1.10
Simon Rackstraw	Office	4729	SEP00C4BAEF9240	10.254.1.10
Frank Gibb	WAH	4733	SEP00EE6C79A466	10.254.1.10
Paul Dunkley	Office	4741	SEP0003DC4A2469	10.254.1.10
Patrik Farkas	WAH	4743	SEP00C43243F1A9	10.254.1.10
Rankin Small	Office	4744	SEP00AFB5F53FE5	10.254.1.10
Stephen Billcliff	Office	4748	SEP0056C8652369	10.254.1.10
Janet Turner	Office	4751	SEP003B6D2714C8	10.254.1.10
Scott Middlemiss	Office	4755	SEP00DCA3A751E0	10.254.1.10
Katalin Endresz	WAH	1204	SEP00E81DA4B7EC	10.254.1.10
Pawel Hadam	WAH	1209	SEP00C470F72DF3	10.254.1.10
Peter Biro	WAH	1211	SEP00810A888A9F	10.254.1.10
Rafal Kajda	WAH	4760	SEP000F9F6CC831	10.254.1.10
Neil MacLean	Office	4761	SEP003E8FB82DDA	10.254.1.10
Julian Fontana	Office	4762	SEP00EF36555DED	10.254.1.10
</pre>
</div>
<div title="sqlplus - exporting a value" creator="YourName" modifier="YourName" created="201309201448" changecount="1">
<pre>How to get a selected value out of DB and available in scripted sqlplus session:
{{{
define stage = 'PRE'
column tm new_value file_label noprint
select to_char(sysdate, 'YYYYMMDD-HH24MI') || '-' || '&amp;stage' || '-' || instance_name tm from v$instance;
}}}</pre>
</div>
<div title="sqlplus set" creator="colm" modifier="colm" created="201208311512" changecount="1">
<pre>APPI[NFO] {ON|OFF|text}
   Application info for performance monitor (see DBMS_APPLICATION_INFO)

ARRAY[SIZE] {15|n}
   Fetch size (1 to 5000) the number of rows that will be retrieved in one go.

AUTO[COMMIT] {OFF|ON|IMM[EDIATE]|n} 
   Autocommit commits after each SQL command or PL/SQL block

AUTOP[RINT] {OFF|ON}
   Automatic PRINTing of bind variables.(see PRINT)

AUTORECOVERY [ON|OFF]
   Configure the RECOVER command to automatically apply 
   archived redo log files during recovery - without any user confirmation.

AUTOT[RACE] {OFF|ON|TRACE[ONLY]} [EXP[LAIN]] [STAT[ISTICS]] 
   Display a trace report for SELECT, INSERT, UPDATE or DELETE statements
   EXPLAIN shows the query execution path by performing an EXPLAIN PLAN.
   STATISTICS displays SQL statement statistics.
   Using ON or TRACEONLY with no explicit options defaults to EXPLAIN STATISTICS

BLO[CKTERMINATOR] {.|c|OFF|ON}
   Set the non-alphanumeric character used to end PL/SQL blocks to c

CMDS[EP] {;|c|OFF|ON}
   Change or enable command separator - default is a semicolon (;)

COLSEP { |text} 
   The text to be printed between SELECTed columns normally a space.

COM[PATIBILITY] {V5|V6|V7|V8|NATIVE}
   Version of oracle - see also init.ora COMPATIBILITY=
   You can set this back by up to 2 major versions e.g. Ora 9 supports 8 and 7

CON[CAT] {.|c|OFF|ON}
   termination character for substitution variable reference
   default is a period.

COPYC[OMMIT] {0|n}
   The COPY command will fetch n batches of data between commits.
   (n= 0 to 5000) the size of each fetch=ARRAYSIZE.
   If COPYCOMMIT = 0, COPY will commit just once - at the end.

COPYTYPECHECK {OFF|ON}
   Suppres the comparison of datatypes while inserting or appending to DB2

DEF[INE] {&amp;|c|OFF|ON}
   c =  the char used to prefix substitution variables. 
   ON or OFF controls whether to replace substitution variables with their values.
   (this overrides SET SCAN) 

DESCRIBE [DEPTH {1|n|ALL}][LINENUM {ON|OFF}][INDENT {ON|OFF}]
   Sets the depth of the level to which you can recursively describe an object
   (1 to 50) see the DESCRIBE command 

ECHO {OFF|ON}
   Display commands as they are executed

EMB[EDDED] {OFF|ON}
   OFF = report printing will start at the top of a new page.
   ON = report printing may begin anywhere on a page.
 
ESC[APE] {\|c|OFF|ON} 
    Defines the escape character. OFF undefines. ON enables. 

FEED[BACK] {6|n|OFF|ON}
   Display the number of records returned (when rows &gt;= n )
   OFF (or n=0) will turn the display off
   ON will set n=1

FLAGGER {OFF|ENTRY|INTERMED[IATE]|FULL}
   Checks to make sure that SQL statements conform to the ANSI/ISO SQL92 standard.
   non-standard constructs are flagged as errors and displayed 
   See also ALTER SESSION SET FLAGGER.

FLU[SH] {OFF|ON}
   Buffer display output (OS)
   (no longer used in Oracle 9)

HEA[DING] {OFF|ON}
   print column headings

HEADS[EP] {||c|OFF|ON}
   Define the heading separator character (used to divide a column heading onto &gt; one line.)
   OFF will actually print the heading separator char
   see also: COLUMN command

INSTANCE [instance_path|LOCAL] 
   Change the default instance for your session, this command may only be issued when 
   not already connected and requires Net8

LIN[ESIZE] {150|n} 
   Width of a line (before wrapping to the next line)
   Earlier versions default to 80, Oracle 9 is 150

LOBOF[FSET] {n|1}
   Starting position from which CLOB and NCLOB data is retrieved and displayed

LOGSOURCE [pathname] 
   Change the location from which archive logs are retrieved during recovery
   normally taken from LOG_ARCHIVE_DEST 

LONG {80|n}
   Set the maximum width (in chars) for displaying and copying LONG values.

LONGC[HUNKSIZE] {80|n}
   Set the fetch size (in chars) for retrieving LONG values.

MARK[UP] HTML [ON|OFF]
  [HEAD text] [BODY text] [TABLE text] 
     [ENTMAP {ON|OFF}][SPOOL {ON|OFF}]
        [PRE[FORMAT] {ON|OFF}]
   Output HTML text, which is the output used by iSQL*Plus.

NEWP[AGE] {1|n}
   The number of blank lines between the top of each page and the top title.
   0 = a formfeed between pages.

NULL text
   Replace a null value with 'text'
   The NULL clause of the COLUMN command will override this for a given column.

NUMF[ORMAT] format
   The default number format.
   see COLUMN FORMAT. 

NUM[WIDTH] {10|n}
   The default width for displaying numbers.

PAGES[IZE] {14|n}
   The height of the page - number of lines.
   0 will suppress all headings, page breaks, titles

PAU[SE] {OFF|ON|text}
   press [Return] after each page
   enclose 'text' in single quotes

RECSEP {WR[APPED]|EA[CH]|OFF}
   Print a single line of the RECSEPCHAR between each record.
   WRAPPED = print only for wrapped lines
   EACH=print for every row

RECSEPCHAR {_|c}
   Define the RECSEPCHAR character, default= ' '

SCAN {OFF|ON}
   OFF = disable substitution variables and parameters

SERVEROUT[PUT] {OFF|ON} [SIZE n] [FOR[MAT] {WRA[PPED]|WOR[D_WRAPPED]|TRU[NCATED]}] 
   whether to display the output of stored procedures (or PL/SQL blocks)
   i.e., DBMS_OUTPUT.PUT_LINE

   SIZE = buffer size (2000-1,000,000) bytes

SHOW[MODE] {OFF|ON}
   Display old and new settings of a system variable

SPA[CE] {1|n}
   The number of spaces between columns in output (1-10)

SQLBL[ANKLINES] {ON|OFF} 
   Allow blank lines within an SQL command. reverts to OFF after the curent command/block.

SQLC[ASE] {MIX[ED]|LO[WER]|UP[PER]} 
   Convert the case of SQL commands and PL/SQL blocks
   (but not the SQL buffer itself)

SQLPLUSCOMPAT[IBILITY] {x.y[.z]}
  Set the behavior or output format of VARIABLE to that of the
  release or version specified by x.y[.z]. 

SQLCO[NTINUE] {&gt; |text}
   Continuation prompt (used when a command is continued on an additional line using a hyphen -)

SQLN[UMBER] {OFF|ON}
   Set the prompt for the second and subsequent lines of a command or PL/SQL block.
   ON = set the SQL prompt = the line number.
   OFF = set the SQL prompt = SQLPROMPT.

SQLPRE[FIX] {#|c}
   set a non-alphanumeric prefix char for immediately executing one line of SQL (#)

SQLP[ROMPT] {SQL&gt;|text}
   Set the command prompt.

SQLT[ERMINATOR] {;|c|OFF|ON}| 
   Set the char used to end and execute SQL commands to c. 
   OFF disables the command terminator - use an empty line instead.
   ON resets the terminator to the default semicolon (;).
 
SUF[FIX] {SQL|text} 
   Default file extension for SQL scripts

TAB {OFF|ON}
   Format white space in terminal output.  
   OFF = use spaces to format white space.
   ON = use the TAB char.
   Note this does not apply to spooled output files.
   The default is system-dependent. Enter SHOW TAB to see the default value. 

TERM[OUT] {OFF|ON}
   OFF suppresses the display of output from a command file
   ON displays the output.
   TERMOUT OFF does not affect the output from commands entered interactively. 

TI[ME] {OFF|ON}
   Display the time at the command prompt.

TIMI[NG] {OFF|ON}
   ON = display timing statistics for each SQL command or PL/SQL block run.
   OFF = suppress timing statistics

TRIM[OUT] {OFF|ON}
   Display trailing blanks at the end of each line.
   ON = remove blanks, improving performance
   OFF = display blanks. 
   This does not affect spooled output.
   SQL*Plus ignores TRIMOUT ON unless you set TAB ON.

TRIMS[POOL] {ON|OFF}
   Allows trailing blanks at the end of each spooled line.
   This does not affect terminal output.

UND[ERLINE] {-|c|ON|OFF}
   Set the char used to underline column headings to c.

VER[IFY] {OFF|ON}
   ON = list the text of a command before and after replacing substitution variables with values.
   OFF = dont display the command.

WRA[P] {OFF|ON}
   Controls whether to truncate or wrap the display of long lines. 
   OFF = truncate 
   ON = wrap to the next line
   The COLUMN command (WRAPPED and TRUNCATED clause) can override this for specific columns. </pre>
</div>
<div title="statspack" creator="colm" modifier="colm" created="201201161409" modified="201303211036" changecount="8">
<pre>!!!Installation
 – provide PERFSTAT user’s password, default tablespace, and temporary tablespace.
{{{
@?/rdbms/admin/spcreate
}}}

Check stats settings with v$statistics_level.

There are three snapshot levels used in STATSPACK, and level 5 is the default:
* Level 0: General Performance Statistics This level collects general performance statistics, such as wait statistics, system events, system statistics, rollback segment data, row cache, SGA, background events, session events, lock statistics, buffer pool statistics, and parent latch statistics.
* Level 5: Add SQL Statements This level includes all level 0 statistics plus SQL statements into the stats$sql_summary table.
* Level 7 (Oracle9i r2 and above only) – This level captures segment level statistics, including logical and physical reads, row lock, itl and buffer busy waits, along with all data captured by lower levels.
* Level 10: Add Child Latch Statistics The level 10 snapshot includes everything in the level 5 statistics plus the addition of child latches into the stats$latch_children table. You rarely, if ever, need this level of detail, and you should only do a level 10 snapshot when directed by Oracle technical support.

Change the STATSPACK collection level to level 5 like this:
{{{
exec statspack.snap(i_snap_level =&gt; 5, i_modify_parameter =&gt; 'true');
}}}
What snapshots are available?
{{{
select SNAP_ID,  TO_CHAR(SNAP_TIME, 'DD/MM/YYYY HH24:MI:SS') time, SNAP_LEVEL 
from STATS$SNAPSHOT
order by time;

   SNAP_ID TIME                SNAP_LEVEL
---------- ------------------- ----------
         1 17/05/2006 12:00:03          5
         2 17/05/2006 18:30:11          5
         3 17/05/2006 19:30:15          5
         4 17/05/2006 20:30:13          5
         5 17/05/2006 21:30:12          5
         6 17/05/2006 22:30:11          5
}}}
!!!Take snapshot:
{{{execute statspack.snap}}}

Set up a DBMS_JOB entry (make sure job_queue_processes &gt; 0) – this is spauto.sql:
{{{
variable jobno number;
variable instno number;
begin
  select instance_number into :instno from v$instance;
  dbms_job.submit(:jobno, 'statspack.snap;', trunc(sysdate+1/24,'HH'), 
                    'trunc(SYSDATE+1/24,''HH'')', TRUE, :instno);
  commit;
end;
/
}}}
!!!Manually generate report:
{{{@?/rdbms/admin/spreport}}}
Remember! If updating the schedule with DBMS_JOB.INTERVAL, the new next date won’t appear until the old interval has passed (this may be forced by calling an immediate instance of the job).</pre>
</div>
<div title="tee on unix" modifier="YourName" created="201003160826" modified="201003160826" changecount="2">
<pre>mireille ~/test&gt; date | tee file1 file2
Thu Jun 10 11:10:34 CEST 2004

mireille ~/test&gt; cat file1
Thu Jun 10 11:10:34 CEST 2004

mireille ~/test&gt; cat file2
Thu Jun 10 11:10:34 CEST 2004

mireille ~/test&gt; uptime | tee -a file2
 11:10:51 up 21 days, 21:21, 57 users,  load average: 0.04, 0.16, 0.26

mireille ~/test&gt; cat file2
Thu Jun 10 11:10:34 CEST 2004
 11:10:51 up 21 days, 21:21, 57 users,  load average: 0.04, 0.16, 0.26</pre>
</div>
<div title="telnet to Taskmaster" creator="colm" modifier="colm" created="201204061447" modified="201204061503" changecount="5">
<pre>Telnet directly to TM's port - after authentication, you can shutdown etc. 
{{{
cdsinf50 [BTANTILL]/psg/working/BTANTILL/cam&gt; telnet hocpi03n 3064
Trying...
Connected to hocpi03n.emea.convergys.com.
Escape character is '^]'.
Task Master Ready. Host IP:10.29.2.101 Process ID:22638
status
OK
0
0
0
0
authenticate geneva_admin geneva_admin
OK
processversions
OK
PROCESSVERSIONS
BG             Billing Engine sqa5.0.5.173.itanium.oracle11g 2.8 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
BF              Bill Formatting Engine sqa5.0.5.itanium.oracle11g 18.8 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
DLG           Dunning Letter Generator sqa5.0.5.itanium.oracle11g 18.9 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
DEBTage  Debt Escalation Engine sqa5.0.5.itanium.oracle11g 36.8 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
RATE         Geneva Active Rating Engine sqa5.0.5.1.itanium.oracle11g 10.8 HP-UX-IA64 Optimisation Level: +O1 +Onoprocelim
...
}}}
Commands include:
AUTHENTICATE &lt;name&gt; &lt;pw&gt;
Authenticate the connection with the Task Master.
&lt;name&gt; is the user name and &lt;pw&gt; is the user password.
This must be the first command given. No other
commands are accepted until authentication is successful.
&lt;pw&gt; may also contain the database SID, for example,
“password@SID”.
READSCHEDULE Reread the schedule information from the database.
SHUTDOWN 1 Shutdown immediately.
SHUTDOWN 0 Shutdown conveniently.
STATUS Supply status information for current tasks and processes.
PROCESSVERSIONS Request the application names and Rating and Billing
Manager version numbers of all defined processes.
For Rating and Billing Manager processes the number
returned is the same as running the application with the -v
option.
READTASKREQUEST Prompt the Task Master to read the TASKREQUEST
table immediately. Issued by System Monitor when a
record is inserted into TASKREQUEST so that the Task
Master picks it up straight away rather than at the next
poll.</pre>
</div>
<div title="tusc" modifier="colm" created="201010011229" changecount="1">
<pre>Jeromes tusc example on HP-UX at logica..

{{{tusc -vfp -o TuscDconfigAgentStart.log DConfigAgent}}}</pre>
</div>
<div title="undo" creator="colm" modifier="colm" created="201201091454" modified="201201091455" changecount="2">
<pre>From [[here|https://forums.oracle.com/forums/thread.jspa?threadID=672907&amp;start=30&amp;tstart=50]] a very good explanation of UNDO and snapshot too old.

A read (SELECT, or the 'read part of a DML) has a 'start of operation' time stamp. Oracle guarantees that any read will reflect the database state as of that time stamp. This is known as a Consistent Read.

To honor that guarantee, if the data the read wants is in a block that was changed after that time stamp, the block is rebuilt using undo information to the stable state as of that time stamp.

In other words, the block being read is copied if necessary, and the copy is rolled back to reflect the last committed state as of that time stamp. (Reads inside a transaction looking at the data previously manipulated in that same transaction do not need to do this.)

In order to do this, the UNDO or ROLLBACK that changed that block must be available to perform the rollback. If that rollback is not available, you get an ORA-01555 during the read.

(Note that if there a problems getting undo space during an update, such as UNDO or ROLLBACK is too small to hold a transaction, you'll get errors such as ORA-01538, ORA-01545, ORA-01562. The ORA-01555 specifically talks about using the segment for consistent read.)

The rollback required for consistent read will not be available if it has been overwritten. That will occur if
- the ROLLBACK SEGMENT is offline (pre-UNDO segments)
- the ROLLBACK SEGMENT is too small to keep the UNDO for several transactions and new transactions are overwriting the older, committed, information

In the more modern UNDO (automatically managed rollback), you can set the UNDO_RETENTION which will try to expand the undo tablespace size to keep the required undo around. Note that this automatic expansion requires the undo tablespace to be auto extensible.

However, if the UNDO tablespace size is larger than needed, the UNDO_RETENTION also permits the system to overwrite the transaction information older than the specified time.rather than invoke an auto-extend. (I believe that is what you are facing.)

So ... if you are facing an ORA-01555 you need to

1) ensure the rollback segment (undo) is large enough to contain the undo needed rebuild blocks to the start time of the query. The UNDO_RETENTION must be larger than the longest running query;

AND

2) You need to tune the queries to be less than the UNDO_RETENTION time.</pre>
</div>
<div title="unix sort" creator="colm" modifier="YourName" created="201305140957" modified="201309301504" changecount="7">
<pre>!!!! Numeric sort
Sort by file size:
{{{ls -la | sort -rn -k 5}}}

Do a numeric sort on a file - to use the numeric 14th char of the (implictly space-divided) first field:
{{{
cdsinf50 [BTANTILL]/psg/working/BTANTILL/consolidated/relbuild&gt; cat patchlist | sort -n -k 1.14
patch_2_2_54_2
patch_2_2_54_3
patch_2_2_54_4
patch_2_2_54_5
patch_2_2_54_6
patch_2_2_54_7
patch_2_2_54_8
patch_2_2_54_10
...
}}}
!!!!Details of HP-UX sort:

{{{-k keydef}}}   The keydef argument defines a restricted sort key. The format of this definition is:

    {{{field_start[type][,field_end[type]]}}}

which defines a key field beginning at field_start and ending at field_end.  The characters at positions field_start and field_end are included in the key field, providing that field_end does not precede field_start.  A missing field_end means the end of the line.  Fields and characters within fields are numbered starting with 1.  

The arguments field_start and field_end each have the form m.n which are optionally followed by one or more of the type options b, d, f, i, n, r, or M.  These modifiers have the functionality for this key only, that their command-line counterparts have for the entire record.

A field_start position specified by m.n is interpreted to mean the nth character in the mth field.  A missing n means .1, indicating the first character of the mth field.  If the -b option is in effect, n is counted from the first non-blank character in the mth field.
</pre>
</div>
<div title="unlock weblogic user" creator="colm" modifier="colm" created="201106210803" changecount="1">
<pre>Go to mydomain in the LH pane - this wiull supply a set of tabs on the RHS. On here, the is a Security/Unlock User section. Admin fo rthe timeouts etc are on the 'Security Realms' drop down on the LHS.</pre>
</div>
<div title="vee dollar parameter" creator="colm" modifier="colm" created="201205081454" changecount="1">
<pre>~v$spparameter displays those values which we are specified in the spfile, whether or not applicable in the session.

But ~v$parameter displays only values which are applicable for the session. ~v$paramter has nothing to do with the pfile/spfile it used to start up; it just displays which values those are in effect for the session.</pre>
</div>
<div title="vi" modifier="YourName" created="201102021608" modified="201109291422" changecount="9">
<pre>{{{
%s/find/replace/g - global s/r
:18,30:s/^/account:/ - selective replace on lines 18-30
:set list - show invisibles
:r! &lt;cmd&gt; - insert result of command
:syntax on|off
:colorscheme delek
}}}

With last one, see color schemes in /usr/share/vim/vim63/colors

:colorscheme delek
:colorscheme blue
:colorscheme default
:colorscheme desert
:colorscheme elflord
:colorscheme evening
:colorscheme koehler
:colorscheme morning
:colorscheme murphy
:colorscheme pablo
:colorscheme peachpuff
:colorscheme ron
:colorscheme shine
:colorscheme torte

Remove Win CR/~LFs - 
{{{
:%s/^M//g - use Ctrl-V Ctrl-M or
tr -d &quot;\015&quot; &lt; dos.txt &gt; unix.txt
}}}

Remove blank lines - with/without spaces:
{{{
&lt;esc&gt;:g/^$/d
&lt;esc&gt;:g/^ *$/d
}}}

!!!Regular Expressions - from http://www.lagmonster.org/docs/vi.html
. (dot)	Any single character except newline
*	zero or more occurances of any character
[...]	Any single character specified in the set
[^...]	Any single character not specified in the set
^	Anchor - beginning of the line
$	Anchor - end of line
\&lt;	Anchor - begining of word
\&gt;	Anchor - end of word
\(...\)	Grouping - usually used to group conditions
\n	Contents of nth grouping

!!Set Examples 
[A-Z]	The SET from Capital A to Capital Z
[a-z]	The SET from lowercase a to lowercase z
[0-9]	The SET from 0 to 9 (All numerals)
[./=+]	The SET containing . (dot), / (slash), =, and +
[-A-F]	The SET from Capital A to Capital F and the dash (dashes must be specified first)
[0-9 A-Z]	The SET containing all capital letters and digits and a space
[A-Z][a-zA-Z]	In the first position, the SET from Capital A to Capital Z. In the second character position, the SET containing all letters</pre>
</div>
<div title="xargs" modifier="colm" created="201009012036" modified="201102091459" changecount="3">
<pre>The following copies all files containing PARALLEL to test. The -I to xargs tell sit what the placeholder is for each processed file - the equivalent of {} for -exec in find:

{{{
grep -l PARALLEL /app/convergys/pkg/RB/RB/schema/migration/scripts/*.sql | xargs -I xxx cp xxx test/.
}}}

A basic recursive grep
{{{
find . -name mwextn.cfg | xargs grep -il CUG
}}}</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->
<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[
//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

// Adaptors
config.adaptors = {};
config.defaultAdaptor = null;

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkIncrementalSearch: true,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayInstrumentation: false,
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8",
	txtTheme: ""
	};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","sync","importTask","tweak","upgrade","plugins"];

// Extensions
config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {defaultView: "text"},
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "http://www.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true;}
	],
	currBrowser: null,
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields syncing permalink references jump|\n|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|',
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki", action: saveChanges},
	sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	upgrade: {text: "upgrade", tooltip: "Upgrade TiddlyWiki core code", content: '<<upgrade>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtTheme: "Name of the theme to use",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#Download for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<\%0>>",
	macroErrorDetails: "Error while executing macro <<\%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'}
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]},
	listViewTemplateReadOnly: {
		columns: [
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.upgrade,{
	wizardTitle: "Upgrade TiddlyWiki core code",
	step1Title: "Update or repair this TiddlyWiki to the latest release",
	step1Html: "You are about to upgrade to the latest release of the TiddlyWiki core code (from <a href='%0' class='externalLink' target='_blank'>%1</a>). Your content will be preserved across the upgrade.<br><br>Note that core upgrades have been known to interfere with older plugins. If you run into problems with the upgraded file, see <a href='http://www.tiddlywiki.org/wiki/CoreUpgrades' class='externalLink' target='_blank'>http://www.tiddlywiki.org/wiki/CoreUpgrades</a>",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
	});

merge(config.macros.sync,{
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Server Type', field: 'serverType', title: "Server type", type: 'String'},
			{name: 'Server Host', field: 'serverHost', title: "Server host", type: 'String'},
			{name: 'Server Workspace', field: 'serverWorkspace', title: "Server workspace", type: 'String'},
			{name: 'Status', field: 'status', title: "Synchronisation status", type: 'String'},
			{name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
			],
		rowClasses: [
			],
		buttons: [
			{caption: "Sync these tiddlers", name: 'sync'}
			]},
	wizardTitle: "Synchronize with external servers and files",
	step1Title: "Choose the tiddlers you want to synchronize",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	syncLabel: "sync",
	syncPrompt: "Sync these tiddlers",
	hasChanged: "Changed while unplugged",
	hasNotChanged: "Unchanged while unplugged",
	syncStatusList: {
		none: {text: "...", display:'none', className:'notChanged'},
		changedServer: {text: "Changed on server", display:null, className:'changedServer'},
		changedLocally: {text: "Changed while unplugged", display:null, className:'changedLocally'},
		changedBoth: {text: "Changed while unplugged and on server", display:null, className:'changedBoth'},
		notFound: {text: "Not found on server", display:null, className:'notFound'},
		putToServer: {text: "Saved update on server", display:null, className:'putToServer'},
		gotFromServer: {text: "Retrieved update from server", display:null, className:'gotFromServer'}
		}
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.syncing,{
	text: "syncing",
	tooltip: "Control synchronisation of this tiddler with a server or external file",
	currentlySyncing: "<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</"+"div><div>host: <span class='popupHighlight'>%1</span></"+"div><div>workspace: <span class='popupHighlight'>%2</span></"+"div>", // Note escaping of closing <div> tag
	notCurrentlySyncing: "Not currently syncing",
	captionUnSync: "Stop synchronising this tiddler",
	chooseServer: "Synchronise this tiddler with another server:",
	currServerMarker: "\u25cf ",
	notCurrServerMarker: "  "});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
	});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "This tiddler is used to store configuration options for this TiddlyWiki document",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = (config.browser.isSafari || config.browser.isOpera) && (document.location.toString().substr(0,4) != "http");

// Starting up
function main()
{
	var t10,t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea","store",true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params,"onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	for(var m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2-t1) + " ms");
		displayMessage("LoadFromDiv " + (t3-t2) + " ms");
		displayMessage("LoadPlugins " + (t5-t4) + " ms");
		displayMessage("Macro init " + (t7-t6) + " ms");
		displayMessage("Notify " + (t8-t7) + " ms");
		displayMessage("Restart " + (t9-t8) + " ms");
		displayMessage("Total: " + (t10-t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. All functions called conditionally since they themselves may have been unloaded.
function unload()
{
	if(window.checkUnsavedChanges)
		checkUnsavedChanges();
	if(window.scrubNodes)
		scrubNodes(document.body);
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
}

function loadPlugins(tag)
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1);});
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n)
			map[n] = p;
		n = p.Source;
		if(n)
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++)
		visit(installedPlugins[i]);
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0],10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1],10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2],10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);
			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;
			var allowEval = true;
			if(config.evaluateMacroParameters=="system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place,macro,m.noPreParse?null:params.readMacroParams(!allowEval),wikifier,params,tiddler);
		} else {
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURIComponent(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var i=1; i<params.length; i++) {
		var p = config.paramifiers[params[i].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[i].value);
		else {
			var h = config.optionHandlers[params[i].name.substr(0,3)];
			if(h && h.set instanceof Function)
				h.set(params[i].name,params[i].value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		if(!readOnly || store.tiddlerExists(v) || store.isShadowTiddler(v))
			story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers("[tag["+v+"]]"),null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly) {
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(v) {
		story.switchTheme(v);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent= {
	onstart: function(v) {
		var titles=[];
		var tiddlers=store.getTiddlers("modified","excludeLists").reverse();
		for(var i=0; i<v && i<tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null,titles);
	}
};

config.paramifiers.filter = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers(v),null,false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},

	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if(s=="bgcolor")
				s = "backgroundColor";
			if(s=="float")
				s = "cssFloat";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1 || link.indexOf("#")!=-1) {
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow");
					theRow.onmouseover = function() {addClass(this,"hoverRow");};
					theRow.onmouseout = function() {removeClass(this,"hoverRow");};
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
					if(colSpanCount > 1) {
						last.element.setAttribute("colspan",colSpanCount);
						last.element.setAttribute("colSpan",colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if(!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?|<hr ?/?>\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w)
	{
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w)
	{
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.unWikiLink+"?"+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink) {
			w.outputText(w.output,w.matchStart+1,w.nextMatch);
			return;
		}
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				addClass(e,"imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3]) {
				img.title = lookaheadMatch[3];
				img.setAttribute("alt",lookaheadMatch[3]);
			}
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if(styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		var t0 = new Date();
		wikifier.subWikify(output);
		if(tiddler && config.options.chkDisplayInstrumentation)
			displayMessage("wikify:" +tiddler.title+ " in " + (new Date()-t0) + " ms");
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"pre");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		if(!tiddler)
			tiddler = new Tiddler("temp");
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikify(e);
		html = e.innerHTML;
		removeNode(e);
	}
	return html;
}

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = getPlainText(e);
	removeNode(e);
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	try {
		if(terminator)
			this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.version.handler = function(place)
{
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] || "all";
	var list = document.createElement("ul");
	place.appendChild(list);
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		createTiddlyLink(li,typeof results[t] == "string" ? results[t] : results[t].title,true);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.list.filter.handler = function(params)
{
	var filter = params[1];
	var results = [];
	if(filter) {
		var tiddlers = store.filterTiddlers(filter);
		for(var t=0; t<tiddlers.length; t++)
			results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
		if(params[1]) {
			btn.setAttribute("sortby",params[1]);
		}
	}
};

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] || "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	var dateFormat = params[2] || this.dateFormat;
	for(var t=tiddlers.length-1; t>=last; t--) {
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay) {
			var ul = document.createElement("ul");
			addClass(ul,"timeline");
			place.appendChild(ul);
			createTiddlyElement(ul,"li",null,"listTitle",tiddler[field].formatString(dateFormat));
			lastDay = theDay;
		}
		createTiddlyElement(ul,"li",null,"listLink").appendChild(createTiddlyLink(place,tiddler.title,true));
	}
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length-1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0,pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name",null,allowEval,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className,null,{
		refresh: "content", tiddler: tiddlerName
	});
	if(args!==undefined)
		wrapper.setAttribute("args","[["+args.join("]] [[")+"]]");
	this.transclude(wrapper,tiddlerName,args);
};

config.macros.tiddler.transclude = function(wrapper,tiddlerName,args)
{
	var text = store.getTiddlerText(tiddlerName);
	if(!text)
		return;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1)
		return;
	stack.push(tiddlerName);
	try {
		if(typeof args == "string")
			args = args.readBracketedList();
		var n = args ? Math.min(args.length,9) : 0;
		for(var i=0; i<n; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
			text = text.replace(placeholderRE,args[i]);
		}
		config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params)
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0],null,params[1],params[2]);
	if(params[3]) {
		btn.setAttribute('sortby',params[3]);
	}
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var label = null;
	for(var t=0; t<tiddler.tags.length; t++) {
		var tag = store.getTiddler(tiddler.tags[t]);
		if(!tag || !tag.tags.contains("excludeLists")) {
			if(!label)
				label = createTiddlyElement(ul,"li",null,"listTitle",lingo.labelTags.format([tiddler.title]));
			createTagButton(createTiddlyElement(ul,"li"),tiddler.tags[t],tiddler.title);
			if(t<tiddler.tags.length-1)
				createTiddlyText(ul,sep);
		}
	}
	if(!label)
		createTiddlyElement(ul,"li",null,"listTitle",lingo.labelNoTags.format([tiddler.title]));
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	ul.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(ul,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place,macroName,params)
{
	if(!readOnly)
		createTiddlyButton(place,params[0] || this.label,params[1] || this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev)
{
	var e = ev || window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var c = cookie || "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var panel = wikifier ? createTiddlyElement(place,"div",null,"gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	params = paramString.parseParams("color");
	var locolors = [], hicolors = [];
	for(var t=2; t<params.length; t++) {
		var c = params[t].value;
		if(params[t].name == "snap") {
			hicolors[hicolors.length-1] = c;
		} else {
			locolors.push(c);
			hicolors.push(c);
		}
	}
	drawGradient(panel,params[1].value != "vert",locolors,hicolors);
	if(wikifier)
		wikifier.subWikify(panel,">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var names = params[0].split(".");
		var lookupMessage = function(root,nameIndex) {
				if(names[nameIndex] in root) {
					if(nameIndex < names.length-1)
						return (lookupMessage(root[names[nameIndex]],nameIndex+1));
					else
						return root[names[nameIndex]];
				} else
					return null;
			};
		var m = lookupMessage(config,0);
		if(m == null)
			m = lookupMessage(window,0);
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};


config.macros.view.depth = 0;
config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value,place,highlightHack,tiddler);
	},
	link: function(value,place,params,wikifier,paramString,tiddler) {
		createTiddlyLink(place,value,true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if(config.macros.view.depth>50)
			return;
		config.macros.view.depth++;
		if(params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value,place,highlightHack,tiddler);
		config.macros.view.depth--;
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value) {
			var type = params[1] || config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if(handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if(field != "text" && !rows) {
			e = createTiddlyElement(null,"input",null,null,null,{
				type: "text", edit: field, size: "40", autocomplete: "off"
			});
			e.value = store.getValue(tiddler,field) || defVal;
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			e = createTiddlyElement(wrapper2,"textarea");
			e.value = v = store.getValue(tiddler,field) || defVal;
			rows = rows || 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
		if(tiddler.isReadOnly()) {
			e.setAttribute("readOnly","readOnly");
			addClass(e,"readOnly");
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev)
{
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));
	if(tags.length == 0)
		jQuery("<li/>").text(lingo.popupNone).appendTo(popup);
	for(var t=0; t<tags.length; t++) {
		var tag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag",tags[t][0]);
		tag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev)
{
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",tiddler.title);
		btn.setAttribute("tags",params[0]);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	for(var t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined)
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title,"text"))
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick,"searchButton");
	var txt = createTiddlyElement(null,"input",null,"txtOptionInput searchField");
	if(params[0]) {
		txt.value = params[0];
	}
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
	place.appendChild(txt);
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",params[1] || this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev)
{
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) {
					clearTimeout(me.timeout);
				}
				var txt = this;
				me.timeout = setTimeout(function() {me.doSearch(txt);},500);
			}
		} else {
			if(me.timeout) {
				clearTimeout(me.timeout);
			}
		}
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,"tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		createTiddlyElement(tab,"span",null,null," ",{style:"font-size:0pt;line-height:0px"});
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			removeNode(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOption(cookie);
		}
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,className)
{
	if(typeof commandName != "string") {
		var c = null;
		for(var t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd;
			switch(command.type) {
			case "popup":
				cmd = this.onClickPopup;
				break;
			case "command":
			default:
				cmd = this.onClickCommand;
				break;
			}
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			addClass(btn,"command_" + commandName);
			if(className)
				addClass(btn,className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyText || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyTooltip || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	var tiddler = store.fetchTiddler(title);
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,className,event)
{
	var children = place.getElementsByTagName("a");
	for(var t=0; t<children.length; t++) {
		var c = children[t];
		if(hasClass(c,className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev)
{
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++) {
		var c = params[t];
		switch(c) {
		case "!":
			createTiddlyText(place,this.separator);
			break;
		case "*":
			createTiddlyElement(place,"br");
			break;
		case "<":
			var btn = createTiddlyButton(place,this.lessLabel,this.lessPrompt,config.macros.toolbar.onClickLess);
			addClass(btn,"lessCommand");
			break;
		case ">":
			var btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
			addClass(btn,"moreCommand");
			var e = createTiddlyElement(place,"span",null,"moreCommand");
			e.style.display = "none";
			place = e;
			break;
		default:
			var className = "";
			switch(c.substr(0,1)) {
			case "+":
				className = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				className = "cancelCommand";
				c = c.substr(1);
				break;
			}
			if(c in config.commands) {
				this.createCommand(place,c,tiddler,className);
			} else {
				this.customCommand(place,c,wikifier,tiddler);
			}
			break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place,command,wikifier,tiddler)
{
}

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	var e = story.getTiddlerField(title,config.options.txtEditorFocus||"text");
	if(e) {
		setCaretPosition(e,0);
	}
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if(config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if(deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	for(var r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyElement(popup,"li",null,"disabled",this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.syncing.handlePopup = function(popup,title)
{
	var me = config.commands.syncing;
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var serverType = tiddler.getServerType();
	var serverHost = tiddler.fields["server.host"];
	var serverWorkspace = tiddler.fields["server.workspace"];
	if(!serverWorkspace)
		serverWorkspace = "";
	if(serverType) {
		var e = createTiddlyElement(popup,"li",null,"popupMessage");
		e.innerHTML = me.currentlySyncing.format([serverType,serverHost,serverWorkspace]);
	} else {
		createTiddlyElement(popup,"li",null,"popupMessage",me.notCurrentlySyncing);
	}
	if(serverType) {
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var btn = createTiddlyButton(createTiddlyElement(popup,"li"),this.captionUnSync,null,me.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type","");
	}
	createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
	createTiddlyElement(popup,"li",null,"popupMessage",me.chooseServer);
	var feeds = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<feeds.length; t++) {
		var f = feeds[t];
		var feedServerType = store.getTiddlerSlice(f.title,"Type");
		if(!feedServerType)
			feedServerType = "file";
		var feedServerHost = store.getTiddlerSlice(f.title,"URL");
		if(!feedServerHost)
			feedServerHost = "";
		var feedServerWorkspace = store.getTiddlerSlice(f.title,"Workspace");
		if(!feedServerWorkspace)
			feedServerWorkspace = "";
		var caption = f.title;
		if(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {
			caption = me.currServerMarker + caption;
		} else {
			caption = me.notCurrServerMarker + caption;
		}
		btn = createTiddlyButton(createTiddlyElement(popup,"li"),caption,null,me.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type",feedServerType);
		btn.setAttribute("server.host",feedServerHost);
		btn.setAttribute("server.workspace",feedServerWorkspace);
	}
};

config.commands.syncing.onChooseServer = function(e)
{
	var tiddler = this.getAttribute("tiddler");
	var serverType = this.getAttribute("server.type");
	if(serverType) {
		store.addTiddlerFields(tiddler,{
			"server.type": serverType,
			"server.host": this.getAttribute("server.host"),
			"server.workspace": this.getAttribute("server.workspace")
			});
	} else {
		store.setValue(tiddler,"server",null);
	}
	return false;
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var items = [];
	store.forEachField(tiddler,function(tiddler,fieldName,value){items.push({field:fieldName,value:value});},true);
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	for(var i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c,10) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function()
{
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields,creator)
{
	this.assign(title,text,modifier,modified,tags,created,fields,creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields,creator)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(creator != undefined)
		this.creator = creator;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g,"").
		replace(/\{{3}((?:.|\n)*?)\}{3}/g,"").
		replace(/"""((?:.|\n)*?)"""/g,"").
		replace(/\<nowiki\>((?:.|\n)*?)\<\/nowiki\>/g,"").
		replace(/\<html\>((?:.|\n)*?)\<\/html\>/g,"").
		replace(/\<script((?:.|\n)*?)\<\/script\>/g,"");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var modifier = this.modifier;
	if(!modifier)
		modifier = config.messages.subtitleUnknown;
	var modified = this.modified;
	if(modified)
		modified = modified.toLocaleString();
	else
		modified = config.messages.subtitleUnknown;
	return config.messages.tiddlerLinkTooltip.format([this.title,modifier,modified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title)
{
	if(typeof config.shadowTiddlers[title] == "string")
		return config.shadowTiddlers[title];
	else
		return "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0,pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(text) {
		if(!section)
			return text;
		var re = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)","mg");
		re.lastIndex = 0;
		var match = re.exec(text);
		if(match) {
			var t = text.substr(match.index+match[1].length);
			var re2 = /^!/mg;
			re2.lastIndex = 0;
			match = re2.exec(t); //# search for the next heading
			if(match)
				t = t.substr(0,match.index-1);//# don't include final \n
			return t;
		}
		return defaultText;
	}
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]*)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\|\n]*)[\t\x20]*\|$)/gm;
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	var m = this.slicesRE.exec(text);
	while(m) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
		m = this.slicesRE.exec(text);
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for(var i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		tiddler.incChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title,true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created,creator)
{
	var tiddler;
	if(title instanceof Tiddler) {
		tiddler = title;
		title = tiddler.title;
		newTitle = title;
	} else {
		tiddler = this.fetchTiddler(title);
		if(tiddler) {
			created = created || tiddler.created; // Preserve created date
			creator = creator || tiddler.creator;
			this.deleteTiddler(title);
		} else {
			created = created || modified;
			tiddler = new Tiddler();
		}
		fields = merge({},fields);
		tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields,creator);
	}
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var candidates = this.reverseLookup("tags",excludeTag,!!match);
	var results = [];
	for(var t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Returns a list of all tags in use
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
// Returns an array of arrays where [tag][0] is the name of the tag and [tag][1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			var n = true;
			for(var c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					n = false;
					results[c][1]++;
				}
			}
			if(n && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					n = false;
			}
			if(n)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field,value,sortField)
{
	return this.reverseLookup(field,value,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			values = tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [];
		}
		for(var lookup=0; lookup<values.length; lookup++) {
			if(values[lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	return this.sortTiddlers(results,sortField);
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		for(var n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.getTiddlerText(link,null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers,field)
{
	var asc = +1;
	switch(field.substr(0,1)) {
	case "-":
		asc = -1;
		// Note: this fall-through is intentional
		/*jsl:fallthru*/
	case "+":
		field = field.substr(1);
		break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field=="title") {
			tiddlers.sort(function(a,b) {return a[field].toLowerCase() < b[field].toLowerCase() ? -asc : (a[field].toLowerCase() == b[field].toLowerCase() ? 0 : asc);});
		} else {
			tiddlers.sort(function(a,b) {return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);});
		}
	} else {
		tiddlers.sort(function(a,b) {return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);});
	}
	return tiddlers;
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results,match) {
		var title = match[1]||match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title,this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results,match) {
		var matched = this.getTaggedTiddlers(match[3]);
		for(var m=0; m<matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	},
	sort: function(results,match) {
		return this.sortTiddlers(results,match[3]);
	},
	limit: function(results,match) {
		return results.slice(0,parseInt(match[3],10));
	},
	field: function(results,match) {
		var matched = this.getValueTiddlers(match[2],match[3]);
		for (var m = 0; m < matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter)
{
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	var results = [];
	if(filter) {
		var match = re.exec(filter);
		while(match) {
			var handler = (match[1]||match[4])?'tiddler':config.filters[match[2]]?match[2]:'field';
			results = config.filters[handler].call(this,results,match);
			match = re.exec(filter);
		}
	}
	return results;
};
// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^"+fieldName+"\\.");
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	fieldName = fieldName.toLowerCase();
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	var n,result;
	for(n in t.fields) {
		result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(n in TiddlyWiki.standardFieldAccess) {
		if(n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
		result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
		if(result)
			return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(containerId,idPrefix)
{
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		var id = this.idPrefix + title;
		return id==this.container ? this.idPrefix + "_" + title : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title)
{
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function()
{
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(fn)
{
	var place = this.getContainer();
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
	}
};

Story.prototype.displayDefaultTiddlers = function()
{
	this.displayTiddlers(null,store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,unused,customFields,toggle,animationSrc)
{
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title,true);
		} else {
			this.refreshTiddler(title,template,false,customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
		case "top":
			before = place.firstChild;
			break;
		case "bottom":
			before = null;
			break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.tiddlerId(title),"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,callback)
{
	var getTiddlerCallback = function(context)
	{
		if(context.status) {
			var t = context.tiddler;
			if(!t.created)
				t.created = new Date();
			if(!t.modified)
				t.modified = t.created;
			context.tiddler = store.saveTiddler(t.title,t.title,t.text,t.modifier,t.modified,t.tags,t.fields,true,t.created,t.creator);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title,null,true);
		}
		context.adaptor.close();
		if(callback) {
			callback(context);
		}
	};
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields||{};
	var context = {serverType:tiddler.getServerType()};
	if(!context.serverType)
		return;
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType];
	adaptor.getTiddler(title,context,null,getTiddlerCallback);
	return config.messages.loadingMissingTiddler.format([title,context.serverType,context.host,context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					var tags = [];
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,tags,version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText || text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			tiddlerElem.innerHTML = this.getTemplateForTiddler(title,template,tiddler);
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(tiddlerElem,"isTag");
			else
				removeClass(tiddlerElem,"isTag");
			if(store.tiddlerExists(title)) {
				removeClass(tiddlerElem,"shadow");
				removeClass(tiddlerElem,"missing");
			} else {
				addClass(tiddlerElem, store.isShadowTiddler(title) ? "shadow" : "missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
			forceReflow();
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = createTiddlyElement(place,"div",null,"customFields");
	w.style.display = "none";
	for(var t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function(force)
{
	var e = this.getContainer().firstChild;
	while(e) {
		var template = e.getAttribute("template");
		if(template && e.getAttribute("dirty") != "true") {
			this.refreshTiddler(e.getAttribute("tiddler"),force ? null : template,true);
		}
		e = e.nextSibling;
	}
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	addClass(this, "selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(target && target.nodeName.toLowerCase() != "input" && target.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	}
	return false;
};

Story.prototype.onTiddlerKeyPress = function(ev)
{
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
	case 9: // Tab
		var ed = story.getTiddlerField(title,"text");
		if(target.tagName.toLowerCase() == "input" && ed.value==config.views.editor.defaultText.format([title])) {
			// moving from input field and editor still contains default text, so select it
			ed.focus();
			ed.select();
			consume = true;
		}
		if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
			replaceSelection(target,String.fromCharCode(9));
			consume = true;
		}
		if(config.isOpera) {
			target.onblur = function() {
				this.focus();
				this.onblur = null;
			};
		}
		break;
	case 13: // Ctrl-Enter
	case 10: // Ctrl-Enter on IE PC
	case 77: // Ctrl-Enter is "M" on some platforms
		if(e.ctrlKey) {
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
			consume = true;
		}
		break;
	case 27: // Escape
		blurElement(this);
		config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
		consume = true;
		break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = this.getTiddler(title);
	var e = null;
	if(tiddlerElem) {
		var children = tiddlerElem.getElementsByTagName("*");
		for(var t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = this.getTiddlerField(title,field);
	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	this.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			removeNode(tiddlerElem);
			forceReflow();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	this.displayTiddlers(null,matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler")) {
		e = hasClass(e,"popup") && Popup.stack[0] ? Popup.stack[0].root : e.parentNode;
	}
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = this.getTiddler(title);
	if(e) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		if(store.fetchTiddler(title)) {
			for(var n in fields) {
				if(store.getValue(title,n) != fields[n]) //# tiddler changed
					return true;
			}
		} else {
			if(store.isShadowTiddler(title) && store.getShadowTiddlerText(title) == fields.text) { //# not checking for title or tags
				return false;
			} else { //# changed shadow or new tiddler
				return true;
			}
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title || title;
		if(!store.tiddlerExists(newTitle)) {
			newTitle = newTitle.trim();
			var creator = config.options.txtUserName;
		}
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.tiddlerId(newTitle);
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		if(store.tiddlerExists(title)) {
			var t = store.fetchTiddler(title);
			var extendedFields = t.fields;
			creator = t.creator;
		} else {
			extendedFields = merge({},config.defaultCustomFields);
		}
		for(var n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
		}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields,null,null,creator);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

Story.prototype.switchTheme = function(theme)
{
	if(safeMode)
		return;

	var isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};

	var getSlice = function(theme,slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme,slice+"ReadOnly") || store.getTiddlerSlice(theme,"Web"+slice);
		r = r || store.getTiddlerSlice(theme,slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator)==0)
			r = theme + r;
		return isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i,name,theme,slice) {
		var newName = getSlice(theme,slice);
		if(name!=newName && store.namedNotifications[i].name==name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i=0; i<config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
		case "PageTemplate":
			config.refresherData.pageTemplate = replaceNotification(i,config.refresherData.pageTemplate,theme,name);
			break;
		case "StyleSheet":
			removeStyleSheet(config.refresherData.styleSheet);
			config.refresherData.styleSheet = replaceNotification(i,config.refresherData.styleSheet,theme,name);
			break;
		case "ColorPalette":
			config.refresherData.colorPalette = replaceNotification(i,config.refresherData.colorPalette,theme,name);
			break;
		default:
			break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme,"ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme,"EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate!=pt || config.tiddlerTemplates[vi]!=vt || config.tiddlerTemplates[ei]!=et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet,"",10),config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};

//--
//-- Backstage
//--

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function(e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function(e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {backstage.switchTab(null);};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			addClass(btn,task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		addClass(this.content,"backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOption("chkBackstage");
			removeClass(this.content, "backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e)
			{
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
			}
		if(tabName == backstage.currTabName) {
			backstage.hidePanel();
			return;
		}
		if(backstage.currTabElem) {
			removeClass(this.currTabElem, "backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			addClass(tabElem,"backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findWindowHeight() + "px";
		backstage.cloak.style.display = "block";
		removeChildren(backstage.panelBody);
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			removeClass(backstage.currTabElem, "backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		} else {
			jQuery([backstage.panel,backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	var place = wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e)
{
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title,this.step1Html);
	var s = wizard.getElement("selTypes");
	for(var t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,config.adaptors[t].serverLabel ? config.adaptors[t].serverLabel : t);
		e.value = t;
	}
	if(config.defaultAdaptor)
		s.value = config.defaultAdaptor;
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = me.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen}]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var tagged = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
		} catch (ex) {
			showException(ex);
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(this.value);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(v)
{
	if(!v || !v.length)
		return v;
	v = v.replace(/\\/g,"/"); // use "/" for cross-platform consistency
	var u;
	var t = v.split(":");
	var p = t[1] || t[0]; // remove drive letter (if any)
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		u = v;
	} else if(p.substr(0,1)=="/") {
		u = document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + v;
	} else {
		var c = document.location.href.replace(/\\/g,"/");
		var pos = c.lastIndexOf("/");
		if(pos!=-1)
			c = c.substr(0,pos); // remove filename
		u = c + "/" + p;
	}
	return u;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	var ret = adaptor.openHost(url,null,wizard,me.onOpenHost);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	var ret = adaptor.getWorkspaceList(context,wizard,me.onGetWorkspaceList);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context",context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length==1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		var ret = context.adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
		if(ret !== true)
			displayMessage(ret);
		wizard.setValue("workspace",workspace);
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title,me.step2Html);
	var s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(var t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace",null,false,true);
		for(var n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = wizard.getValue("context");
	var ret = adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var ret = adaptor.getTiddlerList(context,wizard,me.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.errorGettingTiddlerList);
		return;
	}
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(me.step3Title,me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,me.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setValue("context",context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel},
			{caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,me.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(me.step4Title.format([rowNames.length]),me.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}
		],me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(t=0; t<rowNames.length; t++) {
		var context = {
			allowSynchronous:true,
			tiddler:tiddlers[tiddlers.findByField("title",rowNames[t])]
		};
		adaptor.getTiddler(rowNames[t],context,wizard,me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous)
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose}
			],me.statusDoneImport);
		autoSaveChanges();
	}
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.handler = function(place)
{
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	w.addStep(this.step1Title,this.step1Html.format([this.source,this.source]));
	w.setButtons([{caption: this.upgradeLabel, tooltip: this.upgradePrompt, onClick: this.onClickUpgrade}]);
};

config.macros.upgrade.onClickUpgrade = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(window.location.protocol != "file:") {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}
	var localPath = getLocalPath(document.location.toString());
	var backupPath = getBackupPath(localPath,me.backupExtension);
	w.setValue("backupPath",backupPath);
	w.setButtons([],me.statusPreparingBackup);
	var original = loadOriginal(localPath);
	w.setButtons([],me.statusSavingBackup);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(!backup) {
		w.setButtons([],me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}
	w.setButtons([],me.statusLoadingCore);
	var load = loadRemoteFile(me.source,me.onLoadCore,w);
	if(typeof load == "string") {
		w.setButtons([],me.errorLoadingCore);
		alert(me.errorLoadingCore);
		return false;
	}
	return false;
};

config.macros.upgrade.onLoadCore = function(status,params,responseText,url,xhr)
{
	var me = config.macros.upgrade;
	var w = params;
	var errMsg;
	if(!status)
		errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer)
		errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([],errMsg);
		alert(errMsg);
		return;
	}
	var onStartUpgrade = function(e) {
		w.setButtons([],me.statusSavingCore);
		var localPath = getLocalPath(document.location.toString());
		saveFile(localPath,responseText);
		w.setButtons([],me.statusReloadingCore);
		var backupPath = w.getValue("backupPath");
		var newLoc = document.location.toString() + "?time=" + new Date().convertToYYYYMMDDHHMM() + "#upgrade:[[" + encodeURI(backupPath) + "]]";
		window.setTimeout(function () {window.location = newLoc;},10);
	};
	var step2 = [me.step2Html_downgrade,me.step2Html_restore,me.step2Html_upgrade][compareVersions(version,newVer) + 1];
	w.addStep(me.step2Title,step2.format([formatVersion(newVer),formatVersion(version)]));
	w.setButtons([{caption: me.startLabel, tooltip: me.startPrompt, onClick: onStartUpgrade},{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}]);
};

config.macros.upgrade.onCancel = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title,me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile)
{
	var re = /^var version = \{title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return m ? {title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])} : null;
};

function upgradeFrom(path)
{
	var importStore = new TiddlyWiki();
	var tw = loadFile(path);
	if(window.netscape !== undefined)
		tw = convertUTF8ToUnicode(tw);
	importStore.importTiddlyWiki(tw);
	importStore.forEachTiddler(function(title,tiddler) {
		if(!store.getTiddler(title)) {
			store.addTiddler(tiddler);
		}
	});
	refreshDisplay();
	saveChanges(); //# To create appropriate Markup* sections
	alert(config.messages.upgradeDone.format([formatVersion()]));
	window.location = window.location.toString().substr(0,window.location.toString().lastIndexOf("?"));
}

//--
//-- Sync macro
//--

// Synchronisation handlers
config.syncers = {};

// Sync state.
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!wikifier.isStatic)
		this.startSync(place);
};

config.macros.sync.cancelSync = function()
{
	currSync = null;
};

config.macros.sync.startSync = function(place)
{
	if(currSync)
		config.macros.sync.cancelSync();
	currSync = {};
	currSync.syncList = this.getSyncableTiddlers();
	currSync.syncTasks = this.createSyncTasks(currSync.syncList);
	this.preProcessSyncableTiddlers(currSync.syncList);
	var wizard = new Wizard();
	currSync.wizard = wizard;
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	currSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
	this.processSyncableTiddlers(currSync.syncList);
	wizard.setButtons([{caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}]);
};

config.macros.sync.getSyncableTiddlers = function()
{
	var list = [];
	store.forEachTiddler(function(title,tiddler) {
		var syncItem = {};
		syncItem.serverType = tiddler.getServerType();
		syncItem.serverHost = tiddler.fields['server.host'];
		if(syncItem.serverType && syncItem.serverHost) {
			syncItem.adaptor = new config.adaptors[syncItem.serverType];
			syncItem.serverHost = syncItem.adaptor.fullHostName(syncItem.serverHost);
			syncItem.serverWorkspace = tiddler.fields['server.workspace'];
			syncItem.tiddler = tiddler;
			syncItem.title = tiddler.title;
			syncItem.isTouched = tiddler.isTouched();
			syncItem.selected = syncItem.isTouched;
			syncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? "changedLocally" : "none"];
			syncItem.status = syncItem.syncStatus.text;
			list.push(syncItem);
		}
		});
	list.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	return list;
};

config.macros.sync.preProcessSyncableTiddlers = function(syncList)
{
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		si.serverUrl = si.adaptor.generateTiddlerInfo(si.tiddler).uri;
	}
};

config.macros.sync.processSyncableTiddlers = function(syncList)
{
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		if(si.syncStatus.display)
			si.rowElement.style.display = si.syncStatus.display;
		if(si.syncStatus.className)
			si.rowElement.className = si.syncStatus.className;
	}
};

config.macros.sync.createSyncTasks = function(syncList)
{
	var syncTasks = [];
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		var r = null;
		for(var j=0; j<syncTasks.length; j++) {
			var cst = syncTasks[j];
			if(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)
				r = cst;
		}
		if(r) {
			si.syncTask = r;
			r.syncItems.push(si);
		} else {
			si.syncTask = this.createSyncTask(si);
			syncTasks.push(si.syncTask);
		}
	}
	return syncTasks;
};

config.macros.sync.createSyncTask = function(syncItem)
{
	var st = {};
	st.serverType = syncItem.serverType;
	st.serverHost = syncItem.serverHost;
	st.serverWorkspace = syncItem.serverWorkspace;
	st.syncItems = [syncItem];

	var openWorkspaceCallback = function(context,syncItems) {
		if(context.status) {
			context.adaptor.getTiddlerList(context,syncItems,getTiddlerListCallback);
			return true;
		}
		displayMessage(context.statusText);
		return false;
	};

	var getTiddlerListCallback = function(context,sycnItems) {
		var me = config.macros.sync;
		if(!context.status) {
			displayMessage(context.statusText);
			return false;
		}
		syncItems = context.userParams;
		var tiddlers = context.tiddlers;
		for(var i=0; i<syncItems.length; i++) {
			var si = syncItems[i];
			var f = tiddlers.findByField("title",si.title);
			if(f !== null) {
				if(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {
					si.syncStatus = me.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];
				}
			} else {
				si.syncStatus = me.syncStatusList.notFound;
			}
			me.updateSyncStatus(si);
		}
		return true;
	};
	var context = {host:st.serverHost,workspace:st.serverWorkspace};
	syncItem.adaptor.openHost(st.serverHost);
	syncItem.adaptor.openWorkspace(st.serverWorkspace,context,st.syncItems,openWorkspaceCallback);
	return st;
};

config.macros.sync.updateSyncStatus = function(syncItem)
{
	var e = syncItem.colElements["status"];
	removeChildren(e);
	createTiddlyText(e,syncItem.syncStatus.text);
	syncItem.rowElement.style.display = syncItem.syncStatus.display;
	if(syncItem.syncStatus.className)
		syncItem.rowElement.className = syncItem.syncStatus.className;
};

config.macros.sync.doSync = function(e)
{
	var me = config.macros.sync;
	var getTiddlerCallback = function(context,syncItem) {
		if(syncItem) {
			var tiddler = context.tiddler;
			store.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);
			syncItem.syncStatus = me.syncStatusList.gotFromServer;
			me.updateSyncStatus(syncItem);
		}
	};
	var putTiddlerCallback = function(context,syncItem) {
		if(syncItem) {
			store.resetTiddler(context.title);
			syncItem.syncStatus = me.syncStatusList.putToServer;
			me.updateSyncStatus(syncItem);
		}
	};

	var rowNames = ListView.getSelectedRows(currSync.listView);
	var sl = me.syncStatusList;
	for(var i=0; i<currSync.syncList.length; i++) {
		var si = currSync.syncList[i];
		if(rowNames.indexOf(si.title) != -1) {
			var errorMsg = "Error in doSync: ";
			try {
				var r = true;
				switch(si.syncStatus) {
				case sl.changedServer:
					var context = {"workspace": si.serverWorkspace};
					r = si.adaptor.getTiddler(si.title,context,si,getTiddlerCallback);
					break;
				case sl.notFound:
				case sl.changedLocally:
				case sl.changedBoth:
					r = si.adaptor.putTiddler(si.tiddler,null,si,putTiddlerCallback);
					break;
				default:
					break;
				}
				if(!r)
					displayMessage(errorMsg + r);
			} catch(ex) {
				if(ex.name == "TypeError")
					displayMessage("sync operation unsupported: " + ex.message);
				else
					displayMessage(errorMsg + ex.message);
			}
		}
	}
	return false;
};

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var me = config.macros.plugins;
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(listWrapper);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper,plugins,template,this.onSelectCommand);
		wizard.setValue("listView",listView);
		if(!readOnly) {
			wizard.setButtons([
				{caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag},
				{caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete}
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var t=0; t<rowNames.length; t++)
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(var t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
	}
};

//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		removeChildren(msgArea);
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{name: "SystemSettings", notify: onSystemSettingsChange},
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "WindowTitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},

	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.getAttribute("args");
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			removeChildren(e);
			config.macros.tiddler.transclude(e,title,args);
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	var isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};
	if(!title || !isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	wrapper.innerHTML = store.getRecursiveTiddlerText(title,null,10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div",story.containerId());
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	removeNode(stash);
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	return wikifyPlain("WindowTitle");
}

function refreshStyles(title,doc)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc || document);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? 'true' : 'false';},
		set: function(name,value) {config.options[name] = value == 'true';}
	}
};

function setOption(name,value)
{
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name,value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name)
{
	var optType = name.substr(0,3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ? config.optionHandlers[optType].get(name) : null;
}

function loadOptions()
{
	if(safeMode)
		return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies()
{
	var cookieList = document.cookie.split(';');
	var cookies = {};
	for(var i=0; i<cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = cookieList[i].substr(0,p).trim();
			var value = cookieList[i].substr(p+1).trim();
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies()
{
	var cookies = getCookies();
	if(cookies['TiddlyWiki']) {
		cookies = cookies['TiddlyWiki'].decodeHashMap();
	}
	for(var i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i,cookies[i]);
		}
	}
}

function loadSystemSettings()
{
	var settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(var key in settings) {
		setOption(key,settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange()
{
	if(!startingUp) {
		loadSystemSettings();
	}
}

function saveOption(name)
{
	if(safeMode)
		return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}
	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name,true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name)
{
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name)
{
	var cookies = {};
	for(var key in config.options) {
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWiki=' + String.encodeHashMap(cookies) + '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';
	cookies = getCookies();
	for(var c in cookies) {
		var optType = c.substr(0,3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

function saveSystemSetting(name,saveFile)
{
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title,name);
	if(readOnly || slice === getOption(name)) {
		return; //# don't save if read-only or the option hasn't changed
	}
	var slices = store.calcAllSlices(title);
	var key;
	for(key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}
	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key,slices[key]]));
	}
	text = text.sort().join('\n');
	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title,title,text,'System',new Date(),['excludeLists'],config.defaultCustomFields);
	}
	if(saveFile) {
		if(storeWasDirty == false && story.areAnyDirty() == false) {
			saveChanges(null,[tiddler]);
		} else {
			autoSaveChanges(null,[tiddler]);
		
		}
    }
}

function encodeCookie(s)
{
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,'')));});
}

config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute('type',typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute('option',opt);
	c.className = className || typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute('title',config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != 'no')
		createTiddlyText(place,config.optionsDesc[opt] || opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType,this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType,elem)
{
	config.options[opt] = value;
	saveOption(opt);
	var nodes = document.getElementsByTagName(elementType);
	for(var t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute('option');
		if(opt == optNode && nodes[t]!=elem)
			nodes[t][valueField] = value;
	}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params,'name',null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params,'class',null);
	var desc = getParam(params,'desc','no');
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var showUnknown = getParam(params,'showUnknown','no');
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue('listWrapper',listWrapper);
	this.refreshOptions(listWrapper,showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
	var opts = [];
	for(var n in config.options) {
		var opt = {};
		opt.option = '';
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	var listview = ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	removeChildren(listWrapper);
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + convertUnicodeToFileFormat(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
}

function updateOriginal(original,posDiv,localPath)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToFileFormat(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToFileFormat(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

function loadOriginal(localPath)
{
	return loadFile(localPath);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	var originalPath = document.location.toString();
	if(originalPath.substr(0,5) != "file:") {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(msg.cantSaveError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(msg.invalidFileError.format([localPath]));
		return;
	}
	saveMain(localPath,original,posDiv);
	if(config.options.chkSaveBackups)
		saveBackup(localPath,original);
	if(config.options.chkSaveEmptyTemplate)
		saveEmpty(localPath,original,posDiv);
	if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
		saveRss(localPath);
	if(config.options.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv,localPath);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function saveBackup(localPath,original)
{
	var backupPath = getBackupPath(localPath);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(backup)
		displayMessage(config.messages.backupSaved,"file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath,original,posDiv)
{
	var emptyPath,p;
	if((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";
	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath,empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath,title,extension)
{
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
	if(title)
		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath)
{
	var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
	if(saveFile(rssPath,convertUnicodeToFileFormat(generateRss())))
		displayMessage(config.messages.rssSaved,"file://" + rssPath);
	else
		alert(config.messages.rssFailed);
}

tiddlerToRssItem = function(tiddler,uri)
{
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text,null,tiddler).htmlEncode() + "</description>\n";
	for(var i=0; i<tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s +="<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
};

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for(var i=tiddlers.length-1; i>=n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i],u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToFileFormat(s)
{
	return config.browser.isOpera || !window.netscape ? (config.browser.isIE ? convertUnicodeToHtmlEntities(s) : s) : mozConvertUnicodeToUTF8(s);
}

function convertUnicodeToHtmlEntities(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function convertUnicodeToUTF8(s)
{
// return convertUnicodeToFileFormat to allow plugin migration
	return convertUnicodeToFileFormat(s);
}

function manualConvertUnicodeToUTF8(s)
{
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function copyFile(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}

function saveFile(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos==-1)
		pos = path.lastIndexOf("/");
	if(pos!=-1)
		path = path.substring(0,pos+1);

	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	return i > 0 ? url.substring(i-1) : url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

//--
//-- Server adaptor base class
//--

function AdaptorBase()
{
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function()
{
	return true;
};

AdaptorBase.prototype.fullHostName = function(host)
{
	if(!host)
		return '';
	host = host.trim();
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length-1) == '/')
		host = host.substr(0,host.length-1);
	return host;
};

AdaptorBase.minHostName = function(host)
{
	return host;
};

AdaptorBase.prototype.setContext = function(context,userParams,callback)
{
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
AdaptorBase.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {context.callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
AdaptorBase.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	this.workspace = workspace;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor()
{
}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

// Get the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback,filter)
{
	context = this.setContext(context,userParams,callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		var ret = context.complete(context,context.userParams);
	} else {
		ret = loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
		if(typeof ret != "string")
			ret = true;
	}
	return ret;
};

FileAdaptor.getTiddlerListComplete = function(context,userParams)
{
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title,tiddler) {context.tiddlers.push(tiddler);});
		}
		for(var i=0; i<context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieve a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	return context.adaptor.store ?
		context.complete(context,context.userParams) :
		loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
};

FileAdaptor.getTiddlerComplete = function(context,userParams)
{
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context,userParams);
	} else {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

function ajaxReq(args)
{
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	return jQuery.ajax(args);
}

//--
//-- TiddlyWiki-specific utility functions
//--

// Returns TiddlyWiki version string
function formatVersion(v)
{
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "");
}

function compareVersions(v1,v2)
{
	var a = ["major","minor","revision"];
	for(var i = 0; i<a.length; i++) {
		var x1 = v1[a[i]] || 0;
		var x2 = v2[a[i]] || 0;
		if(x1<x2)
			return 1;
		if(x1>x2)
			return -1;
	}
	x1 = v1.beta || 9999;
	x2 = v2.beta || 9999;
	if(x1<x2)
		return 1;
	return x1 > x2 ? -1 : 0;
}

function createTiddlyButton(parent,text,tooltip,action,className,id,accessKey,attribs)
{
	var btn = document.createElement("a");
	if(action) {
		btn.onclick = action;
		btn.setAttribute("href","javascript:;");
	}
	if(tooltip)
		btn.setAttribute("title",tooltip);
	if(text)
		btn.appendChild(document.createTextNode(text));
	btn.className = className || "button";
	if(id)
		btn.id = id;
	if(attribs) {
		for(var i in attribs) {
			btn.setAttribute(i,attribs[i]);
		}
	}
	if(parent)
		parent.appendChild(btn);
	if(accessKey)
		btn.setAttribute("accessKey",accessKey);
	return btn;
}

function createTiddlyLink(place,title,includeText,className,isStatic,linkedFromTiddler,noToggle)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,className);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
		} else {
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
		}
	}
	if(typeof config.annotations[title]=="string")
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url,label)
{
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	link.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	if(label)
		createTiddlyText(link, label);
	return link;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f,config.defaultCustomFields,true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler,title,tooltip)
{
	var btn = createTiddlyButton(place,title||tag,(tooltip||config.views.wikified.tag.tooltip).format([tag]),onClickTag);
	btn.setAttribute("tag",tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler",excludeTiddler);
	return btn;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	addClass(popup,"taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[")==-1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby&&sortby.length) {
			store.sortTiddlers(tagged,sortby);
		}
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			openAll.setAttribute("sortby",sortby);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyElement(popup,"li",null,"disabled",lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev)
{
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby&&sortby.length) {
		store.sortTiddlers(tiddlers,sortby);
	}
	story.displayTiddlers(this,tiddlers);
	return false;
}

function onClickError(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickTiddlyPopup(ev)
{
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for(var i in src) {
		if(!preserveExisting || dst[i] === undefined)
			dst[i] = src[i];
	}
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description || e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(!g.browsers[b]() && b < g.browsers.length-1)
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}

if(!window.console) {
	console = {tiddlywiki:true,log:function(message) {displayMessage(message);}};
}

//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() //# Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
	case "-tw-vertScroll":
		window.scrollTo(findScrollX(),value);
		break;
	case "-tw-horizScroll":
		window.scrollTo(value,findScrollY());
		break;
	default:
		element.style[style] = value;
		break;
	}
};

Morpher.prototype.stop = function()
{
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	var progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
			case undefined:
			case "style":
				var v = p.start + (p.end-p.start) * progress;
				this.assignStyle(this.element,p.style,template.format([v]));
				break;
			case "color":
				break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {removeNode(element);};
	return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement)
{
	var p = [{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}];
	return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var left = findPosX(element);
	var width = element.scrollWidth;
	var height = element.scrollHeight;
	var winWidth = findWindowWidth();
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
		case "all":
			c = function(element,properties) {removeNode(element);};
			break;
		case "children":
			c = function(element,properties) {removeChildren(element);};
			break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,className)
{
	var stackPosition = this.find(root,"popup");
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem || "ol","popup",className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev)
{
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign,halign,offset)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,valign,halign,offset);
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,valign,halign,offset)
{
	if(!offset)
		var offset = {x:0,y:0};
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e)
{
	var pos = -1;
	for (var t=this.stack.length-1; t>=0; t--) {
		if(isDescendant(e,this.stack[t].popup))
			pos = t;
	}
	return pos;
};

Popup.remove = function(pos)
{
	if(!pos) var pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		removeNode(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	if(this.formElem)
		this.formElem[name] = value;
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? this.formElem[name] : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function()
{
	removeChildren(this.bodyElem);
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	removeChildren(this.footElem);
	for(var t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	removeChildren(this.bodyElem);
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className || "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(c,columnTemplate,t);
			if(columnTemplate.className)
				addClass(c,columnTemplate.className);
		}
	}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++) {
		var rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		for(var cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
				if(columnTemplate.className)
					addClass(c,columnTemplate.className);
			}
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var msg = config.messages.sizeTemplates;
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<msg.length-1 && v<msg[t].unit)
					t++;
				createTiddlyText(place,msg[t].template.format([Math.round(v/msg[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createExternalLink(place,v,c || v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				for(var t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};

//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return Number(c);
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++) {
		if(this[t][field] === value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for(var i = 0; i<items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

if(!Array.prototype.map) {
Array.prototype.map = function(fn,thisObj)
{
	var scope = thisObj || window;
	var a = [];
	for(var i=0, j=this.length; i < j; ++i) {
		a.push(fn.call(scope,this[i],i,this));
	}
	return a;
};}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1) {
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s)
{
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval && config.evaluateMacroParameters != "none") {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) {
							n = window.restrictedEval(n);
						}
					} else {
						n = window.eval(n);
					}
				}
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval)
{
	var p = this.parseParams("list",null,!notAllowEval,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++) {
		if(p[t].value)
			n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var r = {};
	for(var t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var r = [];
	for(var t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix)
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	t = t.replace(/\\/g,"");
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),3) +"0";
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,12));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,14));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d)
{
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2)||"00",10),
			parseInt(d.substr(10,2)||"00",10),
			parseInt(d.substr(12,2)||"00",10),
			parseInt(d.substr(14,3)||"000",10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
				("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
				("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

function drawGradient(place,horiz,locolors,hicolors)
{
	if(!hicolors)
		hicolors = locolors;
	for(var t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var p = t/100*(locolors.length-1);
		var hc = hicolors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = locolors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc,p-Math.floor(p)).toString();
	}
}

function createTiddlyText(parent,text)
{
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,parent);
	return cb;
}

function createTiddlyElement(parent,element,id,className,text,attribs)
{
	var e = document.createElement(element);
	if(className != null)
		e.className = className;
	if(id != null)
		e.setAttribute("id",id);
	if(text != null)
		e.appendChild(document.createTextNode(text));
	if(attribs) {
		for(var n in attribs) {
			e.setAttribute(n,attribs[n]);
		}
	}
	if(parent != null)
		parent.appendChild(e);
	return e;
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj["e"+type+fn] = fn;
		obj[type+fn] = function(){obj["e"+type+fn](window.event);};
		obj.attachEvent("on"+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent("on"+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}


// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !hasClass(e,value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Force the browser to do a document reflow when needed to workaround browser bugs
function forceReflow()
{
	if(config.browser.isGecko) {
		setStylesheet("body {top:0px;margin-top:0px;}","forceReflow");
		setTimeout(function() {setStylesheet("","forceReflow");},1);
	}
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0,e.selectionStart).split("\n").length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e,pos)
{
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) {
		// IE support
		e.focus ();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character',pos);
		sel.moveEnd('character',0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = "";
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor)
{
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e)
{
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	if(!config.browser.isIE)
		return;
	var att = e.attributes;
	if(att) {
		for(var t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function addClass(e,className)
{
	jQuery(e).addClass(className);
}

function removeClass(e,className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e,className)
{
	return jQuery(e).hasClass(className);
}

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

// Remove a node and all it's children
function removeNode(e)
{
	jQuery(e).remove();
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(safeMode && store.isShadowTiddler(title))
		return;
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for(var t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for(var t = 0; t < tiddlers.length; t++) {
		if(!tiddlers[t].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[t]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if(node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var attrs = node.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields,creator);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if(!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created;
		var modified = tiddler.modified;
		var attributes = tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "";
		attributes += tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && created == version.date) ? "" :' created="' + created.convertToYYYYMMDDHHMM() + '"';
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() +'"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//]]>
</script>
<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated DOM utilities
//--

// @Deprecated: Use jQuery.stylesheet instead
function setStylesheet(s,id,doc)
{
	jQuery.twStylesheet(s,{ id: id, doc: doc });
}

// @Deprecated: Use jQuery.stylesheet.remove instead
function removeStyleSheet(id)
{
	jQuery.twStylesheet.remove({ id: id });
}
//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

function httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache)
{
	var options = {
		type:type,
		url:url,
		processData:false,
		data:data,
		cache:!!allowCache,
		beforeSend: function(xhr) {
			for(var i in headers)
				xhr.setRequestHeader(i,headers[i]);
			xhr.setRequestHeader("X-Requested-With", "TiddlyWiki " + formatVersion());
		}
	};

	if(callback) {
		options.complete = function(xhr,textStatus) {
			if(jQuery.httpSuccess(xhr))
				callback(true,params,xhr.responseText,url,xhr);
			else
				callback(false,params,null,url,xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	return jQuery.ajax(options);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*!
 * jQuery JavaScript Library v1.4.3
 * http://jquery.com/
 *
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Includes Sizzle.js
 * http://sizzlejs.com/
 * Copyright 2010, The Dojo Foundation
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Thu Oct 14 23:10:06 2010 -0400
 */
(function(E,A){function U(){return false}function ba(){return true}function ja(a,b,d){d[0].type=a;return c.event.handle.apply(b,d)}function Ga(a){var b,d,e=[],f=[],h,k,l,n,s,v,B,D;k=c.data(this,this.nodeType?"events":"__events__");if(typeof k==="function")k=k.events;if(!(a.liveFired===this||!k||!k.live||a.button&&a.type==="click")){if(a.namespace)D=RegExp("(^|\\.)"+a.namespace.split(".").join("\\.(?:.*\\.)?")+"(\\.|$)");a.liveFired=this;var H=k.live.slice(0);for(n=0;n<H.length;n++){k=H[n];k.origType.replace(X,
"")===a.type?f.push(k.selector):H.splice(n--,1)}f=c(a.target).closest(f,a.currentTarget);s=0;for(v=f.length;s<v;s++){B=f[s];for(n=0;n<H.length;n++){k=H[n];if(B.selector===k.selector&&(!D||D.test(k.namespace))){l=B.elem;h=null;if(k.preType==="mouseenter"||k.preType==="mouseleave"){a.type=k.preType;h=c(a.relatedTarget).closest(k.selector)[0]}if(!h||h!==l)e.push({elem:l,handleObj:k,level:B.level})}}}s=0;for(v=e.length;s<v;s++){f=e[s];if(d&&f.level>d)break;a.currentTarget=f.elem;a.data=f.handleObj.data;
a.handleObj=f.handleObj;D=f.handleObj.origHandler.apply(f.elem,arguments);if(D===false||a.isPropagationStopped()){d=f.level;if(D===false)b=false}}return b}}function Y(a,b){return(a&&a!=="*"?a+".":"")+b.replace(Ha,"`").replace(Ia,"&")}function ka(a,b,d){if(c.isFunction(b))return c.grep(a,function(f,h){return!!b.call(f,h,f)===d});else if(b.nodeType)return c.grep(a,function(f){return f===b===d});else if(typeof b==="string"){var e=c.grep(a,function(f){return f.nodeType===1});if(Ja.test(b))return c.filter(b,
e,!d);else b=c.filter(b,e)}return c.grep(a,function(f){return c.inArray(f,b)>=0===d})}function la(a,b){var d=0;b.each(function(){if(this.nodeName===(a[d]&&a[d].nodeName)){var e=c.data(a[d++]),f=c.data(this,e);if(e=e&&e.events){delete f.handle;f.events={};for(var h in e)for(var k in e[h])c.event.add(this,h,e[h][k],e[h][k].data)}}})}function Ka(a,b){b.src?c.ajax({url:b.src,async:false,dataType:"script"}):c.globalEval(b.text||b.textContent||b.innerHTML||"");b.parentNode&&b.parentNode.removeChild(b)}
function ma(a,b,d){var e=b==="width"?a.offsetWidth:a.offsetHeight;if(d==="border")return e;c.each(b==="width"?La:Ma,function(){d||(e-=parseFloat(c.css(a,"padding"+this))||0);if(d==="margin")e+=parseFloat(c.css(a,"margin"+this))||0;else e-=parseFloat(c.css(a,"border"+this+"Width"))||0});return e}function ca(a,b,d,e){if(c.isArray(b)&&b.length)c.each(b,function(f,h){d||Na.test(a)?e(a,h):ca(a+"["+(typeof h==="object"||c.isArray(h)?f:"")+"]",h,d,e)});else if(!d&&b!=null&&typeof b==="object")c.isEmptyObject(b)?
e(a,""):c.each(b,function(f,h){ca(a+"["+f+"]",h,d,e)});else e(a,b)}function S(a,b){var d={};c.each(na.concat.apply([],na.slice(0,b)),function(){d[this]=a});return d}function oa(a){if(!da[a]){var b=c("<"+a+">").appendTo("body"),d=b.css("display");b.remove();if(d==="none"||d==="")d="block";da[a]=d}return da[a]}function ea(a){return c.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:false}var u=E.document,c=function(){function a(){if(!b.isReady){try{u.documentElement.doScroll("left")}catch(i){setTimeout(a,
1);return}b.ready()}}var b=function(i,r){return new b.fn.init(i,r)},d=E.jQuery,e=E.$,f,h=/^(?:[^<]*(<[\w\W]+>)[^>]*$|#([\w\-]+)$)/,k=/\S/,l=/^\s+/,n=/\s+$/,s=/\W/,v=/\d/,B=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,D=/^[\],:{}\s]*$/,H=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,w=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,G=/(?:^|:|,)(?:\s*\[)+/g,M=/(webkit)[ \/]([\w.]+)/,g=/(opera)(?:.*version)?[ \/]([\w.]+)/,j=/(msie) ([\w.]+)/,o=/(mozilla)(?:.*? rv:([\w.]+))?/,m=navigator.userAgent,p=false,
q=[],t,x=Object.prototype.toString,C=Object.prototype.hasOwnProperty,P=Array.prototype.push,N=Array.prototype.slice,R=String.prototype.trim,Q=Array.prototype.indexOf,L={};b.fn=b.prototype={init:function(i,r){var y,z,F;if(!i)return this;if(i.nodeType){this.context=this[0]=i;this.length=1;return this}if(i==="body"&&!r&&u.body){this.context=u;this[0]=u.body;this.selector="body";this.length=1;return this}if(typeof i==="string")if((y=h.exec(i))&&(y[1]||!r))if(y[1]){F=r?r.ownerDocument||r:u;if(z=B.exec(i))if(b.isPlainObject(r)){i=
[u.createElement(z[1])];b.fn.attr.call(i,r,true)}else i=[F.createElement(z[1])];else{z=b.buildFragment([y[1]],[F]);i=(z.cacheable?z.fragment.cloneNode(true):z.fragment).childNodes}return b.merge(this,i)}else{if((z=u.getElementById(y[2]))&&z.parentNode){if(z.id!==y[2])return f.find(i);this.length=1;this[0]=z}this.context=u;this.selector=i;return this}else if(!r&&!s.test(i)){this.selector=i;this.context=u;i=u.getElementsByTagName(i);return b.merge(this,i)}else return!r||r.jquery?(r||f).find(i):b(r).find(i);
else if(b.isFunction(i))return f.ready(i);if(i.selector!==A){this.selector=i.selector;this.context=i.context}return b.makeArray(i,this)},selector:"",jquery:"1.4.3",length:0,size:function(){return this.length},toArray:function(){return N.call(this,0)},get:function(i){return i==null?this.toArray():i<0?this.slice(i)[0]:this[i]},pushStack:function(i,r,y){var z=b();b.isArray(i)?P.apply(z,i):b.merge(z,i);z.prevObject=this;z.context=this.context;if(r==="find")z.selector=this.selector+(this.selector?" ":
"")+y;else if(r)z.selector=this.selector+"."+r+"("+y+")";return z},each:function(i,r){return b.each(this,i,r)},ready:function(i){b.bindReady();if(b.isReady)i.call(u,b);else q&&q.push(i);return this},eq:function(i){return i===-1?this.slice(i):this.slice(i,+i+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(N.apply(this,arguments),"slice",N.call(arguments).join(","))},map:function(i){return this.pushStack(b.map(this,function(r,y){return i.call(r,
y,r)}))},end:function(){return this.prevObject||b(null)},push:P,sort:[].sort,splice:[].splice};b.fn.init.prototype=b.fn;b.extend=b.fn.extend=function(){var i=arguments[0]||{},r=1,y=arguments.length,z=false,F,I,K,J,fa;if(typeof i==="boolean"){z=i;i=arguments[1]||{};r=2}if(typeof i!=="object"&&!b.isFunction(i))i={};if(y===r){i=this;--r}for(;r<y;r++)if((F=arguments[r])!=null)for(I in F){K=i[I];J=F[I];if(i!==J)if(z&&J&&(b.isPlainObject(J)||(fa=b.isArray(J)))){if(fa){fa=false;clone=K&&b.isArray(K)?K:[]}else clone=
K&&b.isPlainObject(K)?K:{};i[I]=b.extend(z,clone,J)}else if(J!==A)i[I]=J}return i};b.extend({noConflict:function(i){E.$=e;if(i)E.jQuery=d;return b},isReady:false,readyWait:1,ready:function(i){i===true&&b.readyWait--;if(!b.readyWait||i!==true&&!b.isReady){if(!u.body)return setTimeout(b.ready,1);b.isReady=true;if(!(i!==true&&--b.readyWait>0)){if(q){for(var r=0;i=q[r++];)i.call(u,b);q=null}b.fn.triggerHandler&&b(u).triggerHandler("ready")}}},bindReady:function(){if(!p){p=true;if(u.readyState==="complete")return setTimeout(b.ready,
1);if(u.addEventListener){u.addEventListener("DOMContentLoaded",t,false);E.addEventListener("load",b.ready,false)}else if(u.attachEvent){u.attachEvent("onreadystatechange",t);E.attachEvent("onload",b.ready);var i=false;try{i=E.frameElement==null}catch(r){}u.documentElement.doScroll&&i&&a()}}},isFunction:function(i){return b.type(i)==="function"},isArray:Array.isArray||function(i){return b.type(i)==="array"},isWindow:function(i){return i&&typeof i==="object"&&"setInterval"in i},isNaN:function(i){return i==
null||!v.test(i)||isNaN(i)},type:function(i){return i==null?String(i):L[x.call(i)]||"object"},isPlainObject:function(i){if(!i||b.type(i)!=="object"||i.nodeType||b.isWindow(i))return false;if(i.constructor&&!C.call(i,"constructor")&&!C.call(i.constructor.prototype,"isPrototypeOf"))return false;for(var r in i);return r===A||C.call(i,r)},isEmptyObject:function(i){for(var r in i)return false;return true},error:function(i){throw i;},parseJSON:function(i){if(typeof i!=="string"||!i)return null;i=b.trim(i);
if(D.test(i.replace(H,"@").replace(w,"]").replace(G,"")))return E.JSON&&E.JSON.parse?E.JSON.parse(i):(new Function("return "+i))();else b.error("Invalid JSON: "+i)},noop:function(){},globalEval:function(i){if(i&&k.test(i)){var r=u.getElementsByTagName("head")[0]||u.documentElement,y=u.createElement("script");y.type="text/javascript";if(b.support.scriptEval)y.appendChild(u.createTextNode(i));else y.text=i;r.insertBefore(y,r.firstChild);r.removeChild(y)}},nodeName:function(i,r){return i.nodeName&&i.nodeName.toUpperCase()===
r.toUpperCase()},each:function(i,r,y){var z,F=0,I=i.length,K=I===A||b.isFunction(i);if(y)if(K)for(z in i){if(r.apply(i[z],y)===false)break}else for(;F<I;){if(r.apply(i[F++],y)===false)break}else if(K)for(z in i){if(r.call(i[z],z,i[z])===false)break}else for(y=i[0];F<I&&r.call(y,F,y)!==false;y=i[++F]);return i},trim:R?function(i){return i==null?"":R.call(i)}:function(i){return i==null?"":i.toString().replace(l,"").replace(n,"")},makeArray:function(i,r){var y=r||[];if(i!=null){var z=b.type(i);i.length==
null||z==="string"||z==="function"||z==="regexp"||b.isWindow(i)?P.call(y,i):b.merge(y,i)}return y},inArray:function(i,r){if(r.indexOf)return r.indexOf(i);for(var y=0,z=r.length;y<z;y++)if(r[y]===i)return y;return-1},merge:function(i,r){var y=i.length,z=0;if(typeof r.length==="number")for(var F=r.length;z<F;z++)i[y++]=r[z];else for(;r[z]!==A;)i[y++]=r[z++];i.length=y;return i},grep:function(i,r,y){var z=[],F;y=!!y;for(var I=0,K=i.length;I<K;I++){F=!!r(i[I],I);y!==F&&z.push(i[I])}return z},map:function(i,
r,y){for(var z=[],F,I=0,K=i.length;I<K;I++){F=r(i[I],I,y);if(F!=null)z[z.length]=F}return z.concat.apply([],z)},guid:1,proxy:function(i,r,y){if(arguments.length===2)if(typeof r==="string"){y=i;i=y[r];r=A}else if(r&&!b.isFunction(r)){y=r;r=A}if(!r&&i)r=function(){return i.apply(y||this,arguments)};if(i)r.guid=i.guid=i.guid||r.guid||b.guid++;return r},access:function(i,r,y,z,F,I){var K=i.length;if(typeof r==="object"){for(var J in r)b.access(i,J,r[J],z,F,y);return i}if(y!==A){z=!I&&z&&b.isFunction(y);
for(J=0;J<K;J++)F(i[J],r,z?y.call(i[J],J,F(i[J],r)):y,I);return i}return K?F(i[0],r):A},now:function(){return(new Date).getTime()},uaMatch:function(i){i=i.toLowerCase();i=M.exec(i)||g.exec(i)||j.exec(i)||i.indexOf("compatible")<0&&o.exec(i)||[];return{browser:i[1]||"",version:i[2]||"0"}},browser:{}});b.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(i,r){L["[object "+r+"]"]=r.toLowerCase()});m=b.uaMatch(m);if(m.browser){b.browser[m.browser]=true;b.browser.version=
m.version}if(b.browser.webkit)b.browser.safari=true;if(Q)b.inArray=function(i,r){return Q.call(r,i)};if(!/\s/.test("\u00a0")){l=/^[\s\xA0]+/;n=/[\s\xA0]+$/}f=b(u);if(u.addEventListener)t=function(){u.removeEventListener("DOMContentLoaded",t,false);b.ready()};else if(u.attachEvent)t=function(){if(u.readyState==="complete"){u.detachEvent("onreadystatechange",t);b.ready()}};return E.jQuery=E.$=b}();(function(){c.support={};var a=u.documentElement,b=u.createElement("script"),d=u.createElement("div"),
e="script"+c.now();d.style.display="none";d.innerHTML="   <link/><table></table><a href='/a' style='color:red;float:left;opacity:.55;'>a</a><input type='checkbox'/>";var f=d.getElementsByTagName("*"),h=d.getElementsByTagName("a")[0],k=u.createElement("select"),l=k.appendChild(u.createElement("option"));if(!(!f||!f.length||!h)){c.support={leadingWhitespace:d.firstChild.nodeType===3,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/red/.test(h.getAttribute("style")),
hrefNormalized:h.getAttribute("href")==="/a",opacity:/^0.55$/.test(h.style.opacity),cssFloat:!!h.style.cssFloat,checkOn:d.getElementsByTagName("input")[0].value==="on",optSelected:l.selected,optDisabled:false,checkClone:false,scriptEval:false,noCloneEvent:true,boxModel:null,inlineBlockNeedsLayout:false,shrinkWrapBlocks:false,reliableHiddenOffsets:true};k.disabled=true;c.support.optDisabled=!l.disabled;b.type="text/javascript";try{b.appendChild(u.createTextNode("window."+e+"=1;"))}catch(n){}a.insertBefore(b,
a.firstChild);if(E[e]){c.support.scriptEval=true;delete E[e]}a.removeChild(b);if(d.attachEvent&&d.fireEvent){d.attachEvent("onclick",function s(){c.support.noCloneEvent=false;d.detachEvent("onclick",s)});d.cloneNode(true).fireEvent("onclick")}d=u.createElement("div");d.innerHTML="<input type='radio' name='radiotest' checked='checked'/>";a=u.createDocumentFragment();a.appendChild(d.firstChild);c.support.checkClone=a.cloneNode(true).cloneNode(true).lastChild.checked;c(function(){var s=u.createElement("div");
s.style.width=s.style.paddingLeft="1px";u.body.appendChild(s);c.boxModel=c.support.boxModel=s.offsetWidth===2;if("zoom"in s.style){s.style.display="inline";s.style.zoom=1;c.support.inlineBlockNeedsLayout=s.offsetWidth===2;s.style.display="";s.innerHTML="<div style='width:4px;'></div>";c.support.shrinkWrapBlocks=s.offsetWidth!==2}s.innerHTML="<table><tr><td style='padding:0;display:none'></td><td>t</td></tr></table>";var v=s.getElementsByTagName("td");c.support.reliableHiddenOffsets=v[0].offsetHeight===
0;v[0].style.display="";v[1].style.display="none";c.support.reliableHiddenOffsets=c.support.reliableHiddenOffsets&&v[0].offsetHeight===0;s.innerHTML="";u.body.removeChild(s).style.display="none"});a=function(s){var v=u.createElement("div");s="on"+s;var B=s in v;if(!B){v.setAttribute(s,"return;");B=typeof v[s]==="function"}return B};c.support.submitBubbles=a("submit");c.support.changeBubbles=a("change");a=b=d=f=h=null}})();c.props={"for":"htmlFor","class":"className",readonly:"readOnly",maxlength:"maxLength",
cellspacing:"cellSpacing",rowspan:"rowSpan",colspan:"colSpan",tabindex:"tabIndex",usemap:"useMap",frameborder:"frameBorder"};var pa={},Oa=/^(?:\{.*\}|\[.*\])$/;c.extend({cache:{},uuid:0,expando:"jQuery"+c.now(),noData:{embed:true,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:true},data:function(a,b,d){if(c.acceptData(a)){a=a==E?pa:a;var e=a.nodeType,f=e?a[c.expando]:null,h=c.cache;if(!(e&&!f&&typeof b==="string"&&d===A)){if(e)f||(a[c.expando]=f=++c.uuid);else h=a;if(typeof b==="object")if(e)h[f]=
c.extend(h[f],b);else c.extend(h,b);else if(e&&!h[f])h[f]={};a=e?h[f]:h;if(d!==A)a[b]=d;return typeof b==="string"?a[b]:a}}},removeData:function(a,b){if(c.acceptData(a)){a=a==E?pa:a;var d=a.nodeType,e=d?a[c.expando]:a,f=c.cache,h=d?f[e]:e;if(b){if(h){delete h[b];d&&c.isEmptyObject(h)&&c.removeData(a)}}else if(d&&c.support.deleteExpando)delete a[c.expando];else if(a.removeAttribute)a.removeAttribute(c.expando);else if(d)delete f[e];else for(var k in a)delete a[k]}},acceptData:function(a){if(a.nodeName){var b=
c.noData[a.nodeName.toLowerCase()];if(b)return!(b===true||a.getAttribute("classid")!==b)}return true}});c.fn.extend({data:function(a,b){if(typeof a==="undefined")return this.length?c.data(this[0]):null;else if(typeof a==="object")return this.each(function(){c.data(this,a)});var d=a.split(".");d[1]=d[1]?"."+d[1]:"";if(b===A){var e=this.triggerHandler("getData"+d[1]+"!",[d[0]]);if(e===A&&this.length){e=c.data(this[0],a);if(e===A&&this[0].nodeType===1){e=this[0].getAttribute("data-"+a);if(typeof e===
"string")try{e=e==="true"?true:e==="false"?false:e==="null"?null:!c.isNaN(e)?parseFloat(e):Oa.test(e)?c.parseJSON(e):e}catch(f){}else e=A}}return e===A&&d[1]?this.data(d[0]):e}else return this.each(function(){var h=c(this),k=[d[0],b];h.triggerHandler("setData"+d[1]+"!",k);c.data(this,a,b);h.triggerHandler("changeData"+d[1]+"!",k)})},removeData:function(a){return this.each(function(){c.removeData(this,a)})}});c.extend({queue:function(a,b,d){if(a){b=(b||"fx")+"queue";var e=c.data(a,b);if(!d)return e||
[];if(!e||c.isArray(d))e=c.data(a,b,c.makeArray(d));else e.push(d);return e}},dequeue:function(a,b){b=b||"fx";var d=c.queue(a,b),e=d.shift();if(e==="inprogress")e=d.shift();if(e){b==="fx"&&d.unshift("inprogress");e.call(a,function(){c.dequeue(a,b)})}}});c.fn.extend({queue:function(a,b){if(typeof a!=="string"){b=a;a="fx"}if(b===A)return c.queue(this[0],a);return this.each(function(){var d=c.queue(this,a,b);a==="fx"&&d[0]!=="inprogress"&&c.dequeue(this,a)})},dequeue:function(a){return this.each(function(){c.dequeue(this,
a)})},delay:function(a,b){a=c.fx?c.fx.speeds[a]||a:a;b=b||"fx";return this.queue(b,function(){var d=this;setTimeout(function(){c.dequeue(d,b)},a)})},clearQueue:function(a){return this.queue(a||"fx",[])}});var qa=/[\n\t]/g,ga=/\s+/,Pa=/\r/g,Qa=/^(?:href|src|style)$/,Ra=/^(?:button|input)$/i,Sa=/^(?:button|input|object|select|textarea)$/i,Ta=/^a(?:rea)?$/i,ra=/^(?:radio|checkbox)$/i;c.fn.extend({attr:function(a,b){return c.access(this,a,b,true,c.attr)},removeAttr:function(a){return this.each(function(){c.attr(this,
a,"");this.nodeType===1&&this.removeAttribute(a)})},addClass:function(a){if(c.isFunction(a))return this.each(function(s){var v=c(this);v.addClass(a.call(this,s,v.attr("class")))});if(a&&typeof a==="string")for(var b=(a||"").split(ga),d=0,e=this.length;d<e;d++){var f=this[d];if(f.nodeType===1)if(f.className){for(var h=" "+f.className+" ",k=f.className,l=0,n=b.length;l<n;l++)if(h.indexOf(" "+b[l]+" ")<0)k+=" "+b[l];f.className=c.trim(k)}else f.className=a}return this},removeClass:function(a){if(c.isFunction(a))return this.each(function(n){var s=
c(this);s.removeClass(a.call(this,n,s.attr("class")))});if(a&&typeof a==="string"||a===A)for(var b=(a||"").split(ga),d=0,e=this.length;d<e;d++){var f=this[d];if(f.nodeType===1&&f.className)if(a){for(var h=(" "+f.className+" ").replace(qa," "),k=0,l=b.length;k<l;k++)h=h.replace(" "+b[k]+" "," ");f.className=c.trim(h)}else f.className=""}return this},toggleClass:function(a,b){var d=typeof a,e=typeof b==="boolean";if(c.isFunction(a))return this.each(function(f){var h=c(this);h.toggleClass(a.call(this,
f,h.attr("class"),b),b)});return this.each(function(){if(d==="string")for(var f,h=0,k=c(this),l=b,n=a.split(ga);f=n[h++];){l=e?l:!k.hasClass(f);k[l?"addClass":"removeClass"](f)}else if(d==="undefined"||d==="boolean"){this.className&&c.data(this,"__className__",this.className);this.className=this.className||a===false?"":c.data(this,"__className__")||""}})},hasClass:function(a){a=" "+a+" ";for(var b=0,d=this.length;b<d;b++)if((" "+this[b].className+" ").replace(qa," ").indexOf(a)>-1)return true;return false},
val:function(a){if(!arguments.length){var b=this[0];if(b){if(c.nodeName(b,"option")){var d=b.attributes.value;return!d||d.specified?b.value:b.text}if(c.nodeName(b,"select")){var e=b.selectedIndex;d=[];var f=b.options;b=b.type==="select-one";if(e<0)return null;var h=b?e:0;for(e=b?e+1:f.length;h<e;h++){var k=f[h];if(k.selected&&(c.support.optDisabled?!k.disabled:k.getAttribute("disabled")===null)&&(!k.parentNode.disabled||!c.nodeName(k.parentNode,"optgroup"))){a=c(k).val();if(b)return a;d.push(a)}}return d}if(ra.test(b.type)&&
!c.support.checkOn)return b.getAttribute("value")===null?"on":b.value;return(b.value||"").replace(Pa,"")}return A}var l=c.isFunction(a);return this.each(function(n){var s=c(this),v=a;if(this.nodeType===1){if(l)v=a.call(this,n,s.val());if(v==null)v="";else if(typeof v==="number")v+="";else if(c.isArray(v))v=c.map(v,function(D){return D==null?"":D+""});if(c.isArray(v)&&ra.test(this.type))this.checked=c.inArray(s.val(),v)>=0;else if(c.nodeName(this,"select")){var B=c.makeArray(v);c("option",this).each(function(){this.selected=
c.inArray(c(this).val(),B)>=0});if(!B.length)this.selectedIndex=-1}else this.value=v}})}});c.extend({attrFn:{val:true,css:true,html:true,text:true,data:true,width:true,height:true,offset:true},attr:function(a,b,d,e){if(!a||a.nodeType===3||a.nodeType===8)return A;if(e&&b in c.attrFn)return c(a)[b](d);e=a.nodeType!==1||!c.isXMLDoc(a);var f=d!==A;b=e&&c.props[b]||b;if(a.nodeType===1){var h=Qa.test(b);if((b in a||a[b]!==A)&&e&&!h){if(f){b==="type"&&Ra.test(a.nodeName)&&a.parentNode&&c.error("type property can't be changed");
if(d===null)a.nodeType===1&&a.removeAttribute(b);else a[b]=d}if(c.nodeName(a,"form")&&a.getAttributeNode(b))return a.getAttributeNode(b).nodeValue;if(b==="tabIndex")return(b=a.getAttributeNode("tabIndex"))&&b.specified?b.value:Sa.test(a.nodeName)||Ta.test(a.nodeName)&&a.href?0:A;return a[b]}if(!c.support.style&&e&&b==="style"){if(f)a.style.cssText=""+d;return a.style.cssText}f&&a.setAttribute(b,""+d);if(!a.attributes[b]&&a.hasAttribute&&!a.hasAttribute(b))return A;a=!c.support.hrefNormalized&&e&&
h?a.getAttribute(b,2):a.getAttribute(b);return a===null?A:a}}});var X=/\.(.*)$/,ha=/^(?:textarea|input|select)$/i,Ha=/\./g,Ia=/ /g,Ua=/[^\w\s.|`]/g,Va=function(a){return a.replace(Ua,"\\$&")},sa={focusin:0,focusout:0};c.event={add:function(a,b,d,e){if(!(a.nodeType===3||a.nodeType===8)){if(c.isWindow(a)&&a!==E&&!a.frameElement)a=E;if(d===false)d=U;var f,h;if(d.handler){f=d;d=f.handler}if(!d.guid)d.guid=c.guid++;if(h=c.data(a)){var k=a.nodeType?"events":"__events__",l=h[k],n=h.handle;if(typeof l===
"function"){n=l.handle;l=l.events}else if(!l){a.nodeType||(h[k]=h=function(){});h.events=l={}}if(!n)h.handle=n=function(){return typeof c!=="undefined"&&!c.event.triggered?c.event.handle.apply(n.elem,arguments):A};n.elem=a;b=b.split(" ");for(var s=0,v;k=b[s++];){h=f?c.extend({},f):{handler:d,data:e};if(k.indexOf(".")>-1){v=k.split(".");k=v.shift();h.namespace=v.slice(0).sort().join(".")}else{v=[];h.namespace=""}h.type=k;if(!h.guid)h.guid=d.guid;var B=l[k],D=c.event.special[k]||{};if(!B){B=l[k]=[];
if(!D.setup||D.setup.call(a,e,v,n)===false)if(a.addEventListener)a.addEventListener(k,n,false);else a.attachEvent&&a.attachEvent("on"+k,n)}if(D.add){D.add.call(a,h);if(!h.handler.guid)h.handler.guid=d.guid}B.push(h);c.event.global[k]=true}a=null}}},global:{},remove:function(a,b,d,e){if(!(a.nodeType===3||a.nodeType===8)){if(d===false)d=U;var f,h,k=0,l,n,s,v,B,D,H=a.nodeType?"events":"__events__",w=c.data(a),G=w&&w[H];if(w&&G){if(typeof G==="function"){w=G;G=G.events}if(b&&b.type){d=b.handler;b=b.type}if(!b||
typeof b==="string"&&b.charAt(0)==="."){b=b||"";for(f in G)c.event.remove(a,f+b)}else{for(b=b.split(" ");f=b[k++];){v=f;l=f.indexOf(".")<0;n=[];if(!l){n=f.split(".");f=n.shift();s=RegExp("(^|\\.)"+c.map(n.slice(0).sort(),Va).join("\\.(?:.*\\.)?")+"(\\.|$)")}if(B=G[f])if(d){v=c.event.special[f]||{};for(h=e||0;h<B.length;h++){D=B[h];if(d.guid===D.guid){if(l||s.test(D.namespace)){e==null&&B.splice(h--,1);v.remove&&v.remove.call(a,D)}if(e!=null)break}}if(B.length===0||e!=null&&B.length===1){if(!v.teardown||
v.teardown.call(a,n)===false)c.removeEvent(a,f,w.handle);delete G[f]}}else for(h=0;h<B.length;h++){D=B[h];if(l||s.test(D.namespace)){c.event.remove(a,v,D.handler,h);B.splice(h--,1)}}}if(c.isEmptyObject(G)){if(b=w.handle)b.elem=null;delete w.events;delete w.handle;if(typeof w==="function")c.removeData(a,H);else c.isEmptyObject(w)&&c.removeData(a)}}}}},trigger:function(a,b,d,e){var f=a.type||a;if(!e){a=typeof a==="object"?a[c.expando]?a:c.extend(c.Event(f),a):c.Event(f);if(f.indexOf("!")>=0){a.type=
f=f.slice(0,-1);a.exclusive=true}if(!d){a.stopPropagation();c.event.global[f]&&c.each(c.cache,function(){this.events&&this.events[f]&&c.event.trigger(a,b,this.handle.elem)})}if(!d||d.nodeType===3||d.nodeType===8)return A;a.result=A;a.target=d;b=c.makeArray(b);b.unshift(a)}a.currentTarget=d;(e=d.nodeType?c.data(d,"handle"):(c.data(d,"__events__")||{}).handle)&&e.apply(d,b);e=d.parentNode||d.ownerDocument;try{if(!(d&&d.nodeName&&c.noData[d.nodeName.toLowerCase()]))if(d["on"+f]&&d["on"+f].apply(d,b)===
false){a.result=false;a.preventDefault()}}catch(h){}if(!a.isPropagationStopped()&&e)c.event.trigger(a,b,e,true);else if(!a.isDefaultPrevented()){e=a.target;var k,l=f.replace(X,""),n=c.nodeName(e,"a")&&l==="click",s=c.event.special[l]||{};if((!s._default||s._default.call(d,a)===false)&&!n&&!(e&&e.nodeName&&c.noData[e.nodeName.toLowerCase()])){try{if(e[l]){if(k=e["on"+l])e["on"+l]=null;c.event.triggered=true;e[l]()}}catch(v){}if(k)e["on"+l]=k;c.event.triggered=false}}},handle:function(a){var b,d,e;
d=[];var f,h=c.makeArray(arguments);a=h[0]=c.event.fix(a||E.event);a.currentTarget=this;b=a.type.indexOf(".")<0&&!a.exclusive;if(!b){e=a.type.split(".");a.type=e.shift();d=e.slice(0).sort();e=RegExp("(^|\\.)"+d.join("\\.(?:.*\\.)?")+"(\\.|$)")}a.namespace=a.namespace||d.join(".");f=c.data(this,this.nodeType?"events":"__events__");if(typeof f==="function")f=f.events;d=(f||{})[a.type];if(f&&d){d=d.slice(0);f=0;for(var k=d.length;f<k;f++){var l=d[f];if(b||e.test(l.namespace)){a.handler=l.handler;a.data=
l.data;a.handleObj=l;l=l.handler.apply(this,h);if(l!==A){a.result=l;if(l===false){a.preventDefault();a.stopPropagation()}}if(a.isImmediatePropagationStopped())break}}}return a.result},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),
fix:function(a){if(a[c.expando])return a;var b=a;a=c.Event(b);for(var d=this.props.length,e;d;){e=this.props[--d];a[e]=b[e]}if(!a.target)a.target=a.srcElement||u;if(a.target.nodeType===3)a.target=a.target.parentNode;if(!a.relatedTarget&&a.fromElement)a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement;if(a.pageX==null&&a.clientX!=null){b=u.documentElement;d=u.body;a.pageX=a.clientX+(b&&b.scrollLeft||d&&d.scrollLeft||0)-(b&&b.clientLeft||d&&d.clientLeft||0);a.pageY=a.clientY+(b&&b.scrollTop||
d&&d.scrollTop||0)-(b&&b.clientTop||d&&d.clientTop||0)}if(a.which==null&&(a.charCode!=null||a.keyCode!=null))a.which=a.charCode!=null?a.charCode:a.keyCode;if(!a.metaKey&&a.ctrlKey)a.metaKey=a.ctrlKey;if(!a.which&&a.button!==A)a.which=a.button&1?1:a.button&2?3:a.button&4?2:0;return a},guid:1E8,proxy:c.proxy,special:{ready:{setup:c.bindReady,teardown:c.noop},live:{add:function(a){c.event.add(this,Y(a.origType,a.selector),c.extend({},a,{handler:Ga,guid:a.handler.guid}))},remove:function(a){c.event.remove(this,
Y(a.origType,a.selector),a)}},beforeunload:{setup:function(a,b,d){if(c.isWindow(this))this.onbeforeunload=d},teardown:function(a,b){if(this.onbeforeunload===b)this.onbeforeunload=null}}}};c.removeEvent=u.removeEventListener?function(a,b,d){a.removeEventListener&&a.removeEventListener(b,d,false)}:function(a,b,d){a.detachEvent&&a.detachEvent("on"+b,d)};c.Event=function(a){if(!this.preventDefault)return new c.Event(a);if(a&&a.type){this.originalEvent=a;this.type=a.type}else this.type=a;this.timeStamp=
c.now();this[c.expando]=true};c.Event.prototype={preventDefault:function(){this.isDefaultPrevented=ba;var a=this.originalEvent;if(a)if(a.preventDefault)a.preventDefault();else a.returnValue=false},stopPropagation:function(){this.isPropagationStopped=ba;var a=this.originalEvent;if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=ba;this.stopPropagation()},isDefaultPrevented:U,isPropagationStopped:U,isImmediatePropagationStopped:U};
var ta=function(a){var b=a.relatedTarget;try{for(;b&&b!==this;)b=b.parentNode;if(b!==this){a.type=a.data;c.event.handle.apply(this,arguments)}}catch(d){}},ua=function(a){a.type=a.data;c.event.handle.apply(this,arguments)};c.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){c.event.special[a]={setup:function(d){c.event.add(this,b,d&&d.selector?ua:ta,a)},teardown:function(d){c.event.remove(this,b,d&&d.selector?ua:ta)}}});if(!c.support.submitBubbles)c.event.special.submit={setup:function(){if(this.nodeName.toLowerCase()!==
"form"){c.event.add(this,"click.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="submit"||d==="image")&&c(b).closest("form").length){a.liveFired=A;return ja("submit",this,arguments)}});c.event.add(this,"keypress.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="text"||d==="password")&&c(b).closest("form").length&&a.keyCode===13){a.liveFired=A;return ja("submit",this,arguments)}})}else return false},teardown:function(){c.event.remove(this,".specialSubmit")}};if(!c.support.changeBubbles){var V,
va=function(a){var b=a.type,d=a.value;if(b==="radio"||b==="checkbox")d=a.checked;else if(b==="select-multiple")d=a.selectedIndex>-1?c.map(a.options,function(e){return e.selected}).join("-"):"";else if(a.nodeName.toLowerCase()==="select")d=a.selectedIndex;return d},Z=function(a,b){var d=a.target,e,f;if(!(!ha.test(d.nodeName)||d.readOnly)){e=c.data(d,"_change_data");f=va(d);if(a.type!=="focusout"||d.type!=="radio")c.data(d,"_change_data",f);if(!(e===A||f===e))if(e!=null||f){a.type="change";a.liveFired=
A;return c.event.trigger(a,b,d)}}};c.event.special.change={filters:{focusout:Z,beforedeactivate:Z,click:function(a){var b=a.target,d=b.type;if(d==="radio"||d==="checkbox"||b.nodeName.toLowerCase()==="select")return Z.call(this,a)},keydown:function(a){var b=a.target,d=b.type;if(a.keyCode===13&&b.nodeName.toLowerCase()!=="textarea"||a.keyCode===32&&(d==="checkbox"||d==="radio")||d==="select-multiple")return Z.call(this,a)},beforeactivate:function(a){a=a.target;c.data(a,"_change_data",va(a))}},setup:function(){if(this.type===
"file")return false;for(var a in V)c.event.add(this,a+".specialChange",V[a]);return ha.test(this.nodeName)},teardown:function(){c.event.remove(this,".specialChange");return ha.test(this.nodeName)}};V=c.event.special.change.filters;V.focus=V.beforeactivate}u.addEventListener&&c.each({focus:"focusin",blur:"focusout"},function(a,b){function d(e){e=c.event.fix(e);e.type=b;return c.event.trigger(e,null,e.target)}c.event.special[b]={setup:function(){sa[b]++===0&&u.addEventListener(a,d,true)},teardown:function(){--sa[b]===
0&&u.removeEventListener(a,d,true)}}});c.each(["bind","one"],function(a,b){c.fn[b]=function(d,e,f){if(typeof d==="object"){for(var h in d)this[b](h,e,d[h],f);return this}if(c.isFunction(e)||e===false){f=e;e=A}var k=b==="one"?c.proxy(f,function(n){c(this).unbind(n,k);return f.apply(this,arguments)}):f;if(d==="unload"&&b!=="one")this.one(d,e,f);else{h=0;for(var l=this.length;h<l;h++)c.event.add(this[h],d,k,e)}return this}});c.fn.extend({unbind:function(a,b){if(typeof a==="object"&&!a.preventDefault)for(var d in a)this.unbind(d,
a[d]);else{d=0;for(var e=this.length;d<e;d++)c.event.remove(this[d],a,b)}return this},delegate:function(a,b,d,e){return this.live(b,d,e,a)},undelegate:function(a,b,d){return arguments.length===0?this.unbind("live"):this.die(b,null,d,a)},trigger:function(a,b){return this.each(function(){c.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0]){var d=c.Event(a);d.preventDefault();d.stopPropagation();c.event.trigger(d,b,this[0]);return d.result}},toggle:function(a){for(var b=arguments,d=
1;d<b.length;)c.proxy(a,b[d++]);return this.click(c.proxy(a,function(e){var f=(c.data(this,"lastToggle"+a.guid)||0)%d;c.data(this,"lastToggle"+a.guid,f+1);e.preventDefault();return b[f].apply(this,arguments)||false}))},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var wa={focus:"focusin",blur:"focusout",mouseenter:"mouseover",mouseleave:"mouseout"};c.each(["live","die"],function(a,b){c.fn[b]=function(d,e,f,h){var k,l=0,n,s,v=h||this.selector;h=h?this:c(this.context);if(typeof d===
"object"&&!d.preventDefault){for(k in d)h[b](k,e,d[k],v);return this}if(c.isFunction(e)){f=e;e=A}for(d=(d||"").split(" ");(k=d[l++])!=null;){n=X.exec(k);s="";if(n){s=n[0];k=k.replace(X,"")}if(k==="hover")d.push("mouseenter"+s,"mouseleave"+s);else{n=k;if(k==="focus"||k==="blur"){d.push(wa[k]+s);k+=s}else k=(wa[k]||k)+s;if(b==="live"){s=0;for(var B=h.length;s<B;s++)c.event.add(h[s],"live."+Y(k,v),{data:e,selector:v,handler:f,origType:k,origHandler:f,preType:n})}else h.unbind("live."+Y(k,v),f)}}return this}});
c.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error".split(" "),function(a,b){c.fn[b]=function(d,e){if(e==null){e=d;d=null}return arguments.length>0?this.bind(b,d,e):this.trigger(b)};if(c.attrFn)c.attrFn[b]=true});E.attachEvent&&!E.addEventListener&&c(E).bind("unload",function(){for(var a in c.cache)if(c.cache[a].handle)try{c.event.remove(c.cache[a].handle.elem)}catch(b){}});
(function(){function a(g,j,o,m,p,q){p=0;for(var t=m.length;p<t;p++){var x=m[p];if(x){x=x[g];for(var C=false;x;){if(x.sizcache===o){C=m[x.sizset];break}if(x.nodeType===1&&!q){x.sizcache=o;x.sizset=p}if(x.nodeName.toLowerCase()===j){C=x;break}x=x[g]}m[p]=C}}}function b(g,j,o,m,p,q){p=0;for(var t=m.length;p<t;p++){var x=m[p];if(x){x=x[g];for(var C=false;x;){if(x.sizcache===o){C=m[x.sizset];break}if(x.nodeType===1){if(!q){x.sizcache=o;x.sizset=p}if(typeof j!=="string"){if(x===j){C=true;break}}else if(l.filter(j,
[x]).length>0){C=x;break}}x=x[g]}m[p]=C}}}var d=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,e=0,f=Object.prototype.toString,h=false,k=true;[0,0].sort(function(){k=false;return 0});var l=function(g,j,o,m){o=o||[];var p=j=j||u;if(j.nodeType!==1&&j.nodeType!==9)return[];if(!g||typeof g!=="string")return o;var q=[],t,x,C,P,N=true,R=l.isXML(j),Q=g,L;do{d.exec("");if(t=d.exec(Q)){Q=t[3];q.push(t[1]);if(t[2]){P=t[3];
break}}}while(t);if(q.length>1&&s.exec(g))if(q.length===2&&n.relative[q[0]])x=M(q[0]+q[1],j);else for(x=n.relative[q[0]]?[j]:l(q.shift(),j);q.length;){g=q.shift();if(n.relative[g])g+=q.shift();x=M(g,x)}else{if(!m&&q.length>1&&j.nodeType===9&&!R&&n.match.ID.test(q[0])&&!n.match.ID.test(q[q.length-1])){t=l.find(q.shift(),j,R);j=t.expr?l.filter(t.expr,t.set)[0]:t.set[0]}if(j){t=m?{expr:q.pop(),set:D(m)}:l.find(q.pop(),q.length===1&&(q[0]==="~"||q[0]==="+")&&j.parentNode?j.parentNode:j,R);x=t.expr?l.filter(t.expr,
t.set):t.set;if(q.length>0)C=D(x);else N=false;for(;q.length;){t=L=q.pop();if(n.relative[L])t=q.pop();else L="";if(t==null)t=j;n.relative[L](C,t,R)}}else C=[]}C||(C=x);C||l.error(L||g);if(f.call(C)==="[object Array]")if(N)if(j&&j.nodeType===1)for(g=0;C[g]!=null;g++){if(C[g]&&(C[g]===true||C[g].nodeType===1&&l.contains(j,C[g])))o.push(x[g])}else for(g=0;C[g]!=null;g++)C[g]&&C[g].nodeType===1&&o.push(x[g]);else o.push.apply(o,C);else D(C,o);if(P){l(P,p,o,m);l.uniqueSort(o)}return o};l.uniqueSort=function(g){if(w){h=
k;g.sort(w);if(h)for(var j=1;j<g.length;j++)g[j]===g[j-1]&&g.splice(j--,1)}return g};l.matches=function(g,j){return l(g,null,null,j)};l.matchesSelector=function(g,j){return l(j,null,null,[g]).length>0};l.find=function(g,j,o){var m;if(!g)return[];for(var p=0,q=n.order.length;p<q;p++){var t=n.order[p],x;if(x=n.leftMatch[t].exec(g)){var C=x[1];x.splice(1,1);if(C.substr(C.length-1)!=="\\"){x[1]=(x[1]||"").replace(/\\/g,"");m=n.find[t](x,j,o);if(m!=null){g=g.replace(n.match[t],"");break}}}}m||(m=j.getElementsByTagName("*"));
return{set:m,expr:g}};l.filter=function(g,j,o,m){for(var p=g,q=[],t=j,x,C,P=j&&j[0]&&l.isXML(j[0]);g&&j.length;){for(var N in n.filter)if((x=n.leftMatch[N].exec(g))!=null&&x[2]){var R=n.filter[N],Q,L;L=x[1];C=false;x.splice(1,1);if(L.substr(L.length-1)!=="\\"){if(t===q)q=[];if(n.preFilter[N])if(x=n.preFilter[N](x,t,o,q,m,P)){if(x===true)continue}else C=Q=true;if(x)for(var i=0;(L=t[i])!=null;i++)if(L){Q=R(L,x,i,t);var r=m^!!Q;if(o&&Q!=null)if(r)C=true;else t[i]=false;else if(r){q.push(L);C=true}}if(Q!==
A){o||(t=q);g=g.replace(n.match[N],"");if(!C)return[];break}}}if(g===p)if(C==null)l.error(g);else break;p=g}return t};l.error=function(g){throw"Syntax error, unrecognized expression: "+g;};var n=l.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+\-]*)\))?/,
POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(g){return g.getAttribute("href")}},relative:{"+":function(g,j){var o=typeof j==="string",m=o&&!/\W/.test(j);o=o&&!m;if(m)j=j.toLowerCase();m=0;for(var p=g.length,q;m<p;m++)if(q=g[m]){for(;(q=q.previousSibling)&&q.nodeType!==1;);g[m]=o||q&&q.nodeName.toLowerCase()===
j?q||false:q===j}o&&l.filter(j,g,true)},">":function(g,j){var o=typeof j==="string",m,p=0,q=g.length;if(o&&!/\W/.test(j))for(j=j.toLowerCase();p<q;p++){if(m=g[p]){o=m.parentNode;g[p]=o.nodeName.toLowerCase()===j?o:false}}else{for(;p<q;p++)if(m=g[p])g[p]=o?m.parentNode:m.parentNode===j;o&&l.filter(j,g,true)}},"":function(g,j,o){var m=e++,p=b,q;if(typeof j==="string"&&!/\W/.test(j)){q=j=j.toLowerCase();p=a}p("parentNode",j,m,g,q,o)},"~":function(g,j,o){var m=e++,p=b,q;if(typeof j==="string"&&!/\W/.test(j)){q=
j=j.toLowerCase();p=a}p("previousSibling",j,m,g,q,o)}},find:{ID:function(g,j,o){if(typeof j.getElementById!=="undefined"&&!o)return(g=j.getElementById(g[1]))&&g.parentNode?[g]:[]},NAME:function(g,j){if(typeof j.getElementsByName!=="undefined"){for(var o=[],m=j.getElementsByName(g[1]),p=0,q=m.length;p<q;p++)m[p].getAttribute("name")===g[1]&&o.push(m[p]);return o.length===0?null:o}},TAG:function(g,j){return j.getElementsByTagName(g[1])}},preFilter:{CLASS:function(g,j,o,m,p,q){g=" "+g[1].replace(/\\/g,
"")+" ";if(q)return g;q=0;for(var t;(t=j[q])!=null;q++)if(t)if(p^(t.className&&(" "+t.className+" ").replace(/[\t\n]/g," ").indexOf(g)>=0))o||m.push(t);else if(o)j[q]=false;return false},ID:function(g){return g[1].replace(/\\/g,"")},TAG:function(g){return g[1].toLowerCase()},CHILD:function(g){if(g[1]==="nth"){var j=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(g[2]==="even"&&"2n"||g[2]==="odd"&&"2n+1"||!/\D/.test(g[2])&&"0n+"+g[2]||g[2]);g[2]=j[1]+(j[2]||1)-0;g[3]=j[3]-0}g[0]=e++;return g},ATTR:function(g,j,o,
m,p,q){j=g[1].replace(/\\/g,"");if(!q&&n.attrMap[j])g[1]=n.attrMap[j];if(g[2]==="~=")g[4]=" "+g[4]+" ";return g},PSEUDO:function(g,j,o,m,p){if(g[1]==="not")if((d.exec(g[3])||"").length>1||/^\w/.test(g[3]))g[3]=l(g[3],null,null,j);else{g=l.filter(g[3],j,o,true^p);o||m.push.apply(m,g);return false}else if(n.match.POS.test(g[0])||n.match.CHILD.test(g[0]))return true;return g},POS:function(g){g.unshift(true);return g}},filters:{enabled:function(g){return g.disabled===false&&g.type!=="hidden"},disabled:function(g){return g.disabled===
true},checked:function(g){return g.checked===true},selected:function(g){return g.selected===true},parent:function(g){return!!g.firstChild},empty:function(g){return!g.firstChild},has:function(g,j,o){return!!l(o[3],g).length},header:function(g){return/h\d/i.test(g.nodeName)},text:function(g){return"text"===g.type},radio:function(g){return"radio"===g.type},checkbox:function(g){return"checkbox"===g.type},file:function(g){return"file"===g.type},password:function(g){return"password"===g.type},submit:function(g){return"submit"===
g.type},image:function(g){return"image"===g.type},reset:function(g){return"reset"===g.type},button:function(g){return"button"===g.type||g.nodeName.toLowerCase()==="button"},input:function(g){return/input|select|textarea|button/i.test(g.nodeName)}},setFilters:{first:function(g,j){return j===0},last:function(g,j,o,m){return j===m.length-1},even:function(g,j){return j%2===0},odd:function(g,j){return j%2===1},lt:function(g,j,o){return j<o[3]-0},gt:function(g,j,o){return j>o[3]-0},nth:function(g,j,o){return o[3]-
0===j},eq:function(g,j,o){return o[3]-0===j}},filter:{PSEUDO:function(g,j,o,m){var p=j[1],q=n.filters[p];if(q)return q(g,o,j,m);else if(p==="contains")return(g.textContent||g.innerText||l.getText([g])||"").indexOf(j[3])>=0;else if(p==="not"){j=j[3];o=0;for(m=j.length;o<m;o++)if(j[o]===g)return false;return true}else l.error("Syntax error, unrecognized expression: "+p)},CHILD:function(g,j){var o=j[1],m=g;switch(o){case "only":case "first":for(;m=m.previousSibling;)if(m.nodeType===1)return false;if(o===
"first")return true;m=g;case "last":for(;m=m.nextSibling;)if(m.nodeType===1)return false;return true;case "nth":o=j[2];var p=j[3];if(o===1&&p===0)return true;var q=j[0],t=g.parentNode;if(t&&(t.sizcache!==q||!g.nodeIndex)){var x=0;for(m=t.firstChild;m;m=m.nextSibling)if(m.nodeType===1)m.nodeIndex=++x;t.sizcache=q}m=g.nodeIndex-p;return o===0?m===0:m%o===0&&m/o>=0}},ID:function(g,j){return g.nodeType===1&&g.getAttribute("id")===j},TAG:function(g,j){return j==="*"&&g.nodeType===1||g.nodeName.toLowerCase()===
j},CLASS:function(g,j){return(" "+(g.className||g.getAttribute("class"))+" ").indexOf(j)>-1},ATTR:function(g,j){var o=j[1];o=n.attrHandle[o]?n.attrHandle[o](g):g[o]!=null?g[o]:g.getAttribute(o);var m=o+"",p=j[2],q=j[4];return o==null?p==="!=":p==="="?m===q:p==="*="?m.indexOf(q)>=0:p==="~="?(" "+m+" ").indexOf(q)>=0:!q?m&&o!==false:p==="!="?m!==q:p==="^="?m.indexOf(q)===0:p==="$="?m.substr(m.length-q.length)===q:p==="|="?m===q||m.substr(0,q.length+1)===q+"-":false},POS:function(g,j,o,m){var p=n.setFilters[j[2]];
if(p)return p(g,o,j,m)}}},s=n.match.POS,v=function(g,j){return"\\"+(j-0+1)},B;for(B in n.match){n.match[B]=RegExp(n.match[B].source+/(?![^\[]*\])(?![^\(]*\))/.source);n.leftMatch[B]=RegExp(/(^(?:.|\r|\n)*?)/.source+n.match[B].source.replace(/\\(\d+)/g,v))}var D=function(g,j){g=Array.prototype.slice.call(g,0);if(j){j.push.apply(j,g);return j}return g};try{Array.prototype.slice.call(u.documentElement.childNodes,0)}catch(H){D=function(g,j){var o=j||[],m=0;if(f.call(g)==="[object Array]")Array.prototype.push.apply(o,
g);else if(typeof g.length==="number")for(var p=g.length;m<p;m++)o.push(g[m]);else for(;g[m];m++)o.push(g[m]);return o}}var w,G;if(u.documentElement.compareDocumentPosition)w=function(g,j){if(g===j){h=true;return 0}if(!g.compareDocumentPosition||!j.compareDocumentPosition)return g.compareDocumentPosition?-1:1;return g.compareDocumentPosition(j)&4?-1:1};else{w=function(g,j){var o=[],m=[],p=g.parentNode,q=j.parentNode,t=p;if(g===j){h=true;return 0}else if(p===q)return G(g,j);else if(p){if(!q)return 1}else return-1;
for(;t;){o.unshift(t);t=t.parentNode}for(t=q;t;){m.unshift(t);t=t.parentNode}p=o.length;q=m.length;for(t=0;t<p&&t<q;t++)if(o[t]!==m[t])return G(o[t],m[t]);return t===p?G(g,m[t],-1):G(o[t],j,1)};G=function(g,j,o){if(g===j)return o;for(g=g.nextSibling;g;){if(g===j)return-1;g=g.nextSibling}return 1}}l.getText=function(g){for(var j="",o,m=0;g[m];m++){o=g[m];if(o.nodeType===3||o.nodeType===4)j+=o.nodeValue;else if(o.nodeType!==8)j+=l.getText(o.childNodes)}return j};(function(){var g=u.createElement("div"),
j="script"+(new Date).getTime();g.innerHTML="<a name='"+j+"'/>";var o=u.documentElement;o.insertBefore(g,o.firstChild);if(u.getElementById(j)){n.find.ID=function(m,p,q){if(typeof p.getElementById!=="undefined"&&!q)return(p=p.getElementById(m[1]))?p.id===m[1]||typeof p.getAttributeNode!=="undefined"&&p.getAttributeNode("id").nodeValue===m[1]?[p]:A:[]};n.filter.ID=function(m,p){var q=typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id");return m.nodeType===1&&q&&q.nodeValue===p}}o.removeChild(g);
o=g=null})();(function(){var g=u.createElement("div");g.appendChild(u.createComment(""));if(g.getElementsByTagName("*").length>0)n.find.TAG=function(j,o){var m=o.getElementsByTagName(j[1]);if(j[1]==="*"){for(var p=[],q=0;m[q];q++)m[q].nodeType===1&&p.push(m[q]);m=p}return m};g.innerHTML="<a href='#'></a>";if(g.firstChild&&typeof g.firstChild.getAttribute!=="undefined"&&g.firstChild.getAttribute("href")!=="#")n.attrHandle.href=function(j){return j.getAttribute("href",2)};g=null})();u.querySelectorAll&&
function(){var g=l,j=u.createElement("div");j.innerHTML="<p class='TEST'></p>";if(!(j.querySelectorAll&&j.querySelectorAll(".TEST").length===0)){l=function(m,p,q,t){p=p||u;if(!t&&!l.isXML(p))if(p.nodeType===9)try{return D(p.querySelectorAll(m),q)}catch(x){}else if(p.nodeType===1&&p.nodeName.toLowerCase()!=="object"){var C=p.id,P=p.id="__sizzle__";try{return D(p.querySelectorAll("#"+P+" "+m),q)}catch(N){}finally{if(C)p.id=C;else p.removeAttribute("id")}}return g(m,p,q,t)};for(var o in g)l[o]=g[o];
j=null}}();(function(){var g=u.documentElement,j=g.matchesSelector||g.mozMatchesSelector||g.webkitMatchesSelector||g.msMatchesSelector,o=false;try{j.call(u.documentElement,":sizzle")}catch(m){o=true}if(j)l.matchesSelector=function(p,q){try{if(o||!n.match.PSEUDO.test(q))return j.call(p,q)}catch(t){}return l(q,null,null,[p]).length>0}})();(function(){var g=u.createElement("div");g.innerHTML="<div class='test e'></div><div class='test'></div>";if(!(!g.getElementsByClassName||g.getElementsByClassName("e").length===
0)){g.lastChild.className="e";if(g.getElementsByClassName("e").length!==1){n.order.splice(1,0,"CLASS");n.find.CLASS=function(j,o,m){if(typeof o.getElementsByClassName!=="undefined"&&!m)return o.getElementsByClassName(j[1])};g=null}}})();l.contains=u.documentElement.contains?function(g,j){return g!==j&&(g.contains?g.contains(j):true)}:function(g,j){return!!(g.compareDocumentPosition(j)&16)};l.isXML=function(g){return(g=(g?g.ownerDocument||g:0).documentElement)?g.nodeName!=="HTML":false};var M=function(g,
j){for(var o=[],m="",p,q=j.nodeType?[j]:j;p=n.match.PSEUDO.exec(g);){m+=p[0];g=g.replace(n.match.PSEUDO,"")}g=n.relative[g]?g+"*":g;p=0;for(var t=q.length;p<t;p++)l(g,q[p],o);return l.filter(m,o)};c.find=l;c.expr=l.selectors;c.expr[":"]=c.expr.filters;c.unique=l.uniqueSort;c.text=l.getText;c.isXMLDoc=l.isXML;c.contains=l.contains})();var Wa=/Until$/,Xa=/^(?:parents|prevUntil|prevAll)/,Ya=/,/,Ja=/^.[^:#\[\.,]*$/,Za=Array.prototype.slice,$a=c.expr.match.POS;c.fn.extend({find:function(a){for(var b=this.pushStack("",
"find",a),d=0,e=0,f=this.length;e<f;e++){d=b.length;c.find(a,this[e],b);if(e>0)for(var h=d;h<b.length;h++)for(var k=0;k<d;k++)if(b[k]===b[h]){b.splice(h--,1);break}}return b},has:function(a){var b=c(a);return this.filter(function(){for(var d=0,e=b.length;d<e;d++)if(c.contains(this,b[d]))return true})},not:function(a){return this.pushStack(ka(this,a,false),"not",a)},filter:function(a){return this.pushStack(ka(this,a,true),"filter",a)},is:function(a){return!!a&&c.filter(a,this).length>0},closest:function(a,
b){var d=[],e,f,h=this[0];if(c.isArray(a)){var k={},l,n=1;if(h&&a.length){e=0;for(f=a.length;e<f;e++){l=a[e];k[l]||(k[l]=c.expr.match.POS.test(l)?c(l,b||this.context):l)}for(;h&&h.ownerDocument&&h!==b;){for(l in k){e=k[l];if(e.jquery?e.index(h)>-1:c(h).is(e))d.push({selector:l,elem:h,level:n})}h=h.parentNode;n++}}return d}k=$a.test(a)?c(a,b||this.context):null;e=0;for(f=this.length;e<f;e++)for(h=this[e];h;)if(k?k.index(h)>-1:c.find.matchesSelector(h,a)){d.push(h);break}else{h=h.parentNode;if(!h||
!h.ownerDocument||h===b)break}d=d.length>1?c.unique(d):d;return this.pushStack(d,"closest",a)},index:function(a){if(!a||typeof a==="string")return c.inArray(this[0],a?c(a):this.parent().children());return c.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var d=typeof a==="string"?c(a,b||this.context):c.makeArray(a),e=c.merge(this.get(),d);return this.pushStack(!d[0]||!d[0].parentNode||d[0].parentNode.nodeType===11||!e[0]||!e[0].parentNode||e[0].parentNode.nodeType===11?e:c.unique(e))},andSelf:function(){return this.add(this.prevObject)}});
c.each({parent:function(a){return(a=a.parentNode)&&a.nodeType!==11?a:null},parents:function(a){return c.dir(a,"parentNode")},parentsUntil:function(a,b,d){return c.dir(a,"parentNode",d)},next:function(a){return c.nth(a,2,"nextSibling")},prev:function(a){return c.nth(a,2,"previousSibling")},nextAll:function(a){return c.dir(a,"nextSibling")},prevAll:function(a){return c.dir(a,"previousSibling")},nextUntil:function(a,b,d){return c.dir(a,"nextSibling",d)},prevUntil:function(a,b,d){return c.dir(a,"previousSibling",
d)},siblings:function(a){return c.sibling(a.parentNode.firstChild,a)},children:function(a){return c.sibling(a.firstChild)},contents:function(a){return c.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:c.makeArray(a.childNodes)}},function(a,b){c.fn[a]=function(d,e){var f=c.map(this,b,d);Wa.test(a)||(e=d);if(e&&typeof e==="string")f=c.filter(e,f);f=this.length>1?c.unique(f):f;if((this.length>1||Ya.test(e))&&Xa.test(a))f=f.reverse();return this.pushStack(f,a,Za.call(arguments).join(","))}});
c.extend({filter:function(a,b,d){if(d)a=":not("+a+")";return b.length===1?c.find.matchesSelector(b[0],a)?[b[0]]:[]:c.find.matches(a,b)},dir:function(a,b,d){var e=[];for(a=a[b];a&&a.nodeType!==9&&(d===A||a.nodeType!==1||!c(a).is(d));){a.nodeType===1&&e.push(a);a=a[b]}return e},nth:function(a,b,d){b=b||1;for(var e=0;a;a=a[d])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType===1&&a!==b&&d.push(a);return d}});var xa=/ jQuery\d+="(?:\d+|null)"/g,
$=/^\s+/,ya=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,za=/<([\w:]+)/,ab=/<tbody/i,bb=/<|&#?\w+;/,Aa=/<(?:script|object|embed|option|style)/i,Ba=/checked\s*(?:[^=]|=\s*.checked.)/i,cb=/\=([^="'>\s]+\/)>/g,O={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],
area:[1,"<map>","</map>"],_default:[0,"",""]};O.optgroup=O.option;O.tbody=O.tfoot=O.colgroup=O.caption=O.thead;O.th=O.td;if(!c.support.htmlSerialize)O._default=[1,"div<div>","</div>"];c.fn.extend({text:function(a){if(c.isFunction(a))return this.each(function(b){var d=c(this);d.text(a.call(this,b,d.text()))});if(typeof a!=="object"&&a!==A)return this.empty().append((this[0]&&this[0].ownerDocument||u).createTextNode(a));return c.text(this)},wrapAll:function(a){if(c.isFunction(a))return this.each(function(d){c(this).wrapAll(a.call(this,
d))});if(this[0]){var b=c(a,this[0].ownerDocument).eq(0).clone(true);this[0].parentNode&&b.insertBefore(this[0]);b.map(function(){for(var d=this;d.firstChild&&d.firstChild.nodeType===1;)d=d.firstChild;return d}).append(this)}return this},wrapInner:function(a){if(c.isFunction(a))return this.each(function(b){c(this).wrapInner(a.call(this,b))});return this.each(function(){var b=c(this),d=b.contents();d.length?d.wrapAll(a):b.append(a)})},wrap:function(a){return this.each(function(){c(this).wrapAll(a)})},
unwrap:function(){return this.parent().each(function(){c.nodeName(this,"body")||c(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,this)});else if(arguments.length){var a=
c(arguments[0]);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,this.nextSibling)});else if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,c(arguments[0]).toArray());return a}},remove:function(a,b){for(var d=0,e;(e=this[d])!=null;d++)if(!a||c.filter(a,[e]).length){if(!b&&e.nodeType===1){c.cleanData(e.getElementsByTagName("*"));
c.cleanData([e])}e.parentNode&&e.parentNode.removeChild(e)}return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++)for(b.nodeType===1&&c.cleanData(b.getElementsByTagName("*"));b.firstChild;)b.removeChild(b.firstChild);return this},clone:function(a){var b=this.map(function(){if(!c.support.noCloneEvent&&!c.isXMLDoc(this)){var d=this.outerHTML,e=this.ownerDocument;if(!d){d=e.createElement("div");d.appendChild(this.cloneNode(true));d=d.innerHTML}return c.clean([d.replace(xa,"").replace(cb,'="$1">').replace($,
"")],e)[0]}else return this.cloneNode(true)});if(a===true){la(this,b);la(this.find("*"),b.find("*"))}return b},html:function(a){if(a===A)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(xa,""):null;else if(typeof a==="string"&&!Aa.test(a)&&(c.support.leadingWhitespace||!$.test(a))&&!O[(za.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(ya,"<$1></$2>");try{for(var b=0,d=this.length;b<d;b++)if(this[b].nodeType===1){c.cleanData(this[b].getElementsByTagName("*"));this[b].innerHTML=a}}catch(e){this.empty().append(a)}}else c.isFunction(a)?
this.each(function(f){var h=c(this);h.html(a.call(this,f,h.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(c.isFunction(a))return this.each(function(b){var d=c(this),e=d.html();d.replaceWith(a.call(this,b,e))});if(typeof a!=="string")a=c(a).detach();return this.each(function(){var b=this.nextSibling,d=this.parentNode;c(this).remove();b?c(b).before(a):c(d).append(a)})}else return this.pushStack(c(c.isFunction(a)?a():a),"replaceWith",a)},detach:function(a){return this.remove(a,
true)},domManip:function(a,b,d){var e,f,h=a[0],k=[],l;if(!c.support.checkClone&&arguments.length===3&&typeof h==="string"&&Ba.test(h))return this.each(function(){c(this).domManip(a,b,d,true)});if(c.isFunction(h))return this.each(function(s){var v=c(this);a[0]=h.call(this,s,b?v.html():A);v.domManip(a,b,d)});if(this[0]){e=h&&h.parentNode;e=c.support.parentNode&&e&&e.nodeType===11&&e.childNodes.length===this.length?{fragment:e}:c.buildFragment(a,this,k);l=e.fragment;if(f=l.childNodes.length===1?l=l.firstChild:
l.firstChild){b=b&&c.nodeName(f,"tr");f=0;for(var n=this.length;f<n;f++)d.call(b?c.nodeName(this[f],"table")?this[f].getElementsByTagName("tbody")[0]||this[f].appendChild(this[f].ownerDocument.createElement("tbody")):this[f]:this[f],f>0||e.cacheable||this.length>1?l.cloneNode(true):l)}k.length&&c.each(k,Ka)}return this}});c.buildFragment=function(a,b,d){var e,f,h;b=b&&b[0]?b[0].ownerDocument||b[0]:u;if(a.length===1&&typeof a[0]==="string"&&a[0].length<512&&b===u&&!Aa.test(a[0])&&(c.support.checkClone||
!Ba.test(a[0]))){f=true;if(h=c.fragments[a[0]])if(h!==1)e=h}if(!e){e=b.createDocumentFragment();c.clean(a,b,e,d)}if(f)c.fragments[a[0]]=h?e:1;return{fragment:e,cacheable:f}};c.fragments={};c.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){c.fn[a]=function(d){var e=[];d=c(d);var f=this.length===1&&this[0].parentNode;if(f&&f.nodeType===11&&f.childNodes.length===1&&d.length===1){d[b](this[0]);return this}else{f=0;for(var h=
d.length;f<h;f++){var k=(f>0?this.clone(true):this).get();c(d[f])[b](k);e=e.concat(k)}return this.pushStack(e,a,d.selector)}}});c.extend({clean:function(a,b,d,e){b=b||u;if(typeof b.createElement==="undefined")b=b.ownerDocument||b[0]&&b[0].ownerDocument||u;for(var f=[],h=0,k;(k=a[h])!=null;h++){if(typeof k==="number")k+="";if(k){if(typeof k==="string"&&!bb.test(k))k=b.createTextNode(k);else if(typeof k==="string"){k=k.replace(ya,"<$1></$2>");var l=(za.exec(k)||["",""])[1].toLowerCase(),n=O[l]||O._default,
s=n[0],v=b.createElement("div");for(v.innerHTML=n[1]+k+n[2];s--;)v=v.lastChild;if(!c.support.tbody){s=ab.test(k);l=l==="table"&&!s?v.firstChild&&v.firstChild.childNodes:n[1]==="<table>"&&!s?v.childNodes:[];for(n=l.length-1;n>=0;--n)c.nodeName(l[n],"tbody")&&!l[n].childNodes.length&&l[n].parentNode.removeChild(l[n])}!c.support.leadingWhitespace&&$.test(k)&&v.insertBefore(b.createTextNode($.exec(k)[0]),v.firstChild);k=v.childNodes}if(k.nodeType)f.push(k);else f=c.merge(f,k)}}if(d)for(h=0;f[h];h++)if(e&&
c.nodeName(f[h],"script")&&(!f[h].type||f[h].type.toLowerCase()==="text/javascript"))e.push(f[h].parentNode?f[h].parentNode.removeChild(f[h]):f[h]);else{f[h].nodeType===1&&f.splice.apply(f,[h+1,0].concat(c.makeArray(f[h].getElementsByTagName("script"))));d.appendChild(f[h])}return f},cleanData:function(a){for(var b,d,e=c.cache,f=c.event.special,h=c.support.deleteExpando,k=0,l;(l=a[k])!=null;k++)if(!(l.nodeName&&c.noData[l.nodeName.toLowerCase()]))if(d=l[c.expando]){if((b=e[d])&&b.events)for(var n in b.events)f[n]?
c.event.remove(l,n):c.removeEvent(l,n,b.handle);if(h)delete l[c.expando];else l.removeAttribute&&l.removeAttribute(c.expando);delete e[d]}}});var Ca=/alpha\([^)]*\)/i,db=/opacity=([^)]*)/,eb=/-([a-z])/ig,fb=/([A-Z])/g,Da=/^-?\d+(?:px)?$/i,gb=/^-?\d/,hb={position:"absolute",visibility:"hidden",display:"block"},La=["Left","Right"],Ma=["Top","Bottom"],W,ib=u.defaultView&&u.defaultView.getComputedStyle,jb=function(a,b){return b.toUpperCase()};c.fn.css=function(a,b){if(arguments.length===2&&b===A)return this;
return c.access(this,a,b,true,function(d,e,f){return f!==A?c.style(d,e,f):c.css(d,e)})};c.extend({cssHooks:{opacity:{get:function(a,b){if(b){var d=W(a,"opacity","opacity");return d===""?"1":d}else return a.style.opacity}}},cssNumber:{zIndex:true,fontWeight:true,opacity:true,zoom:true,lineHeight:true},cssProps:{"float":c.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,d,e){if(!(!a||a.nodeType===3||a.nodeType===8||!a.style)){var f,h=c.camelCase(b),k=a.style,l=c.cssHooks[h];b=c.cssProps[h]||
h;if(d!==A){if(!(typeof d==="number"&&isNaN(d)||d==null)){if(typeof d==="number"&&!c.cssNumber[h])d+="px";if(!l||!("set"in l)||(d=l.set(a,d))!==A)try{k[b]=d}catch(n){}}}else{if(l&&"get"in l&&(f=l.get(a,false,e))!==A)return f;return k[b]}}},css:function(a,b,d){var e,f=c.camelCase(b),h=c.cssHooks[f];b=c.cssProps[f]||f;if(h&&"get"in h&&(e=h.get(a,true,d))!==A)return e;else if(W)return W(a,b,f)},swap:function(a,b,d){var e={},f;for(f in b){e[f]=a.style[f];a.style[f]=b[f]}d.call(a);for(f in b)a.style[f]=
e[f]},camelCase:function(a){return a.replace(eb,jb)}});c.curCSS=c.css;c.each(["height","width"],function(a,b){c.cssHooks[b]={get:function(d,e,f){var h;if(e){if(d.offsetWidth!==0)h=ma(d,b,f);else c.swap(d,hb,function(){h=ma(d,b,f)});return h+"px"}},set:function(d,e){if(Da.test(e)){e=parseFloat(e);if(e>=0)return e+"px"}else return e}}});if(!c.support.opacity)c.cssHooks.opacity={get:function(a,b){return db.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":
b?"1":""},set:function(a,b){var d=a.style;d.zoom=1;var e=c.isNaN(b)?"":"alpha(opacity="+b*100+")",f=d.filter||"";d.filter=Ca.test(f)?f.replace(Ca,e):d.filter+" "+e}};if(ib)W=function(a,b,d){var e;d=d.replace(fb,"-$1").toLowerCase();if(!(b=a.ownerDocument.defaultView))return A;if(b=b.getComputedStyle(a,null)){e=b.getPropertyValue(d);if(e===""&&!c.contains(a.ownerDocument.documentElement,a))e=c.style(a,d)}return e};else if(u.documentElement.currentStyle)W=function(a,b){var d,e,f=a.currentStyle&&a.currentStyle[b],
h=a.style;if(!Da.test(f)&&gb.test(f)){d=h.left;e=a.runtimeStyle.left;a.runtimeStyle.left=a.currentStyle.left;h.left=b==="fontSize"?"1em":f||0;f=h.pixelLeft+"px";h.left=d;a.runtimeStyle.left=e}return f};if(c.expr&&c.expr.filters){c.expr.filters.hidden=function(a){var b=a.offsetHeight;return a.offsetWidth===0&&b===0||!c.support.reliableHiddenOffsets&&(a.style.display||c.css(a,"display"))==="none"};c.expr.filters.visible=function(a){return!c.expr.filters.hidden(a)}}var kb=c.now(),lb=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
mb=/^(?:select|textarea)/i,nb=/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,ob=/^(?:GET|HEAD|DELETE)$/,Na=/\[\]$/,T=/\=\?(&|$)/,ia=/\?/,pb=/([?&])_=[^&]*/,qb=/^(\w+:)?\/\/([^\/?#]+)/,rb=/%20/g,sb=/#.*$/,Ea=c.fn.load;c.fn.extend({load:function(a,b,d){if(typeof a!=="string"&&Ea)return Ea.apply(this,arguments);else if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var f=a.slice(e,a.length);a=a.slice(0,e)}e="GET";if(b)if(c.isFunction(b)){d=
b;b=null}else if(typeof b==="object"){b=c.param(b,c.ajaxSettings.traditional);e="POST"}var h=this;c.ajax({url:a,type:e,dataType:"html",data:b,complete:function(k,l){if(l==="success"||l==="notmodified")h.html(f?c("<div>").append(k.responseText.replace(lb,"")).find(f):k.responseText);d&&h.each(d,[k.responseText,l,k])}});return this},serialize:function(){return c.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?c.makeArray(this.elements):this}).filter(function(){return this.name&&
!this.disabled&&(this.checked||mb.test(this.nodeName)||nb.test(this.type))}).map(function(a,b){var d=c(this).val();return d==null?null:c.isArray(d)?c.map(d,function(e){return{name:b.name,value:e}}):{name:b.name,value:d}}).get()}});c.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){c.fn[b]=function(d){return this.bind(b,d)}});c.extend({get:function(a,b,d,e){if(c.isFunction(b)){e=e||d;d=b;b=null}return c.ajax({type:"GET",url:a,data:b,success:d,dataType:e})},
getScript:function(a,b){return c.get(a,null,b,"script")},getJSON:function(a,b,d){return c.get(a,b,d,"json")},post:function(a,b,d,e){if(c.isFunction(b)){e=e||d;d=b;b={}}return c.ajax({type:"POST",url:a,data:b,success:d,dataType:e})},ajaxSetup:function(a){c.extend(c.ajaxSettings,a)},ajaxSettings:{url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new E.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",
script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},ajax:function(a){var b=c.extend(true,{},c.ajaxSettings,a),d,e,f,h=b.type.toUpperCase(),k=ob.test(h);b.url=b.url.replace(sb,"");b.context=a&&a.context!=null?a.context:b;if(b.data&&b.processData&&typeof b.data!=="string")b.data=c.param(b.data,b.traditional);if(b.dataType==="jsonp"){if(h==="GET")T.test(b.url)||(b.url+=(ia.test(b.url)?"&":"?")+(b.jsonp||"callback")+"=?");else if(!b.data||
!T.test(b.data))b.data=(b.data?b.data+"&":"")+(b.jsonp||"callback")+"=?";b.dataType="json"}if(b.dataType==="json"&&(b.data&&T.test(b.data)||T.test(b.url))){d=b.jsonpCallback||"jsonp"+kb++;if(b.data)b.data=(b.data+"").replace(T,"="+d+"$1");b.url=b.url.replace(T,"="+d+"$1");b.dataType="script";var l=E[d];E[d]=function(m){f=m;c.handleSuccess(b,w,e,f);c.handleComplete(b,w,e,f);if(c.isFunction(l))l(m);else{E[d]=A;try{delete E[d]}catch(p){}}v&&v.removeChild(B)}}if(b.dataType==="script"&&b.cache===null)b.cache=
false;if(b.cache===false&&h==="GET"){var n=c.now(),s=b.url.replace(pb,"$1_="+n);b.url=s+(s===b.url?(ia.test(b.url)?"&":"?")+"_="+n:"")}if(b.data&&h==="GET")b.url+=(ia.test(b.url)?"&":"?")+b.data;b.global&&c.active++===0&&c.event.trigger("ajaxStart");n=(n=qb.exec(b.url))&&(n[1]&&n[1]!==location.protocol||n[2]!==location.host);if(b.dataType==="script"&&h==="GET"&&n){var v=u.getElementsByTagName("head")[0]||u.documentElement,B=u.createElement("script");if(b.scriptCharset)B.charset=b.scriptCharset;B.src=
b.url;if(!d){var D=false;B.onload=B.onreadystatechange=function(){if(!D&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){D=true;c.handleSuccess(b,w,e,f);c.handleComplete(b,w,e,f);B.onload=B.onreadystatechange=null;v&&B.parentNode&&v.removeChild(B)}}}v.insertBefore(B,v.firstChild);return A}var H=false,w=b.xhr();if(w){b.username?w.open(h,b.url,b.async,b.username,b.password):w.open(h,b.url,b.async);try{if(b.data!=null&&!k||a&&a.contentType)w.setRequestHeader("Content-Type",
b.contentType);if(b.ifModified){c.lastModified[b.url]&&w.setRequestHeader("If-Modified-Since",c.lastModified[b.url]);c.etag[b.url]&&w.setRequestHeader("If-None-Match",c.etag[b.url])}n||w.setRequestHeader("X-Requested-With","XMLHttpRequest");w.setRequestHeader("Accept",b.dataType&&b.accepts[b.dataType]?b.accepts[b.dataType]+", */*; q=0.01":b.accepts._default)}catch(G){}if(b.beforeSend&&b.beforeSend.call(b.context,w,b)===false){b.global&&c.active--===1&&c.event.trigger("ajaxStop");w.abort();return false}b.global&&
c.triggerGlobal(b,"ajaxSend",[w,b]);var M=w.onreadystatechange=function(m){if(!w||w.readyState===0||m==="abort"){H||c.handleComplete(b,w,e,f);H=true;if(w)w.onreadystatechange=c.noop}else if(!H&&w&&(w.readyState===4||m==="timeout")){H=true;w.onreadystatechange=c.noop;e=m==="timeout"?"timeout":!c.httpSuccess(w)?"error":b.ifModified&&c.httpNotModified(w,b.url)?"notmodified":"success";var p;if(e==="success")try{f=c.httpData(w,b.dataType,b)}catch(q){e="parsererror";p=q}if(e==="success"||e==="notmodified")d||
c.handleSuccess(b,w,e,f);else c.handleError(b,w,e,p);d||c.handleComplete(b,w,e,f);m==="timeout"&&w.abort();if(b.async)w=null}};try{var g=w.abort;w.abort=function(){w&&g.call&&g.call(w);M("abort")}}catch(j){}b.async&&b.timeout>0&&setTimeout(function(){w&&!H&&M("timeout")},b.timeout);try{w.send(k||b.data==null?null:b.data)}catch(o){c.handleError(b,w,null,o);c.handleComplete(b,w,e,f)}b.async||M();return w}},param:function(a,b){var d=[],e=function(h,k){k=c.isFunction(k)?k():k;d[d.length]=encodeURIComponent(h)+
"="+encodeURIComponent(k)};if(b===A)b=c.ajaxSettings.traditional;if(c.isArray(a)||a.jquery)c.each(a,function(){e(this.name,this.value)});else for(var f in a)ca(f,a[f],b,e);return d.join("&").replace(rb,"+")}});c.extend({active:0,lastModified:{},etag:{},handleError:function(a,b,d,e){a.error&&a.error.call(a.context,b,d,e);a.global&&c.triggerGlobal(a,"ajaxError",[b,a,e])},handleSuccess:function(a,b,d,e){a.success&&a.success.call(a.context,e,d,b);a.global&&c.triggerGlobal(a,"ajaxSuccess",[b,a])},handleComplete:function(a,
b,d){a.complete&&a.complete.call(a.context,b,d);a.global&&c.triggerGlobal(a,"ajaxComplete",[b,a]);a.global&&c.active--===1&&c.event.trigger("ajaxStop")},triggerGlobal:function(a,b,d){(a.context&&a.context.url==null?c(a.context):c.event).trigger(b,d)},httpSuccess:function(a){try{return!a.status&&location.protocol==="file:"||a.status>=200&&a.status<300||a.status===304||a.status===1223}catch(b){}return false},httpNotModified:function(a,b){var d=a.getResponseHeader("Last-Modified"),e=a.getResponseHeader("Etag");
if(d)c.lastModified[b]=d;if(e)c.etag[b]=e;return a.status===304},httpData:function(a,b,d){var e=a.getResponseHeader("content-type")||"",f=b==="xml"||!b&&e.indexOf("xml")>=0;a=f?a.responseXML:a.responseText;f&&a.documentElement.nodeName==="parsererror"&&c.error("parsererror");if(d&&d.dataFilter)a=d.dataFilter(a,b);if(typeof a==="string")if(b==="json"||!b&&e.indexOf("json")>=0)a=c.parseJSON(a);else if(b==="script"||!b&&e.indexOf("javascript")>=0)c.globalEval(a);return a}});if(E.ActiveXObject)c.ajaxSettings.xhr=
function(){if(E.location.protocol!=="file:")try{return new E.XMLHttpRequest}catch(a){}try{return new E.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}};c.support.ajax=!!c.ajaxSettings.xhr();var da={},tb=/^(?:toggle|show|hide)$/,ub=/^([+\-]=)?([\d+.\-]+)(.*)$/,aa,na=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]];c.fn.extend({show:function(a,b,d){if(a||a===0)return this.animate(S("show",3),a,b,d);else{a=
0;for(b=this.length;a<b;a++){if(!c.data(this[a],"olddisplay")&&this[a].style.display==="none")this[a].style.display="";this[a].style.display===""&&c.css(this[a],"display")==="none"&&c.data(this[a],"olddisplay",oa(this[a].nodeName))}for(a=0;a<b;a++)this[a].style.display=c.data(this[a],"olddisplay")||"";return this}},hide:function(a,b,d){if(a||a===0)return this.animate(S("hide",3),a,b,d);else{a=0;for(b=this.length;a<b;a++){d=c.css(this[a],"display");d!=="none"&&c.data(this[a],"olddisplay",d)}for(a=
0;a<b;a++)this[a].style.display="none";return this}},_toggle:c.fn.toggle,toggle:function(a,b,d){var e=typeof a==="boolean";if(c.isFunction(a)&&c.isFunction(b))this._toggle.apply(this,arguments);else a==null||e?this.each(function(){var f=e?a:c(this).is(":hidden");c(this)[f?"show":"hide"]()}):this.animate(S("toggle",3),a,b,d);return this},fadeTo:function(a,b,d,e){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,d,e)},animate:function(a,b,d,e){var f=c.speed(b,d,e);if(c.isEmptyObject(a))return this.each(f.complete);
return this[f.queue===false?"each":"queue"](function(){var h=c.extend({},f),k,l=this.nodeType===1,n=l&&c(this).is(":hidden"),s=this;for(k in a){var v=c.camelCase(k);if(k!==v){a[v]=a[k];delete a[k];k=v}if(a[k]==="hide"&&n||a[k]==="show"&&!n)return h.complete.call(this);if(l&&(k==="height"||k==="width")){h.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY];if(c.css(this,"display")==="inline"&&c.css(this,"float")==="none")if(c.support.inlineBlockNeedsLayout)if(oa(this.nodeName)===
"inline")this.style.display="inline-block";else{this.style.display="inline";this.style.zoom=1}else this.style.display="inline-block"}if(c.isArray(a[k])){(h.specialEasing=h.specialEasing||{})[k]=a[k][1];a[k]=a[k][0]}}if(h.overflow!=null)this.style.overflow="hidden";h.curAnim=c.extend({},a);c.each(a,function(B,D){var H=new c.fx(s,h,B);if(tb.test(D))H[D==="toggle"?n?"show":"hide":D](a);else{var w=ub.exec(D),G=H.cur(true)||0;if(w){var M=parseFloat(w[2]),g=w[3]||"px";if(g!=="px"){c.style(s,B,(M||1)+g);
G=(M||1)/H.cur(true)*G;c.style(s,B,G+g)}if(w[1])M=(w[1]==="-="?-1:1)*M+G;H.custom(G,M,g)}else H.custom(G,D,"")}});return true})},stop:function(a,b){var d=c.timers;a&&this.queue([]);this.each(function(){for(var e=d.length-1;e>=0;e--)if(d[e].elem===this){b&&d[e](true);d.splice(e,1)}});b||this.dequeue();return this}});c.each({slideDown:S("show",1),slideUp:S("hide",1),slideToggle:S("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"}},function(a,b){c.fn[a]=function(d,e,f){return this.animate(b,
d,e,f)}});c.extend({speed:function(a,b,d){var e=a&&typeof a==="object"?c.extend({},a):{complete:d||!d&&b||c.isFunction(a)&&a,duration:a,easing:d&&b||b&&!c.isFunction(b)&&b};e.duration=c.fx.off?0:typeof e.duration==="number"?e.duration:e.duration in c.fx.speeds?c.fx.speeds[e.duration]:c.fx.speeds._default;e.old=e.complete;e.complete=function(){e.queue!==false&&c(this).dequeue();c.isFunction(e.old)&&e.old.call(this)};return e},easing:{linear:function(a,b,d,e){return d+e*a},swing:function(a,b,d,e){return(-Math.cos(a*
Math.PI)/2+0.5)*e+d}},timers:[],fx:function(a,b,d){this.options=b;this.elem=a;this.prop=d;if(!b.orig)b.orig={}}});c.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this);(c.fx.step[this.prop]||c.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a=parseFloat(c.css(this.elem,this.prop));return a&&a>-1E4?a:0},custom:function(a,b,d){function e(h){return f.step(h)}
this.startTime=c.now();this.start=a;this.end=b;this.unit=d||this.unit||"px";this.now=this.start;this.pos=this.state=0;var f=this;a=c.fx;e.elem=this.elem;if(e()&&c.timers.push(e)&&!aa)aa=setInterval(a.tick,a.interval)},show:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.show=true;this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur());c(this.elem).show()},hide:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.hide=true;
this.custom(this.cur(),0)},step:function(a){var b=c.now(),d=true;if(a||b>=this.options.duration+this.startTime){this.now=this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;for(var e in this.options.curAnim)if(this.options.curAnim[e]!==true)d=false;if(d){if(this.options.overflow!=null&&!c.support.shrinkWrapBlocks){var f=this.elem,h=this.options;c.each(["","X","Y"],function(l,n){f.style["overflow"+n]=h.overflow[l]})}this.options.hide&&c(this.elem).hide();if(this.options.hide||
this.options.show)for(var k in this.options.curAnim)c.style(this.elem,k,this.options.orig[k]);this.options.complete.call(this.elem)}return false}else{a=b-this.startTime;this.state=a/this.options.duration;b=this.options.easing||(c.easing.swing?"swing":"linear");this.pos=c.easing[this.options.specialEasing&&this.options.specialEasing[this.prop]||b](this.state,a,0,1,this.options.duration);this.now=this.start+(this.end-this.start)*this.pos;this.update()}return true}};c.extend(c.fx,{tick:function(){for(var a=
c.timers,b=0;b<a.length;b++)a[b]()||a.splice(b--,1);a.length||c.fx.stop()},interval:13,stop:function(){clearInterval(aa);aa=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){c.style(a.elem,"opacity",a.now)},_default:function(a){if(a.elem.style&&a.elem.style[a.prop]!=null)a.elem.style[a.prop]=(a.prop==="width"||a.prop==="height"?Math.max(0,a.now):a.now)+a.unit;else a.elem[a.prop]=a.now}}});if(c.expr&&c.expr.filters)c.expr.filters.animated=function(a){return c.grep(c.timers,function(b){return a===
b.elem}).length};var vb=/^t(?:able|d|h)$/i,Fa=/^(?:body|html)$/i;c.fn.offset="getBoundingClientRect"in u.documentElement?function(a){var b=this[0],d;if(a)return this.each(function(k){c.offset.setOffset(this,a,k)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);try{d=b.getBoundingClientRect()}catch(e){}var f=b.ownerDocument,h=f.documentElement;if(!d||!c.contains(h,b))return d||{top:0,left:0};b=f.body;f=ea(f);return{top:d.top+(f.pageYOffset||c.support.boxModel&&
h.scrollTop||b.scrollTop)-(h.clientTop||b.clientTop||0),left:d.left+(f.pageXOffset||c.support.boxModel&&h.scrollLeft||b.scrollLeft)-(h.clientLeft||b.clientLeft||0)}}:function(a){var b=this[0];if(a)return this.each(function(s){c.offset.setOffset(this,a,s)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);c.offset.initialize();var d=b.offsetParent,e=b.ownerDocument,f,h=e.documentElement,k=e.body;f=(e=e.defaultView)?e.getComputedStyle(b,null):b.currentStyle;
for(var l=b.offsetTop,n=b.offsetLeft;(b=b.parentNode)&&b!==k&&b!==h;){if(c.offset.supportsFixedPosition&&f.position==="fixed")break;f=e?e.getComputedStyle(b,null):b.currentStyle;l-=b.scrollTop;n-=b.scrollLeft;if(b===d){l+=b.offsetTop;n+=b.offsetLeft;if(c.offset.doesNotAddBorder&&!(c.offset.doesAddBorderForTableAndCells&&vb.test(b.nodeName))){l+=parseFloat(f.borderTopWidth)||0;n+=parseFloat(f.borderLeftWidth)||0}d=b.offsetParent}if(c.offset.subtractsBorderForOverflowNotVisible&&f.overflow!=="visible"){l+=
parseFloat(f.borderTopWidth)||0;n+=parseFloat(f.borderLeftWidth)||0}f=f}if(f.position==="relative"||f.position==="static"){l+=k.offsetTop;n+=k.offsetLeft}if(c.offset.supportsFixedPosition&&f.position==="fixed"){l+=Math.max(h.scrollTop,k.scrollTop);n+=Math.max(h.scrollLeft,k.scrollLeft)}return{top:l,left:n}};c.offset={initialize:function(){var a=u.body,b=u.createElement("div"),d,e,f,h=parseFloat(c.css(a,"marginTop"))||0;c.extend(b.style,{position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",
height:"1px",visibility:"hidden"});b.innerHTML="<div style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;'><div></div></div><table style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>";a.insertBefore(b,a.firstChild);d=b.firstChild;e=d.firstChild;f=d.nextSibling.firstChild.firstChild;this.doesNotAddBorder=e.offsetTop!==5;this.doesAddBorderForTableAndCells=
f.offsetTop===5;e.style.position="fixed";e.style.top="20px";this.supportsFixedPosition=e.offsetTop===20||e.offsetTop===15;e.style.position=e.style.top="";d.style.overflow="hidden";d.style.position="relative";this.subtractsBorderForOverflowNotVisible=e.offsetTop===-5;this.doesNotIncludeMarginInBodyOffset=a.offsetTop!==h;a.removeChild(b);c.offset.initialize=c.noop},bodyOffset:function(a){var b=a.offsetTop,d=a.offsetLeft;c.offset.initialize();if(c.offset.doesNotIncludeMarginInBodyOffset){b+=parseFloat(c.css(a,
"marginTop"))||0;d+=parseFloat(c.css(a,"marginLeft"))||0}return{top:b,left:d}},setOffset:function(a,b,d){var e=c.css(a,"position");if(e==="static")a.style.position="relative";var f=c(a),h=f.offset(),k=c.css(a,"top"),l=c.css(a,"left"),n=e==="absolute"&&c.inArray("auto",[k,l])>-1;e={};var s={};if(n)s=f.position();k=n?s.top:parseInt(k,10)||0;l=n?s.left:parseInt(l,10)||0;if(c.isFunction(b))b=b.call(a,d,h);if(b.top!=null)e.top=b.top-h.top+k;if(b.left!=null)e.left=b.left-h.left+l;"using"in b?b.using.call(a,
e):f.css(e)}};c.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),d=this.offset(),e=Fa.test(b[0].nodeName)?{top:0,left:0}:b.offset();d.top-=parseFloat(c.css(a,"marginTop"))||0;d.left-=parseFloat(c.css(a,"marginLeft"))||0;e.top+=parseFloat(c.css(b[0],"borderTopWidth"))||0;e.left+=parseFloat(c.css(b[0],"borderLeftWidth"))||0;return{top:d.top-e.top,left:d.left-e.left}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||u.body;a&&!Fa.test(a.nodeName)&&
c.css(a,"position")==="static";)a=a.offsetParent;return a})}});c.each(["Left","Top"],function(a,b){var d="scroll"+b;c.fn[d]=function(e){var f=this[0],h;if(!f)return null;if(e!==A)return this.each(function(){if(h=ea(this))h.scrollTo(!a?e:c(h).scrollLeft(),a?e:c(h).scrollTop());else this[d]=e});else return(h=ea(f))?"pageXOffset"in h?h[a?"pageYOffset":"pageXOffset"]:c.support.boxModel&&h.document.documentElement[d]||h.document.body[d]:f[d]}});c.each(["Height","Width"],function(a,b){var d=b.toLowerCase();
c.fn["inner"+b]=function(){return this[0]?parseFloat(c.css(this[0],d,"padding")):null};c.fn["outer"+b]=function(e){return this[0]?parseFloat(c.css(this[0],d,e?"margin":"border")):null};c.fn[d]=function(e){var f=this[0];if(!f)return e==null?null:this;if(c.isFunction(e))return this.each(function(h){var k=c(this);k[d](e.call(this,h,k[d]()))});return c.isWindow(f)?f.document.compatMode==="CSS1Compat"&&f.document.documentElement["client"+b]||f.document.body["client"+b]:f.nodeType===9?Math.max(f.documentElement["client"+
b],f.body["scroll"+b],f.documentElement["scroll"+b],f.body["offset"+b],f.documentElement["offset"+b]):e===A?parseFloat(c.css(f,d)):this.css(d,typeof e==="string"?e:e+"px")}})})(window);

//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.cssText = css;
		} else {
			doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
				'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
		}
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
